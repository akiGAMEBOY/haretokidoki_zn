---
title: "[è§£æ±ºæ–¹æ³•]ãƒ‘ã‚¹ã‚’å®šç¾©ã—ãŸConfigãƒ•ã‚¡ã‚¤ãƒ«ã‚’ConvertFrom-StringDataã«æ¸¡ã™ã¨ã‚¨ãƒ©ãƒ¼"
emoji: "âš™"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["powershell", "config", "ini"]
published: true
---
## æ¦‚è¦
Configãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å®šæ•°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å«ã‚“ã§ã„ã‚‹PowerShellã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¦ãƒ‡ãƒãƒƒã‚°ã—ãŸçµæœã€
ã€Œ `ConvertFrom-StringData: Invalid pattern '"D:\Program Files\Tesseract-OCR\tesseract.exe"' at offset 5. Unrecognized escape sequence \\P.` ã€
ã¨ã„ã†ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

åŸå› ã¯Configãƒ•ã‚¡ã‚¤ãƒ«å†…ã«ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ï¼ˆ\ã€U+005Cï¼‰ã‚’å«ã‚€ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã®ãƒ‘ã‚¹ã‚’å®šç¾©ã—ã¦ãŠã‚Šã€
ãã®ã¾ã¾`ConvertFrom-StringData`ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™ã¨ç™ºç”Ÿã—ã¦ã—ã¾ã†ã‚¨ãƒ©ãƒ¼ã§ã—ãŸã€‚

ã“ã®ã‚¨ãƒ©ãƒ¼ã«å¯¾ã—ã¦èª¿æŸ»ã—ãŸå†…å®¹ã¨å¯¾å‡¦æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

## ã“ã®è¨˜äº‹ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
- åŒã˜äº‹è±¡ ã‚„ é¡ä¼¼äº‹è±¡ ã§ãŠæ‚©ã¿ã®æ–¹
- è©³ã—ã„åŸå› ã‚’çŸ¥ã‚ŠãŸã„æ–¹
- å¯¾å‡¦æ–¹æ³•ï¼ˆè§£æ±ºæ–¹æ³•ï¼‰ã‚’çŸ¥ã‚ŠãŸã„æ–¹

## ç’°å¢ƒ
```powershell
PS C:\WINDOWS\system32> $PSVersionTable

Name                           Value
----                           -----
PSVersion                      7.3.7
PSEdition                      Core
GitCommitId                    7.3.7
OS                             Microsoft Windows 10.0.19045
Platform                       Win32NT
PSCompatibleVersions           {1.0, 2.0, 3.0, 4.0â€¦}
PSRemotingProtocolVersion      2.3
SerializationVersion           1.1.0.1
WSManStackVersion              3.0

PS C:\WINDOWS\system32> 
```

## ã‚¨ãƒ©ãƒ¼
`Get-Content`ã¨`ConvertFrom-StringData`ã®çµ„åˆã›ã§è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆsetup.iniï¼‰ã‚’èª­ã¿è¾¼ã¾ã›ã‚ˆã†ã¨ã—ã¾ã—ãŸãŒã€
`ConvertFrom-StringData`ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã¨ãªã£ã¦ã—ã¾ã†ã€‚
```powershell:ãƒ‡ãƒãƒƒã‚°æ™‚ã®ã‚¨ãƒ©ãƒ¼
[DBG]: PS D:\PowerShell_ResizeImageTool> Get-Content "Configãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ•ãƒ«ãƒ‘ã‚¹" -Raw -Encoding UTF8 | ConvertFrom-StringData

ConvertFrom-StringData: Invalid pattern '"D:\Program Files\Tesseract-OCR\tesseract.exe"' at offset 5. Unrecognized escape sequence \\P.
[DBG]: PS D:\PowerShell_ResizeImageTool>
```
> ğŸ’¡ è‹±èªã®ç›´è¨³
> ã€ŒInvalid patternã€ï¼šç„¡åŠ¹ãªãƒ‘ã‚¿ãƒ¼ãƒ³
> ã€ŒUnrecognized escape sequenceã€ï¼šèªè­˜ã§ããªã„ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹

## ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰
```ini:setup.ini
#################################################################################
# å†…å®¹ã€€ã€€ï½œsetup.ini
# æ©Ÿèƒ½ã€€ã€€ï½œResizeImageToolã§ä½¿ç”¨ã™ã‚‹è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
#--------------------------------------------------------------------------------
# ã€€ã€€ã€€ã€€ï½œ-
#################################################################################
# Tesseract-OCRã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å ´æ‰€
ocr_exe_path="D:\Program Files\Tesseract-OCR\tesseract.exe"         # ğŸ’¡ å€¤ã«ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚ã‚Š
# Tesseract-OCRã®ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå ´æ‰€
ocr_temp_path="D:\Downlodas"                                        # ğŸ’¡ å€¤ã«ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚ã‚Š
# Tesseract-OCRã®ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå ´æ‰€
ocr_check_keyword="sapporo,maruko,sapo,maru,001-0013,åŒ—æµ·é“,æœ­å¹Œ"
# è‡ªå‹•å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰ã®è¨­å®šï¼ˆtrueï¼šè‡ªå‹•å®Ÿè¡Œã€falseï¼šå¯¾è©±å¼å®Ÿè¡Œï¼‰
auto_mode=false
# å¯¾è±¡ãƒ•ã‚©ãƒ«ãƒ€ã®ãƒ‘ã‚¹
input_folder=""
# ãƒªã‚µã‚¤ã‚ºå¾Œã®ç”»åƒã‚µã‚¤ã‚ºï¼ˆpxæŒ‡å®šï¼‰
resize_width="800"
resize_height=""
# å…ƒç”»åƒãŒæŒ‡å®šã‚µã‚¤ã‚ºä»¥ä¸‹ã®å ´åˆã®æ‹¡å¤§æœ‰ç„¡ï¼ˆtrueï¼šæ‹¡å¤§ã™ã‚‹ã€falseï¼šæ‹¡å¤§ã—ãªã„ï¼‰
small_image_resize=false
# WebPå¤‰æ›ã®æœ‰ç„¡
webp_convert=true
# è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆç”¨ã®ãƒ•ã‚©ãƒ«ãƒ€å
output_foldername="To-Resize_"
```

```powershell:Main.ps1ã‚’æŠœç²‹ï¼ˆãƒ¡ã‚¤ãƒ³å‡¦ç†ãŒã‚ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸€éƒ¨ã‚’æŠœç²‹ï¼‰
#################################################################################
# å‡¦ç†åã€€ï½œãƒ¡ã‚¤ãƒ³å‡¦ç†
# æ©Ÿèƒ½ã€€ã€€ï½œåŒä¸Š
#--------------------------------------------------------------------------------
# ã€€ã€€ã€€ã€€ï½œ-
#################################################################################
# ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚³ãƒ¼ãƒ‰ã®è¨­å®š
Add-Type -TypeDefinition @"
    public enum MESSAGECODE {
        Successful = 0,
        Abend,
        Info_LoadedSettingfile,
        Confirm_ExecutionTool,
        Confirm_ResizeImages,
        Error_NotCore,
        Error_NotSupportedVersion,
        Error_NotWindows,
        Error_LoadingSettingfile,
        Error_NotExistsTargetpath,
        Error_EmptyTargetfolder,
        Error_ExecutionTool
    }
"@

# ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å†…ã®å…±é€šå¤‰æ•°ã‚’å®šç¾©
[MESSAGECODE]$result = [MESSAGECODE]::Successful
[System.String]$prompt_message = ''
[System.String]$result_message = ''
[System.String]$append_message = ''
[System.Text.StringBuilder]$sbtemp=New-Object System.Text.StringBuilder

## è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å‡¦ç†
[System.String]$config_fullpath = 'D:\PowerShell_ResizeImageTool\source\powershell\setup.ini'
try {
    # ğŸ’¡ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å ´æ‰€
    [System.Collections.Hashtable]$config = Get-Content $config_fullpath -Raw -Encoding UTF8 | ConvertFrom-StringData
    # å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
    [System.String]$CONFIG_OCR_EXE_PATH=ExpandString($config.ocr_exe_path)
    [System.String]$CONFIG_OCR_TEMP_PATH=ExpandString($config.ocr_temp_path)
    [System.String[]]$CONFIG_OCR_CHECK_KEYWORD=(ExpandString($config.ocr_temp_path)).split(',')
    [System.Boolean]$CONFIG_AUTO_MODE=[System.Convert]::ToBoolean((ExpandString($config.auto_mode)))
    [System.String]$CONFIG_INPUT_FOLDER=ExpandString($config.input_folder)
    [System.String]$CONFIG_RESIZE_WIDTH=ExpandString($config.resize_width)
    [System.String]$CONFIG_RESIZE_HEIGHT=ExpandString($config.resize_height)
    [System.Boolean]$CONFIG_SMALL_IMAGE_RESIZE=[System.Convert]::ToBoolean((ExpandString($config.small_image_resize)))
    [System.Boolean]$CONFIG_WEBP_CONVERT=[System.Convert]::ToBoolean((ExpandString($config.webp_convert)))
    [System.String]$CONFIG_OUTPUT_FOLDERNAME=ExpandString($config.output_foldername)

    $sbtemp=New-Object System.Text.StringBuilder
    @("`r`n",`
      "å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«: [${config_fullpath}]`r`n")|
    ForEach-Object{[void]$sbtemp.Append($_)}
    $append_message = $sbtemp.ToString()
    $prompt_message = RetrieveMessage ([MESSAGECODE]::Info_LoadedSettingfile) $append_message
    Write-Host $prompt_message
}
catch {
    $result = [MESSAGECODE]::Error_LoadingSettingfile
    $sbtemp=New-Object System.Text.StringBuilder
    @("`r`n",`
      "ã‚¨ãƒ©ãƒ¼ã®è©³ç´°: [${config_fullpath}$($_.Exception.Message)]`r`n")|
    ForEach-Object{[void]$sbtemp.Append($_)}
    $append_message = $sbtemp.ToString()
    $result_message = RetrieveMessage ([MESSAGECODE]::Error_LoadingSettingfile) $append_message
}
```

## åŸå› 
`ConvertFrom-StriingData`ã§ã¯ã€ãƒ‘ã‚¹ãªã©ã«å«ã¾ã‚Œã‚‹ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ï¼ˆ\ã€U+005Cï¼‰ã®å€¤ã‚’ãã®ã¾ã¾æ¸¡ã™ã¨ã€
å‡¦ç†ã§ããšã«ã€Œèªè­˜ã§ããªã„ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ï¼ˆ`Unrecognized escape sequence`ï¼‰ã€ã¨ãªã‚Šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã€‚

## å¯¾å¿œæ–¹æ³•
### æ¨å¥¨ã™ã‚‹å¯¾å¿œæ–¹æ³•
`ConvertFrom-StriingData`ã«æ¸¡ã™å‰ã« `\` ã‚’ `\\` ã«å¤‰æ›ã—æ­£ã—ã„ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã«ç½®ãæ›ãˆã‚‹ã‚ˆã†ã«å¤‰æ›´ã€‚
å¤‰æ›´ã«ã‚ˆã‚Šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªããªã‚Š**æœŸå¾…é€šã‚Šã®å‹•ãã¨ãªã£ãŸ**ã€‚
```diff powershell:Main.ps1ã®ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£
-[System.Collections.Hashtable]$config = Get-Content $config_fullpath -Raw -Encoding UTF8 | ConvertFrom-StringData
+[System.Collections.Hashtable]$config = (Get-Content $config_fullpath -Raw -Encoding UTF8).Replace('\','\\') | ConvertFrom-StringData
```
### æ¨å¥¨ã—ãªã„å¯¾å¿œæ–¹æ³•
ä»–ã®å¯¾å¿œæ–¹æ³•ã¨ã—ã¦ã€Configãƒ•ã‚¡ã‚¤ãƒ«ã«å®šç¾©ã—ã¦ã„ã‚‹ãƒ‘ã‚¹ãã®ã‚‚ã®ã‚’ `\` ã‹ã‚‰ `\\` ã§å®šç¾©ã™ã‚‹äº‹ã§ã€
`Get-Content` ã¨ `ConvertFrom-StringData` ã‚’çµ„ã¿åˆã‚ã›ãŸã‚³ãƒãƒ³ãƒ‰ã¯ã€ãã®ã¾ã¾ã®çŠ¶æ…‹ã§å‹•ä½œã™ã‚‹ãŒã€
Configãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã®åˆ©ç”¨è€…ã®äº‹ã‚’è€ƒãˆã‚‹ã¨ã€**ã“ã®æ–¹æ³•ã¯è‰¯ããªã„**ï¼ˆéæ¨å¥¨ï¼‰ã€‚
```diff ini:setup.iniã‚’æŠœç²‹ï¼ˆå®šç¾©å†…å®¹ã‚’å¤‰æ›´ã™ã‚‹æ–¹æ³•ï¼‰ã€éæ¨å¥¨ã€‘
#################################################################################
# å†…å®¹ã€€ã€€ï½œsetup.ini
# æ©Ÿèƒ½ã€€ã€€ï½œResizeImageToolã§ä½¿ç”¨ã™ã‚‹è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
#--------------------------------------------------------------------------------
# ã€€ã€€ã€€ã€€ï½œ-
#################################################################################
# Tesseract-OCRã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å ´æ‰€
-ocr_exe_path="D:\Program Files\Tesseract-OCR\tesseract.exe"
+ocr_exe_path="D:\\Program Files\\Tesseract-OCR\\tesseract.exe"
# Tesseract-OCRã®ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå ´æ‰€
-ocr_temp_path="D:\Downlodas"
+ocr_temp_path="D:\\Downlodas"
```

## å‚è€ƒæƒ…å ±
https://stackoverflow.com/questions/24142436/powershell-parsing-a-properties-file-that-contains-colons
https://itsakura.com/powershell-replace
https://coffeekemuri.blogspot.com/2018/05/powershell-convertfrom.html

## ã¾ã¨ã‚
- åŸå› 
  Configãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã™ã‚‹`ConvertFrom-StringData`ã§ã¯ã€ãƒ‘ã‚¹ã«å«ã¾ã‚Œã‚‹ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ï¼ˆ\ã€U+005Cï¼‰ã‚’ãã®ã¾ã¾æ¸¡ã™ã¨â€œç„¡åŠ¹ãªãƒ‘ã‚¿ãƒ¼ãƒ³â€ã‚„â€œèªè­˜ã§ããªã„ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹â€ã¨ã—ã¦ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹
- å¯¾å‡¦æ–¹æ³•1
  `ConvertFrom-StringData`ã«æ¸¡ã™å‰ã«ã€ãƒ‘ã‚¹ã«å«ã¾ã‚Œã‚‹ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ï¼ˆ\ã€U+005Cï¼‰ã‚’ã€Œ `\\` ã€ã«ç½®æ›ã™ã‚‹äº‹ã§å¯¾å¿œå¯èƒ½
- å¯¾å‡¦è£œæ³•2ï¼ˆéæ¨å¥¨ï¼‰
  Configãƒ•ã‚¡ã‚¤ãƒ«ã«å®šç¾©ã—ã¦ã„ã‚‹ãƒ‘ã‚¹ã®åŒºåˆ‡ã‚Šã‚’ `\` ã‹ã‚‰ `\\` ã§å®šç¾©ã™ã‚‹ã‚ˆã†å¤‰æ›´

## é–¢é€£è¨˜äº‹
https://haretokidoki-blog.com/pasocon_powershell-startup/
https://zenn.dev/haretokidoki/articles/7e6924ff0cc960
