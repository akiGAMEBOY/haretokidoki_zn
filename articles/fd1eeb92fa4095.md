---
title: "PSSessionã‚’ä½¿ã„ãƒªãƒ¢ãƒ¼ãƒˆæ¥ç¶šã§PowerShell CLIã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•"
emoji: "ğŸ‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["powershell", "remote", "PSSession"]
published: false
---
## PowerShell - PSSession
```powershell
PS C:\WINDOWS\system32> New-PSSession -ComputerName XXXX
New-PSSession : [XXXX] ãƒªãƒ¢ãƒ¼ãƒˆ ã‚µãƒ¼ãƒãƒ¼ XXXX ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã€æ¬¡ã®ã‚¨ãƒ©ãƒ¼ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã¾ã—ãŸ: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³
ãƒˆã¯ã€è¦æ±‚ã§æŒ‡å®šã•ã‚ŒãŸæ¥ç¶šå…ˆã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚ æ¥ç¶šå…ˆã®ã‚µãƒ¼ãƒ“ã‚¹ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã¦ã€è¦æ±‚ã‚’å—ã‘ä»˜ã‘ã‚‰ã‚Œã‚‹çŠ¶æ…‹ã§ã‚ã‚‹ã“ã¨ã‚’ç¢º
èªã—ã¦ãã ã•ã„ã€‚ æ¥ç¶šå…ˆã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ WS-Management ã‚µãƒ¼ãƒ“ã‚¹ (é€šå¸¸ã¯ IIS ã¾ãŸã¯ WinRM) ã«é–¢ã™ã‚‹ãƒ­ã‚°ã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚
ç…§ã—ã¦ãã ã•ã„ã€‚ æ¥ç¶šå…ˆãŒ WinRM ã‚µãƒ¼ãƒ“ã‚¹ã®å ´åˆã¯ã€ãƒªãƒ¢ãƒ¼ãƒˆ ãƒ›ã‚¹ãƒˆä¸Šã§æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€WinRM ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ†æãŠã‚ˆã³
æ§‹æˆã—ã¦ãã ã•ã„: "winrm quickconfig"è©³ç´°ã«ã¤ã„ã¦ã¯ã€about_Remote_Troubleshooting ã®ãƒ˜ãƒ«ãƒ— ãƒˆãƒ”ãƒƒã‚¯ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
ç™ºç”Ÿå ´æ‰€ è¡Œ:1 æ–‡å­—:1
+ New-PSSession -ComputerName XXXX
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : OpenError: (System.Manageme....RemoteRunspace:RemoteRunspace) [New-PSSession], PSRemotin
   gTransportException
    + FullyQualifiedErrorId : CannotConnect,PSSessionOpenFailed
PS C:\WINDOWS\system32>
```

### è¨­å®š
1. PowerShell CLIã‚’ç®¡ç†è€…ã¨ã—ã¦å®Ÿè¡Œ
1. æ¥ç¶šå…ˆã®è¨­å®š - PSRemothingã®æœ‰åŠ¹åŒ–
```powershell
PS C:\WINDOWS\system32> Enable-PSRemoting -SkipNetworkProfileCheck
WinRM ã¯è¦æ±‚ã‚’å—ä¿¡ã™ã‚‹ã‚ˆã†ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚
WinRM ã‚µãƒ¼ãƒ“ã‚¹ã®ç¨®é¡ã‚’æ­£ã—ãå¤‰æ›´ã§ãã¾ã—ãŸã€‚
WinRM ã‚µãƒ¼ãƒ“ã‚¹ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸã€‚

WinRM ã¯ãƒªãƒ¢ãƒ¼ãƒˆç®¡ç†ç”¨ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚
WinRM ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã®ä¾‹å¤–ã‚’æœ‰åŠ¹ã«ã—ã¾ã—ãŸã€‚
ãƒ­ãƒ¼ã‚«ãƒ« ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒªãƒ¢ãƒ¼ãƒˆã§ç®¡ç†æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ã‚ˆã† LocalAccountTokenFilterPolicy ã‚’æ§‹æˆã—ã¾ã—ãŸã€‚

PS C:\WINDOWS\system32>
PS C:\WINDOWS\system32>
```
1. æ¥ç¶šå…ƒã®è¨­å®š - PSRemothingã®æœ‰åŠ¹åŒ–
	ä¸Šè¨˜ã¨åŒæ§˜ã®æ‰‹é †
1. æ¥ç¶šå…ƒã®è¨­å®š - ä¿¡é ¼ã§ãã‚‹æ¥ç¶šå…ˆã‚’è¨­å®š
	- è¨­å®šå‰ã®çŠ¶æ…‹
		```powershell
		PS C:\WINDOWS\system32> Get-Item WSMan:\localhost\Client\TrustedHosts


		   WSManConfig: Microsoft.WSMan.Management\WSMan::localhost\Client

		Type            Name                           SourceOfValue   Value
		----            ----                           -------------   -----
		System.String   TrustedHosts


		PS C:\WINDOWS\system32>
		```
	- ALLã§è¨±å¯
		```powershell
		PS C:\WINDOWS\system32> Set-Item WSMan:\localhost\Client\TrustedHosts -Value "*"
		```
	- æ¥ç¶šå…ˆã‚’æŒ‡å®šã—ã¦è¨±å¯
		1. æ¥ç¶šå…ˆã‚’è¨­å®š
			```powershell
			PS C:\WINDOWS\system32> Set-Item WSMan:\localhost\Client\TrustedHosts -Value "192.168.160.189, Windows10.intra.local"

			WinRM ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®æ§‹æˆã€‚
			ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ WinRM ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã® TrustedHosts ã®ä¸€è¦§ã‚’å¤‰æ›´ã—ã¾ã™ã€‚TrustedHosts
			ã®ä¸€è¦§å†…ã«ã‚ã‚‹ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã¯èªè¨¼ã•ã‚Œãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ã“ã‚Œã‚‰ã®ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã«è³‡æ ¼æƒ…å ±ã‚’é€ä¿¡ã™ã‚‹å¯
			èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ä¸€è¦§ã‚’å¤‰æ›´ã—ã¾ã™ã‹?
			[Y] ã¯ã„(Y)  [N] ã„ã„ãˆ(N)  [S] ä¸­æ–­(S)  [?] ãƒ˜ãƒ«ãƒ— (æ—¢å®šå€¤ã¯ "Y"): y
			PS C:\WINDOWS\system32>
			PS C:\WINDOWS\system32>
			```
		1. è¨­å®šå¾Œã®çŠ¶æ…‹
			```powershell
			PS C:\WINDOWS\system32> Get-Item WSMan:\localhost\Client\TrustedHosts


			   WSManConfig: Microsoft.WSMan.Management\WSMan::localhost\Client

			Type            Name                           SourceOfValue   Value
			----            ----                           -------------   -----
			System.String   TrustedHosts                                   192.168.160.189, Windows10.intra.local


			PS C:\WINDOWS\system32>
			```
1. å®Ÿéš›ã®æ¥ç¶šç¢ºèª
	```powershell
	Enter-PSSession -ComputerName 192.168.XXX.XXX -Credential XXXX
	```
	![](https://storage.googleapis.com/zenn-user-upload/a3e271b0b4ba-20230824.png)
	*ç”»åƒï¼šã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼ï¼ˆè³‡æ ¼æƒ…å ±ã®è¦æ±‚ï¼‰ãŒè¡¨ç¤º*
	
- å‚è€ƒæƒ…å ±
	https://www.kayura-se.com/entry/2020/03/30/004146

- Enter-PSSessionã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è‡ªå‹•çš„ã«å…¥åŠ›
	https://yanor.net/wiki/?PowerShell/ãƒªãƒ¢ãƒ¼ãƒˆæ¥ç¶š/Enter-PSSessionã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ã‚’è‡ªå‹•åŒ–ã™ã‚‹
