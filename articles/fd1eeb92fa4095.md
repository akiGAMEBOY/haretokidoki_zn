---
title: "PSSessionã‚’ä½¿ã„ãƒªãƒ¢ãƒ¼ãƒˆæ¥ç¶šã§PowerShell CLIã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•"
emoji: "ğŸ‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["powershell", "remote", "cli"]
published: false
---
## PowerShell - PSSession
```powershell
PS C:\WINDOWS\system32> New-PSSession -ComputerName XXXX
New-PSSession : [XXXX] ãƒªãƒ¢ãƒ¼ãƒˆ ã‚µãƒ¼ãƒãƒ¼ XXXX ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã€æ¬¡ã®ã‚¨ãƒ©ãƒ¼ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã¾ã—ãŸ: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³
ãƒˆã¯ã€è¦æ±‚ã§æŒ‡å®šã•ã‚ŒãŸæ¥ç¶šå…ˆã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚ æ¥ç¶šå…ˆã®ã‚µãƒ¼ãƒ“ã‚¹ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã¦ã€è¦æ±‚ã‚’å—ã‘ä»˜ã‘ã‚‰ã‚Œã‚‹çŠ¶æ…‹ã§ã‚ã‚‹ã“ã¨ã‚’ç¢º
èªã—ã¦ãã ã•ã„ã€‚ æ¥ç¶šå…ˆã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ WS-Management ã‚µãƒ¼ãƒ“ã‚¹ (é€šå¸¸ã¯ IIS ã¾ãŸã¯ WinRM) ã«é–¢ã™ã‚‹ãƒ­ã‚°ã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚
ç…§ã—ã¦ãã ã•ã„ã€‚ æ¥ç¶šå…ˆãŒ WinRM ã‚µãƒ¼ãƒ“ã‚¹ã®å ´åˆã¯ã€ãƒªãƒ¢ãƒ¼ãƒˆ ãƒ›ã‚¹ãƒˆä¸Šã§æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€WinRM ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ†æãŠã‚ˆã³
æ§‹æˆã—ã¦ãã ã•ã„: "winrm quickconfig"è©³ç´°ã«ã¤ã„ã¦ã¯ã€about_Remote_Troubleshooting ã®ãƒ˜ãƒ«ãƒ— ãƒˆãƒ”ãƒƒã‚¯ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
ç™ºç”Ÿå ´æ‰€ è¡Œ:1 æ–‡å­—:1
+ New-PSSession -ComputerName XXXX
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : OpenError: (System.Manageme....RemoteRunspace:RemoteRunspace) [New-PSSession], PSRemotin
   gTransportException
    + FullyQualifiedErrorId : CannotConnect,PSSessionOpenFailed
PS C:\WINDOWS\system32>
```

### ä»–ã®PSSessioné–¢é€£ã®ã‚³ãƒãƒ³ãƒ‰ãƒ¬ãƒƒãƒˆ
```powershell:helpã‚³ãƒãƒ³ãƒ‰ã§ä¸€è¦§ã‚’è¡¨ç¤º
PS C:\WINDOWS\system32> help *PSSession

Name                              Category  Module                    Synopsis
----                              --------  ------                    --------
Connect-PSSession                 Cmdlet    Microsoft.PowerShell.Core Reconnects to disconnected sessions.
Disconnect-PSSession              Cmdlet    Microsoft.PowerShell.Core Disconnects from a session.
Enter-PSSession                   Cmdlet    Microsoft.PowerShell.Core Starts an interactive session with a remote co...
Exit-PSSession                    Cmdlet    Microsoft.PowerShell.Core Ends an interactive session with a remote comp...
Get-PSSession                     Cmdlet    Microsoft.PowerShell.Core Gets the PowerShell sessions on local and remo...
New-PSSession                     Cmdlet    Microsoft.PowerShell.Core Creates a persistent connection to a local or ...
Receive-PSSession                 Cmdlet    Microsoft.PowerShell.Core Gets results of commands in disconnected sessions
Remove-PSSession                  Cmdlet    Microsoft.PowerShell.Core Closes one or more PowerShell sessions (PSSess...
Export-PSSession                  Cmdlet    Microsoft.PowerShell.U... Exports commands from another session and save...
Import-PSSession                  Cmdlet    Microsoft.PowerShell.U... Imports commands from another session into the...



PS C:\WINDOWS\system32>
```

## äº‹å‰è¨­å®š
PSSessioné–¢é€£ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ç‚ºã«ã¯æ¥ç¶šå…ƒã¨æ¥ç¶šå…ˆã§è¨­å®šã‚’å¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
### æ¥ç¶šå…ˆã®è¨­å®š
1. PowerShell CLIã‚’ç®¡ç†è€…ã¨ã—ã¦å®Ÿè¡Œ
1. PSRemothingã®æœ‰åŠ¹åŒ–
    ```powershell
    PS C:\WINDOWS\system32> Enable-PSRemoting -SkipNetworkProfileCheck
    WinRM ã¯è¦æ±‚ã‚’å—ä¿¡ã™ã‚‹ã‚ˆã†ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚
    WinRM ã‚µãƒ¼ãƒ“ã‚¹ã®ç¨®é¡ã‚’æ­£ã—ãå¤‰æ›´ã§ãã¾ã—ãŸã€‚
    WinRM ã‚µãƒ¼ãƒ“ã‚¹ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸã€‚

    WinRM ã¯ãƒªãƒ¢ãƒ¼ãƒˆç®¡ç†ç”¨ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚
    WinRM ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã®ä¾‹å¤–ã‚’æœ‰åŠ¹ã«ã—ã¾ã—ãŸã€‚
    ãƒ­ãƒ¼ã‚«ãƒ« ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒªãƒ¢ãƒ¼ãƒˆã§ç®¡ç†æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ã‚ˆã† LocalAccountTokenFilterPolicy ã‚’æ§‹æˆã—ã¾ã—ãŸã€‚

    PS C:\WINDOWS\system32>
    PS C:\WINDOWS\system32>
    ```
### æ¥ç¶šå…ƒã®è¨­å®š
1. PowerShell CLIã‚’ç®¡ç†è€…ã¨ã—ã¦å®Ÿè¡Œ
1. PSRemothingã®æœ‰åŠ¹åŒ–
	ä¸Šè¨˜ã®æ¥ç¶šå…ˆã®è¨­å®šã¨åŒæ§˜ã€ŒEnable-PSRemotingã€ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã€‚
1. ä¿¡é ¼ã§ãã‚‹æ¥ç¶šå…ˆã‚’è¨­å®š
	- ä½œæ¥­å‰ã®çŠ¶æ…‹
		```powershell
		PS C:\WINDOWS\system32> Get-Item WSMan:\localhost\Client\TrustedHosts


		   WSManConfig: Microsoft.WSMan.Management\WSMan::localhost\Client

		Type            Name                           SourceOfValue   Value
		----            ----                           -------------   -----
		System.String   TrustedHosts


		PS C:\WINDOWS\system32>
		```
	- æ¥ç¶šå…ˆã®è¨±å¯è¨­å®š
		- æ¥ç¶šå…ˆã®è¨±å¯è¨­å®šï¼ˆæ¥ç¶šå…ˆã‚’æŒ‡å®šã—ã¦è¨±å¯ã—ãŸå ´åˆï¼‰
            ä»Šå›ã¯ã“ã¡ã‚‰ã®è¨­å®šã‚’å®Ÿæ–½
            ```powershell:æ¥ç¶šå…ˆã‚’æŒ‡å®šã—ã¦è¨±å¯
            PS C:\WINDOWS\system32> Set-Item WSMan:\localhost\Client\TrustedHosts -Value "192.168.XXX.XXX, Windows10.intra.local"

            WinRM ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®æ§‹æˆã€‚
            ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ WinRM ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã® TrustedHosts ã®ä¸€è¦§ã‚’å¤‰æ›´ã—ã¾ã™ã€‚TrustedHosts
            ã®ä¸€è¦§å†…ã«ã‚ã‚‹ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã¯èªè¨¼ã•ã‚Œãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ã“ã‚Œã‚‰ã®ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã«è³‡æ ¼æƒ…å ±ã‚’é€ä¿¡ã™ã‚‹å¯
            èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ä¸€è¦§ã‚’å¤‰æ›´ã—ã¾ã™ã‹?
            [Y] ã¯ã„(Y)  [N] ã„ã„ãˆ(N)  [S] ä¸­æ–­(S)  [?] ãƒ˜ãƒ«ãƒ— (æ—¢å®šå€¤ã¯ "Y"): y
            PS C:\WINDOWS\system32>
            PS C:\WINDOWS\system32>
            ```
        - æ¥ç¶šå…ˆã®è¨±å¯è¨­å®šï¼ˆã™ã¹ã¦ã®æ¥ç¶šå…ˆã‚’è¨±å¯ã—ãŸå ´åˆï¼‰
            å‚è€ƒæƒ…å ±ã€‚ä»Šå›ã¯ã“ã®è¨­å®šã¯å®Ÿæ–½ã—ã¦ã„ãªã„ã€‚
            ç‰¹å®šã®æ¥ç¶šå…ˆã§ã¯ãªãå…¨ã¦ã®æ¥ç¶šå…ˆã‚’è¨±å¯ã™ã‚‹å ´åˆã®ã‚³ãƒãƒ³ãƒ‰ã€‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®è¦³ç‚¹ã§è¦‹ã‚‹ã¨å®Ÿæ–½ã—ãªã„æ–¹ãŒè‰¯ã„ã€‚
            ```powershell:ã™ã¹ã¦ã®æ¥ç¶šå…ˆã‚’è¨±å¯
            PS C:\WINDOWS\system32> Set-Item WSMan:\localhost\Client\TrustedHosts -Value "*"
            ```

    - ä½œæ¥­å¾Œã®çŠ¶æ…‹
        ä»Šå›ã¯æ¥ç¶šå…ˆã‚’æŒ‡å®šã—ã¦è¨±å¯ã®è¨­å®šã‚’è¡Œã„è¨­å®šå†…å®¹ã«åæ˜ ã•ã‚ŒãŸäº‹ã‚’ç¢ºèªã€‚
        ```powershell
        PS C:\WINDOWS\system32> Get-Item WSMan:\localhost\Client\TrustedHosts


            WSManConfig: Microsoft.WSMan.Management\WSMan::localhost\Client

        Type            Name                           SourceOfValue   Value
        ----            ----                           -------------   -----
        System.String   TrustedHosts                                   192.168.XXX.XXX, Windows10.intra.local


        PS C:\WINDOWS\system32>
        ```

## äº‹å‰è¨­å®šã®åˆ‡ã‚Šæˆ»ã—æ‰‹é †
### æ¥ç¶šå…ˆã®è¨­å®šæˆ»ã—
1. PowerShell CLIã‚’ç®¡ç†è€…ã¨ã—ã¦å®Ÿè¡Œ
1. PSRemotingã®ç„¡åŠ¹åŒ–
    :::messages
    **ç„¡åŠ¹åŒ–å¾Œã«äº‹å¾Œä½œæ¥­ã‚ã‚Š**

    `Disable-PSRemoting`ã‚³ãƒãƒ³ãƒ‰ã§ã¯ã€PSSessionã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯è¨­å®šãŒæ‹’å¦ã«æˆ»ã‚Šã¾ã™ã€‚
    ãŸã ã—ã€å®Œå…¨ã«å…ƒã®è¨­å®šã«æˆ»ã‚‹è¨³ã§ã¯ãªã„ã®ã§ç„¡åŠ¹åŒ–å¾Œã«æ‰‹å‹•ã§ä½œæ¥­ãŒå¿…è¦ã§ã™ã€‚

    ã“ã‚Œã‚‰ãŒæ‰‹å‹•ã§è¨­å®šã‚’æˆ»ã™å¿…è¦ãŒã‚ã‚‹ç†ç”±ã¯ã€PSRemotingä»¥å¤–ã§ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ç‚ºã€
    è‡ªå‹•çš„ã«è¨­å®šã‚’æˆ»ã™äº‹ã¯ã§ãã¾ã›ã‚“ã€‚
    :::

    - ä½œæ¥­å‰ã®çŠ¶æ…‹
        ```
        PS C:\WINDOWS\system32> Get-PSSessionConfiguration | Format-Table -Property Name, Permission

        Name                          Permission
        ----                          ----------
        microsoft.powershell          NT AUTHORITY\INTERACTIVE AccessAllowed, BUILTIN\Administrators AccessAllowed, BUILTIN\...
        microsoft.powershell.workflow BUILTIN\Administrators AccessAllowed, BUILTIN\Remote Management Users AccessAllowed
        microsoft.powershell32        NT AUTHORITY\INTERACTIVE AccessAllowed, BUILTIN\Administrators AccessAllowed, BUILTIN\...


        PS C:\WINDOWS\system32>
        ```
    - PSRemotingã®ç„¡åŠ¹åŒ–ã‚’å®Ÿè¡Œ
        ```powershell
        PS C:\WINDOWS\system32> Disable-PSRemoting
        è­¦å‘Š: ã‚»ãƒƒã‚·ãƒ§ãƒ³æ§‹æˆã‚’ç„¡åŠ¹ã«ã—ã¦ã‚‚ã€Enable-PSRemoting ã¾ãŸã¯ Enable-PSSessionConfiguration
        ã‚³ãƒãƒ³ãƒ‰ãƒ¬ãƒƒãƒˆã«ã‚ˆã‚‹å¤‰æ›´ãŒã™ã¹ã¦å…ƒã«æˆ»ã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æ¬¡ã®æ‰‹é †ã«å¾“ã£ã¦ã€æ‰‹å‹•ã§å¤‰æ›´ã‚’å…ƒã«æˆ»ã™å¿…è¦ãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚
        ã‚Šã¾ã™ã€‚
            1. WinRM ã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢ã¾ãŸã¯ç„¡åŠ¹ã«ã—ã¾ã™ã€‚
            2. IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä½¿ç”¨ã—ã¦è¦æ±‚ã‚’å—ã‘ä»˜ã‘ã‚‹ãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã€‚
            3. WS-Management é€šä¿¡ç”¨ã®ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ä¾‹å¤–ã‚’ç„¡åŠ¹ã«ã—ã¾ã™ã€‚
            4. LocalAccountTokenFilterPolicy ã®å€¤ã‚’ 0 ã«æˆ»ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒªãƒ¢ãƒ¼ãƒˆ ã‚¢ã‚¯ã‚»ã‚¹ãŒã“ã®ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã®
        Administrators ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ¡ãƒ³ãƒãƒ¼ã«åˆ¶é™ã•ã‚Œã¾ã™ã€‚
        PS C:\WINDOWS\system32>
        ```

    - ä½œæ¥­å¾Œã®çŠ¶æ…‹    
        ```
        PS C:\WINDOWS\system32> Get-PSSessionConfiguration | Format-Table -Property Name, Permission

        Name                          Permission
        ----                          ----------
        microsoft.powershell          NT AUTHORITY\NETWORK AccessDenied, NT AUTHORITY\INTERACTIVE AccessAllowed, BUILTIN\Adm...
        microsoft.powershell.workflow NT AUTHORITY\NETWORK AccessDenied, BUILTIN\Administrators AccessAllowed, BUILTIN\Remot...
        microsoft.powershell32        NT AUTHORITY\NETWORK AccessDenied, NT AUTHORITY\INTERACTIVE AccessAllowed, BUILTIN\Adm...


        PS C:\WINDOWS\system32>
        ```
1. ç„¡åŠ¹åŒ–å¾Œã®äº‹å¾Œä½œæ¥­
    - IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä½¿ç”¨ã—ã¦è¦æ±‚ã‚’å—ã‘ä»˜ã‘ã‚‹ãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
        :::message
        **æ³¨æ„äº‹é …**

        `Disable-PSRemoting`ã®ã‚³ãƒãƒ³ãƒ‰çµæœã§è¡¨ç¤ºã•ã‚Œã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é †ç•ªã¨ç•°ãªã‚‹ãŒã€
        WinRMã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•ä¸­ã«ãƒªã‚¹ãƒŠãƒ¼åã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚‹ç‚ºã€é †ç•ªã‚’å…¥ã‚Œæ›¿ãˆã¦å®Ÿæ–½ã€‚
        :::
        1. å‰Šé™¤å¯¾è±¡ã®ãƒªã‚¹ãƒŠãƒ¼åã‚’å–å¾—
            ```powershell
            PS C:\WINDOWS\system32> dir wsman:\localhost\listener


            WSManConfig: Microsoft.WSMan.Management\WSMan::localhost\Listener

            Type            Keys                                Name
            ----            ----                                ----
            Container       {Transport=HTTP, Address=*}         Listener_1084132640


            PS C:\WINDOWS\system32>
            ```
            ä¸Šè¨˜ã®ã‚³ãƒãƒ³ãƒ‰çµæœã§ã¯ã€ãƒªã‚¹ãƒŠãƒ¼åã€Œ `Listener_1084132640` ã€ãŒå‰Šé™¤å¯¾è±¡ã€‚
        1. æŒ‡å®šã®ãƒªã‚¹ãƒŠãƒ¼åã‚’å‰Šé™¤
            ```powershell
            PS C:\WINDOWS\system32> Remove-Item -Path WSMan:\Localhost\listener\Listener_1084132640

            ç¢ºèª
            WSMan:\localhost\Listener\Listener_1084132640 ã®é …ç›®ã«ã¯å­ãŒã‚ã‚Šã€Recurse
            ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚ç¶šè¡Œã—ãŸå ´åˆã€é …ç›®ã¨å…±ã«ã™ã¹ã¦ã®å­ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹?
            [Y] ã¯ã„(Y)  [A] ã™ã¹ã¦ç¶šè¡Œ(A)  [N] ã„ã„ãˆ(N)  [L] ã™ã¹ã¦ç„¡è¦–(L)  [S] ä¸­æ–­(S)  [?] ãƒ˜ãƒ«ãƒ— (æ—¢å®šå€¤ã¯ "Y"): y
            PS C:\WINDOWS\system32>
            ```
        1. å¯¾è±¡ã®ãƒªã‚¹ãƒŠãƒ¼ãŒå‰Šé™¤ã•ã‚ŒãŸäº‹ã‚’ç¢ºèª            
            ä»Šå›ã®ç’°å¢ƒã§ã¯ãƒªã‚¹ãƒŠãƒ¼ãŒ1ã¤ã®ã¿ã§å‰Šé™¤ã•ã‚ŒãŸç‚ºã€ä½•ã‚‚è¡¨ç¤ºã•ã‚Œãªã„ã€‚
            ```powershell
            PS C:\WINDOWS\system32> dir wsman:\localhost\listener
            PS C:\WINDOWS\system32>
            ```
    - WinRMï¼ˆWindows Remote Managementï¼‰ã®ã‚µãƒ¼ãƒ“ã‚¹ã®åœæ­¢

ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼

        1. WinRMï¼ˆï¼‰ã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢ã¾ãŸã¯ç„¡åŠ¹
            ```powershell
            PS C:\WINDOWS\system32> Get-Service WinRM

            Status   Name               DisplayName
            ------   ----               -----------
            Running  WinRM              Windows Remote Management (WS-Manag...


            PS C:\WINDOWS\system32>
            PS C:\WINDOWS\system32> Stop-Service WinRM -PassThru

            Status   Name               DisplayName
            ------   ----               -----------
            Stopped  WinRM              Windows Remote Management (WS-Manag...


            PS C:\WINDOWS\system32>
            PS C:\WINDOWS\system32> Set-Service WinRM -StartupType Manual -PassThru

            Status   Name               DisplayName
            ------   ----               -----------
            Stopped  WinRM              Windows Remote Management (WS-Manag...


            PS C:\WINDOWS\system32>
            ```
            ![](https://storage.googleapis.com/zenn-user-upload/6813741c32df-20230831.png)
            *ç”»åƒï¼šã‚µãƒ¼ãƒ“ã‚¹ç”»é¢ - â€œWindows Remote Management (WS-Management)â€ãŒç„¡åŠ¹åŒ–ã¨ãªã£ã¦ã„ã‚‹äº‹*
            :::details ã‚³ãƒãƒ³ãƒ‰ã§ã‚µãƒ¼ãƒ“ã‚¹ã®è©³ç´°ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèªã™ã‚‹æ–¹æ³•
            ```powershell:è‡ªä½œã‚³ãƒãƒ³ãƒ‰éƒ¨åˆ†ã®ã¿
            $triggers = Get-ChildItem "HKLM:\SYSTEM\CurrentControlSet\Services" |
                Where-Object { $_.GetSubkeyNames().Contains("TriggerInfo") } |
                ForEach-Object { $_.Name.Split("\")[-1] }

            $startMode = @{ Manual = "æ‰‹å‹•"; Disabled = "ç„¡åŠ¹"; Auto = "è‡ªå‹•"; Unknown = "ä¸æ˜" }
            $startOption = @{ 01 = " (ãƒˆãƒªã‚¬ãƒ¼é–‹å§‹)"; 10 = " (é…å»¶é–‹å§‹)"; 11 = " (é…å»¶é–‹å§‹ã€ãƒˆãƒªã‚¬ãƒ¼é–‹å§‹)" }

            $serviceData = Get-CimInstance -ClassName Win32_Service | Select-Object @(
                @{ n = "è¡¨ç¤ºå";              e = { $_.DisplayName } }
                @{ n = "ã‚µãƒ¼ãƒ“ã‚¹å";          e = { $_.Name } }
                @{ n = "ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ã®ç¨®é¡"; e = { $startMode[$_.StartMode] + $startOption[10 * ($_.StartMode -eq "Auto" -and $_.DelayedAutoStart) + $triggers.Contains($_.Name)] } }
                @{ n = "çŠ¶æ…‹";                e = { if($_.State -eq "Running") { "å®Ÿè¡Œ" } else { "åœæ­¢" } } }
            )
            ```
            ```powershell:è‡ªä½œã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œæ–¹æ³•
            PS C:\WINDOWS\system32> $triggers = Get-ChildItem "HKLM:\SYSTEM\CurrentControlSet\Services" |
            >>     Where-Object { $_.GetSubkeyNames().Contains("TriggerInfo") } |
            >>     ForEach-Object { $_.Name.Split("\")[-1] }
            >>
            >> $startMode = @{ Manual = "æ‰‹å‹•"; Disabled = "ç„¡åŠ¹"; Auto = "è‡ªå‹•"; Unknown = "ä¸æ˜" }
            >> $startOption = @{ 01 = " (ãƒˆãƒªã‚¬ãƒ¼é–‹å§‹)"; 10 = " (é…å»¶é–‹å§‹)"; 11 = " (é…å»¶é–‹å§‹ã€ãƒˆãƒªã‚¬ãƒ¼é–‹å§‹)" }
            >>
            >> $serviceData = Get-CimInstance -ClassName Win32_Service | Select-Object @(
            >>     @{ n = "è¡¨ç¤ºå";              e = { $_.DisplayName } }
            >>     @{ n = "ã‚µãƒ¼ãƒ“ã‚¹å";          e = { $_.Name } }
            >>     @{ n = "ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ã®ç¨®é¡"; e = { $startMode[$_.StartMode] + $startOption[10 * ($_.StartMode -eq "Auto" -and $_.DelayedAutoStart) + $triggers.Contains($_.Name)] } }
            >>     @{ n = "çŠ¶æ…‹";                e = { if($_.State -eq "Running") { "å®Ÿè¡Œ" } else { "åœæ­¢" } } }
            >> )
            PS C:\WINDOWS\system32>
            PS C:\WINDOWS\system32> $serviceData | select ã‚µãƒ¼ãƒ“ã‚¹å,ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ã®ç¨®é¡,çŠ¶æ…‹ | Where-Object {$_.ã‚µãƒ¼ãƒ“ã‚¹å -eq 'WinRM'}

            ã‚µãƒ¼ãƒ“ã‚¹å ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ã®ç¨®é¡ çŠ¶æ…‹
            ---------- -------------------- ----
            WinRM      æ‰‹å‹•                 åœæ­¢


            PS C:\WINDOWS\system32>
            ```
            - å‚è€ƒæƒ…å ±
                https://qiita.com/Mr-K/items/0ab787135eb4ec3b3a1c
            :::
        1. WS-Management é€šä¿¡ç”¨ã®ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ä¾‹å¤–ã‚’ç„¡åŠ¹
            ```powershell
            PS C:\WINDOWS\system32> Get-NetFirewallRule -Name "WINRM-HTTP-In-TCP*" | Select -Property DisplayName, Profile, Enabled

            DisplayName                              Profile Enabled
            -----------                              ------- -------
            Windows ãƒªãƒ¢ãƒ¼ãƒˆç®¡ç† (HTTP å—ä¿¡) Domain, Private    True
            Windows ãƒªãƒ¢ãƒ¼ãƒˆç®¡ç† (HTTP å—ä¿¡)          Public    True


            PS C:\WINDOWS\system32>
            PS C:\WINDOWS\system32> Set-NetFirewallRule -Name "WINRM-HTTP-In-TCP*" -Enabled False -PassThru | Select -Property DisplayName, Profile, Enabled

            DisplayName                              Profile Enabled
            -----------                              ------- -------
            Windows ãƒªãƒ¢ãƒ¼ãƒˆç®¡ç† (HTTP å—ä¿¡) Domain, Private   False
            Windows ãƒªãƒ¢ãƒ¼ãƒˆç®¡ç† (HTTP å—ä¿¡)          Public   False


            PS C:\WINDOWS\system32>
            ```
        1. LocalAccountTokenFilterPolicy ã®å€¤ã‚’æˆ»ã™ï¼ˆã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ¼ãƒ³ç’°å¢ƒã®ã¿ï¼‰
            :::message
            **ã“ã®é …ç›®ã¯ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ¼ãƒ³ç’°å¢ƒã§å¿…è¦ãªä½œæ¥­**

            ä½œæ¥­å¯¾è±¡ã®ç«¯æœ«ãŒã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ¼ãƒ³ç’°å¢ƒã®å ´åˆã€`Enable-PSRemoting`ã®å®Ÿè¡Œæ™‚ã«ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚­ãƒ¼ãŒè¿½åŠ ã•ã‚Œã¾ã™ã€‚
            ä»®ã«ä½œæ¥­ç«¯æœ«ãŒ**Active Directoryãƒ‰ãƒ¡ã‚¤ãƒ³ã®é…ä¸‹ã«ã‚ã‚‹å ´åˆã¯ã€ã“ã®ä½œæ¥­ã¯ä¸è¦**ã§ã™ã€‚
            :::
            ```powershell
            PS C:\WINDOWS\system32> Get-ItemProperty -Path HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\policies\system -Name LocalAccountTokenFilterPolicy


            LocalAccountTokenFilterPolicy : 1
            PSPath                        : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\Curre
                                            ntVersion\policies\system
            PSParentPath                  : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\Curre
                                            ntVersion\policies
            PSChildName                   : system
            PSDrive                       : HKLM
            PSProvider                    : Microsoft.PowerShell.Core\Registry



            PS C:\WINDOWS\system32>
            PS C:\WINDOWS\system32> Set-ItemProperty -Path HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\policies\system -Name LocalAccountTokenFilterPolicy -Value 0
            PS C:\WINDOWS\system32>
            PS C:\WINDOWS\system32> Get-ItemProperty -Path HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\policies\system -Name LocalAccountTokenFilterPolicy


            LocalAccountTokenFilterPolicy : 0
            PSPath                        : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\Curre
                                            ntVersion\policies\system
            PSParentPath                  : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\Curre
                                            ntVersion\policies
            PSChildName                   : system
            PSDrive                       : HKLM
            PSProvider                    : Microsoft.PowerShell.Core\Registry



            PS C:\WINDOWS\system32>
            ```

ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼




:::details è¨­å®šã‚’åˆ‡ã‚Šæˆ»ã™æ‰‹é †ï¼ˆã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’é¸æŠã™ã‚‹ã¨æŠ˜ã‚ŠãŸãŸã¿ãŒé–‹ãï¼‰
- æ¥ç¶šå…ƒã®è¨­å®šæˆ»ã—
    1. ä½œæ¥­å‰ã®çŠ¶æ…‹
        ```powershell
        PS C:\WINDOWS\system32> Get-Item WSMan:\localhost\Client\Trustedhosts


        WSManConfig: Microsoft.WSMan.Management\WSMan::localhost\Client

        Type            Name                           SourceOfValue   Value
        ----            ----                           -------------   -----
        System.String   TrustedHosts                                   192.168.XXX.XXX, Windows10.intra.local


        PS C:\WINDOWS\system32>
        ```
    1. è¨­å®šã®ã‚¯ãƒªã‚¢ï¼ˆè¨­å®šæˆ»ã—ï¼‰
        ```powershell
        PS C:\WINDOWS\system32> Clear-Item WSMan:\localhost\Client\Trustedhosts

        WinRM ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®æ§‹æˆã€‚
        ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ WinRM ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã® TrustedHosts ã®ä¸€è¦§ã‚’å¤‰æ›´ã—ã¾ã™ã€‚TrustedHosts
        ã®ä¸€è¦§å†…ã«ã‚ã‚‹ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã¯èªè¨¼ã•ã‚Œãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ã“ã‚Œã‚‰ã®ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã«è³‡æ ¼æƒ…å ±ã‚’é€ä¿¡ã™ã‚‹å¯
        èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ä¸€è¦§ã‚’å¤‰æ›´ã—ã¾ã™ã‹?
        [Y] ã¯ã„(Y)  [N] ã„ã„ãˆ(N)  [S] ä¸­æ–­(S)  [?] ãƒ˜ãƒ«ãƒ— (æ—¢å®šå€¤ã¯ "Y"): y
        PS C:\WINDOWS\system32>
        ```
    1. ä½œæ¥­å¾Œã®çŠ¶æ…‹
        ```powershell
        PS C:\WINDOWS\system32> Get-Item WSMan:\localhost\Client\Trustedhosts


        WSManConfig: Microsoft.WSMan.Management\WSMan::localhost\Client

        Type            Name                           SourceOfValue   Value
        ----            ----                           -------------   -----
        System.String   TrustedHosts


        PS C:\WINDOWS\system32>
        ```
    1. PSRemotingã®ç„¡åŠ¹åŒ–
        ```powershell
        PS C:\WINDOWS\system32> Disable-PSRemoting
        è­¦å‘Š: ã‚»ãƒƒã‚·ãƒ§ãƒ³æ§‹æˆã‚’ç„¡åŠ¹ã«ã—ã¦ã‚‚ã€Enable-PSRemoting ã¾ãŸã¯ Enable-PSSessionConfiguration
        ã‚³ãƒãƒ³ãƒ‰ãƒ¬ãƒƒãƒˆã«ã‚ˆã‚‹å¤‰æ›´ãŒã™ã¹ã¦å…ƒã«æˆ»ã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æ¬¡ã®æ‰‹é †ã«å¾“ã£ã¦ã€æ‰‹å‹•ã§å¤‰æ›´ã‚’å…ƒã«æˆ»ã™å¿…è¦ãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚
        ã‚Šã¾ã™ã€‚
            1. WinRM ã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢ã¾ãŸã¯ç„¡åŠ¹ã«ã—ã¾ã™ã€‚
            2. IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä½¿ç”¨ã—ã¦è¦æ±‚ã‚’å—ã‘ä»˜ã‘ã‚‹ãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã€‚
            3. WS-Management é€šä¿¡ç”¨ã®ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ä¾‹å¤–ã‚’ç„¡åŠ¹ã«ã—ã¾ã™ã€‚
            4. LocalAccountTokenFilterPolicy ã®å€¤ã‚’ 0 ã«æˆ»ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒªãƒ¢ãƒ¼ãƒˆ ã‚¢ã‚¯ã‚»ã‚¹ãŒã“ã®ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã®
        Administrators ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ¡ãƒ³ãƒãƒ¼ã«åˆ¶é™ã•ã‚Œã¾ã™ã€‚
        PS C:\WINDOWS\system32>
        ```

    - æ‰‹å‹•ã®è¨­å®šæˆ»ã—ä½œæ¥­
        1. IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä½¿ç”¨ã—ã¦è¦æ±‚ã‚’å—ã‘ä»˜ã‘ã‚‹ãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
            :::message
            **æ³¨æ„äº‹é …**

            `Disable-PSRemoting`ã‚’å®Ÿè¡Œå¾Œã«è¡¨ç¤ºã•ã‚Œã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é †ç•ªã¨ç•°ãªã‚‹ãŒã€
            WinRMã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•ä¸­ã«ãƒªã‚¹ãƒŠãƒ¼åã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚‹ç‚ºã€ã“ã®æ‰‹é †ã§ã¯1ã¨2ã‚’é€†è»¢ã€‚
            :::
            ```powershell
            PS C:\WINDOWS\system32> dir wsman:\localhost\listener


            WSManConfig: Microsoft.WSMan.Management\WSMan::localhost\Listener

            Type            Keys                                Name
            ----            ----                                ----
            Container       {Transport=HTTP, Address=*}         Listener_1084132640


            PS C:\WINDOWS\system32>
            PS C:\WINDOWS\system32> Remove-Item -Path WSMan:\Localhost\listener\Listener_1084132640

            ç¢ºèª
            WSMan:\localhost\Listener\Listener_1084132640 ã®é …ç›®ã«ã¯å­ãŒã‚ã‚Šã€Recurse
            ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚ç¶šè¡Œã—ãŸå ´åˆã€é …ç›®ã¨å…±ã«ã™ã¹ã¦ã®å­ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹?
            [Y] ã¯ã„(Y)  [A] ã™ã¹ã¦ç¶šè¡Œ(A)  [N] ã„ã„ãˆ(N)  [L] ã™ã¹ã¦ç„¡è¦–(L)  [S] ä¸­æ–­(S)  [?] ãƒ˜ãƒ«ãƒ— (æ—¢å®šå€¤ã¯ "Y"): y
            PS C:\WINDOWS\system32>
            PS C:\WINDOWS\system32> dir wsman:\localhost\listener
            PS C:\WINDOWS\system32>
            ```
        1. WinRM ã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢ã¾ãŸã¯ç„¡åŠ¹
            ```powershell
            PS C:\WINDOWS\system32> Get-Service WinRM

            Status   Name               DisplayName
            ------   ----               -----------
            Running  WinRM              Windows Remote Management (WS-Manag...


            PS C:\WINDOWS\system32>
            PS C:\WINDOWS\system32> Stop-Service WinRM -PassThru

            Status   Name               DisplayName
            ------   ----               -----------
            Stopped  WinRM              Windows Remote Management (WS-Manag...


            PS C:\WINDOWS\system32>
            PS C:\WINDOWS\system32> Set-Service WinRM -StartupType Manual -PassThru

            Status   Name               DisplayName
            ------   ----               -----------
            Stopped  WinRM              Windows Remote Management (WS-Manag...


            PS C:\WINDOWS\system32>
            ```
            ![](https://storage.googleapis.com/zenn-user-upload/6813741c32df-20230831.png)
            *ç”»åƒï¼šã‚µãƒ¼ãƒ“ã‚¹ç”»é¢ - â€œWindows Remote Management (WS-Management)â€ãŒç„¡åŠ¹åŒ–ã¨ãªã£ã¦ã„ã‚‹äº‹*
            :::details ã‚³ãƒãƒ³ãƒ‰ã§ã‚µãƒ¼ãƒ“ã‚¹ã®è©³ç´°ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèªã™ã‚‹æ–¹æ³•
            ```powershell:è‡ªä½œã‚³ãƒãƒ³ãƒ‰éƒ¨åˆ†ã®ã¿
            $triggers = Get-ChildItem "HKLM:\SYSTEM\CurrentControlSet\Services" |
                Where-Object { $_.GetSubkeyNames().Contains("TriggerInfo") } |
                ForEach-Object { $_.Name.Split("\")[-1] }

            $startMode = @{ Manual = "æ‰‹å‹•"; Disabled = "ç„¡åŠ¹"; Auto = "è‡ªå‹•"; Unknown = "ä¸æ˜" }
            $startOption = @{ 01 = " (ãƒˆãƒªã‚¬ãƒ¼é–‹å§‹)"; 10 = " (é…å»¶é–‹å§‹)"; 11 = " (é…å»¶é–‹å§‹ã€ãƒˆãƒªã‚¬ãƒ¼é–‹å§‹)" }

            $serviceData = Get-CimInstance -ClassName Win32_Service | Select-Object @(
                @{ n = "è¡¨ç¤ºå";              e = { $_.DisplayName } }
                @{ n = "ã‚µãƒ¼ãƒ“ã‚¹å";          e = { $_.Name } }
                @{ n = "ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ã®ç¨®é¡"; e = { $startMode[$_.StartMode] + $startOption[10 * ($_.StartMode -eq "Auto" -and $_.DelayedAutoStart) + $triggers.Contains($_.Name)] } }
                @{ n = "çŠ¶æ…‹";                e = { if($_.State -eq "Running") { "å®Ÿè¡Œ" } else { "åœæ­¢" } } }
            )
            ```
            ```powershell:è‡ªä½œã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œæ–¹æ³•
            PS C:\WINDOWS\system32> $triggers = Get-ChildItem "HKLM:\SYSTEM\CurrentControlSet\Services" |
            >>     Where-Object { $_.GetSubkeyNames().Contains("TriggerInfo") } |
            >>     ForEach-Object { $_.Name.Split("\")[-1] }
            >>
            >> $startMode = @{ Manual = "æ‰‹å‹•"; Disabled = "ç„¡åŠ¹"; Auto = "è‡ªå‹•"; Unknown = "ä¸æ˜" }
            >> $startOption = @{ 01 = " (ãƒˆãƒªã‚¬ãƒ¼é–‹å§‹)"; 10 = " (é…å»¶é–‹å§‹)"; 11 = " (é…å»¶é–‹å§‹ã€ãƒˆãƒªã‚¬ãƒ¼é–‹å§‹)" }
            >>
            >> $serviceData = Get-CimInstance -ClassName Win32_Service | Select-Object @(
            >>     @{ n = "è¡¨ç¤ºå";              e = { $_.DisplayName } }
            >>     @{ n = "ã‚µãƒ¼ãƒ“ã‚¹å";          e = { $_.Name } }
            >>     @{ n = "ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ã®ç¨®é¡"; e = { $startMode[$_.StartMode] + $startOption[10 * ($_.StartMode -eq "Auto" -and $_.DelayedAutoStart) + $triggers.Contains($_.Name)] } }
            >>     @{ n = "çŠ¶æ…‹";                e = { if($_.State -eq "Running") { "å®Ÿè¡Œ" } else { "åœæ­¢" } } }
            >> )
            PS C:\WINDOWS\system32>
            PS C:\WINDOWS\system32> $serviceData | select ã‚µãƒ¼ãƒ“ã‚¹å,ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ã®ç¨®é¡,çŠ¶æ…‹ | Where-Object {$_.ã‚µãƒ¼ãƒ“ã‚¹å -eq 'WinRM'}

            ã‚µãƒ¼ãƒ“ã‚¹å ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ã®ç¨®é¡ çŠ¶æ…‹
            ---------- -------------------- ----
            WinRM      æ‰‹å‹•                 åœæ­¢


            PS C:\WINDOWS\system32>
            ```
            - å‚è€ƒæƒ…å ±
                https://qiita.com/Mr-K/items/0ab787135eb4ec3b3a1c
            :::
        1. WS-Management é€šä¿¡ç”¨ã®ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ä¾‹å¤–ã‚’ç„¡åŠ¹
            ```powershell
            PS C:\WINDOWS\system32> Get-NetFirewallRule -Name "WINRM-HTTP-In-TCP*" | Select -Property DisplayName, Profile, Enabled

            DisplayName                              Profile Enabled
            -----------                              ------- -------
            Windows ãƒªãƒ¢ãƒ¼ãƒˆç®¡ç† (HTTP å—ä¿¡) Domain, Private    True
            Windows ãƒªãƒ¢ãƒ¼ãƒˆç®¡ç† (HTTP å—ä¿¡)          Public    True


            PS C:\WINDOWS\system32>
            PS C:\WINDOWS\system32> Set-NetFirewallRule -Name "WINRM-HTTP-In-TCP*" -Enabled False -PassThru | Select -Property DisplayName, Profile, Enabled

            DisplayName                              Profile Enabled
            -----------                              ------- -------
            Windows ãƒªãƒ¢ãƒ¼ãƒˆç®¡ç† (HTTP å—ä¿¡) Domain, Private   False
            Windows ãƒªãƒ¢ãƒ¼ãƒˆç®¡ç† (HTTP å—ä¿¡)          Public   False


            PS C:\WINDOWS\system32>
            ```
        1. LocalAccountTokenFilterPolicy ã®å€¤ã‚’æˆ»ã™ï¼ˆã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ¼ãƒ³ç’°å¢ƒã®ã¿ï¼‰
            :::message
            **ã“ã®é …ç›®ã¯ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ¼ãƒ³ç’°å¢ƒã§å¿…è¦ãªä½œæ¥­**

            ä½œæ¥­å¯¾è±¡ã®ç«¯æœ«ãŒã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ¼ãƒ³ç’°å¢ƒã®å ´åˆã€`Enable-PSRemoting`ã®å®Ÿè¡Œæ™‚ã«ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚­ãƒ¼ãŒè¿½åŠ ã•ã‚Œã¾ã™ã€‚
            ä»®ã«ä½œæ¥­ç«¯æœ«ãŒ**Active Directoryãƒ‰ãƒ¡ã‚¤ãƒ³ã®é…ä¸‹ã«ã‚ã‚‹å ´åˆã¯ã€ã“ã®ä½œæ¥­ã¯ä¸è¦**ã§ã™ã€‚
            :::
            ```powershell
            PS C:\WINDOWS\system32> Get-ItemProperty -Path HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\policies\system -Name LocalAccountTokenFilterPolicy


            LocalAccountTokenFilterPolicy : 1
            PSPath                        : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\Curre
                                            ntVersion\policies\system
            PSParentPath                  : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\Curre
                                            ntVersion\policies
            PSChildName                   : system
            PSDrive                       : HKLM
            PSProvider                    : Microsoft.PowerShell.Core\Registry



            PS C:\WINDOWS\system32>
            PS C:\WINDOWS\system32> Set-ItemProperty -Path HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\policies\system -Name LocalAccountTokenFilterPolicy -Value 0
            PS C:\WINDOWS\system32>
            PS C:\WINDOWS\system32> Get-ItemProperty -Path HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\policies\system -Name LocalAccountTokenFilterPolicy


            LocalAccountTokenFilterPolicy : 0
            PSPath                        : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\Curre
                                            ntVersion\policies\system
            PSParentPath                  : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\Curre
                                            ntVersion\policies
            PSChildName                   : system
            PSDrive                       : HKLM
            PSProvider                    : Microsoft.PowerShell.Core\Registry



            PS C:\WINDOWS\system32>
            ```
            
- å‚è€ƒæƒ…å ±
    - ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚­ãƒ¼
        - ã‚µãƒ¼ãƒ“ã‚¹
            âŠWinã‚­ãƒ¼ + R â†’ ã€Œ `services.msc` ã€ â†’ Ctrl + Shift + Enter
        - ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã®ç®¡ç†
            âŠWinã‚­ãƒ¼ + R â†’ ã€Œ `compmgmt.msc` ã€ â†’ Ctrl + Shift + Enter
    - å‚è€ƒãƒªãƒ³ã‚¯
        https://4sysops.com/wiki/disable-powershell-remoting-disable-psremoting-winrm-listener-firewall-and-localaccounttokenfilterpolicy/
        https://www.ipentec.com/document/windows-windows-10-add-winrm-trasted-hosts
        https://unarist.hatenadiary.org/entry/20131020/1382287767
:::
## PSSessioné–¢é€£ã®ã‚³ãƒãƒ³ãƒ‰

| ã‚³ãƒãƒ³ãƒ‰å | ä½¿ç”¨ç”¨é€” |
| ---- | ---- |
| [Connect-PSSession](https://github.com/MicrosoftDocs/PowerShell-Docs/blob/main/reference/5.1/Microsoft.PowerShell.Core/Connect-PSSession.md) | åˆ‡æ–­ã•ã‚ŒãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ã«å†æ¥ç¶šã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ |
| [Disconnect-PSSession](https://github.com/MicrosoftDocs/PowerShell-Docs/blob/main/reference/5.1/Microsoft.PowerShell.Core/Disconnect-PSSession.md) | ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰åˆ‡æ–­ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ |
| [Enter-PSSession](https://github.com/MicrosoftDocs/PowerShell-Docs/blob/main/reference/5.1/Microsoft.PowerShell.Core/Enter-PSSession.md) | ãƒªãƒ¢ãƒ¼ãƒˆã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã¨å¯¾è©±å½¢å¼ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ |
| [Exit-PSSession](https://github.com/MicrosoftDocs/PowerShell-Docs/blob/main/reference/5.1/Microsoft.PowerShell.Core/Exit-PSSession.md) | ãƒªãƒ¢ãƒ¼ãƒˆã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã¨å¯¾è©±å½¢å¼ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ã™ã‚‹ |
| [Get-PSSession](https://github.com/MicrosoftDocs/PowerShell-Docs/blob/main/reference/5.1/Microsoft.PowerShell.Core/Get-PSSession.md) | ãƒ­ãƒ¼ã‚«ãƒ«ãŠã‚ˆã³ãƒªãƒ¢ãƒ¼ãƒˆã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ä¸Šã®PowerShellã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹ |
| [New-PSSession](https://github.com/MicrosoftDocs/PowerShell-Docs/blob/main/reference/5.1/Microsoft.PowerShell.Core/New-PSSession.md) | ãƒ­ãƒ¼ã‚«ãƒ«ã¾ãŸã¯ãƒªãƒ¢ãƒ¼ãƒˆã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã¸ã®æ°¸ç¶šçš„ãªã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ |
| [Receive-PSSession](https://github.com/MicrosoftDocs/PowerShell-Docs/blob/main/reference/5.1/Microsoft.PowerShell.Core/Receive-PSSession.md) | åˆ‡æ–­ã•ã‚ŒãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚³ãƒãƒ³ãƒ‰çµæœã‚’å–å¾—ã™ã‚‹ |
| [Remove-PSSession](https://github.com/MicrosoftDocs/PowerShell-Docs/blob/main/reference/5.1/Microsoft.PowerShell.Core/Remove-PSSession.md) | 1ã¤ã¾ãŸã¯è¤‡æ•°ã®PowerShellã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‰ã˜ã‚‹ |
| [Export-PSSession](https://github.com/MicrosoftDocs/PowerShell-Docs/blob/main/reference/5.1/Microsoft.PowerShell.Utility/Export-PSSession.md) | ä»–ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã€PowerShellãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ä¿å­˜ã™ã‚‹ã€‚ |
| [Import-PSSession](https://github.com/MicrosoftDocs/PowerShell-Docs/blob/main/reference/5.1/Microsoft.PowerShell.Utility/Import-PSSession.md) | ä»–ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã€‚ |

- Connect-PSSession
    åˆ‡æ–­ã•ã‚ŒãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ã«å†æ¥ç¶šã™ã‚‹ã‚³ãƒãƒ³ãƒ‰
- Disconnect-PSSession
    ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰åˆ‡æ–­ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰
- Enter-PSSession
    ãƒªãƒ¢ãƒ¼ãƒˆã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã¨å¯¾è©±å½¢å¼ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰
    1. æ¥ç¶šå…ˆã«ã¤ãªã’ã‚‹
        ```powershell:Enter-PSSessionã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œ
        PS C:\WINDOWS\system32> Enter-PSSession -ComputerName 192.168.XXX.XXX -Credential "ãƒ¦ãƒ¼ã‚¶ãƒ¼å"
        [192.168.XXX.XXX]: PS D:\ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ>
        ```
        ![](https://storage.googleapis.com/zenn-user-upload/a3e271b0b4ba-20230824.png =600x)
        *ç”»åƒï¼šEnter-PSSessionã‚³ãƒãƒ³ãƒ‰ã‚’æ‰“ã£ãŸç›´å¾Œã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼ï¼ˆè³‡æ ¼æƒ…å ±ã®è¦æ±‚ï¼‰ãŒè¡¨ç¤º*

    1. æ¥ç¶šå…ˆã§ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
        æ¥ç¶šå…ˆã®ä»»æ„ã®å ´æ‰€ã«ç§»å‹•ã—dirã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã€‚
        ```powershell:æ¥ç¶šå…ˆã®C:\Windows\Logsã«ç§»å‹•ï¼†dirã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
        [192.168.XXX.XXX]: PS D:\ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ> cd C:\Windows\Logs\
        [192.168.XXX.XXX]: PS C:\Windows\Logs>
        [192.168.XXX.XXX]: PS C:\Windows\Logs> dir


            ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: C:\Windows\Logs


        Mode                 LastWriteTime         Length Name
        ----                 -------------         ------ ----
        d-----        2023/08/25     11:12                CBS
        d-----        2022/11/17     10:09                DISM
        d-----        2023/08/28      8:23                DPX
        d---s-        2023/08/10     16:44                MeasuredBoot
        d-----        2023/08/10     16:10                MoSetup
        d-----        2023/08/24     16:21                NetSetup
        d-----        2021/11/25     11:28                Paragon Software
        d-----        2023/08/28      8:23                SIH
        d-----        2023/08/24     13:28                SystemRestore
        d-----        2023/08/28     13:14                waasmedic
        d-----        2023/08/28      8:25                waasmediccapsule
        d-----        2022/09/21     13:30                WindowsBackup
        d-----        2023/08/28     13:35                WindowsUpdate
        d-----        2021/10/13      5:44                WinREAgent
        -a----        2023/08/17      8:30          90031 StorGroupPolicy.log


        [192.168.XXX.XXX]: PS C:\Windows\Logs>
        [192.168.XXX.XXX]: PS C:\Windows\Logs>
        ```

    1. æ¥ç¶šå…ˆã‹ã‚‰æŠœã‘ã‚‹
        ```powershell:exitã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œ
        [192.168.XXX.XXX]: PS C:\Windows\Logs> exit
        PS C:\WINDOWS\system32>
        ```
- Exit-PSSession
    ãƒªãƒ¢ãƒ¼ãƒˆã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã¨å¯¾è©±å½¢å¼ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ã™ã‚‹
- Get-PSSession
    ãƒ­ãƒ¼ã‚«ãƒ«ãŠã‚ˆã³ãƒªãƒ¢ãƒ¼ãƒˆã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ä¸Šã®PowerShellã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹
- New-PSSession
    ãƒ­ãƒ¼ã‚«ãƒ«ã¾ãŸã¯ãƒªãƒ¢ãƒ¼ãƒˆã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã¸ã®æ°¸ç¶šçš„ãªã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹ã‚³ãƒãƒ³ãƒ‰
    New-PSSessionã¯ã€ãƒ­ãƒ¼ã‚«ãƒ«ã¾ãŸã¯ãƒªãƒ¢ãƒ¼ãƒˆã®ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã¸ã®æ°¸ç¶šçš„ãªã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã§ã™ã€‚
    ```powershell:New-PSSession â†’ Remove-PSSession
    PS C:\WINDOWS\system32> New-PSSession -ComputerName 192.168.XXX.XXX -Name TestTask

    Id Name            ComputerName    ComputerType    State         ConfigurationName     Availability
    -- ----            ------------    ------------    -----         -----------------     ------------
    6 TestTask        192.168.XXX.XXX RemoteMachine   Opened        Microsoft.PowerShell     Available


    PS C:\WINDOWS\system32>
    PS C:\WINDOWS\system32> Get-PSSession

    Id Name            ComputerName    ComputerType    State         ConfigurationName     Availability
    -- ----            ------------    ------------    -----         -----------------     ------------
    6 TestTask        192.168.XXX.XXX RemoteMachine   Opened        Microsoft.PowerShell     Available


    PS C:\WINDOWS\system32>
    PS C:\WINDOWS\system32> Remove-PSSession -Name TestTask
    PS C:\WINDOWS\system32>
    PS C:\WINDOWS\system32> Get-PSSession
    PS C:\WINDOWS\system32>
    ```
- Receive-PSSession
    åˆ‡æ–­ã•ã‚ŒãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚³ãƒãƒ³ãƒ‰çµæœã‚’å–å¾—ã™ã‚‹
- Remove-PSSession
    1ã¤ã¾ãŸã¯è¤‡æ•°ã®PowerShellã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‰ã˜ã‚‹ã€‚
- Export-PSSession
    ä»–ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã€PowerShellãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ä¿å­˜ã™ã‚‹ã€‚
- Import-PSSession
    ä»–ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã€‚

### å‚è€ƒæƒ…å ±
https://github.com/MicrosoftDocs/PowerShell-Docs/tree/main/reference/5.1/Microsoft.PowerShell.Core
https://github.com/MicrosoftDocs/PowerShell-Docs/blob/main/reference/5.1/Microsoft.PowerShell.Utility

## ãã®ä»–ã®å‚è€ƒæƒ…å ±
- Enter-PSSessionã‚’ä½¿ã†ã¾ã§ã®è§£èª¬
    https://www.kayura-se.com/entry/2020/03/30/004146
- Microsoftå…¬å¼ã€ŒPSSessionã«ã¤ã„ã¦ã€
    https://learn.microsoft.com/ja-jp/powershell/module/microsoft.powershell.core/about/about_pssessions?view=powershell-7.3
- Enter-PSSessionã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è‡ªå‹•çš„ã«å…¥åŠ›
    https://yanor.net/wiki/?PowerShell/ãƒªãƒ¢ãƒ¼ãƒˆæ¥ç¶š/Enter-PSSessionã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ã‚’è‡ªå‹•åŒ–ã™ã‚‹

â˜…è¨­å®šã®è§£é™¤æ–¹æ³•ã‚’ã¾ã¨ã‚ã‚‹ã€‚
