---
title: "PSSessionを使いリモート接続でPowerShell CLIを使用する方法"
emoji: "👏"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["powershell", "remote", "PSSession"]
published: false
---
## PowerShell - PSSession
```powershell
PS C:\WINDOWS\system32> New-PSSession -ComputerName XXXX
New-PSSession : [XXXX] リモート サーバー XXXX への接続に失敗し、次のエラー メッセージが返されました: クライアン
トは、要求で指定された接続先に接続できません。 接続先のサービスが実行されていて、要求を受け付けられる状態であることを確
認してください。 接続先で実行されている WS-Management サービス (通常は IIS または WinRM) に関するログとドキュメントを参
照してください。 接続先が WinRM サービスの場合は、リモート ホスト上で次のコマンドを実行して、WinRM サービスを分析および
構成してください: "winrm quickconfig"詳細については、about_Remote_Troubleshooting のヘルプ トピックを参照してください。
発生場所 行:1 文字:1
+ New-PSSession -ComputerName XXXX
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : OpenError: (System.Manageme....RemoteRunspace:RemoteRunspace) [New-PSSession], PSRemotin
   gTransportException
    + FullyQualifiedErrorId : CannotConnect,PSSessionOpenFailed
PS C:\WINDOWS\system32>
```

### 他のPSSession関連のコマンドレット
```powershell:helpコマンドで一覧を表示
PS C:\WINDOWS\system32> help *PSSession

Name                              Category  Module                    Synopsis
----                              --------  ------                    --------
Connect-PSSession                 Cmdlet    Microsoft.PowerShell.Core Reconnects to disconnected sessions.
Disconnect-PSSession              Cmdlet    Microsoft.PowerShell.Core Disconnects from a session.
Enter-PSSession                   Cmdlet    Microsoft.PowerShell.Core Starts an interactive session with a remote co...
Exit-PSSession                    Cmdlet    Microsoft.PowerShell.Core Ends an interactive session with a remote comp...
Get-PSSession                     Cmdlet    Microsoft.PowerShell.Core Gets the PowerShell sessions on local and remo...
New-PSSession                     Cmdlet    Microsoft.PowerShell.Core Creates a persistent connection to a local or ...
Receive-PSSession                 Cmdlet    Microsoft.PowerShell.Core Gets results of commands in disconnected sessions
Remove-PSSession                  Cmdlet    Microsoft.PowerShell.Core Closes one or more PowerShell sessions (PSSess...
Export-PSSession                  Cmdlet    Microsoft.PowerShell.U... Exports commands from another session and save...
Import-PSSession                  Cmdlet    Microsoft.PowerShell.U... Imports commands from another session into the...



PS C:\WINDOWS\system32>
```

## 設定
1. PowerShell CLIを管理者として実行
1. 接続先の設定 - PSRemothingの有効化
```powershell
PS C:\WINDOWS\system32> Enable-PSRemoting -SkipNetworkProfileCheck
WinRM は要求を受信するように更新されました。
WinRM サービスの種類を正しく変更できました。
WinRM サービスが開始されました。

WinRM はリモート管理用に更新されました。
WinRM ファイアウォールの例外を有効にしました。
ローカル ユーザーにリモートで管理権限を付与するよう LocalAccountTokenFilterPolicy を構成しました。

PS C:\WINDOWS\system32>
PS C:\WINDOWS\system32>
```
1. 接続元の設定 - PSRemothingの有効化
	上記と同様の手順
1. 接続元の設定 - 信頼できる接続先を設定
	- 設定前の状態
		```powershell
		PS C:\WINDOWS\system32> Get-Item WSMan:\localhost\Client\TrustedHosts


		   WSManConfig: Microsoft.WSMan.Management\WSMan::localhost\Client

		Type            Name                           SourceOfValue   Value
		----            ----                           -------------   -----
		System.String   TrustedHosts


		PS C:\WINDOWS\system32>
		```
	- 接続先を指定して許可
        この手順では、こちらで設定。
		1. 接続先を指定して許可
			```powershell:接続先を指定して許可
			PS C:\WINDOWS\system32> Set-Item WSMan:\localhost\Client\TrustedHosts -Value "192.168.XXX.XXX, Windows10.intra.local"

			WinRM セキュリティの構成。
			このコマンドは WinRM クライアントの TrustedHosts の一覧を変更します。TrustedHosts
			の一覧内にあるコンピューターは認証されない可能性があります。クライアントはこれらのコンピューターに資格情報を送信する可
			能性があります。この一覧を変更しますか?
			[Y] はい(Y)  [N] いいえ(N)  [S] 中断(S)  [?] ヘルプ (既定値は "Y"): y
			PS C:\WINDOWS\system32>
			PS C:\WINDOWS\system32>
			```
    - 接続先すべてを許可する場合
        特定の接続先ではなく全ての接続先を許可する場合のコマンド。
        ```powershell:接続先すべてを許可する場合
        PS C:\WINDOWS\system32> Set-Item WSMan:\localhost\Client\TrustedHosts -Value "*"
        ```

1. 設定後の状態（接続先を指定して許可の場合）
    ```powershell
    PS C:\WINDOWS\system32> Get-Item WSMan:\localhost\Client\TrustedHosts


        WSManConfig: Microsoft.WSMan.Management\WSMan::localhost\Client

    Type            Name                           SourceOfValue   Value
    ----            ----                           -------------   -----
    System.String   TrustedHosts                                   192.168.XXX.XXX, Windows10.intra.local


    PS C:\WINDOWS\system32>
    ```
1. 対話式の接続「Enter-PSSessionコマンド」の実行
	```powershell:Enter-PSSessionの実行
	PS C:\WINDOWS\system32> Enter-PSSession -ComputerName 192.168.XXX.XXX -Credential "ユーザー名"
    [192.168.XXX.XXX]: PS D:\ドキュメント>
	```
	![](https://storage.googleapis.com/zenn-user-upload/a3e271b0b4ba-20230824.png)
	*画像：Enter-PSSessionコマンドを打った直後、アカウント認証（資格情報の要求）が表示*

1. 接続先でコマンドを実行してみる
    ```
    [192.168.XXX.XXX]: PS C:\windows> cd C:\Windows\Logs\
    [192.168.XXX.XXX]: PS C:\Windows\Logs>
    [192.168.XXX.XXX]: PS C:\Windows\Logs> dir


        ディレクトリ: C:\Windows\Logs


    Mode                 LastWriteTime         Length Name
    ----                 -------------         ------ ----
    d-----        2023/08/25     11:12                CBS
    d-----        2022/11/17     10:09                DISM
    d-----        2023/08/28      8:23                DPX
    d---s-        2023/08/10     16:44                MeasuredBoot
    d-----        2023/08/10     16:10                MoSetup
    d-----        2023/08/24     16:21                NetSetup
    d-----        2021/11/25     11:28                Paragon Software
    d-----        2023/08/28      8:23                SIH
    d-----        2023/08/24     13:28                SystemRestore
    d-----        2023/08/28     13:14                waasmedic
    d-----        2023/08/28      8:25                waasmediccapsule
    d-----        2022/09/21     13:30                WindowsBackup
    d-----        2023/08/28     13:35                WindowsUpdate
    d-----        2021/10/13      5:44                WinREAgent
    -a----        2023/08/17      8:30          90031 StorGroupPolicy.log


    [192.168.XXX.XXX]: PS C:\Windows\Logs>
    [192.168.XXX.XXX]: PS C:\Windows\Logs>
    ```

1. 接続先から抜ける
```powershell
[192.168.XXX.XXX]: PS C:\Windows\Logs> exit
PS C:\WINDOWS\system32>
```

```powershell:New-PSSession → Remove-PSSession
PS C:\WINDOWS\system32> New-PSSession -ComputerName 192.168.XXX.XXX -Name TestTask

 Id Name            ComputerName    ComputerType    State         ConfigurationName     Availability
 -- ----            ------------    ------------    -----         -----------------     ------------
  6 TestTask        192.168.XXX.XXX RemoteMachine   Opened        Microsoft.PowerShell     Available


PS C:\WINDOWS\system32>
PS C:\WINDOWS\system32> Get-PSSession

 Id Name            ComputerName    ComputerType    State         ConfigurationName     Availability
 -- ----            ------------    ------------    -----         -----------------     ------------
  6 TestTask        192.168.XXX.XXX RemoteMachine   Opened        Microsoft.PowerShell     Available


PS C:\WINDOWS\system32>
PS C:\WINDOWS\system32> Remove-PSSession -Name TestTask
PS C:\WINDOWS\system32>
PS C:\WINDOWS\system32> Get-PSSession
PS C:\WINDOWS\system32>
```

- 参考情報
    - Enter-PSSessionを使うまでの解説
        https://www.kayura-se.com/entry/2020/03/30/004146
    - Microsoft公式「PSSessionについて」
        https://learn.microsoft.com/ja-jp/powershell/module/microsoft.powershell.core/about/about_pssessions?view=powershell-7.3
    - Enter-PSSessionのパスワードを自動的に入力
        https://yanor.net/wiki/?PowerShell/リモート接続/Enter-PSSessionのパスワード入力を自動化する

★設定の解除方法をまとめる。
