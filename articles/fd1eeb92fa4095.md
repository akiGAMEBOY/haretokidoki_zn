---
title: "PSSessionã‚’ä½¿ã„ãƒªãƒ¢ãƒ¼ãƒˆæ¥ç¶šã§PowerShell CLIã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•"
emoji: "ğŸ‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["powershell", "remote", "PSSession"]
published: false
---
## PowerShell - PSSession
```powershell
PS C:\WINDOWS\system32> New-PSSession -ComputerName XXXX
New-PSSession : [XXXX] ãƒªãƒ¢ãƒ¼ãƒˆ ã‚µãƒ¼ãƒãƒ¼ XXXX ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã€æ¬¡ã®ã‚¨ãƒ©ãƒ¼ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã¾ã—ãŸ: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³
ãƒˆã¯ã€è¦æ±‚ã§æŒ‡å®šã•ã‚ŒãŸæ¥ç¶šå…ˆã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚ æ¥ç¶šå…ˆã®ã‚µãƒ¼ãƒ“ã‚¹ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã¦ã€è¦æ±‚ã‚’å—ã‘ä»˜ã‘ã‚‰ã‚Œã‚‹çŠ¶æ…‹ã§ã‚ã‚‹ã“ã¨ã‚’ç¢º
èªã—ã¦ãã ã•ã„ã€‚ æ¥ç¶šå…ˆã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ WS-Management ã‚µãƒ¼ãƒ“ã‚¹ (é€šå¸¸ã¯ IIS ã¾ãŸã¯ WinRM) ã«é–¢ã™ã‚‹ãƒ­ã‚°ã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚
ç…§ã—ã¦ãã ã•ã„ã€‚ æ¥ç¶šå…ˆãŒ WinRM ã‚µãƒ¼ãƒ“ã‚¹ã®å ´åˆã¯ã€ãƒªãƒ¢ãƒ¼ãƒˆ ãƒ›ã‚¹ãƒˆä¸Šã§æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€WinRM ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ†æãŠã‚ˆã³
æ§‹æˆã—ã¦ãã ã•ã„: "winrm quickconfig"è©³ç´°ã«ã¤ã„ã¦ã¯ã€about_Remote_Troubleshooting ã®ãƒ˜ãƒ«ãƒ— ãƒˆãƒ”ãƒƒã‚¯ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
ç™ºç”Ÿå ´æ‰€ è¡Œ:1 æ–‡å­—:1
+ New-PSSession -ComputerName XXXX
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : OpenError: (System.Manageme....RemoteRunspace:RemoteRunspace) [New-PSSession], PSRemotin
   gTransportException
    + FullyQualifiedErrorId : CannotConnect,PSSessionOpenFailed
PS C:\WINDOWS\system32>
```

### ä»–ã®PSSessioné–¢é€£ã®ã‚³ãƒãƒ³ãƒ‰ãƒ¬ãƒƒãƒˆ
```powershell:helpã‚³ãƒãƒ³ãƒ‰ã§ä¸€è¦§ã‚’è¡¨ç¤º
PS C:\WINDOWS\system32> help *PSSession

Name                              Category  Module                    Synopsis
----                              --------  ------                    --------
Connect-PSSession                 Cmdlet    Microsoft.PowerShell.Core Reconnects to disconnected sessions.
Disconnect-PSSession              Cmdlet    Microsoft.PowerShell.Core Disconnects from a session.
Enter-PSSession                   Cmdlet    Microsoft.PowerShell.Core Starts an interactive session with a remote co...
Exit-PSSession                    Cmdlet    Microsoft.PowerShell.Core Ends an interactive session with a remote comp...
Get-PSSession                     Cmdlet    Microsoft.PowerShell.Core Gets the PowerShell sessions on local and remo...
New-PSSession                     Cmdlet    Microsoft.PowerShell.Core Creates a persistent connection to a local or ...
Receive-PSSession                 Cmdlet    Microsoft.PowerShell.Core Gets results of commands in disconnected sessions
Remove-PSSession                  Cmdlet    Microsoft.PowerShell.Core Closes one or more PowerShell sessions (PSSess...
Export-PSSession                  Cmdlet    Microsoft.PowerShell.U... Exports commands from another session and save...
Import-PSSession                  Cmdlet    Microsoft.PowerShell.U... Imports commands from another session into the...



PS C:\WINDOWS\system32>
```

## è¨­å®š
1. PowerShell CLIã‚’ç®¡ç†è€…ã¨ã—ã¦å®Ÿè¡Œ
1. æ¥ç¶šå…ˆã®è¨­å®š - PSRemothingã®æœ‰åŠ¹åŒ–
```powershell
PS C:\WINDOWS\system32> Enable-PSRemoting -SkipNetworkProfileCheck
WinRM ã¯è¦æ±‚ã‚’å—ä¿¡ã™ã‚‹ã‚ˆã†ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚
WinRM ã‚µãƒ¼ãƒ“ã‚¹ã®ç¨®é¡ã‚’æ­£ã—ãå¤‰æ›´ã§ãã¾ã—ãŸã€‚
WinRM ã‚µãƒ¼ãƒ“ã‚¹ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸã€‚

WinRM ã¯ãƒªãƒ¢ãƒ¼ãƒˆç®¡ç†ç”¨ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚
WinRM ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã®ä¾‹å¤–ã‚’æœ‰åŠ¹ã«ã—ã¾ã—ãŸã€‚
ãƒ­ãƒ¼ã‚«ãƒ« ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒªãƒ¢ãƒ¼ãƒˆã§ç®¡ç†æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ã‚ˆã† LocalAccountTokenFilterPolicy ã‚’æ§‹æˆã—ã¾ã—ãŸã€‚

PS C:\WINDOWS\system32>
PS C:\WINDOWS\system32>
```
1. æ¥ç¶šå…ƒã®è¨­å®š - PSRemothingã®æœ‰åŠ¹åŒ–
	ä¸Šè¨˜ã¨åŒæ§˜ã®æ‰‹é †
1. æ¥ç¶šå…ƒã®è¨­å®š - ä¿¡é ¼ã§ãã‚‹æ¥ç¶šå…ˆã‚’è¨­å®š
	- è¨­å®šå‰ã®çŠ¶æ…‹
		```powershell
		PS C:\WINDOWS\system32> Get-Item WSMan:\localhost\Client\TrustedHosts


		   WSManConfig: Microsoft.WSMan.Management\WSMan::localhost\Client

		Type            Name                           SourceOfValue   Value
		----            ----                           -------------   -----
		System.String   TrustedHosts


		PS C:\WINDOWS\system32>
		```
	- æ¥ç¶šå…ˆã‚’æŒ‡å®šã—ã¦è¨±å¯
        ã“ã®æ‰‹é †ã§ã¯ã€ã“ã¡ã‚‰ã§è¨­å®šã€‚
		1. æ¥ç¶šå…ˆã‚’æŒ‡å®šã—ã¦è¨±å¯
			```powershell:æ¥ç¶šå…ˆã‚’æŒ‡å®šã—ã¦è¨±å¯
			PS C:\WINDOWS\system32> Set-Item WSMan:\localhost\Client\TrustedHosts -Value "192.168.XXX.XXX, Windows10.intra.local"

			WinRM ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®æ§‹æˆã€‚
			ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ WinRM ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã® TrustedHosts ã®ä¸€è¦§ã‚’å¤‰æ›´ã—ã¾ã™ã€‚TrustedHosts
			ã®ä¸€è¦§å†…ã«ã‚ã‚‹ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã¯èªè¨¼ã•ã‚Œãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ã“ã‚Œã‚‰ã®ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã«è³‡æ ¼æƒ…å ±ã‚’é€ä¿¡ã™ã‚‹å¯
			èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ä¸€è¦§ã‚’å¤‰æ›´ã—ã¾ã™ã‹?
			[Y] ã¯ã„(Y)  [N] ã„ã„ãˆ(N)  [S] ä¸­æ–­(S)  [?] ãƒ˜ãƒ«ãƒ— (æ—¢å®šå€¤ã¯ "Y"): y
			PS C:\WINDOWS\system32>
			PS C:\WINDOWS\system32>
			```
    - æ¥ç¶šå…ˆã™ã¹ã¦ã‚’è¨±å¯ã™ã‚‹å ´åˆ
        ç‰¹å®šã®æ¥ç¶šå…ˆã§ã¯ãªãå…¨ã¦ã®æ¥ç¶šå…ˆã‚’è¨±å¯ã™ã‚‹å ´åˆã®ã‚³ãƒãƒ³ãƒ‰ã€‚
        ```powershell:æ¥ç¶šå…ˆã™ã¹ã¦ã‚’è¨±å¯ã™ã‚‹å ´åˆ
        PS C:\WINDOWS\system32> Set-Item WSMan:\localhost\Client\TrustedHosts -Value "*"
        ```

1. è¨­å®šå¾Œã®çŠ¶æ…‹ï¼ˆæ¥ç¶šå…ˆã‚’æŒ‡å®šã—ã¦è¨±å¯ã®å ´åˆï¼‰
    ```powershell
    PS C:\WINDOWS\system32> Get-Item WSMan:\localhost\Client\TrustedHosts


        WSManConfig: Microsoft.WSMan.Management\WSMan::localhost\Client

    Type            Name                           SourceOfValue   Value
    ----            ----                           -------------   -----
    System.String   TrustedHosts                                   192.168.XXX.XXX, Windows10.intra.local


    PS C:\WINDOWS\system32>
    ```
1. å¯¾è©±å¼ã®æ¥ç¶šã€ŒEnter-PSSessionã‚³ãƒãƒ³ãƒ‰ã€ã®å®Ÿè¡Œ
	```powershell:Enter-PSSessionã®å®Ÿè¡Œ
	PS C:\WINDOWS\system32> Enter-PSSession -ComputerName 192.168.XXX.XXX -Credential "ãƒ¦ãƒ¼ã‚¶ãƒ¼å"
    [192.168.XXX.XXX]: PS D:\ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ>
	```
	![](https://storage.googleapis.com/zenn-user-upload/a3e271b0b4ba-20230824.png)
	*ç”»åƒï¼šEnter-PSSessionã‚³ãƒãƒ³ãƒ‰ã‚’æ‰“ã£ãŸç›´å¾Œã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼ï¼ˆè³‡æ ¼æƒ…å ±ã®è¦æ±‚ï¼‰ãŒè¡¨ç¤º*

1. æ¥ç¶šå…ˆã§ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã¿ã‚‹
    ```
    [192.168.XXX.XXX]: PS C:\windows> cd C:\Windows\Logs\
    [192.168.XXX.XXX]: PS C:\Windows\Logs>
    [192.168.XXX.XXX]: PS C:\Windows\Logs> dir


        ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: C:\Windows\Logs


    Mode                 LastWriteTime         Length Name
    ----                 -------------         ------ ----
    d-----        2023/08/25     11:12                CBS
    d-----        2022/11/17     10:09                DISM
    d-----        2023/08/28      8:23                DPX
    d---s-        2023/08/10     16:44                MeasuredBoot
    d-----        2023/08/10     16:10                MoSetup
    d-----        2023/08/24     16:21                NetSetup
    d-----        2021/11/25     11:28                Paragon Software
    d-----        2023/08/28      8:23                SIH
    d-----        2023/08/24     13:28                SystemRestore
    d-----        2023/08/28     13:14                waasmedic
    d-----        2023/08/28      8:25                waasmediccapsule
    d-----        2022/09/21     13:30                WindowsBackup
    d-----        2023/08/28     13:35                WindowsUpdate
    d-----        2021/10/13      5:44                WinREAgent
    -a----        2023/08/17      8:30          90031 StorGroupPolicy.log


    [192.168.XXX.XXX]: PS C:\Windows\Logs>
    [192.168.XXX.XXX]: PS C:\Windows\Logs>
    ```

1. æ¥ç¶šå…ˆã‹ã‚‰æŠœã‘ã‚‹
```powershell
[192.168.XXX.XXX]: PS C:\Windows\Logs> exit
PS C:\WINDOWS\system32>
```

```powershell:New-PSSession â†’ Remove-PSSession
PS C:\WINDOWS\system32> New-PSSession -ComputerName 192.168.XXX.XXX -Name TestTask

 Id Name            ComputerName    ComputerType    State         ConfigurationName     Availability
 -- ----            ------------    ------------    -----         -----------------     ------------
  6 TestTask        192.168.XXX.XXX RemoteMachine   Opened        Microsoft.PowerShell     Available


PS C:\WINDOWS\system32>
PS C:\WINDOWS\system32> Get-PSSession

 Id Name            ComputerName    ComputerType    State         ConfigurationName     Availability
 -- ----            ------------    ------------    -----         -----------------     ------------
  6 TestTask        192.168.XXX.XXX RemoteMachine   Opened        Microsoft.PowerShell     Available


PS C:\WINDOWS\system32>
PS C:\WINDOWS\system32> Remove-PSSession -Name TestTask
PS C:\WINDOWS\system32>
PS C:\WINDOWS\system32> Get-PSSession
PS C:\WINDOWS\system32>
```

- å‚è€ƒæƒ…å ±
    - Enter-PSSessionã‚’ä½¿ã†ã¾ã§ã®è§£èª¬
        https://www.kayura-se.com/entry/2020/03/30/004146
    - Microsoftå…¬å¼ã€ŒPSSessionã«ã¤ã„ã¦ã€
        https://learn.microsoft.com/ja-jp/powershell/module/microsoft.powershell.core/about/about_pssessions?view=powershell-7.3
    - Enter-PSSessionã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è‡ªå‹•çš„ã«å…¥åŠ›
        https://yanor.net/wiki/?PowerShell/ãƒªãƒ¢ãƒ¼ãƒˆæ¥ç¶š/Enter-PSSessionã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ã‚’è‡ªå‹•åŒ–ã™ã‚‹

â˜…è¨­å®šã®è§£é™¤æ–¹æ³•ã‚’ã¾ã¨ã‚ã‚‹ã€‚
