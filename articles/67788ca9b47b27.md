---
title: "[PowerShell]文字コードと管理者権限を判定しタイトルを変更"
emoji: "✨"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["powershell"]
published: false
---
## 概要

日本語のOSでPowerShellを使用する場合、PowerShellコンソール（PowerShellウィンドウ）の文字コードは規定値が複雑です。
現状の設定が把握しにくいので、今回は取得した設定値を使ってコンソールのタイトルを変更するFunctionを作成しました。

## この記事のターゲット

- PowerShell ユーザーの方
- PowerShell の文字コードをウィンドウのタイトルで把握したい方

## 対応方法

### 作成したPowerShellのFunction

作成したPowerShellのコードは以下の通りです。
簡易な説明は後述します。

```powershell:PowerShellコンソールのタイトル変更するFunction
# 管理者として実行しているか確認（Trueの場合、“管理者として実行”と判断）
Function isAdminConsole {
    $win_id = [System.Security.Principal.WindowsIdentity]::GetCurrent()
    $win_principal = new-object System.Security.Principal.WindowsPrincipal($win_id)
    $admin_permission = [System.Security.Principal.WindowsBuiltInRole]::Administrator
    return $win_principal.IsInRole($admin_permission)
}
# 現在、設定している文字コードを取得
Function GetPsCharcode {
    [System.String[]]$ps_charcode = @()
    $ps_charcode = @(
        # 文字エンコードを指定できるコマンドレットの既定値
        ($PSDefaultParameterValues['*:Encoding']),
        # PowerShellから外部プログラムに渡す文字エンコードの設定
        ($global:OutputEncoding).WebName,
        # PowerShellのコンソールに出力する文字エンコードの設定
        ([console]::OutputEncoding).WebName
    )

    return $ps_charcode
}
# PowerShellウィンドウのタイトル変更
Function ChangeConsoleTitle {
    # 区切り文字の設定
    [System.String]$pos1 = '|'
    [System.String]$pos2 = ';'

    # 現在のタイトルを取得
    [System.String]$title = $Host.UI.RawUI.WindowTitle
    [System.String]$base_title = $title

    # 既にこのFunctionでタイトル変更している場合、一番左にある文字列を抽出
    [System.String[]]$title_array = $title.Split($pos1)
    if ($title_array.Length -ne 0) {
        $base_title = ($title_array[0]).TrimEnd()
    }

    # 現在の文字コードを取得しタイトルに追加
    [System.String[]]$ps_charcode = GetPsCharcode

    [System.String]$change_title = $base_title
    if (isAdminConsole) {
        # 管理者権限ありの場合
        $change_title = $base_title + " $pos1 " +
                        "DefaultParameter='$($ps_charcode[0])'" + " $pos2 " +
                        "GlobalEncoding='$($ps_charcode[1])'" + " $pos2 " +
                        "ConsoleEncoding='$($ps_charcode[2])'" + " $pos2 " +
                        "#Administrator"
    }
    else {
        # 管理者権限なしの場合
        $change_title = $base_title + " $pos1 " +
                        "DefaultParameter='$($ps_charcode[0])'" + " $pos2 " +
                        "GlobalEncoding='$($ps_charcode[1])'" + " $pos2 " +
                        "ConsoleEncoding='$($ps_charcode[2])'" + " $pos2 " +
                        "#Not_Administrator"
    }
    $Host.UI.RawUI.WindowTitle = $change_title

    # 完了メッセージ
    Write-Host 'タイトルに“文字コード”と“管理者権限の有無”の情報を追加しました。' -ForegroundColor Cyan
}
```

### 作成したFunctionの流れ

1. 現在のタイトルを取得
1. （すでにこのFunctiondでタイトル変更済みの場合）元のタイトル名を抽出
1. 文字コードを取得
    - `$PSDefaultParameterValues['*:Encoding']`
        文字エンコードを指定できるコマンドレットの既定値。
        仮にこの設定値を`utf8`にした場合、`Out-File`コマンドレットのパラメーター`Encoding`の規定値が`utf8`となる。
    - `$global:OutputEncoding`
        PowerShellから外部プログラムに渡す文字エンコードの設定。
        PowerShellのコマンドからPythonなどの外部プログラムで文字列を表示する際に使用される。
    - `[console]::OutputEncoding`
        PowerShellのコンソールに出力する文字エンコードの設定。
        PowerShellのCLIウィンドウやWindows ターミナルなどで文字列を表示する際に使用される。

1. 管理者権限の有無を取得
1. 取得した情報を使用しタイトルを変更する
    - 管理者権限がありの場合
        元のタイトル + 区切り文字1（`｜`） + 文字コード1（`DefaultParameter='xxx'`） + 区切り文字2（` ; `） + 文字コード2（`GlobalEncoding='xxx'`） + 区切り文字2（` ; `） + 文字コード3（`ConsoleEncoding='xxx'`） + 区切り文字2（` ; `） + `#Administrator`
    - 管理者権限がなしの場合
        元のタイトル + 区切り文字1（`｜`） + 文字コード1（`DefaultParameter='xxx'`） + 区切り文字2（` ; `） + 文字コード2（`GlobalEncoding='xxx'`） + 区切り文字2（` ; `） + 文字コード3（`ConsoleEncoding='xxx'`） + 区切り文字2（` ; `） + `#Not_Administrator`

## 実際に実行してみる

### PowerShell 5.x

```powershell:PowerShellのバージョン
PS C:\Users\"ユーザー名"> $PSVersionTable

Name                           Value
----                           -----
PSVersion                      5.1.19041.3930
PSEdition                      Desktop
PSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}
BuildVersion                   10.0.19041.3930
CLRVersion                     4.0.30319.42000
WSManStackVersion              3.0
PSRemotingProtocolVersion      2.3
SerializationVersion           1.1.0.1


PS C:\Users\"ユーザー名">
```

- 管理者権限あり

    - 実行前
        ![PowerShell 5.x - 管理者権限あり - タイトル変更前](https://storage.googleapis.com/zenn-user-upload/d9d5144e2a02-20240116.png)
    - 実行後
        ![PowerShell 5.x - 管理者権限あり - タイトル変更後](https://storage.googleapis.com/zenn-user-upload/c339b859a4a3-20240116.png)

- 管理者権限なし

    - 実行前
        ![PowerShell 5.x - 管理者権限なし - タイトル変更前](https://storage.googleapis.com/zenn-user-upload/268f3c7661eb-20240116.png)
    - 実行後
        ![PowerShell 5.x - 管理者権限なし - タイトル変更後](https://storage.googleapis.com/zenn-user-upload/3ba121664956-20240116.png)

### PowerShell Core（7.x）

```powershell:PowerShellのバージョン
PS C:\Users\"ユーザー名"> $PSVersionTable

Name                           Value
----                           -----
PSVersion                      7.3.10
PSEdition                      Core
GitCommitId                    7.3.10
OS                             Microsoft Windows 10.0.19045
Platform                       Win32NT
PSCompatibleVersions           {1.0, 2.0, 3.0, 4.0…}
PSRemotingProtocolVersion      2.3
SerializationVersion           1.1.0.1
WSManStackVersion              3.0

PS C:\Users\"ユーザー名">
```

- 管理者権限あり

    - 実行前
        ![PowerShell 7.x - 管理者権限あり - タイトル変更前](https://storage.googleapis.com/zenn-user-upload/c09cf5e84797-20240116.png)

    - 実行後
        ![PowerShell 7.x - 管理者権限なし - タイトル変更後](https://storage.googleapis.com/zenn-user-upload/700c5c200035-20240116.png)

        ```powershell:見切れてしまったのでウィンドウのタイトルを取得
        PS C:\Users\"ユーザー名"> Get-Process | Where-Object {$_.MainWindowTitle} | Select-Object Name, MainWindowTitle | Format-Table -AutoSize -Wrap

        Name                 MainWindowTitle
        ----                 ---------------
        pwsh                 Administrator: C:\Program Files\PowerShell\7\pwsh.exe | DefaultParameter='' ; GlobalEncodi
                            ng='utf-8' ; ConsoleEncoding='shift_jis' ; #Administrator

        PS C:\Users\"ユーザー名">
        ```

- 管理者権限なし

    - 実行前
        ![PowerShell 7.x - 管理者権限なし - タイトル変更前](https://storage.googleapis.com/zenn-user-upload/e1a671c7e1ac-20240116.png)

    - 実行後
        ![PowerShell 7.x - 管理者権限なし - タイトル変更後](https://storage.googleapis.com/zenn-user-upload/aa2e4a8bd47c-20240116.png)

### Windows ターミナル

```powershell:PowerShellのバージョン
PS C:\Users\"ユーザー名"> $PSVersionTable

Name                           Value
----                           -----
PSVersion                      7.3.10
PSEdition                      Core
GitCommitId                    7.3.10
OS                             Microsoft Windows 10.0.19045
Platform                       Win32NT
PSCompatibleVersions           {1.0, 2.0, 3.0, 4.0…}
PSRemotingProtocolVersion      2.3
SerializationVersion           1.1.0.1
WSManStackVersion              3.0

PS C:\Users\"ユーザー名">
```

- 管理者権限あり

    - 実行前
        ![Windowsターミナル（PowerShell 7.x） - 管理者権限あり - タイトル変更前](https://storage.googleapis.com/zenn-user-upload/2ef6b7e82894-20240116.png)
    - 実行後
        ![Windowsターミナル（PowerShell 7.x） - 管理者権限あり - タイトル変更後](https://storage.googleapis.com/zenn-user-upload/cb8c3297dd63-20240116.png)

- 管理者権限なし

    - 実行前
        ![Windowsターミナル（PowerShell 7.x） - 管理者権限なし - タイトル変更前](https://storage.googleapis.com/zenn-user-upload/4aa62a34d1ae-20240116.png)

    - 実行後
        ![Windowsターミナル（PowerShell 7.x） - 管理者権限なし - タイトル変更後](https://storage.googleapis.com/zenn-user-upload/d51afb7a178e-20240116.png)

#### Windows ターミナルを使用する場合、 

1. Windows ターミナルの設定を開く
    ![Windows ターミナル - 設定](https://storage.googleapis.com/zenn-user-upload/15ed4186b2e0-20240116.png)
1. 設定の項目「外観」を選択する
1. “タイトル バーを非表示にする”をオンからオフに変更
    - オン状態
        ![Windows ターミナル - 設定 - 外観 - タイトル バーを非表示にする が オンの状態](https://storage.googleapis.com/zenn-user-upload/a083f704afea-20240116.png)
    - オフ状態
        ![Windows ターミナル - 設定 - 外観 - タイトル バーを非表示にする が オフの状態](https://storage.googleapis.com/zenn-user-upload/7fc0b97ed297-20240116.png)
1. 保存ボタンを押す
1. Windows ターミナルを再起動

## 参考情報

### 現在のセッションが管理者権限で実行しているか確認する方法

https://tex2e.github.io/blog/powershell/check-is-admin

## まとめ
