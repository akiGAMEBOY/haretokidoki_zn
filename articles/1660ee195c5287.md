---
title: "WebPファイルが静止画かGIFアニメーションか判断する方法"
emoji: "💭"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["powershell", "webp", "hex"]
published: false
---

どうやら、しっかりと判定する方法はなさそう。（高い圧縮率を実現するため情報が切り捨てられている？）

WebPファイルがGIFアニメ（GIFアニメーション）形式のファイルであるか判定する方法はなさそうだが、
拡張データがないWebPファイルに関しては、静止画か判定する方法が見つかった。

ただ、拡張データが含まれるWebPファイルだと、静止画 か GIFアニメか 判定できないという微妙な方法。

## 判定

WebPファイルをバイナリモードで読み取りヘッダー情報で“確実に静止画のファイル”を判定できるというもの。

ヘッダー情報で拡張データ（XMP）の有無を確認すると下記の2パターンが判定できる。

- WebPファイルかつ、拡張データなし：拡張データがない静止画のWebPファイルと判定
- WebPファイルかつ、拡張データあり：拡張データがあるWebPファイルと判定（拡張データありの静止画 or GIFアニメ）

### 具体的な判定方法

01桁目 ～ 04桁目    ：`RIFF`            WebPファイルの判定条件 その1
05桁目 ～ 08桁目    ：(その他のデータ)
09桁目 ～ 12桁目    ：`WEBP`            WebPファイルの判定条件 その2
13桁目 ～ 16桁目    ：`VP8␣`           静止画・GIFアニメの判定条件 - 拡張データなし（静止画）
                    　`VP8L`            静止画・GIFアニメの判定条件 - ロスレス      （静止画）
                    　`VP8X`            静止画・GIFアニメの判定条件 - 拡張データあり（静止画 or GIFアニメ）
17桁目 ～           ：(その他のデータ)

※ 上記にある「 `␣` 」は、半角スペースを表す。

つまり、13桁目 ～ 16桁目 にあるバイナリデータで 'VP8X'**以外** が 「確実に静止画のWebPファイル」、
'VP8X' が 「静止画 か GIFアニメ かわからないWebPファイル」となる。

## 確認方法

バイナリモードでファイルを確認しヘッダー情報を読み取って文字列を判断する必要がある。

PowerShellでは「`Format-Hex`」コマンドレットを使用する事でバイナリ情報を確認する事が可能。

### 実際にバイナリモードで確認してみる

```powershell:「Format-Hex」コマンドレットを使ってヘッダー情報を確認
# バイナリモードでGIFアニメのWebPファイルを読み取る
PS D:\Downloads> [System.Object[]]$webp_hex_ascii = (Format-Hex -Path .\screentogif_multi-frame_lossress.webp | Select-Object Ascii)
PS D:\Downloads>
# ヘッダー情報を表示
PS D:\Downloads>
PS D:\Downloads> $webp_hex_ascii[0].Ascii
RIFF$1� WEBPVP8X
PS D:\Downloads>
# 01桁目 ～ 04桁目：WebPファイルの判定条件 その1
PS D:\Downloads> $webp_hex_ascii[0].Ascii.ToString().Substring(0, 4)
RIFF
PS D:\Downloads>
# 05桁目 ～ 08桁目：（その他のデータ）
PS D:\Downloads> $webp_hex_ascii[0].Ascii.ToString().Substring(4, 4)
$1�
PS D:\Downloads>
# 09桁目 ～ 12桁目：WebPファイルの判定条件 その2
PS D:\Downloads> $webp_hex_ascii[0].Ascii.ToString().Substring(8, 4)
WEBP
PS D:\Downloads>
# 13桁目 ～ 16桁目：静止画・GIFアニメの判定条件
PS D:\Downloads> $webp_hex_ascii[0].Ascii.ToString().Substring(12, 4)
VP8X
PS D:\Downloads>
```

### IF文を使ってヘッダー情報を判定してみる

#### WebPファイルか判定

```powershell:WebPファイルの判定「1桁目 ～ 4桁目 ＝ 'RIFF' & 9桁目 ～ 12桁目 ＝ 'WEBP'」
[System.Object[]]$webp_hex_ascii = (Format-Hex -Path .\screentogif_multi-frame_lossress.webp | Select-Object Ascii)
if (($webp_hex_ascii[0].Ascii.ToString().Substring(0, 4) -eq 'RIFF') -and
    ($webp_hex_ascii[0].Ascii.ToString().Substring(8, 4) -eq 'WEBP')) {
        # WebPファイル形式の場合
        Write-Host 'Is Webp file.'
}
```

#### 拡張データがない静止画か判定

```powershell:静止画 の判定「13桁目 ～ 16桁目 ≠ 'VP8X'」
[System.Object[]]$webp_hex_ascii = (Format-Hex -Path .\screentogif_multi-frame_lossress.webp | Select-Object Ascii)
if (($webp_hex_ascii[0].Ascii.ToString().Substring(12, 4) -ne 'VP8X')) {
        # 拡張データがない静止画の場合
        #   'VP8 ' or 'VP8L'
        Write-Host 'Is Still image.'
}
else {
        # 拡張データがある静止画 or GIFアニメ の場合
        #   'VP8X'  XMP 拡張データあり
        Write-Host 'Is "Still image" or "GIF animetion".'
}
```

## 参考情報

- GIMPを使ってWebPファイルをエクスポートする際のオプション
    <https://docs.gimp.org/2.10/ja/gimp-images-out.html>

- WebPファイルを詳しく解説している記事
    <https://note.com/mith_mmk/n/n31d1c81e142b>

- Bing AI
    :::details Bing AIの回答内容 < クリックで折りたたみが開く >
    > ❓ Bing AIへの依頼内容（"より創造的に"）
    > 
    > プログラムでWebPファイルが静止画かGIFアニメか判定する方法
    -----
    > ✅ Bing AIからの回答
    > 
    > こんにちは、これはBingです。😊
    > WebPファイルは、静止画とGIFアニメの両方に対応している画像フォーマットです。¹²
    > プログラムでWebPファイルが静止画かGIFアニメか判定する方法をお探しですね。
    > 私はWeb検索をしてみましたが、そのような方法は多くありませんでした。³
    > 一つの方法としては、WebPファイルのヘッダーを読み取って、アニメーションの情報があるかどうかを確認することです。⁴⁵
    > 例えば、以下のようなプログラムを使ってWebPファイルのヘッダーを表示することができます。⁶
    > 
    > ```python
    > # WebPファイルのヘッダーを表示するプログラム
    > import struct
    > 
    > def read_webp_header(filename):
    >     # WebPファイルをバイナリモードで開く
    >     with open(filename, "rb") as f:
    >         # 最初の4バイトを読み取る
    >         riff = f.read(4)
    >         # RIFFという文字列であることを確認する
    >         if riff != b"RIFF":
    >             print("Invalid WebP file")
    >             return
    >         # 次の4バイトを読み取ってファイルサイズを得る
    >         size = struct.unpack("<I", f.read(4))[0]
    >         # 次の4バイトを読み取ってWEBPという文字列であることを確認する
    >         webp = f.read(4)
    >         if webp != b"WEBP":
    >             print("Invalid WebP file")
    >             return
    >         # ヘッダーの情報を表示する
    >         print(f"RIFF header: {riff}")
    >         print(f"File size: {size}")
    >         print(f"WEBP header: {webp}")
    >         # 次の4バイトを読み取ってチャンクの種類を得る
    >         chunk_type = f.read(4)
    >         # チャンクの種類によって処理を分岐する
    >         if chunk_type == b"VP8 ":
    >             # VP8チャンクの場合は静止画である
    >             print(f"Chunk type: {chunk_type}")
    >             print("This is a still image")
    >         elif chunk_type == b"VP8L":
    >             # VP8Lチャンクの場合は静止画である
    >             print(f"Chunk type: {chunk_type}")
    >             print("This is a still image")
    >         elif chunk_type == b"VP8X":
    >             # VP8Xチャンクの場合は拡張ヘッダーがある
    >             print(f"Chunk type: {chunk_type}")
    >             # 次の4バイトを読み取ってチャンクのサイズを得る
    >             chunk_size = struct.unpack("<I", f.read(4))[0]
    >             # 次の4バイトを読み取ってフラグを得る
    >             flags = struct.unpack("<I", f.read(4))[0]
    >             # フラグの最下位ビットが1の場合はアニメーションである
    >             if flags & 1:
    >                 print("This is an animation")
    >             else:
    >                 print("This is not an animation")
    >         else:
    >             # その他のチャンクの場合は無効である
    >             print(f"Chunk type: {chunk_type}")
    >             print("Invalid WebP file")
    >             return
    > 
    > # テスト用のWebPファイルのパス
    > webp_file = "test.webp"
    > # WebPファイルのヘッダーを表示する
    > read_webp_header(webp_file)
    > ```
    > 
    > このプログラムを実行すると、以下のような結果が得られます。
    > 
    > ```
    > RIFF header: b'RIFF'
    > File size: 106
    > WEBP header: b'WEBP'
    > Chunk type: b'VP8X'
    > This is an animation
    > ```
    > 
    > このようにして、WebPファイルが静止画かGIFアニメか判定することができます。
    > ご参考になれば幸いです。
    > 
    > ¹: [WebP形式のアニメーション画像ファイルの作成と動作確認 ...](^1^)
    > ²: [WebPをアニメーションGIFに変換することは可能ですか？ これが ...](^2^)
    > ³: [プログラムでWebPファイルが静止画かGIFアニメか判定する方法](^3^)
    > ⁴: [アニメーションGIFのファイルを判定する方法 - 雑多なブログ](^4^)
    > ⁵: [WebP を GIF に完全に変換する究極の方法 - FVC](^5^)
    > ⁶: [WebPファイルのヘッダーを表示するプログラム](^6^)
    > : [アニメーションWebPの作り方 #Blender - Qiita]
    > 
    > ソース: Bing との会話 2024/1/4
    > (1) アニメーションWebP(Animated WebP)の作り方 #dlang - Qiita. https://qiita.com/devmynote/items/e4a015cbbbbb5a9a1ea4.
    > (2) アニメーションGIFのファイルを判定する方法 - 雑多なブログ. https://cufl.hateblo.jp/entry/2021/11/17/225758.
    > (3) WebP を GIF に完全に変換する究極の方法 - FVC. https://www.free-videoconverter.net/ja/image-converting/convert-webp-to-gif/.
    > (4) アニメーションGIFを表示するには | 自己啓発。人生について考える. http://mslabo.sakura.ne.jp/WordPress/make/processing%e3%80%80%e9%80%86%e5%bc%95%e3%81%8d%e3%83%aa%e3%83%95%e3%82%a1%e3%83%ac%e3%83%b3%e3%82%b9/%e3%82%a2%e3%83%8b%e3%83%a1%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3gif%e3%82%92%e8%a1%a8%e7%a4%ba%e3%81%99%e3%82%8b%e3%81%ab%e3%81%af/.
    > (5) アニメーションWebPの作り方 #Blender - Qiita. https://qiita.com/Yatoichi/items/4335269223c0e3dc9921.
    > (6) undefined. https://github.com/devmynote/libwebp-d.git.
    > (7) アニメーションWebP(Animated WebP)の作り方 #dlang - Qiita. https://qiita.com/devmynote/items/e4a015cbbbbb5a9a1ea4.
    > (8) アニメーションGIFのファイルを判定する方法 - 雑多なブログ. https://cufl.hateblo.jp/entry/2021/11/17/225758.
    > (9) WebP を GIF に完全に変換する究極の方法 - FVC. https://www.free-videoconverter.net/ja/image-converting/convert-webp-to-gif/.
    > (10) アニメーションGIFを表示するには | 自己啓発。人生について考える. http://mslabo.sakura.ne.jp/WordPress/make/processing%e3%80%80%e9%80%86%e5%bc%95%e3%81%8d%e3%83%aa%e3%83%95%e3%82%a1%e3%83%ac%e3%83%b3%e3%82%b9/%e3%82%a2%e3%83%8b%e3%83%a1%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3gif%e3%82%92%e8%a1%a8%e7%a4%ba%e3%81%99%e3%82%8b%e3%81%ab%e3%81%af/.
    > (11) アニメーションWebPの作り方 #Blender - Qiita. https://qiita.com/Yatoichi/items/4335269223c0e3dc9921.
    > (12) undefined. https://github.com/devmynote/libwebp-d.git.
    :::

## まとめ

- （おそらく）プログラムでWebPファイルがGIFアニメか判定する方法はない
    WebPファイルをブラウザ・WebP対応の動画プレイヤーで実際に再生してみるのみ？
- プログラムでWebPファイルが静止画か判定する方法
    WebPファイルをバイナリモードで読み取りヘッダー情報で判断
    1. WebPファイル形式か判断
        1桁目 ～ 4桁目 and 9桁目 ～ 12桁目 が 'RIFF' and 'WEBP' の場合、WebPファイル形式と判断する。
    1. 静止画か判断
        13桁目 ～ 16桁目 が 'VP8X'以外の場合、WebPファイルが静止画と判断する。
