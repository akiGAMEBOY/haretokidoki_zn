---
title: "[PowerShell]Excelãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…ƒã«PDFãƒ•ã‚¡ã‚¤ãƒ«ã®å¸³ç¥¨ã‚’å‡ºåŠ›"
emoji: "ğŸ¯"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["powershell", "excel", "pdf"]
published: false
---
PowerShellã‚’ä½¿ç”¨ã—ã¦Excelãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªæ–‡å­—åˆ—ã‚’å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã®æƒ…å ±ã§ç½®ãæ›ãˆã€PDFã¨ã—ã¦å‡ºåŠ›ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã™ã‚‹è¦ä»¶ã«ã¤ã„ã¦ç†è§£ã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã¯ãã®è¦ä»¶ã‚’æº€ãŸã™åŸºæœ¬çš„ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä¾‹ã§ã™ï¼š

```csv:inputdata.csv
"TargetPath","TargetRange","Date","User","ComputerName","ColumnName","Value"
"TargetPath01","TargetRange01","Date01","User01","ComputerName01","ColumnName01","Value01"
"TargetPath02","TargetRange02","Date02","User02","ComputerName02","ColumnName02","Value02"
"TargetPath03","TargetRange03","Date03","User03","ComputerName03","ColumnName03","Value03"
"TargetPath04","TargetRange04","Date04","User04","ComputerName04","ColumnName04","Value04"
"TargetPath05","TargetRange05","Date05","User05","ComputerName05","ColumnName05","Value05"
"TargetPath06","TargetRange06","Date06","User06","ComputerName06","ColumnName06","Value06"
"TargetPath07","TargetRange07","Date07","User07","ComputerName07","ColumnName07","Value07"
"TargetPath08","TargetRange08","Date08","User08","ComputerName08","ColumnName08","Value08"
"TargetPath09","TargetRange09","Date09","User09","ComputerName09","ColumnName09","Value09"
"TargetPath10","TargetRange10","Date10","User10","ComputerName10","ColumnName10","Value10"
"TargetPath11","TargetRange11","Date11","User11","ComputerName11","ColumnName11","Value11"
"TargetPath12","TargetRange12","Date12","User12","ComputerName12","ColumnName12","Value12"
```

![excelãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«](https://storage.googleapis.com/zenn-user-upload/8bf7eabd1083-20240610.png)
*ç”»åƒï¼šExcelãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«*

```powershell:ã‚·ãƒ³ãƒ—ãƒ«ãªCOMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ç”¨ã—ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# COMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ç”¨ã—ã¦PDFå‡ºåŠ›å‡¦ç†
function OutputPdfForComObject {
    param(
        [parameter(Mandatory=$true)][string]$excelFilePath,
        [parameter(Mandatory=$true)][string]$pdfOutputPath
    )

    # Excelã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
    $excel = New-Object -ComObject Excel.Application
    $excel.Visible = $false
    $excel.DisplayAlerts = $false

    # ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ã‚’é–‹ã
    $workbook = $excel.Workbooks.Open($excelFilePath)

    # PDFã¨ã—ã¦ä¿å­˜
    $workbook.ExportAsFixedFormat([Microsoft.Office.Interop.Excel.XlFixedFormatType]::xlTypePDF, $pdfOutputPath)

    # ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ã‚’é–‰ã˜ã‚‹
    $workbook.Close($false)
    $excel.Quit()

    # COMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è§£æ”¾
    [System.Runtime.InteropServices.Marshal]::ReleaseComObject($workbook)
    [System.Runtime.InteropServices.Marshal]::ReleaseComObject($excel)
    [System.GC]::Collect()
    [System.GC]::WaitForPendingFinalizers()

    # â˜…Try-Catchã—ã¦fainallyã§çµ‚äº†å‡¦ç†ã‚’å…¥ã‚ŒãŸã„ã€‚
    finally {
        # COMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®è§£æ”¾å‡¦ç†
        if ($null -ne $workbook) {
            $workbook.Close($false)
            [System.Runtime.Interopservices.Marshal]::ReleaseComObject($workbook) | Out-Null
            $workbook = $null
        }
        $excel.Quit()
        [System.Runtime.Interopservices.Marshal]::ReleaseComObject($excel) | Out-Null
        $excel = $null
        [System.GC]::Collect()
        [System.GC]::WaitForPendingFinalizers()
    }
}
```

https://www.nuget.org/packages/Microsoft.Office.Interop.Excel

https://www.nuget.org/api/v2/package/Microsoft.Office.Interop.Excel/15.0.4795.1001

â€» nupkgãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¯¾è±¡ã®DLLã‚’æŠ½å‡ºã™ã‚‹æ–¹æ³•ã‚’è¨˜è¼‰ã™ã‚‹ã€‚

```powershell:ã€Œmicrosoft.office.interop.excel.15.0.4795.1001.nupkgã€ã®ä¸­èº«
\MICROSOFT.OFFICE.INTEROP.EXCEL.15.0.4795.1001
â”‚  .signature.p7s
â”‚  Microsoft.Office.Interop.Excel.nuspec
â”‚  [Content_Types].xml
â”‚
â”œâ”€lib
â”‚  â”œâ”€net20
â”‚  â”‚      Microsoft.Office.Interop.Excel.dll
â”‚  â”‚
â”‚  â””â”€netstandard2.0
â”‚          Microsoft.Office.Interop.Excel.dll
â”‚
â”œâ”€package
â”‚  â””â”€services
â”‚      â””â”€metadata
â”‚          â””â”€core-properties
â”‚                  4d82b7cfe74f42ef8f07a225a0ab61b6.psmdcp
â”‚
â””â”€_rels
        .rels
```

â†’ `D:\Downloads\microsoft.office.interop.excel.15.0.4795.1001\lib\netstandard2.0\Microsoft.Office.Interop.Excel.dll`

```powershell:ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‹ã‚‰DLLã®é…ç½®ã¾ã§è‡ªå‹•åŒ–ã—ã¦ã‚‚é¢ç™½ã„ã‹ã‚‚
1. nupkgãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªãƒ³ã‚¯ã‚’æŒ‡å®šã™ã‚‹ã¨ã€æŒ‡å®šå ´æ‰€ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
1. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸnupkgãƒ•ã‚¡ã‚¤ãƒ«ã‚’ZIPå½¢å¼ã«å¤‰æ›´
1. æŒ‡å®šå ´æ‰€ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å±•é–‹ï¼ˆZIPè§£å‡ï¼‰
1. è§£å‡ã—ãŸãƒ•ã‚©ãƒ«ãƒ€ãƒ¼å†…ã‹ã‚‰DDLãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
1. æŒ‡å®šã—ãŸæ ¼ç´å…ˆã«DLLãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ ¼ç´
1. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸnupkgãƒ•ã‚¡ã‚¤ãƒ«ã‚„å±•é–‹ã—ãŸãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’å‰Šé™¤
1. DLLã®ã¿å–å¾—å®Œäº†
```

```powershell:åŸ‹ã‚è¾¼ã‚“ã C#ã®ã‚³ãƒ¼ãƒ‰ã§å®Ÿè¡Œ
$assemblyPath = "D:\Downloads\sampledata\lib\netstandard2.0\Microsoft.Office.Interop.Excel.dll"
# C#ã®ã‚³ãƒ¼ãƒ‰ã‚’æ–‡å­—åˆ—ã¨ã—ã¦å®šç¾©
$sourceCode = @"
using System;
using System.Runtime.InteropServices;
using Microsoft.Office.Interop.Excel;

public class OutputPdfForCSharp
{
    public static void Convert(string excelFilePath, string pdfOutputPath)
    {
        Application excelApplication = null;
        Workbook workbook = null;

        try
        {
            excelApplication = new Application();
            workbook = excelApplication.Workbooks.Open(excelFilePath);
            
            // å…¨ã‚·ãƒ¼ãƒˆã‚’PDFã«å¤‰æ›
            workbook.ExportAsFixedFormat(XlFixedFormatType.xlTypePDF, pdfOutputPath);
        }
        catch (Exception ex)
        {
            // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
            Console.WriteLine(ex.Message);
        }
        finally
        {
            // ãƒªã‚½ãƒ¼ã‚¹ã®è§£æ”¾
            if (workbook != null)
            {
                workbook.Close(false);
                Marshal.ReleaseComObject(workbook);
            }

            if (excelApplication != null)
            {
                excelApplication.Quit();
                Marshal.ReleaseComObject(excelApplication);
            }
        }
    }
}
"@

# C#ã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦ã‚¢ã‚»ãƒ³ãƒ–ãƒªã‚’è¿½åŠ 
Add-Type -TypeDefinition $sourceCode -ReferencedAssemblies $assemblyPath -Language CSharp

# Excelãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
$excelFilePath = "D:\Downloads\sampledata\excel_form.xlsx"

# PDFå‡ºåŠ›ã®ãƒ‘ã‚¹
$pdfFilePath = "D:\Downloads\sampledata\excel_form.pdf"

# C#ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã¦Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’PDFã«å¤‰æ›
[OutputPdfForCSharp]::Convert($excelFilePath, $pdfFilePath)
```

```powershell:
# å¿…è¦ãªPowerShellãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
Install-Module -Name ImportExcel -Scope CurrentUser -Force

# å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’å®šç¾©ã—ã¾ã™
$inputFilePath = "D:\Downloads\sampledata\inputdata.csv"
$templateFilePath = "D:\Downloads\sampledata\template_form.xlsx"
$excelFilePath = "D:\Downloads\sampledata\excel_form.xlsx"
$pdfFilePath = "D:\Downloads\sampledata\excel_form.pdf"

# CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™
$inputData = Import-Csv -Path $inputFilePath

# Excelãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãã¾ã™
Copy-Item -Path $templateFilePath -Destination $excelFilePath
$excel = Open-ExcelPackage -Path $excelFilePath

# ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªæ–‡å­—åˆ—ã‚’å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã§ç½®ãæ›ãˆã¾ã™
$targetSheet = $excel.Workbook.Worksheets["ãƒ˜ãƒƒãƒ€ãƒ¼ï¼‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„"]
# Date
$targetSheet.Cells[6, 8].Value = '2024/06/10'
# User
$targetSheet.Cells[5, 18].Value = 'Aã•ã‚“'
# TargetRange
$targetSheet.Cells[7, 8].Value = 'XXXX'
# ComputerName
$targetSheet.Cells[8, 8].Value = 'XXX'
# TargetPath
$targetSheet.Cells[9, 8].Value = 'D:\Downloads\RootFolder'

# ColumnNameãƒ»Value
$rowStart = 12
$rowMax = $rowStart + $inputData.Length
$colIndex = 4
$colValue = 16
$rowCsv = 0
for ($i=$rowStart; $i -lt $rowMax; $i++) {
    $targetSheet.Cells[$i, $colIndex].Value = $inputData[$rowCsv]."ColumnName"
    $targetSheet.Cells[$i, $colValue].Value = $inputData[$rowCsv]."Value"
    $rowCsv++
}

# å¤‰æ›´ã‚’ä¿å­˜ã—ã€Excelãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’é–‰ã˜ã¾ã™
Close-ExcelPackage -ExcelPackage $excel

# ç›´æ¥COMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‘¼ã³å‡ºã—ã¦å‡ºåŠ›ã™ã‚‹æ–¹æ³•
OutputPdfForComObject $excelFilePath $pdfFilePath
[OutputPdfForCSharp]::Convert($excelFilePath, $pdfFilePath)
```

## é–¢é€£è¨˜äº‹

https://haretokidoki-blog.com/pasocon_powershell-startup/
https://zenn.dev/haretokidoki/articles/7e6924ff0cc960
https://zenn.dev/haretokidoki/articles/fb6830f9155de5
