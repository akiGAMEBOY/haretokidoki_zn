---
title: "PowerShellã‹ã‚‰Pythonã®chardetã‚’ä½¿ã„æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’åˆ¤å®š"
emoji: "ğŸ™†"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["powershell", "python"]
published: false
---
## æ¦‚è¦

å‰å›ã¯[ã“ã¡ã‚‰ã®è¨˜äº‹](https://zenn.dev/haretokidoki/articles/962a7fc6c51b47)ã§PowerShellã ã‘ã§æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’åˆ¤å®šã™ã‚‹Functionã‚’ä½œæˆã—ã¾ã—ãŸãŒã€
åˆ¤å®šã§ãã‚‹æ–‡å­—ã‚³ãƒ¼ãƒ‰ã«é™ã‚ŠãŒã‚ã‚Šã¾ã™ã€‚

ãã‚“ãªèª²é¡Œã‚’æ”¹å–„ã—ã‚ˆã†ã¨ä»Šå›ã¯ã€PowerShellã‹ã‚‰Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‘¼ã³å‡ºã—ã€
Pythonã®chardetã‚’ä½¿ã„ã€ã‚ˆã‚Šåºƒç¯„å›²ã«æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’åˆ¤å®šã§ãã‚‹æ–¹æ³•ã‚’èª¿ã¹ã¾ã—ãŸã€‚

## ã“ã®è¨˜äº‹ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ

- Windows ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ–¹
- PowerShell ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ–¹
- PowerShell ã‹ã‚‰ Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ãŸã„æ–¹
- Windowsã§ã‚ˆã‚Šè©³ç´°ãªæ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’åˆ¤å®šã—ãŸã„æ–¹

## äº‹å‰ä½œæ¥­

Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ã¯Windows OS ã« Python ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ç›´æ¥ã€Microsoft Store ã‚’èµ·å‹•ã—ã¦GUIæ“ä½œã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹æ–¹æ³•ã§ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ãŒã€
ã›ã£ã‹ããªã®ã§ã‚³ãƒãƒ³ãƒ‰ã§Pythonã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚

### Microsoft Store ã‚¢ãƒ—ãƒª ã‹ã‚‰ã€Œã‚¢ãƒ—ãƒª ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ã€ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ã‚³ãƒãƒ³ãƒ‰ã§Pythonã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ç‚ºã€[ã‚¢ãƒ—ãƒª ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼](https://www.microsoft.com/store/productId/9NBLGGH4NNS1?ocid=pdpshare) ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’è¡Œã„ã¾ã™ã€‚
ï¼ˆã“ã®MS Store ã‚¢ãƒ—ãƒªã¯GUIæ“ä½œã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ã‚ã‚Šã€‚ï¼‰

ã“ã®ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã¨PowerShellã€ã¾ãŸã¯ã‚³ãƒãƒ³ãƒ‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¸Šã‹ã‚‰wingetã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã§ãã¾ã™ã€‚
ã“ã®wingetã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦[Python 3.12](https://www.microsoft.com/store/productId/9NCVDN91XZQP?ocid=pdpshare)ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€‚

### wingetã‚³ãƒãƒ³ãƒ‰ã§Microsoft Store ã‚¢ãƒ—ãƒªã€ŒPython 3.12ã€ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

PowerShellã®ã‚³ãƒãƒ³ãƒ‰ã§ä¸‹è¨˜ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
ï¼ˆã‚³ãƒãƒ³ãƒ‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ã‚‚å®Ÿè¡Œå¯èƒ½ã€‚ï¼‰

1. winget search ã‚³ãƒãƒ³ãƒ‰ã§ã‚¢ãƒ—ãƒªã‚’æ¤œç´¢

    ```powershell:wingetã‚³ãƒãƒ³ãƒ‰ã§åå‰ã«"python 3"ã‚’å«ã‚€ã‚¢ãƒ—ãƒªã‚’æ¢ã™
    PS D:\Downloads> winget search "python 3" --source msstore
    åå‰        ID           ãƒãƒ¼ã‚¸ãƒ§ãƒ³
    -----------------------------------
    Python 3.12 9NCVDN91XZQP Unknown
    Python 3.11 9NRWMJP3717K Unknown
    Python 3.10 9PJPW5LDXLZ5 Unknown
    Python 3.7  9NJ46SX7X90P Unknown
    Python 3.9  9P7QFQMJRFP7 Unknown
    Python 3.8  9MSSZTT1N39L Unknown
    PS D:\Downloads>
    ```

    â¡ ã€Œ`Python 3.12 9NCVDN91XZQP Unknown`ã€ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

1. winget install ã‚³ãƒãƒ³ãƒ‰ ã§ Python 3.12 ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

    ```powershell:winget install ã§ Python 3.12 ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    PS D:\Downloads> winget install --id=9NCVDN91XZQP -e --source msstore
    è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ Python 3.12 [9NCVDN91XZQP] ãƒãƒ¼ã‚¸ãƒ§ãƒ³ Unknown
    ã“ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ Microsoft Store ã‹ã‚‰æä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚winget ã¯ã€ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä»£ã‚ã£ã¦ Microsoft Store ã‹ã‚‰ãƒ‘ãƒƒã‚±ãƒ¼ ã‚¸ã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
    å¥‘ç´„ã®å¯¾è±¡ Python 3.12 [9NCVDN91XZQP] ãƒãƒ¼ã‚¸ãƒ§ãƒ³ Unknown
    ãƒãƒ¼ã‚¸ãƒ§ãƒ³: Unknown
    å…¬é–‹å…ƒ: Python Software Foundation
    ç™ºè¡Œå…ƒ URL: https://www.python.org/
    ç™ºè¡Œå…ƒã®ã‚µãƒãƒ¼ãƒˆ URL: https://www.python.org/doc/
    èª¬æ˜:
    Python is an easy to learn, powerful programming language. It has efficient high-level data structures and a simple but effective approach to object-oriented programming. Pythonâ€™s elegant syntax and dynamic typing, together with its interpreted nature, make it an ideal language for scripting and rapid application development in many areas on most platforms.

    The Python interpreter and the extensive standard library are freely available in source or binary form for all major platforms from the Python web site, https://www.python.org/, and may be freely distributed. The same site also contains distributions of and pointers to many free third party Python modules, programs and tools, and additional documentation.

    The Python interpreter is easily extended with new functions and data types implemented in C or C++ (or other languages callable from C). Python is also suitable as an extension language for customizable applications.
    ãƒ©ã‚¤ã‚»ãƒ³ã‚¹: https://docs.python.org/3.12/license.html
    ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ URL: https://www.python.org/privacy
    è‘—ä½œæ¨©: (c) Python Software Foundation
    å¥‘ç´„:
    Category: Developer tools
    Pricing: Free
    Free Trial: No
    Terms of Transaction: https://aka.ms/microsoft-store-terms-of-transaction
    Seizure Warning: https://aka.ms/microsoft-store-seizure-warning
    Store License Terms: https://aka.ms/microsoft-store-license


    ç™ºè¡Œå…ƒã¯ã€ãŠå®¢æ§˜ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å‰ã«ä¸Šè¨˜ã®æƒ…å ±ã‚’è¡¨ç¤ºã—ã€å¥‘ç´„ã«åŒæ„ã™ã‚‹ã“ã¨ã‚’å¿…è¦ã¨ã—ã¦ã„ã¾ã™ã€‚
    ä½¿ç”¨æ¡ä»¶ã«åŒæ„ã—ã¾ã™ã‹?
    [Y] ã¯ã„  [N] ã„ã„ãˆ: y
    ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...
    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100%
    ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸ
    PS D:\Downloads>
    ```

    ã“ã‚Œã§ãŠæ‰‹ç‰©ã®Windows OSã«Pythonç’°å¢ƒãŒã§ãã¾ã—ãŸã€‚

## è‡ªä½œã—ãŸPowerShell Function

ä¸‹è¨˜ã®Functionã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§Pythonã®chardatã‚’ä½¿ã„æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’åˆ¤å®šã§ãã¾ã™ã€‚

ãªãŠã€Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯PowerShellãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ$PROFILEï¼‰ã¨åŒã˜éšå±¤ã«å°‚ç”¨ã®ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’ä½œæˆã—ã€
ãã®ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼å†…ã«ä¿å­˜ã™ã‚‹ä»•çµ„ã¿ã¨ãªã£ã¦ã„ã¾ã™ã€‚

ç§ã®PowerShell 5.1 ç’°å¢ƒ ã§ã¯ã€Œ`D:\Documents\WindowsPowerShell\user-defined-py\chardet_runner.py`ã€ã«ä¿å­˜ã€‚

Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯PowerShell Functionå†…ã«å®šæ•°ã¨ã—ã¦å®šç¾©ã—ã¦ã„ã¾ã™ã€‚
Pythonã®ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ãŸã„å ´åˆã€Functionå†…ã®ã‚³ãƒ¼ãƒ‰ä¿®æ­£ã—ä¿å­˜æ¸ˆã¿ã® `chardet_runner.py` ã‚’æ‰‹å‹•å‰Šé™¤ãŒå¿…è¦ã€‚

```powershell:Get-PyEncoding
Function Get-PyEncoding {
    param (
        [System.String]$target_file
    )

    # python ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª
    if (-Not(Get-Command 'python' -ErrorAction SilentlyContinue)) {
        Write-Host 'Python is not install.' -ForegroundColor Red
        return
    }

    # Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã‚³ãƒ¼ãƒ‰
    [System.String[]]$py_source = 
@'
import subprocess
import sys

# chardet ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
try:
    import chardet
except ImportError:
    # Install chardet in the user's local directory
    subprocess.check_call([sys.executable, '-m', 'pip', 'install', 'chardet', '--user'])

import chardet

# ãƒ•ã‚¡ã‚¤ãƒ«ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ±ºå®šã™ã‚‹Function
def determine_encoding(file_path):
    with open(file_path, 'rb') as file:
        raw_data = file.read()
        result = chardet.detect(raw_data)
        print(f"Detected encoding for [{file_path}] is {result['encoding']} with {result['confidence']*100}% confidence.")

# ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã®å¼•æ•°ã‚’å–å¾—
file_path = sys.argv[1]

# å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã®æ–‡å­—åˆ—ã‚’åˆ¤å®š
determine_encoding(file_path)
'@ -split "`r`n"

    # Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æº–å‚™
    # Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ ¼ç´ã™ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ãŒãªã„å ´åˆã¯ã€æ–°è¦ä½œæˆ
    [System.String]$pyfolder_path = "$PROFILE\..\user-defined-py"
    if (-Not(Test-Path $pyfolder_path)) {
        New-Item -Path $pyfolder_path -ItemType 'directory' -Force > $null
    }
    # ä»Šå›å®Ÿè¡Œã™ã‚‹Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒãªã„å ´åˆã¯ã€æ–°è¦ä½œæˆ
    [System.String]$pyscript_path = "$PROFILE\..\user-defined-py\chardet_runner.py"
    if (-Not(Test-Path $pyscript_path)) {
        $utf8Encoding = New-Object System.Text.UTF8Encoding
        [System.IO.File]::WriteAllText($pyscript_path, $py_source, $utf8Encoding)
    }

    # ç›¸å¯¾ãƒ‘ã‚¹ã ã£ãŸå ´åˆã«çµ¶å¯¾ãƒ‘ã‚¹ã«å¤‰æ›´
    [System.String]$fullpath = (Convert-Path $target_file)

    # Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ
    try {
        python $pyscript_path $fullpath
    }
    catch {
        Write-Host 'Python script execution error.'
    }
}
```

### å‚è€ƒæƒ…å ±

https://chardet.readthedocs.io/en/latest/
https://github.com/chardet/chardet/tree/main

## ã¾ã¨ã‚

- `System.IO.StreamReader`ã‚’ä½¿ã£ã¦æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’åˆ¤å®š
- å…ˆé ­ã®ãƒã‚¤ãƒˆæ•°ã‚’èª­ã¿å–ã‚ŠBOMä»˜ãã‹åˆ¤å®š
    UTF-7ã®å ´åˆï¼šå…ˆé ­4ãƒã‚¤ãƒˆã«ã‚ˆã‚Šåˆ¤æ–­
    UTF-8ã®å ´åˆï¼šå…ˆé ­3ãƒã‚¤ãƒˆã«ã‚ˆã‚Šåˆ¤æ–­
    UTF-16ã®å ´åˆï¼šå…ˆé ­2ãƒã‚¤ãƒˆã«ã‚ˆã‚Šåˆ¤æ–­
    UTF-32ã®å ´åˆï¼šå…ˆé ­4ãƒã‚¤ãƒˆã«ã‚ˆã‚Šåˆ¤æ–­

## é–¢é€£è¨˜äº‹

https://haretokidoki-blog.com/pasocon_powershell-startup/
https://zenn.dev/haretokidoki/articles/7e6924ff0cc960
