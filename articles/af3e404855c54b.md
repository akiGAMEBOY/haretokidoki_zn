---
title: "PowerShell6.0以降で独自のイベントログを出力するまでの方法"
emoji: "🦁"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["powershell"]
published: false
---
## 概要

Windowsで標準インストールされているPowerShell 5.1をはじめとする6.0よりも前のバージョンでは、
New-EvnetLogコマンドレットやWrite-EventLogコマンドレットなどを使用して独自のイベントログが出力できるそう。

ただ、PowerShell 6.0以降のCore Editionでは、それらのコマンドレットは使用できません。
今回、バージョンが6.0以降でも独自のイベントログを出力できる方法を調べました。

イベントビューアー

管理者権限

## 環境

```powershell
PS C:\Users\"ユーザー名"> $PSVersionTable

Name                           Value
----                           -----
PSVersion                      7.4.1
PSEdition                      Core
GitCommitId                    7.4.1
OS                             Microsoft Windows 10.0.19045
Platform                       Win32NT
PSCompatibleVersions           {1.0, 2.0, 3.0, 4.0…}
PSRemotingProtocolVersion      2.3
SerializationVersion           1.1.0.1
WSManStackVersion              3.0

PS C:\Users\"ユーザー名">
```

## 対応方法

今回、.Net Frameworkの[System.Diagnostics.EventLogクラス](https://learn.microsoft.com/ja-jp/dotnet/api/system.diagnostics.eventlog)で実現する方法がありました。

1. 管理者権限でPowerShellを起動
    PowerShellウィンドウであれば、⊞Windowsキー ＋ R でファイル名を指定して実行(R)を起動。
    「`pwsh`」を入力し、Ctrl ＋ Shift ＋ Enter で管理者として実行。

1. イベントビューアーで記録する場所とソースを指定

    ```powershell
    $target_logtype = "Application"
    $target_source = "MyAppSource"
    ```

    ```powershell:存在するソースか判定する場合
    if ([System.Diagnostics.EventLog]::SourceExists($target_source)) {
        # 存在する場合の処理
    }
    else {
        # 存在しない場合の処理
    }
    ```

1. イベントソースの作成

    ```powershell:
    # ソース作成用のオブジェクトを作成
    $eventsource_data = New-Object System.Diagnostics.EventSourceCreationData($target_source, $target_logtype)
    # 独自のソースを作成
    [System.Diagnostics.EventLog]::CreateEventSource($eventsource_data)
    ```

    :::message
    **注意：管理者権限としてPowerShellを実行していない場合**

    下記のエラーが発生。

    ```powershell:
    PS C:\Users\"ユーザー名"> [System.Diagnostics.EventLog]::CreateEventSource($eventsource_data)
    MethodInvocationException: Exception calling "CreateEventSource" with "1" argument(s): "The source was not found, but some or all event logs could not be searched.  To create the source, you need permission to read all event logs to make sure that the new source name is unique.  Inaccessible logs: Security."
    PS C:\Users\"ユーザー名">
    ```

    :::

1. イベントログの出力

    ```powershell:
    # イベントログ書き込み用のオブジェクトを作成
    $eventlog_data = New-Object System.Diagnostics.EventLog($target_logtype)
    # ソースを指定
    $eventlog_data.Source = $target_source
    # 「メッセージ内容、レベル、イベントID」を指定してイベントログに出力
    $eventlog_data.WriteEntry("Test Message.", "Information", 1001)
    ```

    ![イベントビューアーで出力したイベントログを確認](https://storage.googleapis.com/zenn-user-upload/9b832ef0ae8c-20240305.png =500x)
    *画像：イベントビューアーで出力したイベントログを確認*



6.0以降を想定しているのでWrite-EventLogやNew-EventLogは使用できない。

-----

PowerShellを使って独自のイベントログを出力する手順を教えて。
なお、下記のルールに従った手順であること。
・PowerShell 6.0以降の環境で動作可能なコマンドであること
・6.0以降のため、Write-EventLogは使用できない
・6.0以降のため、New-EventLogは使用できない

-----

こんにちは、Copilotです。PowerShell 6.0以降で独自のイベントログを出力する方法をお教えします。😊

まず、イベントログに書き込むためのソースを作成する必要があります。ソースとは、イベントログの発生元を識別する名前です。ソースは、イベントログの種類（Application, System, Securityなど）と紐づけられます。ソースは、New-EventLogコマンドレットで作成できますが、PowerShell 6.0以降では使用できないため、.NET FrameworkのクラスであるSystem.Diagnostics.EventLogを利用します。¹

以下のコードは、ApplicationログにMySourceというソースを作成する例です。ソースがすでに存在する場合は、何もしません。

```powershell
# ソース名とログ名を変数に格納
$source = "MySource"
$log = "Application"

# ソースが存在しない場合は作成
if (-not [System.Diagnostics.EventLog]::SourceExists($source)) {
    # ソースを作成するためのオブジェクトを生成
    $sourceData = New-Object System.Diagnostics.EventSourceCreationData($source, $log)
    # ソースを作成
    [System.Diagnostics.EventLog]::CreateEventSource($sourceData)
}
```

次に、イベントログにイベントを書き込むために、Write-EventLogコマンドレットを使います。しかし、PowerShell 6.0以降では使用できないため、ここでもSystem.Diagnostics.EventLogクラスを利用します。¹

以下のコードは、ApplicationログのMySourceソースに、イベントIDが1000、エントリタイプがInformation、メッセージが"Hello, World!"というイベントを書き込む例です。

```powershell
# ソース名とログ名を変数に格納
$source = "MySource"
$log = "Application"

# ソースが存在することを確認
if ([System.Diagnostics.EventLog]::SourceExists($source)) {
    # イベントログに書き込むためのオブジェクトを生成
    $eventLog = New-Object System.Diagnostics.EventLog($log)
    # ソースを指定
    $eventLog.Source = $source
    # イベントID、エントリタイプ、メッセージを指定してイベントを書き込む
    $eventLog.WriteEntry("Hello, World!", "Information", 1000)
}
```

以上が、PowerShell 6.0以降で独自のイベントログを出力する手順です。²³⁴ ご参考になれば幸いです。😊

¹: [PowerShell 6.0以降でイベントログを操作する方法](^1^)
²: [【PowerShell】イベントログをCSVファイルとして出力する](^2^)
³: [Get-Eventlogの使い方から覚えていくPowershellの基本的な使い方](^3^)
⁴: [Windowsイベントをログに記録する方法について](^4^)

ソース: Bing との会話 2024/3/5
(1) 【PowerShell】イベントログをCSVファイルとして出力する - Qiita. https://qiita.com/hara_power/items/073fa6079e633f084412.
(2) Get-Eventlogの使い方から覚えていくPowershellの基本的な使い .... https://qiita.com/Anubis_369/items/d0566143a1356a2f8ec5.
(3) Windowsイベントをログに記録する方法について #Windows - Qiita. https://qiita.com/King_kenshi/items/7e6f421f9b3545e65420.
(4) PowerShell で EventLog にイベントを出力する. http://www.vwnet.jp/Windows/PowerShell/2018051901/WriteEventLog.htm.
(5) 【PowerShell】イベントログをCSVファイルとして出力する - Qiita. https://qiita.com/hara_power/items/073fa6079e633f084412.
(6) Get-Eventlogの使い方から覚えていくPowershellの基本的な使い .... https://qiita.com/Anubis_369/items/d0566143a1356a2f8ec5.
(7) Windowsイベントをログに記録する方法について #Windows - Qiita. https://qiita.com/King_kenshi/items/7e6f421f9b3545e65420.
(8) PowerShell で EventLog にイベントを出力する. http://www.vwnet.jp/Windows/PowerShell/2018051901/WriteEventLog.htm.