---
title: "PowerShell 6.0以降でイベントログを出力する方法"
emoji: "6️⃣"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["powershell", "dotnet", "windows"]
published: false
---
## 概要

Windowsで標準インストールされているPowerShell 5.1のバージョンでは、
New-EvnetLogコマンドレットやWrite-EventLogコマンドレットなどを使用して独自のイベントログが出力できるそう。

ただ、PowerShell 6.0以降のCore Editionでは、それらのコマンドレットは仕様変更により使えなくなりました。
今回、バージョンが6.0以降でも独自のイベントログを出力できる方法を調べました。

## 環境

```powershell
PS C:\Users\"ユーザー名"> $PSVersionTable

Name                           Value
----                           -----
PSVersion                      7.4.1
PSEdition                      Core
GitCommitId                    7.4.1
OS                             Microsoft Windows 10.0.19045
Platform                       Win32NT
PSCompatibleVersions           {1.0, 2.0, 3.0, 4.0…}
PSRemotingProtocolVersion      2.3
SerializationVersion           1.1.0.1
WSManStackVersion              3.0

PS C:\Users\"ユーザー名">
```

## 対応方法

### 独自のイベントログを出力する方法

PowerShell 6.0以降の環境で登録済みのソース・イベントIDを出力したい場合は、New-WinEventコマンドレットで対応できましたが、
独自のソース・イベントIDを作成する際の対応方法は調べきれませんでした。（おそらく、何かしらの方法があると思われます）

今回、PowerShell 6.0以降 ＋ 独自のイベントログを出力する場合、\.Net Frameworkの[System.Diagnostics.EventLogクラス](https://learn.microsoft.com/ja-jp/dotnet/api/system.diagnostics.eventlog)を使用する方法を紹介。


1. 管理者権限でPowerShellを起動
    コンソール（PowerShellウィンドウ）で実行する場合、「 `⊞ Windowsキー ＋ R` 」 でファイル名を指定して実行(R)を起動。
    「`pwsh`」と入力し、`Ctrl ＋ Shift ＋ Enter` で管理者として実行。

1. ログの種類とイベントソースを指定
    ログの種類を `Application` とすることで、イベントビューアーの Windowsログ -> アプリケーション 内に記録する。
    また、独自のイベントソースである `MyAppSource` を出力するための準備。

    ```powershell:
    $target_logtype = "Application"
    $target_eventsource = "MyAppSource"
    ```

    :::details 作成するソース名の存在チェックを行う場合 < クリックで折りたたみが開く >

    ```powershell:SourceExistsメソッドにて判定
    if ([System.Diagnostics.EventLog]::SourceExists($target_eventsource)) {
        # 存在する場合の処理
    }
    else {
        # 存在しない場合の処理
    }
    ```

    :::

1. イベントソースの作成

    ```powershell:“管理者として実行”の必要あり
    # ソース作成用のオブジェクトを作成
    $eventsource_data = New-Object System.Diagnostics.EventSourceCreationData($target_eventsource, $target_logtype)
    # 独自のソースを作成
    [System.Diagnostics.EventLog]::CreateEventSource($eventsource_data)
    ```

    :::message
    **注意：CreateEventSourceを管理者で実行しなかった場合**

    下記のエラーが発生し正常終了しない。

    ```powershell:管理者ユーザーで実行しなかった場合はエラー
    PS C:\Users\"ユーザー名"> [System.Diagnostics.EventLog]::CreateEventSource($eventsource_data)
    MethodInvocationException: Exception calling "CreateEventSource" with "1" argument(s): "The source was not found, but some or all event logs could not be searched.  To create the source, you need permission to read all event logs to make sure that the new source name is unique.  Inaccessible logs: Security."
    PS C:\Users\"ユーザー名">
    ```

    :::

    :::details 作成したソースを削除する方法 < クリックで折りたたみが開く >

    PowerShellコンソールを管理者として実行し、下記のコマンドレットを実行。

    ```powershell:コピー用
    [System.Diagnostics.EventLog]::DeleteEventSource("削除対象のソース名")
    ```

    ```powershell:実際に実行した結果
    PS C:\WINDOWS\system32> Write-Host "$target_eventsource"
    MyAppSource
    PS C:\WINDOWS\system32>
    PS C:\WINDOWS\system32> [System.Diagnostics.EventLog]::DeleteEventSource($target_eventsource)
    PS C:\WINDOWS\system32>
    ```

    :::

1. イベントログの出力
    イベントログの出力に関しては、管理者権限は不要です。

    ```powershell:一般ユーザーでも実行可能
    # 対象の ログの種類 と イベントソース を確認
    Write-Host "LogType: [$target_logtype], EventSource: [$target_eventsource]"
    # イベントログ書き込み用のオブジェクトを作成
    $eventlog_data = New-Object System.Diagnostics.EventLog($target_logtype)
    # ソースを指定
    $eventlog_data.Source = $target_eventsource
    # 「メッセージ内容、レベル、イベントID」を指定してイベントログに出力
    $eventlog_data.WriteEntry("Test Message.", "Information", 1001)
    ```

    ![WriteEntryコマンドにより出力したログをイベントビューアーで確認](https://storage.googleapis.com/zenn-user-upload/9b832ef0ae8c-20240305.png =500x)
    *画像：WriteEntryコマンドにより出力したログをイベントビューアーで確認*

### すでに登録済みのイベントログを出力する方法

すでに登録されているイベントソース（イベントプロバイダー）・イベントIDの場合、一般ユーザー権限で出力可能。

#### 登録済みのイベントソースを確認する方法

```powershell:既存のイベントソースを確認
# Get-WinEventでイベントソースを確認
# ↓
# Format-Tableで表形式に変更
# ↓
# Out－File -Width で横の最大文字数を設定
Get-WinEvent -ListProvider * | Format-Table -AutoSize -Wrap | Out-File -filepath D:\Downloads\getwinevent-listproviders.txt -Width 10000
# 出力したファイルを確認
Get-Content D:\Downloads\getwinevent-listproviders.txt
```

:::details 実際に実行した結果

[参考情報：見切れたり改行したりする横長のコマンド結果を折り返しせずに確認する方法](https://t-dilemma.info/windows-powershell-format/)

```powershell:実際に実行した結果
PS C:\Users\"ユーザー名"> Get-WinEvent -ListProvider "*PowerShell*" | Format-Table -AutoSize -Wrap | Out-File -Width 10000 D:\Downloads\getwinevent_listprovider_powershell.txt
PS C:\Users\"ユーザー名"> Get-Content D:\Downloads\getwinevent_listprovider_powershell.txt

Name                                                                       LogLinks
----                                                                       --------
PowerShell                                                                 {Windows PowerShell}
PowerShellCore                                                             {PowerShellCore/Operational, PowerShellCore/Analytic, PowerShellCore/Debug}
Microsoft-Windows-PowerShell-DesiredStateConfiguration-FileDownloadManager {Microsoft-Windows-PowerShell-DesiredStateConfiguration-FileDownloadManager/Operational, Microsoft-Windows-PowerShell-DesiredStateConfiguration-FileDownloadManager/Analytic, Microsoft-Windows-PowerShell-DesiredStateConfiguration-FileDownloadManager/Debug}
Microsoft-Windows-PowerShell                                               {Microsoft-Windows-PowerShell/Operational, Microsoft-Windows-PowerShell/Analytic, Microsoft-Windows-PowerShell/Debug, Microsoft-Windows-PowerShell/Admin}

PS C:\Users\"ユーザー名">
```

:::

#### 登録済みのイベントソースを確認する方法

