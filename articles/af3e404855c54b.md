---
title: "PowerShell 6.0以降（Core Edition）でイベントログを出力する方法"
emoji: "6️⃣"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["powershell", "dotnet", "windows"]
published: false
---
## 概要

Windowsで標準インストールされているPowerShell 5.1のバージョンでは、
New-EvnetLogコマンドレットやWrite-EventLogコマンドレットなどを使用して独自のイベントログが出力できます。

ただ、PowerShell 6.0以降のCore Editionでは、それらのコマンドレットは仕様変更により使えなくなりました。
今回、バージョンが6.0以降でも独自のイベントログを出力できる方法を調べました。

※ PowerShell 5.1でイベントログに出力する方法は、[こちら](https://zenn.dev/haretokidoki/articles/0a179fe71a2cc8)の記事を参照してください。

## この記事のターゲット

- PowerShell ユーザーの方
- PowerShell バージョン 6.0以降の環境（Core エディション）でイベントビューアーにログを出力したい方
    - 【パターンA】独自のイベントソースとイベントIDで出力
    - 【パターンB】既存のイベントソースとイベントIDで出力

## 環境

```powershell
PS C:\Users\"ユーザー名"> $PSVersionTable

Name                           Value
----                           -----
PSVersion                      7.4.1
PSEdition                      Core
GitCommitId                    7.4.1
OS                             Microsoft Windows 10.0.19045
Platform                       Win32NT
PSCompatibleVersions           {1.0, 2.0, 3.0, 4.0…}
PSRemotingProtocolVersion      2.3
SerializationVersion           1.1.0.1
WSManStackVersion              3.0

PS C:\Users\"ユーザー名">
```

## 対応方法

### 【パターンA】独自のイベントソースとイベントIDで出力

PowerShell 6.0以降の環境で登録済みのソース・イベントIDを出力したい場合は、New-WinEventコマンドレットで対応できましたが、
独自のイベントソース（イベントプロバイダー）・イベントIDを作成する際の対応方法は調べきれませんでした。（おそらく、何かしらの方法があると思われます）

今回、PowerShell 6.0以降 ＋ 独自のイベントログを出力する場合、\.Net Frameworkの[System.Diagnostics.EventLogクラス](https://learn.microsoft.com/ja-jp/dotnet/api/system.diagnostics.eventlog)を使用する方法を紹介。


1. 管理者権限でPowerShellを起動
    コンソール（PowerShellウィンドウ）で実行する場合、「 `⊞ Windowsキー ＋ R` 」 でファイル名を指定して実行(R)を起動。
    「`pwsh`」と入力し、`Ctrl ＋ Shift ＋ Enter` で管理者として実行。

1. ログの種類とイベントソースを指定
    ログの種類を `Application` とすることで、イベントビューアーの Windowsログ -> アプリケーション 内に記録する。
    また、独自のイベントソースである `MyAppSource` を出力するための準備。

    ```powershell:ログの種別とイベントソースの名前を変数に代入
    $target_logtype = "Application"
    $target_eventsource = "MyAppSource"
    ```

    :::details 補足情報：作成するソース名の存在チェックを行う場合 < クリックで折りたたみが開く >

    ```powershell:SourceExistsメソッドにて判定
    if ([System.Diagnostics.EventLog]::SourceExists($target_eventsource)) {
        # 存在する場合の処理
    }
    else {
        # 存在しない場合の処理
    }
    ```

    :::

1. イベントソースの作成

    ```powershell:“管理者として実行”の必要あり
    # ソース作成用のオブジェクトを作成
    $eventsource_data = New-Object System.Diagnostics.EventSourceCreationData($target_eventsource, $target_logtype)
    # 独自のソースを作成
    [System.Diagnostics.EventLog]::CreateEventSource($eventsource_data)
    ```

    :::message
    **注意：CreateEventSourceを管理者権限で実行しなかった場合**

    下記のエラーが発生し正常終了しない。

    ```powershell:管理者ユーザーで実行しなかった場合はエラー
    PS C:\Users\"一般ユーザー名"> [System.Diagnostics.EventLog]::CreateEventSource($eventsource_data)
    MethodInvocationException: Exception calling "CreateEventSource" with "1" argument(s): "The source was not found, but some or all event logs could not be searched.  To create the source, you need permission to read all event logs to make sure that the new source name is unique.  Inaccessible logs: Security."
    PS C:\Users\"一般ユーザー名">
    ```

    :::

    :::details 補足情報：作成したイベントソースを削除する方法 < クリックで折りたたみが開く >

    PowerShellコンソールを管理者として実行し、下記のコマンドレットを実行。

    ```powershell:コピー用
    [System.Diagnostics.EventLog]::DeleteEventSource("削除対象のソース名")
    ```

    ```powershell:実際に実行した結果
    PS C:\WINDOWS\system32> Write-Host "$target_eventsource"
    MyAppSource
    PS C:\WINDOWS\system32>
    PS C:\WINDOWS\system32> [System.Diagnostics.EventLog]::DeleteEventSource($target_eventsource)
    PS C:\WINDOWS\system32>
    ```

    :::

1. イベントログの出力
    イベントログの出力に関しては、管理者権限は不要です。
    また、イベントソースを作成していない状態だったとしても、管理者権限でこのイベントログの出力メソッド「WriteEntry」を実行すると、
    「 イベントソースの作成 ＋ イベントログの出力 」の2つを自動で実行してくれます。

    :::details 補足情報：管理者権限で独自のイベントソースの登録 と 一般権限でそのイベントソースをログ出力 をわける必要性 < クリックで折りたたみが開く >

    管理者権限で「WriteEntry」メソッドを実行すると、イベントソース と イベントログ の両方を実行するのであれば、
    わざわざイベントソースのみを登録する「CreateEventSource」は不要と考える方がいるかもしれませんが、
    運用の仕方によって「CreateEventSource」メソッドは必要になります。

    たとえば、管理者権限を持たない一般ユーザーで“独自のログ出力するPowerShellスクリプト”を実行する運用があった場合、
    管理者権限の範囲は最小限にした方が良いです。

    「WriteEntry」メソッドが含まれるPowerShellスクリプトを一般ユーザーで実行してもらうため、
    管理者権限のあるユーザーとパスワードを一般ユーザーに公開するという方法は、悪手中の悪手です。
    むやみに管理者権限を渡すのはやめましょう。

    このケースで私が良いと思う方法は、独自イベントソースを登録するPowerShellスクリプト と 独自イベントソースのログを出力するPowerShellスクリプト の2つにわける方法です。
    
    これにより一般ユーザーに管理者権限を渡す必要が無く、運用できると思います。
    （セットアップする台数が多い場合は、また違った手法を考える必要がありそう。）

    :::

    ```powershell:一般ユーザーでも実行可能
    # 対象の ログの種類 と イベントソース を確認
    Write-Host "LogType: [$target_logtype], EventSource: [$target_eventsource]"
    # イベントログ書き込み用のオブジェクトを作成
    $eventlog_data = New-Object System.Diagnostics.EventLog($target_logtype)
    # ソースを指定
    $eventlog_data.Source = $target_eventsource
    # 「メッセージ内容、レベル、イベントID」を指定してイベントログに出力
    $eventlog_data.WriteEntry("Test Message.", "Information", 1001)
    ```

    ![WriteEntryコマンドにより出力したログをイベントビューアーで確認（独自のイベントソース・イベントIDの場合）](https://storage.googleapis.com/zenn-user-upload/9b832ef0ae8c-20240305.png =500x)
    *画像：WriteEntryコマンドにより出力したログをイベントビューアーで確認（独自のイベントソース・イベントIDの場合）*

### 【パターンB】既存のイベントソースとイベントIDで出力

#### B-1）\.Net Frameworkを使う方法

初期状態で登録されているイベントソース・イベントIDの場合、一般ユーザー権限のユーザーだけで対応可能。

::::details 登録済みのイベントソース・イベントIDを確認する方法

- 登録済みのイベントソースを確認する方法

    ```powershell:既存のイベントソースを確認
    # Get-WinEventでイベントソースを確認 → Format-Tableで表形式に変更 → Out－File -Width で横の最大文字数を設定
    Get-WinEvent -ListProvider * -Erroraction Silentlycontinue | Format-Table -AutoSize -Wrap | Out-File -filepath D:\Downloads\getwinevent-listproviders-all.txt -Width 10000
    # 出力したファイルを確認
    Get-Content D:\Downloads\getwinevent-listproviders-all.txt
    ```

    :::details 実際に実行した結果

    ```powershell:実際に実行した結果
    PS C:\Users\"ユーザー名"> Get-WinEvent -ListProvider * -Erroraction Silentlycontinue | Format-Table -AutoSize -Wrap | Out-File -filepath D:\Downloads\getwinevent-listproviders-all.txt -Width 10000
    PS C:\Users\"ユーザー名">
    PS C:\Users\"ユーザー名"> Get-Content D:\Downloads\getwinevent-listproviders-all.txt

    Name                                                                       LogLinks                                                                                                                                                                                                                                                                                                                     
    ----                                                                       --------                                                                                                                                                                                                                                                                                                                     
    PowerShell                                                                 {Windows PowerShell}                                                                                                                                                                                                                                                                                                         
    Visual Studio Audit Log                                                    {Visual Studio}                                                                                                                                                                                                                                                                                                              
    Visual Studio                                                              {Visual Studio}                                                                                                                                                                                                                                                                                                              

    ～～～ 省略 ～～～

    Microsoft-IE                                                               {Microsoft-IE/Diagnostic, Microsoft-Windows-WebPlatStorage-Server}                                                                                                                                                                                                                                                           
    Microsoft-Windows-MF-FrameServer                                           {MF_MediaFoundationFrameServer}                                                                                                                                                                                                                                                                                              
    Microsoft-Windows-WebcamExperience                                         {Microsoft-Windows-WebcamProvider/Analytic}                                                                                                                                                                                                                                                                                  
    Microsoft-Windows-Sensors-Core-Performance                                 {}                                                                                                                                                                                                                                                                                                                           
    Microsoft-Windows-IdleTriggerProvider                                      {}                                                                                                                                                                                                                                                                                                                           
    Microsoft-Windows-FunctionDiscovery                                        {Analytic}                                                                                                                                                                                                                                                                                                                   
    Microsoft-Windows-Winsrv                                                   {Application, Microsoft-Windows-Winsrv/Analytic}                                                                                                                                                                                                                                                                             
    Microsoft-AppV-ServiceLog                                                  {Microsoft-AppV-Client/Debug}                                                                                                                                                                                                                                                                                                
    Microsoft-Windows-EapMethods-RasTls                                        {Microsoft-Windows-EapMethods-RasTls/Operational}                                                                                                                                                                                                                                                                            
    Microsoft-Windows-Store                                                    {Microsoft-Windows-Store/Operational}                                                                                                                                                                                                                                                                                        

    ～～～ 省略 ～～～

    Microsoft-Windows-ErrorReportingConsole                                    {}                                                                                                                                                                                                                                                                                                                           
    Microsoft-Windows-VAN                                                      {Microsoft-Windows-VAN/Diagnostic}                                                                                                                                                                                                                                                                                           
    Microsoft-Windows-ParentalControls                                         {Microsoft-Windows-ParentalControls/Operational}                                                                                                                                                                                                                                                                             
    Microsoft-Windows-Security-IdentityStore                                   {Microsoft-Windows-Security-IdentityStore/Performance}                                                                                                                                                                                                                                                                       
    Microsoft-Windows-Services                                                 {Microsoft-Windows-Services/Diagnostic}                                                                                                                                                                                                                                                                                      




    PS C:\Users\"ユーザー名">
    ```

    :::

- 登録済みのイベントIDを確認する方法

    ```powershell:特定のイベントソースのイベントIDを確認する方法
    # Get-WinEventでイベントIDを確認 → Format-Tableで表形式に変更 → Out－File -Width で横の最大文字数を設定
    (Get-WinEvent -ListProvider "Microsoft-Windows-Winsrv").Events | Format-Table Id, Description -AutoSize -Wrap | Out-File -filepath D:\Downloads\getwinevent-winsrv-eventid.txt -Width 10000
    # 出力したファイルを確認
    Get-Content D:\Downloads\getwinevent-winsrv-eventid.txt
    ```

    :::details 実際に実行した結果

    ```powershell:実際に実行した結果
    PS C:\Users\"ユーザー名"> (Get-WinEvent -ListProvider "Microsoft-Windows-Winsrv").Events | Format-Table Id, Description -AutoSize -Wrap | Out-File -filepath D:\Downloads\getwinevent-winsrv-eventid.txt -Width 10000
    PS C:\Users\"ユーザー名">
    PS C:\Users\"ユーザー名"> Get-Content D:\Downloads\getwinevent-winsrv-eventid.txt

    Id Description
    -- -----------
    10001 次のアプリケーションによりシャットダウンが拒否されました: %1。
    10002 次のアプリケーションは停止したために終了しました: %1。
    12001
    12001
    12002
    12002
    12003
    12003
    12005
    12005
    12006
    12006
    12007
    12007
    12008
    12008
    12009
    12010
    12011
    12012

    PS C:\Users\"ユーザー名">
    ```

    ```powershell:イベントIDの一覧を取得する方法
    # 全プロバイダー（イベントソース）を取得 → イベントソースに登録されているイベントIDを取得 → Out－File -Width で横の最大文字数を設定
    Get-WinEvent -ListProvider * -Erroraction Silentlycontinue | Select-Object Name -ExpandProperty Events | Format-Table Name, ID, Description | Out-File -filepath D:\Downloads\getwinevent-all-eventid.txt -Width 10000
    # 出力したファイルを確認
    Get-Content D:\Downloads\getwinevent-all-eventid.txt
    ```

    ```powershell:実際に実行した結果
    PS C:\Users\"ユーザー名"> Get-WinEvent -ListProvider * -Erroraction Silentlycontinue | Select-Object Name -ExpandProperty Events | Format-Table Name, ID, Description | Out-File -filepath D:\Downloads\getwinevent-all-eventid.txt -Width 10000
    PS C:\Users\"ユーザー名">
    PS C:\Users\"ユーザー名"> Get-Content D:\Downloads\getwinevent-all-eventid.txt

    Name                                                  Id Description
    ----                                                  -- -----------
    Ntfs                                                  55 ボリューム %1 のファイル システム構造で破損が検出されました。…
    Ntfs                                                 130 ボリューム %2 のファイル システム構造は修復されました。
    Ntfs                                                 131 ボリューム %2 のファイル システム構造は修正できませんでした。…
    Ntfs                                                 132 短時間の間に修復イベントが数多く発生しました。…
    Ntfs                                                 133 %1 の修復イベントの送信をスキップしました。修復イベントの送信は再開されます。…
    PowerShellCore                                      4097 Computer Name $null or . resolve to LocalHost

    ～～～ 省略 ～～～

    Microsoft-Windows-Services                           203
    Microsoft-Windows-Services                           204
    Microsoft-Windows-Services                           205

    PS C:\Users\"ユーザー名">
    ```

    :::

    [参考情報：見切れたり改行したりする横長のコマンド結果を折り返しせずに確認する方法](https://t-dilemma.info/windows-powershell-format/)

::::

```powershell:登録済みのイベントソース・イベントIDの場合は、一般ユーザーで実行可能
[System.Diagnostics.EventLog]::WriteEntry("イベントソース", "出力するメッセージ", "エラーの種類", "イベントID")
```

なお、WriteEntryメソッドは、オーバーロードがあり引き渡す引数の数により、動作が変わります。
引数を増やすと、よりログ出力する際の情報を追加可能。

:::details WriteEntryメソッドのオーバーロードについて

|引数の数|オーバーロードの指定方法|説明|
|---|---|---|
|6個|WriteEntry(String, String, EventLogEntryType, Int32, Int16, Byte[])|引数1：イベント ソース、引数2：メッセージ テキスト、引数3：エラーレベル、引数4：イベントID、引数5：カテゴリー、引数6：付加するバイナリ データ|
|5個（引数で渡すデータ型の違い）|WriteEntry(String, String, EventLogEntryType, Int32, Int16)|引数1：イベント ソース、引数2：メッセージ テキスト、引数3：エラーレベル、引数4：イベントID、引数5：カテゴリー|
|5個（引数で渡すデータ型の違い）|WriteEntry(String, EventLogEntryType, Int32, Int16, Byte[])|引数1：メッセージ テキスト、引数2：エラーレベル、引数3：イベントID、引数4：カテゴリー、引数5：付加するバイナリーデータ|
|4個（引数で渡すデータ型の違い）|WriteEntry(String, String, EventLogEntryType, Int32)|引数1：イベント ソース、引数2：メッセージ テキスト、引数3：エラーレベル、引数4：イベントID|
|4個（引数で渡すデータ型の違い）|WriteEntry(String, EventLogEntryType, Int32, Int16)|引数1：メッセージ テキスト、引数2：エラーレベル、引数3：イベントID、引数4：カテゴリー|
|3個（引数で渡すデータ型の違い）|WriteEntry(String, String, EventLogEntryType)|引数1：イベント ソース、引数2：メッセージ テキスト、引数3：エラーレベル|
|3個（引数で渡すデータ型の違い）|WriteEntry(String, EventLogEntryType, Int32)|引数1：メッセージ テキスト、引数2：エラーレベル、引数3：イベントID|
|2個（引数で渡すデータ型の違い）|WriteEntry(String, EventLogEntryType)|引数1：メッセージ テキスト、引数3：エラーレベル|
|2個（引数で渡すデータ型の違い）|WriteEntry(String, String)|引数1：イベント ソース、引数2：メッセージ テキスト|
|1個|WriteEntry(String)|引数1：メッセージ テキスト|

[参考情報：WriteEntryメソッド](https://learn.microsoft.com/ja-jp/dotnet/api/system.diagnostics.eventlog.writeentry)
[参考情報：エラーの種類で設定する数値](https://learn.microsoft.com/ja-jp/dotnet/api/system.diagnostics.eventlogentrytype)

:::

```powershell:実際に実行した結果
PS C:\Users\"ユーザー名"> [System.Diagnostics.EventLog]::WriteEntry("Winsrv", "テストメッセージ", 1, 10001)
PS C:\Users\"ユーザー名">
```

![WriteEntryコマンドにより出力したログをイベントビューアーで確認（登録済みのイベントソース・イベントIDの場合）](https://storage.googleapis.com/zenn-user-upload/e358d2549017-20240319.png =500x)
*画像：WriteEntryコマンドにより出力したログをイベントビューアーで確認（登録済みのイベントソース・イベントIDの場合）*  

#### B-2）PowerShellコマンドレット「New-WinEvent」を使う方法

XXXX

## まとめ

- 
