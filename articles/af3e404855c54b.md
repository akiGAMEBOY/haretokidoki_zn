---
title: "PowerShell 6.0以降（Core Edition）でイベントログを出力する方法"
emoji: "6️⃣"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["powershell", "dotnet", "windows"]
published: false
---
## 概要

Windowsで標準インストールされているPowerShell 5.1のバージョンでは、
New-EvnetLogコマンドレットやWrite-EventLogコマンドレットなどを使用して独自のイベントログが出力できます。

ただ、PowerShell 6.0以降のCore Editionでは、それらのコマンドレットは仕様変更により使えなくなりました。
今回、バージョンが6.0以降でも独自のイベントログを出力できる方法を調べました。

※ PowerShell 5.1でイベントログに出力する方法は、[こちら](https://zenn.dev/haretokidoki/articles/0a179fe71a2cc8)の記事を参照してください。

## この記事のターゲット

- PowerShell ユーザーの方
- PowerShell バージョン 6.0以降の環境（Core エディション）でイベントビューアーにログを出力したい方

## 環境

```powershell
PS C:\Users\"ユーザー名"> $PSVersionTable

Name                           Value
----                           -----
PSVersion                      7.4.1
PSEdition                      Core
GitCommitId                    7.4.1
OS                             Microsoft Windows 10.0.19045
Platform                       Win32NT
PSCompatibleVersions           {1.0, 2.0, 3.0, 4.0…}
PSRemotingProtocolVersion      2.3
SerializationVersion           1.1.0.1
WSManStackVersion              3.0

PS C:\Users\"ユーザー名">
```

## 対応方法

### 独自のイベントログを出力する方法

PowerShell 6.0以降の環境で登録済みのソース・イベントIDを出力したい場合は、New-WinEventコマンドレットで対応できましたが、
独自のイベントソース（イベントプロバイダー）・イベントIDを作成する際の対応方法は調べきれませんでした。（おそらく、何かしらの方法があると思われます）

今回、PowerShell 6.0以降 ＋ 独自のイベントログを出力する場合、\.Net Frameworkの[System.Diagnostics.EventLogクラス](https://learn.microsoft.com/ja-jp/dotnet/api/system.diagnostics.eventlog)を使用する方法を紹介。


1. 管理者権限でPowerShellを起動
    コンソール（PowerShellウィンドウ）で実行する場合、「 `⊞ Windowsキー ＋ R` 」 でファイル名を指定して実行(R)を起動。
    「`pwsh`」と入力し、`Ctrl ＋ Shift ＋ Enter` で管理者として実行。

1. ログの種類とイベントソースを指定
    ログの種類を `Application` とすることで、イベントビューアーの Windowsログ -> アプリケーション 内に記録する。
    また、独自のイベントソースである `MyAppSource` を出力するための準備。

    ```powershell:
    $target_logtype = "Application"
    $target_eventsource = "MyAppSource"
    ```

    :::details 作成するソース名の存在チェックを行う場合 < クリックで折りたたみが開く >

    ```powershell:SourceExistsメソッドにて判定
    if ([System.Diagnostics.EventLog]::SourceExists($target_eventsource)) {
        # 存在する場合の処理
    }
    else {
        # 存在しない場合の処理
    }
    ```

    :::

1. イベントソースの作成

    ```powershell:“管理者として実行”の必要あり
    # ソース作成用のオブジェクトを作成
    $eventsource_data = New-Object System.Diagnostics.EventSourceCreationData($target_eventsource, $target_logtype)
    # 独自のソースを作成
    [System.Diagnostics.EventLog]::CreateEventSource($eventsource_data)
    ```

    :::message
    **注意：CreateEventSourceを管理者権限で実行しなかった場合**

    下記のエラーが発生し正常終了しない。

    ```powershell:管理者ユーザーで実行しなかった場合はエラー
    PS C:\Users\"一般ユーザー名"> [System.Diagnostics.EventLog]::CreateEventSource($eventsource_data)
    MethodInvocationException: Exception calling "CreateEventSource" with "1" argument(s): "The source was not found, but some or all event logs could not be searched.  To create the source, you need permission to read all event logs to make sure that the new source name is unique.  Inaccessible logs: Security."
    PS C:\Users\"一般ユーザー名">
    ```

    :::

    :::details 作成したイベントソースを削除する方法 < クリックで折りたたみが開く >

    PowerShellコンソールを管理者として実行し、下記のコマンドレットを実行。

    ```powershell:コピー用
    [System.Diagnostics.EventLog]::DeleteEventSource("削除対象のソース名")
    ```

    ```powershell:実際に実行した結果
    PS C:\WINDOWS\system32> Write-Host "$target_eventsource"
    MyAppSource
    PS C:\WINDOWS\system32>
    PS C:\WINDOWS\system32> [System.Diagnostics.EventLog]::DeleteEventSource($target_eventsource)
    PS C:\WINDOWS\system32>
    ```

    :::

1. イベントログの出力
    イベントログの出力に関しては、管理者権限は不要です。
    なお、イベントソースを作成していない状態だったとしても、管理者権限でこのイベントログの出力を実行すると、
    「 イベントソースの作成 ＋ イベントログの出力 」が自動的に実行してくれます。

    ```powershell:一般ユーザーでも実行可能
    # 対象の ログの種類 と イベントソース を確認
    Write-Host "LogType: [$target_logtype], EventSource: [$target_eventsource]"
    # イベントログ書き込み用のオブジェクトを作成
    $eventlog_data = New-Object System.Diagnostics.EventLog($target_logtype)
    # ソースを指定
    $eventlog_data.Source = $target_eventsource
    # 「メッセージ内容、レベル、イベントID」を指定してイベントログに出力
    $eventlog_data.WriteEntry("Test Message.", "Information", 1001)
    ```

    ![WriteEntryコマンドにより出力したログをイベントビューアーで確認](https://storage.googleapis.com/zenn-user-upload/9b832ef0ae8c-20240305.png =500x)
    *画像：WriteEntryコマンドにより出力したログをイベントビューアーで確認*

### すでに登録済みのイベントログを出力する方法

すでに登録されているイベントソース・イベントIDの場合、一般ユーザー権限で出力可能。

::::details 登録済みのイベントソース・イベントIDを確認する方法

- 登録済みのイベントソースを確認する方法

    ```powershell:既存のイベントソースを確認
    # Get-WinEventでイベントソースを確認
    # ↓
    # Format-Tableで表形式に変更
    # ↓
    # Out－File -Width で横の最大文字数を設定
    Get-WinEvent -ListProvider * | Format-Table -AutoSize -Wrap | Out-File -filepath D:\Downloads\getwinevent-listproviders.txt -Width 10000
    # 出力したファイルを確認
    Get-Content D:\Downloads\getwinevent-listproviders.txt
    ```

    :::details 実際に実行した結果

    ```powershell:実際に実行した結果
    PS C:\Users\"ユーザー名"> Get-WinEvent -ListProvider "*PowerShell*" | Format-Table -AutoSize -Wrap | Out-File -Width 10000 D:\Downloads\getwinevent_listprovider_powershell.txt
    PS C:\Users\"ユーザー名">
    PS C:\Users\"ユーザー名"> Get-Content D:\Downloads\getwinevent_listprovider_powershell.txt

    Name                                                                       LogLinks
    ----                                                                       --------
    PowerShell                                                                 {Windows PowerShell}
    PowerShellCore                                                             {PowerShellCore/Operational, PowerShellCore/Analytic, PowerShellCore/Debug}
    Microsoft-Windows-PowerShell-DesiredStateConfiguration-FileDownloadManager {Microsoft-Windows-PowerShell-DesiredStateConfiguration-FileDownloadManager/Operational, Microsoft-Windows-PowerShell-DesiredStateConfiguration-FileDownloadManager/Analytic, Microsoft-Windows-PowerShell-DesiredStateConfiguration-FileDownloadManager/Debug}
    Microsoft-Windows-PowerShell                                               {Microsoft-Windows-PowerShell/Operational, Microsoft-Windows-PowerShell/Analytic, Microsoft-Windows-PowerShell/Debug, Microsoft-Windows-PowerShell/Admin}

    PS C:\Users\"ユーザー名">
    ```

    :::

- 登録済みのイベントIDを確認する方法

    ```powershell:特定のイベントソースのイベントIDを確認する方法
    # Get-WinEventでイベントIDを確認
    # ↓
    # Format-Tableで表形式に変更
    # ↓
    # Out－File -Width で横の最大文字数を設定
    (Get-WinEvent -ListProvider Microsoft-Windows-PowerShell).Events | Format-Table Id, Description -AutoSize -Wrap | Out-File -filepath D:\Downloads\getwinevent-powershell-eventid.txt -Width 10000
    # 出力したファイルを確認
    Get-Content D:\Downloads\getwinevent-powershell-eventid.txt
    ```

    :::details 実際に実行した結果

    ```powershell:実際に実行した結果
    PS C:\Users\"ユーザー名"> (Get-WinEvent -ListProvider Microsoft-Windows-PowerShell).Events | Format-Table Id, Description -AutoSize -Wrap | Out-File -filepath D:\Downloads\getwinevent-powershell-eventid.txt -Width 10000
    PS C:\Users\"ユーザー名">
    PS C:\Users\"ユーザー名"> Get-Content D:\Downloads\getwinevent-powershell-eventid.txt

    Id Description
    -- -----------
    4097 コンピューター名が $null または . の場合は LocalHost に解決されます
    4098 既定のスキームの http に解決しています
    4099 リモート シェル名が、既定の Microsoft.PowerShell に解決されました
    4100 %3
        
        コンテキスト:
        %1
        
        ユーザー データ:
        %2
        
    4101 %3
        
        コンテキスト:
        %1
        
        ユーザー データ:
        %2
        
    4102 %3
        
        コンテキスト:
        %1
        
        ユーザー データ:
        %2
        
    4103 %3
        
        コンテキスト:
        %1
        
        ユーザー データ:
        %2
        
    4104 Scriptblock テキストを作成しています (%2 個中 %1 個目):
        %3
        
        ScriptBlock ID: %4
        パス: %5
    4105 ScriptBlock ID: %1
        Runspace ID: %2 の呼び出しを開始しました
    4106 ScriptBlock ID: %1
        Runspace ID: %2 の呼び出しが完了しました

    ～～～ 省略　～～～

    53504 Windows PowerShell は、AppDomain %2 のプロセス %1 で IPC リッスン スレッドを開始しました。
    53505 Windows PowerShell は、AppDomain %2 のプロセス %1 で IPC リッスン スレッドを終了しました。
    53506 AppDomain %2、プロセス %1 の Windows PowerShell IPC リッスン スレッドでエラーが発生しました。エラー メッセージ: %3
        。
    53507 Windows PowerShell は、ユーザー %3、AppDomain %2、プロセス %1 で IPC 接続を確立しました。
    53508 Windows PowerShell は、ユーザー %3、AppDomain %2、プロセス %1 で IPC 接続を切断しました。



    PS C:\Users\"ユーザー名">
    ```

    ```powershell:イベントIDの一覧を取得する方法
    Get-WinEvent -ListProvider * | ForEach-Object { $_.Name; ($_.Events | Format-Table Id, Description -AutoSize -Wrap)} | Out-File -filepath D:\Downloads\getwinevent-all-eventid.txt -Width 10000

    Get-WinEvent -ListProvider * | ForEach-Object { $_.Name; ($_.Events | Where-Object { $_.Description } | Format-Table Id, Description -AutoSize -Wrap) } | Out-File -filepath D:\Downloads\getwinevent-all-eventid.txt -Width 10000

    ```

    ```powershell:実際に実行した結果
    PS C:\Users\"ユーザー名"> Get-WinEvent -ListProvider * | ForEach-Object { $_.Name; ($_.Events | Format-Table Id, Description -AutoSize -Wrap)} | Out-File -filepath D:\Downloads\getwinevent-all-eventid.txt -Width 10000
    Get-WinEvent: Could not retrieve information about the Microsoft-Windows-USB-CCID provider. Error: 指定されたファイルが 見つかりません。.
    Get-WinEvent: Could not retrieve information about the IntelCPEventProvider provider. Error: 指定されたリソースの種類が イメージ ファイルに見つかりません。.
    Get-WinEvent: Could not retrieve information about the Intel-SST-CFD-HDA provider. Error: 指定されたファイルが見つかりません。.

    ～～～ 省略 ～～～

    Get-WinEvent: Could not retrieve information about the Microsoft-Windows-RemoteDesktopServices-RemoteFX-Manager provider. Error: 指定されたファイルが見つかりません。.
    Get-WinEvent: Could not retrieve information about the Microsoft-Windows-RemoteDesktopServices-RemoteFX-SessionLicensing provider. Error: 指定されたファイルが見つかりません。.
    PS C:\Users\"ユーザー名">
    ```

    エラーも発生するが、テキストファイルとして取得可能。

    :::

    [参考情報：見切れたり改行したりする横長のコマンド結果を折り返しせずに確認する方法](https://t-dilemma.info/windows-powershell-format/)

::::

```powershell:
[System.Diagnostics.EventLog]::WriteEntry("イベントソース", "出力するメッセージ", "エラーの種類", "イベントID")

[System.Diagnostics.EventLog]::WriteEntry(
        "イベントソース",
        "出力するメッセージ",
        "エラーの種類",
        "イベントID"
)
```

[参考情報：エラーの種類で設定する数値](https://learn.microsoft.com/ja-jp/dotnet/api/system.diagnostics.eventlogentrytype)

```powershell:実際に実行した結果
PS C:\Users\"ユーザー名"> [System.Diagnostics.EventLog]::WriteEntry(
>>     "Application Error",
>>     "テスト：テストメッセージ",
>>     1,
>>     1000
>> )
PS C:\Users\"ユーザー名">
```

★ 上記の画面キャプチャ。

[](https://learn.microsoft.com/ja-jp/dotnet/api/system.diagnostics.eventlog.writeentry)
