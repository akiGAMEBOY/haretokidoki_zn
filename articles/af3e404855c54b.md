---
title: "PowerShell 6.0ä»¥é™ã§ç‹¬è‡ªã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ã‚’å‡ºåŠ›ã™ã‚‹æ–¹æ³•"
emoji: "ğŸ¦"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["powershell", "dotnet", "windows"]
published: false
---
## æ¦‚è¦

Windowsã§æ¨™æº–ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹PowerShell 5.1ã‚’ã¯ã˜ã‚ã¨ã™ã‚‹6.0ã‚ˆã‚Šã‚‚å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯ã€
New-EvnetLogã‚³ãƒãƒ³ãƒ‰ãƒ¬ãƒƒãƒˆã‚„Write-EventLogã‚³ãƒãƒ³ãƒ‰ãƒ¬ãƒƒãƒˆãªã©ã‚’ä½¿ç”¨ã—ã¦ç‹¬è‡ªã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ãŒå‡ºåŠ›ã§ãã‚‹ãã†ã€‚

ãŸã ã€PowerShell 6.0ä»¥é™ã®Core Editionã§ã¯ã€ãã‚Œã‚‰ã®ã‚³ãƒãƒ³ãƒ‰ãƒ¬ãƒƒãƒˆã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚
ä»Šå›ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒ6.0ä»¥é™ã§ã‚‚ç‹¬è‡ªã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ã‚’å‡ºåŠ›ã§ãã‚‹æ–¹æ³•ã‚’èª¿ã¹ã¾ã—ãŸã€‚

ã‚¤ãƒ™ãƒ³ãƒˆãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼

ç®¡ç†è€…æ¨©é™

## ç’°å¢ƒ

```powershell
PS C:\Users\"ãƒ¦ãƒ¼ã‚¶ãƒ¼å"> $PSVersionTable

Name                           Value
----                           -----
PSVersion                      7.4.1
PSEdition                      Core
GitCommitId                    7.4.1
OS                             Microsoft Windows 10.0.19045
Platform                       Win32NT
PSCompatibleVersions           {1.0, 2.0, 3.0, 4.0â€¦}
PSRemotingProtocolVersion      2.3
SerializationVersion           1.1.0.1
WSManStackVersion              3.0

PS C:\Users\"ãƒ¦ãƒ¼ã‚¶ãƒ¼å">
```

## å¯¾å¿œæ–¹æ³•

PowerShell 6.0ä»¥é™ã®ç’°å¢ƒã§ç™»éŒ²æ¸ˆã¿ã®ã‚½ãƒ¼ã‚¹ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆIDã®ã‚±ãƒ¼ã‚¹ã¯ã€New-WinEventã‚³ãƒãƒ³ãƒ‰ãƒ¬ãƒƒãƒˆã§å¯¾å¿œã§ããã†ã§ã—ãŸãŒã€
ç‹¬è‡ªã®ã‚½ãƒ¼ã‚¹ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆIDã‚’ä½œæˆã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ãƒ¬ãƒƒãƒˆã¯èª¿ã¹ãã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ï¼ˆãŠãã‚‰ãã€ä½•ã‹ã—ã‚‰ã®æ–¹æ³•ã§å¯¾å¿œã¯ã§ãã‚‹ã¨æ€ã‚ã‚Œã¾ã™ï¼‰

ä»Šå›ã€.Net Frameworkã®[System.Diagnostics.EventLogã‚¯ãƒ©ã‚¹](https://learn.microsoft.com/ja-jp/dotnet/api/system.diagnostics.eventlog)ã§å®Ÿç¾ã™ã‚‹æ–¹æ³•ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚


1. ç®¡ç†è€…æ¨©é™ã§PowerShellã‚’èµ·å‹•
    PowerShellã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§ã‚ã‚Œã°ã€âŠWindowsã‚­ãƒ¼ ï¼‹ R ã§ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŒ‡å®šã—ã¦å®Ÿè¡Œ(R)ã‚’èµ·å‹•ã€‚
    ã€Œ`pwsh`ã€ã‚’å…¥åŠ›ã—ã€Ctrl ï¼‹ Shift ï¼‹ Enter ã§ç®¡ç†è€…ã¨ã—ã¦å®Ÿè¡Œã€‚

1. ã‚¤ãƒ™ãƒ³ãƒˆãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã§è¨˜éŒ²ã™ã‚‹å ´æ‰€ã¨ã‚½ãƒ¼ã‚¹ã‚’æŒ‡å®š

    ```powershell:
    $target_logtype = "Application"
    $target_source = "MyAppSource"
    ```

    ```powershell:å­˜åœ¨ã™ã‚‹ã‚½ãƒ¼ã‚¹ã‹åˆ¤å®šã™ã‚‹å ´åˆ
    if ([System.Diagnostics.EventLog]::SourceExists($target_source)) {
        # å­˜åœ¨ã™ã‚‹å ´åˆã®å‡¦ç†
    }
    else {
        # å­˜åœ¨ã—ãªã„å ´åˆã®å‡¦ç†
    }
    ```

1. ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚¹ã®ä½œæˆ

    ```powershell:ç®¡ç†è€…æ¨©é™ã¨ã—ã¦å®Ÿè¡Œ
    # ã‚½ãƒ¼ã‚¹ä½œæˆç”¨ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
    $eventsource_data = New-Object System.Diagnostics.EventSourceCreationData($target_source, $target_logtype)
    # ç‹¬è‡ªã®ã‚½ãƒ¼ã‚¹ã‚’ä½œæˆ
    [System.Diagnostics.EventLog]::CreateEventSource($eventsource_data)
    ```

    :::message
    **æ³¨æ„ï¼šCreateEventSourceã‚’ç®¡ç†è€…ã§å®Ÿè¡Œã—ãªã‹ã£ãŸå ´åˆ**

    ä¸‹è¨˜ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—æ­£å¸¸çµ‚äº†ã—ãªã„ã€‚

    ```powershell:ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§å®Ÿè¡Œã—ãªã‹ã£ãŸå ´åˆã¯ã‚¨ãƒ©ãƒ¼
    PS C:\Users\"ãƒ¦ãƒ¼ã‚¶ãƒ¼å"> [System.Diagnostics.EventLog]::CreateEventSource($eventsource_data)
    MethodInvocationException: Exception calling "CreateEventSource" with "1" argument(s): "The source was not found, but some or all event logs could not be searched.  To create the source, you need permission to read all event logs to make sure that the new source name is unique.  Inaccessible logs: Security."
    PS C:\Users\"ãƒ¦ãƒ¼ã‚¶ãƒ¼å">
    ```

    :::

    :::details ä½œæˆã—ãŸã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ã™ã‚‹æ–¹æ³•

    ```powershell:ç®¡ç†è€…æ¨©é™ã¨ã—ã¦å®Ÿè¡Œ
    [System.Diagnostics.EventLog]::DeleteEventSource("å‰Šé™¤å¯¾è±¡ã®ã‚½ãƒ¼ã‚¹å")
    ```

    ```powershell:å®Ÿéš›ã«å®Ÿè¡Œã—ãŸçµæœ
    PS C:\WINDOWS\system32> $target_source
    MyAppSource
    PS C:\WINDOWS\system32>
    PS C:\WINDOWS\system32> [System.Diagnostics.EventLog]::DeleteEventSource($target_source)
    PS C:\WINDOWS\system32>
    ```

    :::

1. ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ã®å‡ºåŠ›

    ```powershell:ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚‚å®Ÿè¡Œå¯èƒ½
    # ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°æ›¸ãè¾¼ã¿ç”¨ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
    $eventlog_data = New-Object System.Diagnostics.EventLog($target_logtype)
    # ã‚½ãƒ¼ã‚¹ã‚’æŒ‡å®š
    $eventlog_data.Source = $target_source
    # ã€Œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ã€ãƒ¬ãƒ™ãƒ«ã€ã‚¤ãƒ™ãƒ³ãƒˆIDã€ã‚’æŒ‡å®šã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ã«å‡ºåŠ›
    $eventlog_data.WriteEntry("Test Message.", "Information", 1001)
    ```

    ![WriteEntryã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã‚Šå‡ºåŠ›ã—ãŸãƒ­ã‚°ã‚’ã‚¤ãƒ™ãƒ³ãƒˆãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã§ç¢ºèª](https://storage.googleapis.com/zenn-user-upload/9b832ef0ae8c-20240305.png =500x)
    *ç”»åƒï¼šWriteEntryã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã‚Šå‡ºåŠ›ã—ãŸãƒ­ã‚°ã‚’ã‚¤ãƒ™ãƒ³ãƒˆãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã§ç¢ºèª*
