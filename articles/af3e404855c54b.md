---
title: "PowerShell 6.0以降で独自のイベントログを出力する方法"
emoji: "🦁"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["powershell", "dotnet"]
published: false
---
## 概要

Windowsで標準インストールされているPowerShell 5.1をはじめとする6.0よりも前のバージョンでは、
New-EvnetLogコマンドレットやWrite-EventLogコマンドレットなどを使用して独自のイベントログが出力できるそう。

ただ、PowerShell 6.0以降のCore Editionでは、それらのコマンドレットは使用できません。
今回、バージョンが6.0以降でも独自のイベントログを出力できる方法を調べました。

イベントビューアー

管理者権限

## 環境

```powershell
PS C:\Users\"ユーザー名"> $PSVersionTable

Name                           Value
----                           -----
PSVersion                      7.4.1
PSEdition                      Core
GitCommitId                    7.4.1
OS                             Microsoft Windows 10.0.19045
Platform                       Win32NT
PSCompatibleVersions           {1.0, 2.0, 3.0, 4.0…}
PSRemotingProtocolVersion      2.3
SerializationVersion           1.1.0.1
WSManStackVersion              3.0

PS C:\Users\"ユーザー名">
```

## 対応方法

PowerShell 6.0以降の環境で登録済みのソース・イベントIDのケースは、New-WinEventコマンドレットで対応できそうでしたが、
独自のソース・イベントIDを作成するコマンドレットは調べきれませんでした。（おそらく、何かしらの方法で対応はできると思われます）

今回、.Net Frameworkの[System.Diagnostics.EventLogクラス](https://learn.microsoft.com/ja-jp/dotnet/api/system.diagnostics.eventlog)で実現する方法が見つかりました。


1. 管理者権限でPowerShellを起動
    PowerShellウィンドウであれば、⊞Windowsキー ＋ R でファイル名を指定して実行(R)を起動。
    「`pwsh`」を入力し、Ctrl ＋ Shift ＋ Enter で管理者として実行。

1. イベントビューアーで記録する場所とソースを指定

    ```powershell
    $target_logtype = "Application"
    $target_source = "MyAppSource"
    ```

    ```powershell:存在するソースか判定する場合
    if ([System.Diagnostics.EventLog]::SourceExists($target_source)) {
        # 存在する場合の処理
    }
    else {
        # 存在しない場合の処理
    }
    ```

1. イベントソースの作成

    ```powershell:
    # ソース作成用のオブジェクトを作成
    $eventsource_data = New-Object System.Diagnostics.EventSourceCreationData($target_source, $target_logtype)
    # 独自のソースを作成
    [System.Diagnostics.EventLog]::CreateEventSource($eventsource_data)
    ```

    :::message
    **注意：管理者権限としてPowerShellを実行していない場合**

    下記のエラーが発生。

    ```powershell:
    PS C:\Users\"ユーザー名"> [System.Diagnostics.EventLog]::CreateEventSource($eventsource_data)
    MethodInvocationException: Exception calling "CreateEventSource" with "1" argument(s): "The source was not found, but some or all event logs could not be searched.  To create the source, you need permission to read all event logs to make sure that the new source name is unique.  Inaccessible logs: Security."
    PS C:\Users\"ユーザー名">
    ```

    :::

1. イベントログの出力

    ```powershell:
    # イベントログ書き込み用のオブジェクトを作成
    $eventlog_data = New-Object System.Diagnostics.EventLog($target_logtype)
    # ソースを指定
    $eventlog_data.Source = $target_source
    # 「メッセージ内容、レベル、イベントID」を指定してイベントログに出力
    $eventlog_data.WriteEntry("Test Message.", "Information", 1001)
    ```

    ![イベントビューアーで出力したイベントログを確認](https://storage.googleapis.com/zenn-user-upload/9b832ef0ae8c-20240305.png =500x)
    *画像：イベントビューアーで出力したイベントログを確認*
