---
title: "[PowerShell]Markdownのテーブル形式で各列の幅を揃えるFunction"
emoji: "📘"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["powershell"]
published: false
---
## 概要

列の幅がバラバラになっているMarkdownのテーブル形式の開始位置を半角スペースで整頓するFuncitonを作成。

```powershell:
# UTF8 BOM付きか判定するFunction
function Test-UTF8Bom {
    param (
        [Parameter(Mandatory=$true)][System.String]$FilePath
    )
    
    # BOMのバイトシーケンス
    $UTF8_BOM = [System.Byte[]](0xEF,0xBB,0xBF)
    
    # 先頭行をバイトで読み込み先頭から3バイト分のデータを取得
    [System.Byte[]]$first_4bytes = (Get-Content -Path $FilePath -Encoding Byte -TotalCount 4)
    [System.Byte[]]$first_3bytes = $first_4bytes[0..2]
    [System.Byte[]]$first_2bytes = $first_4bytes[0..1]
    
    # 先頭バイトでBOM付きか判定
    # UTF-8
    if ($null -eq (Compare-Object $first_3bytes $UTF8_BOM -SyncWindow 0)) {
        return $true
    }
    else {
        return $false
    }
}
function Format-MarkdownTableColumnWidth {
    param (
        [System.String]$FilePath
    )

    # 文字コードの判定
    if (-not (Test-UTF8Bom $FilePath)) {
        Write-Warning 'Not UTF8 BOM'
        return
    }

    # マルチバイト文字を考慮して文字列のバイト数を計算する関数
    function Get-ByteLength {
        param (
            [string]$InputString
        )
        $length = 0
        foreach ($char in $InputString.ToCharArray()) {
            if ([System.Text.Encoding]::UTF8.GetByteCount($char) -gt 1) {
                $length += 2
            } else {
                $length += 1
            }
        }
        return $length
    }

    # ファイルから入力を読み込む
    $MarkdownTable = (Get-Content -Path $FilePath -Raw)

    # 入力を行ごとに分割
    $lines = $MarkdownTable -split "`n"

    # 各列の最大幅を計算
    $maxWidths = @{}
    foreach ($line in $lines) {
        if (-not ([System.String]::IsNullOrWhiteSpace($line))) {
            $columns = $line -split '\|'
            for ($i = 1; $i -lt $columns.Length - 1; $i++) {
                $column = $columns[$i].Trim()
                $byteLength = (Get-ByteLength $column)
                if (-not $maxWidths.ContainsKey($i)) {
                    $maxWidths[$i] = $byteLength
                } else {
                    if ($byteLength -gt $maxWidths[$i]) {
                        $maxWidths[$i] = $byteLength
                    }
                }
            }
        }
    }

    # 列の幅を揃えて再構築
    $alignedTable = @()
    foreach ($line in $lines) {
        if ($line.Trim() -eq "") { continue } # 空行を無視
        $columns = $line -split '\|'
        $newLine = "|"
        for ($i = 1; $i -lt $columns.Length - 1; $i++) {
            $column = $columns[$i].Trim()
            $padding = " " * ($maxWidths[$i] - (Get-ByteLength $column))
            $newLine += " " + $column + $padding + " |"
        }
        $alignedTable += $newLine
    }

    # エスケープされた特殊文字を元に戻す
    $alignedTable = $alignedTable -join "`r`n" -replace '\\\$', '\$' -replace '\\\|', '\|' -replace '\\\*', '\*' -replace '\\_', '_'
    
    return $alignedTable
}

# 入力ファイルのパスを指定
$inputFilePath = "D:\Downloads\input_markdowntable.md"
$outputFilePath = "D:\Downloads\output_markdowntable.md"

# 関数を呼び出して結果をファイルに出力
Format-MarkdownTableColumnWidth $inputFilePath > $outputFilePath
```

```markdown:入力ファイル「input_markdowntable.md」
| column-A | column-B | column-C |
| --- | --- | --- |
| value-A1 | B1 | C1 |
| A2 | column-B2 | C2 |
| A3 | B3 | column-C3 |

```

```markdown:出力ファイル「output_markdowntable.md」
| column-A | column-B  | column-C  |
| ---      | ---       | ---       |
| value-A1 | B1        | C1        |
| A2       | column-B2 | C2        |
| A3       | B3        | column-C3 |

```
