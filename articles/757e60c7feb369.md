---
title: "PowerShellスクリプトでリソースを削除する際に自分自身も最後に削除する方法"
emoji: "⛳"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["powershell"]
published: false
---
##

削除自体は、Remove-Itemで自身のフルパスを指定する事で対応可能だが、
もし、削除対象が自身を格納されているフォルダーも含まれていた場合は、
工夫が必要。

実際に削除する際の構成を作成して、サンプルプログラムを作成して検証してみる。

-----

PowerShellスクリプトでリソースの削除処理を作成し、スクリプト自体も実行後に削除する方法はいくつかあります。以下にその方法をいくつか示します：

1. **スクリプト終了後に自己削除**:
   ```powershell
   # スクリプトの最後に以下のコマンドを追加
   Start-Sleep -Seconds 10
   Remove-Item $MyInvocation.MyCommand.Path -Force
   ```
   このコマンドは、スクリプトが終了してから10秒後にスクリプトファイルを強制的に削除します。

2. **一時ファイルとして実行**:
   スクリプトを一時ファイルとして実行し、実行後に自動的に削除されるようにします。これは、スクリプトをメモリ上で実行することで実現できます。

3. **別のスクリプトによる削除**:
   スクリプトが終了した後に、別のスクリプトを実行して元のスクリプトを削除する方法です。例えば、以下のようなバッチファイルを使用してPowerShellスクリプトを削除することができます¹。

   ```batch
   @echo off
   :loop
   del "C:\path\to\your\script.ps1"
   if exist "C:\path\to\your\script.ps1" goto loop
   ```

4. **スケジュールされたタスクによる削除**:
   スケジュールされたタスクを作成し、スクリプトの実行が完了した後にスクリプトファイルを削除するように設定します。

これらの方法を使用する際には、スクリプトが重要な処理を行っている場合に誤って削除しないように注意が必要です。また、セキュリティの観点から、自己削除機能を持つスクリプトの使用は慎重に行うべきです。²

ソース: Bing との会話 2024/5/22
(1) 実行したファイルを自爆（自分自身を削除）するコマンド .... https://amksystem.com/cmd/self-delete/.
(2) PowerShelプログラム実行後、スクリプト自体を削除する方法 .... https://www.binarydevelop.com/article/powershel-8682.
(3) PowerShelプログラム実行後、スクリプト自体を削除する方法 .... https://bing.com/search?q=PowerShell%e3%82%b9%e3%82%af%e3%83%aa%e3%83%97%e3%83%88+%e5%ae%9f%e8%a1%8c%e5%be%8c+%e8%87%aa%e5%b7%b1%e5%89%8a%e9%99%a4%e6%96%b9%e6%b3%95.

## 対応方法

下記のルールでPowerShellのコードを生成してください。
・最初に実行するPowerShellスクリプトで一時フォルダー配下に新たなPowerShellスクリプトを作成
・スクリプトを作成する一時フォルダーはシステムで使用される作業場所を自動変数などから取得
・一時フォルダーの候補を複数提案
・新たに作成したPowerShellスクリプトでは、実行したPowerShellスクリプトが格納されているフォルダーを削除する
・新たに作成したPowerShellスクリプトでは、実行元のスクリプトの終了を待ち合わせる処理を冒頭で実施
・最初に実行するPowerShellスクリプトで削除スクリプトを実行後、すぐに終了する。
・非同期処理と同期処理の2パターンを提案
・考えうる対応方法をすべて提案

-----

PowerShellスクリプトの要件に基づいて、以下のコードを提案します。一時フォルダーの候補としては、`$env:TEMP`や`$env:TMP`などの環境変数を使用することが一般的です。これらはシステムが自動的に割り当てる一時的なファイルを保存する場所を指します。

まず、最初に実行するスクリプトを作成し、そのスクリプトが新たなPowerShellスクリプトを一時フォルダーに作成し、そのスクリプトが実行元のスクリプトが格納されているフォルダーを削除するようにします。非同期処理と同期処理の両方のパターンを含めます。

```powershell
# 最初に実行するスクリプト
$scriptPath = $MyInvocation.MyCommand.Path
$tempPath = [System.IO.Path]::GetTempPath()

# 一時フォルダーに新たなスクリプトを作成
$newScriptPath = Join-Path $tempPath "deleteScript.ps1"
$deleteScriptContent = @"
Remove-Item -Path (Split-Path -Parent `"$scriptPath`") -Recurse -Force
"@
Set-Content -Path $newScriptPath -Value $deleteScriptContent

# 非同期処理パターン
Start-Job -ScriptBlock {
    param($newScriptPath, $scriptPath)
    Start-Sleep -Seconds 2 # 実行元のスクリプトの終了を待つ
    & PowerShell -File $newScriptPath
} -ArgumentList $newScriptPath, $scriptPath

# 同期処理パターン
# Start-Process -FilePath "PowerShell" -ArgumentList "-File `"$newScriptPath`"" -WindowStyle Hidden

# スクリプトを実行後、すぐに終了
exit
```

このスクリプトは、最初に実行するスクリプトが終了した後、2秒間待ってから新たに作成したスクリプトを実行します。非同期処理では`Start-Job`を使用し、同期処理ではコメントアウトされた`Start-Process`を使用します。必要に応じて、非同期処理か同期処理かを選択してください。

**注意**: このコードは実行すると、実行元のスクリプトが格納されているフォルダーを削除します。重要なデータを失わないように、実行前に十分に確認してください。
