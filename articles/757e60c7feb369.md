---
title: "PowerShellスクリプトでリソースを削除する際に自分自身も最後に削除する方法"
emoji: "⛳"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["powershell"]
published: false
---
##

削除自体は、Remove-Itemで自身のフルパスを指定する事で対応可能だが、
もし、削除対象が自身を格納されているフォルダーも含まれていた場合は、
工夫が必要。

実際に削除する際の構成を作成して、サンプルプログラムを作成して検証してみる。

-----

PowerShellスクリプトでリソースの削除処理を作成し、スクリプト自体も実行後に削除する方法はいくつかあります。以下にその方法をいくつか示します：

1. **スクリプト終了後に自己削除**:
   ```powershell
   # スクリプトの最後に以下のコマンドを追加
   Start-Sleep -Seconds 10
   Remove-Item $MyInvocation.MyCommand.Path -Force
   ```
   このコマンドは、スクリプトが終了してから10秒後にスクリプトファイルを強制的に削除します。

2. **一時ファイルとして実行**:
   スクリプトを一時ファイルとして実行し、実行後に自動的に削除されるようにします。これは、スクリプトをメモリ上で実行することで実現できます。

3. **別のスクリプトによる削除**:
   スクリプトが終了した後に、別のスクリプトを実行して元のスクリプトを削除する方法です。例えば、以下のようなバッチファイルを使用してPowerShellスクリプトを削除することができます¹。

   ```batch
   @echo off
   :loop
   del "C:\path\to\your\script.ps1"
   if exist "C:\path\to\your\script.ps1" goto loop
   ```

4. **スケジュールされたタスクによる削除**:
   スケジュールされたタスクを作成し、スクリプトの実行が完了した後にスクリプトファイルを削除するように設定します。

これらの方法を使用する際には、スクリプトが重要な処理を行っている場合に誤って削除しないように注意が必要です。また、セキュリティの観点から、自己削除機能を持つスクリプトの使用は慎重に行うべきです。²

ソース: Bing との会話 2024/5/22
(1) 実行したファイルを自爆（自分自身を削除）するコマンド .... https://amksystem.com/cmd/self-delete/.
(2) PowerShelプログラム実行後、スクリプト自体を削除する方法 .... https://www.binarydevelop.com/article/powershel-8682.
(3) PowerShelプログラム実行後、スクリプト自体を削除する方法 .... https://bing.com/search?q=PowerShell%e3%82%b9%e3%82%af%e3%83%aa%e3%83%97%e3%83%88+%e5%ae%9f%e8%a1%8c%e5%be%8c+%e8%87%aa%e5%b7%b1%e5%89%8a%e9%99%a4%e6%96%b9%e6%b3%95.

## 調査

### 非同期処理で削除する方法



### 同期処理で削除する方法

PowerShellスクリプトを実行する際、処理の最後にPowerShellスクリプト自身の格納先をふくめて削除する処理を設けたいと考えている。

そのような場合、どのような構成と手法でスクリプトを実行した方がよいか複数、提案してください。

なお、非同期による処理だと確実性が下がるので、同期処理で対応できる方法に絞って提案してください。

-----

PowerShellスクリプトを実行した後に自身を削除するには、いくつかの方法があります。以下に同期処理で対応可能な2つの方法を提案します。

1. **一時ファイルを使用する方法:**

    ```powershell
    $tempScript = [System.IO.Path]::GetTempFileName() + ".ps1"

    # スクリプトが一時ファイルから実行されているかをチェック
    if ($MyInvocation.MyCommand.Definition -eq $tempScript) {
        # 一時ファイルから実行されている場合の処理
        # ここにメインのスクリプト処理を記述

        # 処理完了後、一時ファイルを削除
        Remove-Item -Path $tempScript -Force
    } else {
        # オリジナルのスクリプトから実行されている場合、一時ファイルを作成して実行
        Get-Content $MyInvocation.MyCommand.Definition | Set-Content $tempScript
        Start-Process powershell -ArgumentList "-File `"$tempScript`"" -WindowStyle Hidden
        exit
    }
    ```

2. **スケジュールされたタスクを使用する方法:**
   スクリプトの最後に、スケジュールされたタスクを作成して、数秒後に自身を削除するように設定します。これにより、スクリプトが完全に終了した後に削除が行われます。

   ```powershell
   $action = New-ScheduledTaskAction -Execute "PowerShell.exe" -Argument "-Command `"Remove-Item -Path '$MyInvocation.MyCommand.Definition' -Force`""
   $trigger = New-ScheduledTaskTrigger -Once -At (Get-Date).AddSeconds(10)
   Register-ScheduledTask -Action $action -Trigger $trigger -TaskName "SelfDelete" -RunLevel Highest -Force
   ```

これらの方法は、スクリプトが他の処理を完了した後に自身を削除するための同期的なアプローチです。スクリプトの内容や実行環境に応じて、適切な方法を選択してください。また、これらの操作は慎重に行う必要があります。特に、スケジュールされたタスクを使用する場合は、システムに予期せぬ影響を与えないように注意してください。実行前には、テスト環境での検証をお勧めします。