---
title: "Expand-Archive（もしくはExtractToDirectory）で文字化けする場合の対応方法（PowerShell x 解凍）"
emoji: "🧊"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["powershell", "zip"]
published: true
---

先日、ZIPファイルの解凍処理を行うPowerShellスクリプトを作成しました。そのスクリプトをテストしていた時に、なぜか解凍後のファイル名が文字化けしてしまう現象が発生。
対応方法として最初、Windows OSの文字コードを変更するためのレジストリ修正を検討しましたが、影響範囲が広くリスクがありそうなので断念。
**他の対処方法** を調べてみました。

## この記事のターゲット

- PowerShellユーザーの方
- 日本語などマルチバイトの名前を含むZIPファイルを正常に解凍したい方
- 危険が伴うレジストリの変更は避けた他の対応方法を知りたい方

## なぜ、PowerShellの解凍で文字化けしてしまうのか

PowerShellで標準搭載されている機能は下記の2点です。

- **Expand-Archive**: PowerShell標準搭載のコマンドレット
  
- **ExtractToDirectory**: \.NET（ドットネット）のフレームワークから呼び出すメソッド

```powershell
$zipPath = "解凍するZIPファイルのパス"
$outputPath = "解凍後の出力先のパス"

# PowerShell標準搭載のコマンドレット
Expand-Archive -Path $zipPath -DestinationPath $outputPath

# .NETから呼び出すメソッド
([System.IO.Compression.ZipFile]::ExtractToDirectory($zipPath, $outputPath))
```

これら機能は、各バージョンのPowerShellに標準搭載。内部処理の文字コードでは「UTF-8」が採用されているようです。
一方、Windows 日本語OSのフォルダーやファイルの名前で採用されているのは、レガシーな文字コードである「Shift JIS」。

このようにコマンドレット・メソッド（関数）の機能 と フォルダー・ファイルの名前 の文字コードがでチグハグな関係性となっており、
このことがフォルダー名やファイル名が **文字化けしている要因** だと思われます。

なお、起きている不具合は名前のみで **解凍処理そのものは正常** に終えています。

つぎから解決するために検証したことを紹介します。

## 実際に文字化けを確認してみる

まず、圧縮対象のフォルダー内の日本語を含む名前のファイルを準備し、同じ場所にZIPファイルも配置。

```powershell:日本語を含む名前のファイルを準備
PS D:\Desktop\Test_7Zip4Powershell> tree /F .\CompressedFile-Containing-MultibyteCharacters
フォルダー パスの一覧:  ボリューム ボリューム
ボリューム シリアル番号は 0000XXXX XXXX:XXXX です
D:\DESKTOP\TEST_7ZIP4POWERSHELL\COMPRESSEDFILE-CONTAINING-MULTIBYTECHARACTERS
    Only-Alphabet.txt
    マルチバイト（日本語）を含む.txt

サブフォルダーは存在しません

PS D:\Desktop\Test_7Zip4Powershell>
```

下記のとおり、PowerShellコマンドレット「**Expand-Archive**」で解凍すると解凍そのものは正常終了しますが、
解凍先のファイル名が文字化けしてしまいました。

```powershell:実際に実行した結果
PS D:\Desktop\Test_7Zip4Powershell> $zipPath = ".\CompressedFile-Containing-MultibyteCharacters.zip"
PS D:\Desktop\Test_7Zip4Powershell> $outputPath = ".\"
PS D:\Desktop\Test_7Zip4Powershell>
PS D:\Desktop\Test_7Zip4Powershell> Expand-Archive -Path $zipPath -DestinationPath $outputPath
PS D:\Desktop\Test_7Zip4Powershell>
PS D:\Desktop\Test_7Zip4Powershell> tree /F .\CompressedFile-Containing-MultibyteCharacters
フォルダー パスの一覧:  ボリューム ボリューム
ボリューム シリアル番号は 0000XXXX XXXX:XXXX です
D:\DESKTOP\TEST_7ZIP4POWERSHELL\COMPRESSEDFILE-CONTAINING-MULTIBYTECHARACTERS
    Only-Alphabet.txt
    �}���`�o�C�g�i���{��j���܂�.txt

サブフォルダーは存在しません

PS D:\Desktop\Test_7Zip4Powershell>Powershell>
```

\.NETにおける `System.IO.Compression.ZipFile` のメソッド「**ExtractToDirectory**」で解凍しても、
`Expand-Archive`と同じように解凍は正常、解凍先は文字化けという結果に。

```powershell
PS D:\Desktop\Test_7Zip4Powershell> [System.IO.Compression.ZipFile]::ExtractToDirectory($zipPath, $outputPath)
PS D:\Desktop\Test_7Zip4Powershell>
PS D:\Desktop\Test_7Zip4Powershell> tree /F .\CompressedFile-Containing-MultibyteCharacters
フォルダー パスの一覧:  ボリューム ボリューム
ボリューム シリアル番号は 0000XXXX XXXX:XXXX です
D:\DESKTOP\TEST_7ZIP4POWERSHELL\COMPRESSEDFILE-CONTAINING-MULTIBYTECHARACTERS
    Only-Alphabet.txt
    �}���`�o�C�g�i���{��j���܂�.txt

サブフォルダーは存在しません

PS D:\Desktop\Test_7Zip4Powershell>
```

## 検証したこと

下記のように文字コードを変える方法を検討しましたが、期待通りの結果とはなりませんでした。

- 【検証中止】レジストリの修正でWindows OSの文字コードを変更する方法
    日本語OSで前提している文字コードを変更する場合は危険と感じ、この検証は中止しました。

- 【検証結果：NG】一時的にPowerShellの文字コードを変更する方法
    下記のように一時的に文字コードを切り替える事で文字化けを回避できないか検証しましたが、
    変わらず文字化けしてしまいました。

    ```powershell:解凍前に文字コードを「Shift JIS」へ変更
    chcp 932  # Shift_JISに変更
    $OutputEncoding = [System.Text.Encoding]::GetEncoding("shift_jis")
    ```

    ```powershell:解凍後に文字コードを「UTF-8」に戻す
    chcp 65001  # UTF-8に変更
    $OutputEncoding = [System.Text.Encoding]::UTF8
    ```

## 解決方法（回避方法）

文字化けしてしまうコマンドレットとメソッドの使用を避けて、代替えとなる機能を探した結果、
「**7Zip4Powershell**」というモジュールに行き着きました。

精力的に更新されていないようですが、オープンソースのモジュールを活用することで、
文字化けすることなくZIPファイルの解凍が可能です。

### 「7Zip4Powershell」モジュールのインストール

下記のコマンドでインストールできます。初回はインストールして良いか確認メッセージが表示されるので、
問題なければ `Y` か `A` を選択してインストールを続行してください。

```powershell:7Zip4Powershellモジュールをインストール
PS C:\Users\XXXX> Install-Module -Name 7Zip4Powershell

Untrusted repository
You are installing the modules from an untrusted repository. If you trust this repository, change its
InstallationPolicy value by running the Set-PSRepository cmdlet. Are you sure you want to install the modules from
'PSGallery'?
[Y] Yes  [A] Yes to All  [N] No  [L] No to All  [S] Suspend  [?] Help (default is "N"): a
PS C:\Users\Administrator>

# 対象のモジュールがインストールされたこと①
PS C:\Users\Administrator> Get-InstalledModule

Version              Name                                Repository           Description
-------              ----                                ----------           -----------
2.7.0                7Zip4Powershell                     PSGallery            Powershell module for creating and extra…

PS C:\Users\XXXX>

# 対象のモジュールがインストールされたこと②
PS C:\Users\XXXX> Get-Package -name 7Zip4Powershell

Name                           Version          Source                           ProviderName
----                           -------          ------                           ------------
7Zip4Powershell                2.7.0            https://www.powershellgallery.c… PowerShellGet

PS C:\Users\XXXX>
```

### 「Expand-7Zip」の解凍で文字化けしない

```powershell:「Expand-7Zip」で解凍
PS D:\Desktop\Test_7Zip4Powershell> Expand-7Zip -ArchiveFileName $zipPath -TargetPath $outputPath
PS D:\Desktop\Test_7Zip4Powershell> 
PS D:\Desktop\Test_7Zip4Powershell> tree /F .\CompressedFile-Containing-MultibyteCharacters
フォルダー パスの一覧:  ボリューム ボリューム
ボリューム シリアル番号は 0000XXXX XXXX:XXXX です
D:\DESKTOP\TEST_7ZIP4POWERSHELL\COMPRESSEDFILE-CONTAINING-MULTIBYTECHARACTERS
    Only-Alphabet.txt
    マルチバイト（日本語）を含む.txt

サブフォルダーは存在しません

PS D:\Desktop\Test_7Zip4Powershell>
```

## まとめ

PowerShellの標準機能では文字コードの制御が問題で解凍したフォルダーやファイルの名前が文字化けしてしまうが、
モジュール **7Zip4Powershell** の「**Expand-7Zip**」コマンドレットを使用することで回避できました！

強力な機能をもっているPowerShellですが、とくに言語まわりの細かい不具合が多い印象です。
おそらく最初から英語OSだったり、名前に日本語を使用しないとすれば問題ないのでしょうが、ロケーションが日本だとその対応方法は難しそう。

いっそのこと、互換を捨てたグローバル用のWindows OSというのも需要がありそうな気がしますが、どうなんでしょうね。

## 参考文献

https://github.com/thoemmi/7Zip4Powershell

https://qiita.com/LightSilver7/items/a2532cc6e33757bb9edb
