---
title: "Expand-Archive（もしくはExtractToDirectory）で文字化けする場合の対応方法（PowerShell x 解凍）"
emoji: "🧊"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["powershell", "zip"]
published: true
---

先日、ZIPファイルの解凍処理を行うPowerShellスクリプトを作成しました。そのスクリプトをテストしていた時にタイトル通り、なぜか解凍後のファイル名が文字化けしてしまう現象が発生。
調べた結果、解凍対象のZIPファイルがShift JISで圧縮されたファイルであり、PowerShellの標準的なコマンドレットやメソッドを使うと文字コードの不一致により文字化けしていることがわかりました。

それらをふまえた対応方法を紹介します。

## この記事のターゲット

- PowerShellユーザーの方
- 日本語などマルチバイトの名前を含むZIPファイルを正常に解凍したい方
- 危険が伴うレジストリの変更は避けた他の対応方法を知りたい方

## なぜ、PowerShellの解凍で文字化けしてしまうのか

PowerShellで標準搭載されている機能は下記の2点です。

- **Expand-Archive**: PowerShell標準搭載のコマンドレット
  
- **ExtractToDirectory**: \.NET（ドットネット）のフレームワークから呼び出すメソッド

```powershell
$zipPath = "解凍するZIPファイルのパス"
$outputPath = "解凍後の出力先のパス"

# PowerShell標準搭載のコマンドレット
Expand-Archive -Path $zipPath -DestinationPath $outputPath

# .NETから呼び出すメソッド
Add-Type -AssemblyName System.IO.Compression.FileSystem
([System.IO.Compression.ZipFile]::ExtractToDirectory($zipPath, $outputPath))
```

これら機能は、各バージョンのPowerShellに標準搭載。これらのエンコードは「UTF-8」が採用されています。
一方、Windows 10（11は未検証）においてGUI操作で圧縮できるような古い規格のツール（例: 右クリック → 送る → ZIP圧縮）のエンコードは、
「**Shift-JIS**」が採用。

このように圧縮した際のエンコードと解凍する時のエンコードがチグハグになっているため、UTF-8で解凍した際にフォルダー名やファイル名が文字化けしてしまう事がわかりました。

なお、起きている不具合は名前のみで **解凍処理そのものは正常** に終えています。

つぎから解決するために検証したことを紹介します。

## 実際に文字化けを確認してみる

まず、フォルダー内に日本語を含む名前のファイルを準備。同じ場所に **エンコードがShift-JISで圧縮** したファイルを配置。

```powershell:日本語を含む名前のファイルを準備
PS D:\Desktop\Test_7Zip4Powershell> tree /F .\CompressedFile-Containing-MultibyteCharacters
フォルダー パスの一覧:  ボリューム ボリューム
ボリューム シリアル番号は 0000XXXX XXXX:XXXX です
D:\DESKTOP\TEST_7ZIP4POWERSHELL\COMPRESSEDFILE-CONTAINING-MULTIBYTECHARACTERS
    Only-Alphabet.txt
    マルチバイト（日本語）を含む.txt

サブフォルダーは存在しません

PS D:\Desktop\Test_7Zip4Powershell>
```

下記のとおり、PowerShellコマンドレット「**Expand-Archive**」で解凍すると解凍そのものは正常終了しますが、
解凍先のファイル名が文字化けしてしまいました。

```powershell:実際に実行した結果
PS D:\Desktop\Test_7Zip4Powershell> $zipPath = ".\CompressedFile-Containing-MultibyteCharacters.zip"
PS D:\Desktop\Test_7Zip4Powershell> $outputPath = ".\"
PS D:\Desktop\Test_7Zip4Powershell>
PS D:\Desktop\Test_7Zip4Powershell> Expand-Archive -Path $zipPath -DestinationPath $outputPath
PS D:\Desktop\Test_7Zip4Powershell>
PS D:\Desktop\Test_7Zip4Powershell> tree /F .\CompressedFile-Containing-MultibyteCharacters
フォルダー パスの一覧:  ボリューム ボリューム
ボリューム シリアル番号は 0000XXXX XXXX:XXXX です
D:\DESKTOP\TEST_7ZIP4POWERSHELL\COMPRESSEDFILE-CONTAINING-MULTIBYTECHARACTERS
    Only-Alphabet.txt
    �}���`�o�C�g�i���{��j���܂�.txt

サブフォルダーは存在しません

PS D:\Desktop\Test_7Zip4Powershell>Powershell>
```

\.NETにおける `System.IO.Compression.ZipFile` のメソッド「**ExtractToDirectory**」で解凍しても、
`Expand-Archive`と同じように解凍は正常、解凍先は文字化けという結果に。

```powershell
PS D:\Desktop\Test_7Zip4Powershell> [System.IO.Compression.ZipFile]::ExtractToDirectory($zipPath, $outputPath)
PS D:\Desktop\Test_7Zip4Powershell>
PS D:\Desktop\Test_7Zip4Powershell> tree /F .\CompressedFile-Containing-MultibyteCharacters
フォルダー パスの一覧:  ボリューム ボリューム
ボリューム シリアル番号は 0000XXXX XXXX:XXXX です
D:\DESKTOP\TEST_7ZIP4POWERSHELL\COMPRESSEDFILE-CONTAINING-MULTIBYTECHARACTERS
    Only-Alphabet.txt
    �}���`�o�C�g�i���{��j���܂�.txt

サブフォルダーは存在しません

PS D:\Desktop\Test_7Zip4Powershell>
```

:::details 補足情報: エンコードがShift-JISの圧縮処理をコードで行い、文字化けを検証してみました。

```powershell:参照元と出力先を設定
$CompressFrom = "D:\Desktop\Test_7Zip4Powershell\TargetFolder"
$CompressTo = "D:\Desktop\Test_7Zip4Powershell\TargetFolder.zip"
$ExtractFrom = "D:\Desktop\Test_7Zip4Powershell\TargetFolder.zip"
$ExtractTo = "D:\Desktop\Test_7Zip4Powershell\Extract"
```

```powershell:CompressFromの圧縮対象フォルダーの中身を確認
PS D:\Desktop\Test_7Zip4Powershell> tree /f .\TargetFolder
フォルダー パスの一覧: ボリューム ボリューム
ボリューム シリアル番号は 0000XXXX XXXX:XXXX です
D:\DESKTOP\TEST_7ZIP4POWERSHELL\TARGETFOLDER
 Only-Alphabet.txt
 マルチバイト（日本語）のみ.txt
サブフォルダーは存在しません
PS D:\Desktop\Test_7Zip4Powershell>
```

下記コマンドでエンコードをShift-JISで圧縮。

```powershell:エンコードがShift-JISの圧縮をコマンドで実行
# ZIPファイルを生成
New-Item -ItemType File -Path $CompressTo
# ZIPファイルにデータを格納
$shell = New-Object -ComObject Shell.Application
$zip = $shell.NameSpace($CompressTo)
$source = $shell.NameSpace($CompressFrom)
$source.Items() | ForEach-Object {  $zip.CopyHere($_) }
```

下記2通りのエンコードがUTF-8のコマンドで解凍。

```powershell:エンコードがUTF-8のコマンドで解凍
# エンコードUTF-8の解凍コマンド その1
Expand-Archive $ExtractFrom $ExtractTo

# エンコードUTF-8の解凍コマンド その2
Add-Type -AssemblyName System.IO.Compression.FileSystem
[System.IO.Compression.ZipFile]::ExtractToDirectory($ExtractFrom , $ExtractTo)
```

どちらのコマンドでも、同じように文字化けが発生。

```powershell:文字化けが発生
PS D:\Desktop\Test_7Zip4Powershell> tree /F .\Extract\
フォルダー パスの一覧:  ボリューム ボリューム
ボリューム シリアル番号は 0000XXXX XXXX:XXXX です
D:\DESKTOP\TEST_7ZIP4POWERSHELL\EXTRACT
    Only-Alphabet.txt
    �}���`�o�C�g�i���{��j�̂�.txt

サブフォルダーは存在しません

PS D:\Desktop\Test_7Zip4Powershell>
```

圧縮のエンコードをShift-JISではなく、UTF-8でエンコードするPowerShellのコマンド・メソッドを使用してみる。

```powershell:エンコードがUTF-8のコマンドで圧縮
# エンコードUTF-8の圧縮コマンド その1
Compress-Archive $CompressFrom $CompressTo

# エンコードUTF-8の圧縮コマンド その2
Add-Type -AssemblyName System.IO.Compression.FileSystem
[System.IO.Compression.ZipFile]::CreateFromDirectory($CompressFrom , $CompressTo)
```

前述したエンコードがUTF-8の解凍コマンドを実行し、文字化けせずに解凍できたことを確認。

```powershell:圧縮・解凍の両方ともエンコードがUTF-8のコマンドを実行すると文字化けしない
# エンコードがUTF-8で圧縮・解凍その1
PS D:\Desktop\Test_7Zip4Powershell> Compress-Archive $CompressFrom $CompressTo
PS D:\Desktop\Test_7Zip4Powershell>
PS D:\Desktop\Test_7Zip4Powershell> Expand-Archive $ExtractFrom $ExtractTo
PS D:\Desktop\Test_7Zip4Powershell>
PS D:\Desktop\Test_7Zip4Powershell> tree /f .\Extract
フォルダー パスの一覧:  ボリューム ボリューム
ボリューム シリアル番号は 0000XXXX XXXX:XXXX です
D:\DESKTOP\TEST_7ZIP4POWERSHELL\EXTRACT
└─TargetFolder
        Only-Alphabet.txt
        マルチバイト（日本語）のみ.txt

PS D:\Desktop\Test_7Zip4Powershell>

# エンコードがUTF-8で圧縮・解凍その2
PS D:\Desktop\Test_7Zip4Powershell> Add-Type -AssemblyName System.IO.Compression.FileSystem
PS D:\Desktop\Test_7Zip4Powershell>
PS D:\Desktop\Test_7Zip4Powershell> [System.IO.Compression.ZipFile]::CreateFromDirectory($CompressFrom , $CompressTo)
PS D:\Desktop\Test_7Zip4Powershell>
PS D:\Desktop\Test_7Zip4Powershell> [System.IO.Compression.ZipFile]::ExtractToDirectory($ExtractFrom , $ExtractTo)
PS D:\Desktop\Test_7Zip4Powershell>
PS D:\Desktop\Test_7Zip4Powershell> tree /f .\Extract
フォルダー パスの一覧:  ボリューム ボリューム
ボリューム シリアル番号は 00000013 1298:06B4 です
D:\DESKTOP\TEST_7ZIP4POWERSHELL\EXTRACT
    Only-Alphabet.txt
    マルチバイト（日本語）のみ.txt

サブフォルダーは存在しません

PS D:\Desktop\Test_7Zip4Powershell>
```

以上の結果から圧縮のエンコードがShift-JISとなっているZIPファイルに対し、解凍のエンコードがUTF-8で処理すると、
文字化けしてしまうということがわかります。

:::

## 解決方法（回避方法）

まずシンプルで手っ取り早い解決方法は、「圧縮する際の**エンコードをUTF-8**にする」です。

外部プログラムや外部システムで連携されたエンコードShift-JISのZIPファイルをそのまま使用しなければいけないケースもありそうです。
そのようなケースの場合を調査した結果、「**7Zip4Powershell**」というモジュールに行き着きました。

現在、精力的に更新されていないようですが、「**7Zip4Powershell**」はオープンソースのモジュールで一定の信頼性はありそうです。
このモジュールを使用することで解凍対象のエンコードを判定し、文字化けしないように解凍処理を自動で行ってくれます。

### 「7Zip4Powershell」モジュールのインストール

下記のコマンドでインストールできます。初回はインストールして良いか確認メッセージが表示されるので、
問題なければ `Y` か `A` を選択してインストールを続行してください。

```powershell:7Zip4Powershellモジュールをインストール
PS C:\Users\XXXX> Install-Module -Name 7Zip4Powershell

Untrusted repository
You are installing the modules from an untrusted repository. If you trust this repository, change its
InstallationPolicy value by running the Set-PSRepository cmdlet. Are you sure you want to install the modules from
'PSGallery'?
[Y] Yes  [A] Yes to All  [N] No  [L] No to All  [S] Suspend  [?] Help (default is "N"): a
PS C:\Users\Administrator>

# 対象のモジュールがインストールされたこと①
PS C:\Users\Administrator> Get-InstalledModule

Version              Name                                Repository           Description
-------              ----                                ----------           -----------
2.7.0                7Zip4Powershell                     PSGallery            Powershell module for creating and extra…

PS C:\Users\XXXX>

# 対象のモジュールがインストールされたこと②
PS C:\Users\XXXX> Get-Package -name 7Zip4Powershell

Name                           Version          Source                           ProviderName
----                           -------          ------                           ------------
7Zip4Powershell                2.7.0            https://www.powershellgallery.c… PowerShellGet

PS C:\Users\XXXX>
```

### 「Expand-7Zip」の解凍で文字化けしない

```powershell:「Expand-7Zip」で解凍
PS D:\Desktop\Test_7Zip4Powershell> Expand-7Zip -ArchiveFileName $zipPath -TargetPath $outputPath
PS D:\Desktop\Test_7Zip4Powershell> 
PS D:\Desktop\Test_7Zip4Powershell> tree /F .\CompressedFile-Containing-MultibyteCharacters
フォルダー パスの一覧:  ボリューム ボリューム
ボリューム シリアル番号は 0000XXXX XXXX:XXXX です
D:\DESKTOP\TEST_7ZIP4POWERSHELL\COMPRESSEDFILE-CONTAINING-MULTIBYTECHARACTERS
    Only-Alphabet.txt
    マルチバイト（日本語）を含む.txt

サブフォルダーは存在しません

PS D:\Desktop\Test_7Zip4Powershell>
```

## まとめ

- 文字化けしてしまう原因は、圧縮時のエンコードと解凍時のエンコードが不一致となり、文字化けしていた！
- 圧縮も解凍もUTF-8で行うのがシンプルな解決方法
- 上記が不可能な場合は、圧縮データのエンコードを自動的に判定し解凍してくれるモジュール **7Zip4Powershell** の「**Expand-7Zip**」コマンドレットを使用することで文字化けを回避・解決できた！

強力な機能をもっているPowerShellですが、とくに言語まわりの細かい不具合が多い印象です。
おそらく「Shift-JISが関係のない英語OSを使用」したり、「フォルダー名やファイル名にマルチバイト（日本語）を使用しない」とすれば問題ないのでしょうが、ロケーションが日本だとその対応方法は難しそう。

いっそのこと、互換を捨てたグローバル用のWindows OSというのも需要がありそうな気がしますが、どうなんでしょうね。

## 参考文献

https://github.com/thoemmi/7Zip4Powershell

https://qiita.com/LightSilver7/items/a2532cc6e33757bb9edb
