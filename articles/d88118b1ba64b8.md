---
title: "Expand-Archive（もしくはExtractToDirectory）の解凍で文字化けする場合"
emoji: "🙌"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["powershell"]
published: false
---
なぜ、Expand-ArchiveやExtractToDirectoryだと文字化けするか

PowerShellで標準搭載されている機能は下記の2点です。

- **Expand-Archive**: PowerShell 5.0以降で使用できるコマンドレット
  
- **ExtractToDirectory**: PowerShell 7.0以降で使用できる.NETのメソッド
  

```powershell
$zipPath = "解凍するZIPファイルのパス"
$outputPath = "解凍後の出力先のパス"

# PowerShell 5.0 以降で動作
Expand-Archive -Path $zipPath -DestinationPath $outputPath

# PowerShell 7.0 以降で動作
([System.IO.Compression.ZipFile]::ExtractToDirectory($zipPath, $outputPath))
```

これらは、PowerShellで標準搭載されている機能は、内部的に「UTF-8」が採用されています。

一方でフォルダー名やファイル名で使用されている日本語は、日本語OSの文字コード「Shift JIS」が採用。

コマンドレット・メソッドの機能 と フォルダー・ファイルの名前 の文字コードがでチグハグな関係性になっています。

このチグハグな文字コードの関係性によって今回、解凍後のフォルダーやファイルが文字化けする事象が発生したことがわかりました。

## 検証したこと

下記のように文字コードを一時的に変えてコマンドレット・関数を実行しましたが、
変わらず文字化けした。

あ

```powershell
chcp 932  # Shift_JISに変更
$OutputEncoding = [System.Text.Encoding]::GetEncoding("shift_jis")

chcp 65001  # UTF-8に変更
$OutputEncoding = [System.Text.Encoding]::UTF8
```

```powershell
# 7Zip4Powershellモジュールをインストール
PS C:\Users\XXXX> Install-Module -Name 7Zip4Powershell

Untrusted repository
You are installing the modules from an untrusted repository. If you trust this repository, change its
InstallationPolicy value by running the Set-PSRepository cmdlet. Are you sure you want to install the modules from
'PSGallery'?
[Y] Yes  [A] Yes to All  [N] No  [L] No to All  [S] Suspend  [?] Help (default is "N"): a
PS C:\Users\Administrator>

# 対象のモジュールがインストールされたこと
PS C:\Users\Administrator> Get-InstalledModule

Version              Name                                Repository           Description
-------              ----                                ----------           -----------
2.7.0                7Zip4Powershell                     PSGallery            Powershell module for creating and extra…

PS C:\Users\XXXX>

PS C:\Users\XXXX> Get-Package -name 7Zip4Powershell

Name                           Version          Source                           ProviderName
----                           -------          ------                           ------------
7Zip4Powershell                2.7.0            https://www.powershellgallery.c… PowerShellGet

PS C:\Users\XXXX>

Expand-7Zip -ArchiveFileName $zipPath -TargetPath $outputPath
```

```powershell
PS D:\Desktop\Test_7Zip4Powershell> tree /F .\CompressedFile-Containing-MultibyteCharacters
フォルダー パスの一覧:  ボリューム ボリューム
ボリューム シリアル番号は 000000A7 1298:06B4 です
D:\DESKTOP\TEST_7ZIP4POWERSHELL\COMPRESSEDFILE-CONTAINING-MULTIBYTECHARACTERS
    Only-Alphabet.txt
    マルチバイト（日本語）を含む.txt

サブフォルダーは存在しません

PS D:\Desktop\Test_7Zip4Powershell>
```

```powershell
PS D:\Desktop\Test_7Zip4Powershell> $zipPath = ".\CompressedFile-Containing-MultibyteCharacters.zip"
PS D:\Desktop\Test_7Zip4Powershell> $outputPath = ".\"
PS D:\Desktop\Test_7Zip4Powershell>
PS D:\Desktop\Test_7Zip4Powershell> Expand-Archive -Path $zipPath -DestinationPath $outputPath
PS D:\Desktop\Test_7Zip4Powershell>
PS D:\Desktop\Test_7Zip4Powershell> tree /F .\CompressedFile-Containing-MultibyteCharacters
フォルダー パスの一覧:  ボリューム ボリューム
ボリューム シリアル番号は 000000B7 1298:06B4 です
D:\DESKTOP\TEST_7ZIP4POWERSHELL\COMPRESSEDFILE-CONTAINING-MULTIBYTECHARACTERS
    Only-Alphabet.txt
    �}���`�o�C�g�i���{��j���܂�.txt

サブフォルダーは存在しません

PS D:\Desktop\Test_7Zip4Powershell>Powershell>
```

```powershell
PS D:\Desktop\Test_7Zip4Powershell> [System.IO.Compression.ZipFile]::ExtractToDirectory($zipPath, $outputPath)
PS D:\Desktop\Test_7Zip4Powershell>
PS D:\Desktop\Test_7Zip4Powershell> tree /F .\CompressedFile-Containing-MultibyteCharacters
フォルダー パスの一覧:  ボリューム ボリューム
ボリューム シリアル番号は 0000000B 1298:06B4 です
D:\DESKTOP\TEST_7ZIP4POWERSHELL\COMPRESSEDFILE-CONTAINING-MULTIBYTECHARACTERS
    Only-Alphabet.txt
    �}���`�o�C�g�i���{��j���܂�.txt

サブフォルダーは存在しません

PS D:\Desktop\Test_7Zip4Powershell>
PS D:\Desktop\Test_7Zip4Powershell>
```

```powershell
PS D:\Desktop\Test_7Zip4Powershell> Expand-7Zip -ArchiveFileName $zipPath -TargetPath $outputPath
PS D:\Desktop\Test_7Zip4Powershell> 
PS D:\Desktop\Test_7Zip4Powershell> tree /F .\CompressedFile-Containing-MultibyteCharacters
フォルダー パスの一覧:  ボリューム ボリューム
ボリューム シリアル番号は 00000034 1298:06B4 です
D:\DESKTOP\TEST_7ZIP4POWERSHELL\COMPRESSEDFILE-CONTAINING-MULTIBYTECHARACTERS
    Only-Alphabet.txt
    マルチバイト（日本語）を含む.txt

サブフォルダーは存在しません

PS D:\Desktop\Test_7Zip4Powershell>
```

## 参考文献

https://github.com/thoemmi/7Zip4Powershell

https://qiita.com/LightSilver7/items/a2532cc6e33757bb9edb