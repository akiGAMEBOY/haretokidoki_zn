---
title: "PowerShellで進捗表示したいときに使う共通化した関数を紹介"
emoji: "🗂"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["powershell"]
published: false
---

はい、承知いたしました。
PowerShellで様々なシチュエーションで利用できる、汎用的なプログレスバー表示関数を生成します。

PowerShellには標準で `Write-Progress` という強力なコマンドレットがありますが、ループ内で毎回パラメータを計算して指定するのは少し手間がかかります。そこで、その処理をラップ（包み込む）し、**「全体の数」**と**「現在の位置」**を渡すだけで簡単に見栄えの良いプログレスバーを表示できる関数を作成します。

---

### 完成したPowerShell関数 `Show-ProgressBar`

この関数は、進捗の計算と表示を自動で行い、さらに処理が完了した後にプログレスバーを非表示にする方法まで含めて、ベストプラクティスを盛り込んでいます。

```powershell
function Show-ProgressBar {
<#
.SYNOPSIS
    コレクションやループ処理の進捗状況を分かりやすくプログレスバーで表示します。
.DESCRIPTION
    全体のステップ数と現在のステップ数を渡すだけで、パーセンテージを自動計算し、
    PowerShell標準のWrite-Progressコマンドレットを呼び出します。
    これにより、スクリプト内での進捗表示を簡単かつ統一的に実装できます。
.PARAMETER TotalCount
    処理全体のステップ数や、処理対象のアイテムの総数。
.PARAMETER CurrentStep
    現在の処理が全体の何番目かを示す数値。
.PARAMETER Activity
    プログレスバーのメインタイトルとなる、実行中のタスク全体の名前。（例: "ファイルのコピー"）
.PARAMETER Status
    現在実行中のサブタスクや、処理中のアイテム名など、より詳細な状況を示す文字列。
    指定しない場合は、デフォルトの進捗テキストが表示されます。
.PARAMETER Id
    プログレスバーのID。ネストした（入れ子の）プログレスバーを表示する場合に、
    それぞれを区別するために使用します。
.EXAMPLE
    # --- 基本的な使い方 (1から100までのループ) ---
    $total = 100
    for ($i = 1; $i -le $total; $i++) {
        Show-ProgressBar -TotalCount $total -CurrentStep $i -Activity "テスト処理を実行中"
        Start-Sleep -Milliseconds 50 # 処理のダミー
    }
    # 最後に必ず -Completed スイッチでプログレスバーを非表示にする
    Write-Progress -Activity "テスト処理を実行中" -Completed

.EXAMPLE
    # --- ファイル処理での使い方 ---
    $files = Get-ChildItem -Path "C:\Windows\System32" -File
    $totalFiles = $files.Count
    $currentFileIndex = 0

    foreach ($file in $files) {
        $currentFileIndex++
        $statusMessage = "処理中: $($file.Name)"
        Show-ProgressBar -TotalCount $totalFiles -CurrentStep $currentFileIndex -Activity "システムファイルをスキャン中" -Status $statusMessage
        Start-Sleep -Milliseconds 10 # 処理のダミー
    }
    Write-Progress -Activity "システムファイルをスキャン中" -Completed
#>
    [CmdletBinding()]
    param(
        [Parameter(Mandatory = $true)]
        [int]$TotalCount,

        [Parameter(Mandatory = $true)]
        [int]$CurrentStep,

        [Parameter(Mandatory = $true)]
        [string]$Activity,

        [Parameter()]
        [string]$Status,

        [Parameter()]
        [int]$Id = 1
    )

    # 全体の数が0以下の場合はエラーを避ける
    if ($TotalCount -le 0) {
        return
    }

    # パーセンテージを計算
    $percentComplete = [int](($CurrentStep / $TotalCount) * 100)
    # パーセンテージが100を超えないように調整
    if ($percentComplete -gt 100) {
        $percentComplete = 100
    }

    # Statusが指定されていない場合は、デフォルトのメッセージを作成
    $progressText = "($CurrentStep / $TotalCount)"
    if ([string]::IsNullOrEmpty($Status)) {
        $statusMessage = "処理を進めています... $progressText"
    }
    else {
        $statusMessage = "$Status $progressText"
    }

    # プログレスバーを表示
    Write-Progress -Activity $Activity -Status $statusMessage -PercentComplete $percentComplete -Id $Id
}
```

### この関数の使い方

#### 1. 関数の読み込み
上記のコードを `.ps1` ファイル（例: `ProgressBar.ps1`）として保存し、あなたのスクリプトの先頭で、ドットソース演算子を使って読み込みます。

```powershell
. .\ProgressBar.ps1
```
*(PowerShellのプロファイル `$PROFILE` にこの関数を記述しておくと、いつでも利用できて便利です)*

#### 2. スクリプト内での利用

**非常に重要なポイント:** プログレスバーは、処理が完了した後に**明示的に非表示**にする必要があります。これは、`Write-Progress` に `-Completed` スイッチを付けて呼び出すことで行います。

---

#### 使用例1：シンプルなループ処理

単純に100回のループ処理の進捗を表示したい場合に最適です。

```powershell
$activityName = "データのエクスポート"
$totalSteps = 100

for ($i = 1; $i -le $totalSteps; $i++) {
    # 関数を呼び出してプログレスバーを更新
    Show-ProgressBar -TotalCount $totalSteps -CurrentStep $i -Activity $activityName
    
    # ここで実際の処理を行う
    Start-Sleep -Milliseconds 20
}

# 【重要】処理完了後、必ずプログレスバーを非表示にする
Write-Progress -Activity $activityName -Completed

Write-Host "エクスポートが完了しました。"
```

#### 使用例2：ファイル一覧の処理

`foreach` ループでファイルのコレクションを処理するような、より実践的なシナリオです。

```powershell
$activityName = "画像のリサイズ"
$imageFiles = Get-ChildItem -Path "C:\Photos" -Filter "*.jpg"
$totalFiles = $imageFiles.Count
$counter = 0

foreach ($file in $imageFiles) {
    $counter++
    
    # 現在処理中のファイル名をStatusとして渡す
    $status = "リサイズ中: $($file.Name)"
    Show-ProgressBar -TotalCount $totalFiles -CurrentStep $counter -Activity $activityName -Status $status
    
    # ここで画像リサイズ処理を行う
    Start-Sleep -Milliseconds 50
}

# 【重要】処理完了後、必ずプログレスバーを非表示にする
Write-Progress -Activity $activityName -Completed

Write-Host "すべての画像のリサイズが完了しました。"
```

この `Show-ProgressBar` 関数を使えば、様々なスクリプトに簡単かつ統一された方法で進捗表示を追加でき、ユーザーにとって非常に親切なツールを作成することができます。
