---
title: "[PowerShell]“$LastExitCode”と“$?”の戻り値の動きを検証（cmdとも比較）"
emoji: "💭"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["windows", "powershell", "cmd"]
published: false
---
## 概要
## この記事のターゲット
- PowerShellの初心者の方
- エラー制御がうまくいかず悩んでいる方
- `$LastExitCode`と`$0`の違いを詳しく知りたい方
- コマンドプロンプト（cmd）とも動きを比較したい方
## 環境
```:PowerShellのバージョン
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

新しいクロスプラットフォームの PowerShell をお試しください https://aka.ms/pscore6

PS C:\WINDOWS\system32>
PS C:\WINDOWS\system32> $PSVersionTable

Name                           Value
----                           -----
PSVersion                      5.1.19041.3031
PSEdition                      Desktop
PSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}
BuildVersion                   10.0.19041.3031
CLRVersion                     4.0.30319.42000
WSManStackVersion              3.0
PSRemotingProtocolVersion      2.3
SerializationVersion           1.1.0.1


PS C:\WINDOWS\system32>
```
```:コマンドプロンプトのバージョン
C:\WINDOWS\system32>ver

Microsoft Windows [Version 10.0.19045.3324]

C:\WINDOWS\system32>
```
## 結論
PowerShellで`$LastExitCode`と`$?`の実際の動きの説明と用途は下記の通りです。
| 自動変数 | 実際の動き | 用途 |
| ---- | ---- | ---- |
| `$LastExitCode` | `exit`コマンド（`exit 0` or `exit -1`など）が実行された場合、指定された終了コードを取得可能。<br>`exit`コマンドが実行されていない場合は、空文字（`""`）が結果で返ってくる。 | 外部コマンドと連携する場合に向いている。<br>ただし、その外部コマンドで終了コードを指定していない場合は使用できない。 |
| `$?` | 直前のコマンドの結果が戻り値、Boolean（`True` or `False`）で値が返される。 | ただ単純に直前に実行したコマンドの結果だけ見たいときに使用。<br>外部コマンドと連携した場合、独特な動きになりエラー制御が難しいので外部連携は不向き。 |

以降より検証した結果を記載します。
まず最初に混同しやすいコマンドプロンプトでの動きについて検証。

## コマンドプロンプトの戻り値（%ERRORLEVEL%）を検証
過去、コマンドプロンプトでバッチファイルを作成していた方は、混乱しやすいと思うので、
まずはコマンドプロンプトの動きを検証。
コマンドプロンプトでエラー制御する場合は、`%ERRORLEVEL%`を使って実装します。
### 準備したバッチファイル
```:準備したバッチファイル一覧
D:\Downloads\lastexitcode_test\bat>dir
 ドライブ D のボリューム ラベルは ボリューム です
 ボリューム シリアル番号は 1298-06B4 です

 D:\Downloads\lastexitcode_test\bat のディレクトリ

2023/08/21  09:12    <DIR>          .
2023/08/21  09:12    <DIR>          ..
2023/08/21  09:12                19 ng-pattern.bat
2023/08/21  09:13                12 ok-pattern.bat
               2 個のファイル                  31 バイト
               2 個のディレクトリ  56,886,099,968 バイトの空き領域

D:\Downloads\lastexitcode_test\bat>
```
```:ok-pattern.batの中身
ECHO CMD-OKAY!

```
```:ng-pattern.batの中身
NOT-EXISTS-COMMAND

```
```:ng-pattern_set-exitcode.batの中身
NOT-EXISTS-COMMAND
EXIT /B 404

```
### 戻り値（%ERRORLEVEL%）を検証
以下の検証結果からコマンドプロンプトで実行した場合、直接コマンドで打とうが、外部コマンドを打とうが、
直前のコマンド結果（終了コードを指定した場合は、指定した値）が`%ERRORLEVEL%`に反映される。
#### 直接コマンドを実行した場合
```:OKパターンの戻り値を確認
C:\WINDOWS\system32>ECHO CMD-OKAY!                                  // 直接コマンドを実行（存在するコマンド）
CMD-OKAY!

C:\WINDOWS\system32>ECHO %ERRORLEVEL%                               // 戻り値を確認
0
```
```:NGパターンの戻り値を確認
C:\WINDOWS\system32>NOT-EXISTS-COMMAND                               // 直接コマンドを実行（存在しないコマンド）
'NOT-EXISTS-COMMAND' は、内部コマンドまたは外部コマンド、
操作可能なプログラムまたはバッチ ファイルとして認識されていません。

C:\WINDOWS\system32>
C:\WINDOWS\system32>ECHO %ERRORLEVEL%                               // 戻り値を確認
9009

C:\WINDOWS\system32>
```
#### 外部コマンド（バッチファイル）を実行した場合
```:OKパターンの戻り値を確認
D:\Downloads\lastexitcode_test\bat>ok-pattern.bat                   // バッチの実行

D:\Downloads\lastexitcode_test\bat>ECHO CMD-OKAY!
CMD-OKAY!

D:\Downloads\lastexitcode_test\bat>ECHO %ERRORLEVEL%                // 戻り値を確認
0
```
```:NGパターンの戻り値を確認
D:\Downloads\lastexitcode_test\bat>ng-pattern.bat                   // バッチの実行

D:\Downloads\lastexitcode_test\bat>NOT-EXISTS-COMMAND
'NOT-EXISTS-COMMAND' は、内部コマンドまたは外部コマンド、
操作可能なプログラムまたはバッチ ファイルとして認識されていません。

D:\Downloads\lastexitcode_test\bat>
D:\Downloads\lastexitcode_test\bat>echo %ERRORLEVEL%                // 戻り値を確認
9009

D:\Downloads\lastexitcode_test\bat>
```
```:NGパターン（＋終了コード指定）の戻り値を確認
D:\Downloads\lastexitcode_test\bat>ng-pattern_set-exitcode.bat      // バッチの実行

D:\Downloads\lastexitcode_test\bat>NOT-EXISTS-COMMAND
'NOT-EXISTS-COMMAND' は、内部コマンドまたは外部コマンド、
操作可能なプログラムまたはバッチ ファイルとして認識されていません。

D:\Downloads\lastexitcode_test\bat>EXIT /B 404

D:\Downloads\lastexitcode_test\bat>ECHO %ERRORLEVEL%                // 戻り値を確認
404
```
## PowerShellの戻り値（$LastExitCodeと$?）を検証
PowerShell CLIやプログラム（ps1ファイル）のエラー制御する場合は、`$LastExitCode` または `$?`を使って実装します。
### 準備したスクリプトファイル
```:ok-pattern.ps1の中身
Write-Host "PS-OKAY!"

```
```:ng-pattern.ps1の中身
Not-Exists-Command

```
```:ng-pattern_set-exitcode.ps1の中身
Not-Exists-Command
Exit 404

```
### 戻り値（$?）を検証
★
以下の検証結果からPowerShellで実行し、直接コマンドで打った場合、
外部コマンドを打った場合、
直前のコマンド結果（終了コードを指定した場合は、指定した値）が`%ERRORLEVEL%`に反映される。
#### 直接コマンドを実行した場合
```:OKパターンの戻り値を確認
PS C:\WINDOWS\system32> Write-Host "PS-OKAY!"                           // 直接コマンドを実行
PS-OKAY!
PS C:\WINDOWS\system32>
PS C:\WINDOWS\system32> $?                                              // 戻り値を確認
True
PS C:\WINDOWS\system32>
```
```:NGパターンの戻り値を確認
PS C:\WINDOWS\system32> Not-Exists-Command                              // 直接コマンドを実行
Not-Exists-Command : 用語 'Not-Exists-Command' は、コマンドレット、関数、スクリプト ファイル、または操作可能なプログラム
の名前として認識されません。名前が正しく記述されていることを確認し、パスが含まれている場合はそのパスが正しいことを確認
してから、再試行してください。
発生場所 行:1 文字:1
+ Not-Exists-Command
+ ~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ObjectNotFound: (Not-Exists-Command:String) [], CommandNotFoundException
    + FullyQualifiedErrorId : CommandNotFoundException

PS C:\WINDOWS\system32>
PS C:\WINDOWS\system32> $?                                              // 戻り値を確認
False
PS C:\WINDOWS\system32>
```
#### 外部コマンド（スクリプトファイル）を実行した場合
```:OKパターンの戻り値を確認
PS D:\Downloads\lastexitcode_test\ps> .\ok-pattern.ps1                  // スクリプトの実行
PS-OKAY!
PS D:\Downloads\lastexitcode_test\ps>
PS D:\Downloads\lastexitcode_test\ps> $?                                // 戻り値を確認
True
PS D:\Downloads\lastexitcode_test\ps>
```
```:NGパターンの戻り値を確認
PS D:\Downloads\lastexitcode_test\ps> .\ng-pattern.ps1                  // スクリプトの実行
Not-Exists-Command : 用語 'Not-Exists-Command' は、コマンドレット、関数、スクリプト ファイル、または操作可能なプログラム
の名前として認識されません。名前が正しく記述されていることを確認し、パスが含まれている場合はそのパスが正しいことを確認
してから、再試行してください。
発生場所 D:\Downloads\lastexitcode_test\ps\ng-pattern.ps1:1 文字:1
+ Not-Exists-Command
+ ~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ObjectNotFound: (Not-Exists-Command:String) [], CommandNotFoundException
    + FullyQualifiedErrorId : CommandNotFoundException

PS D:\Downloads\lastexitcode_test\ps>
PS D:\Downloads\lastexitcode_test\ps> $?
True
PS D:\Downloads\lastexitcode_test\ps>
```
```:NGパターン（＋終了コード=404で指定）の戻り値を確認
PS D:\Downloads\lastexitcode_test\ps> .\ng-pattern_set-exitcode.ps1     // スクリプトの実行
Not-Exists-Command : 用語 'Not-Exists-Command' は、コマンドレット、関数、スクリプト ファイル、または操作可能なプログラム
の名前として認識されません。名前が正しく記述されていることを確認し、パスが含まれている場合はそのパスが正しいことを確認
してから、再試行してください。
発生場所 D:\Downloads\lastexitcode_test\ps\ng-pattern_set-exitcode.ps1:1 文字:1
+ Not-Exists-Command
+ ~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ObjectNotFound: (Not-Exists-Command:String) [], CommandNotFoundException
    + FullyQualifiedErrorId : CommandNotFoundException

PS D:\Downloads\lastexitcode_test\ps>
PS D:\Downloads\lastexitcode_test\ps> $?                                // 戻り値を確認
False
PS D:\Downloads\lastexitcode_test\ps>
```
ps1ファイルで終了コードを`404`で指定してみた結果、`$?`が**False**になりました。
では、終了コードを`0`で指定してみて実行するとどうなるか下記で確認してみました。
```:NGパターン（＋終了コード=0で指定）の戻り値を確認
PS D:\Downloads\lastexitcode_test\ps> .\ng-pattern_set-exitcode.ps1     // スクリプトの実行
Not-Exists-Command : 用語 'Not-Exists-Command' は、コマンドレット、関数、スクリプト ファイル、または操作可能なプログラム
の名前として認識されません。名前が正しく記述されていることを確認し、パスが含まれている場合はそのパスが正しいことを確認
してから、再試行してください。
発生場所 D:\Downloads\lastexitcode_test\ps\ng-pattern_set-exitcode.ps1:1 文字:1
+ Not-Exists-Command
+ ~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ObjectNotFound: (Not-Exists-Command:String) [], CommandNotFoundException
    + FullyQualifiedErrorId : CommandNotFoundException

PS D:\Downloads\lastexitcode_test\ps>
PS D:\Downloads\lastexitcode_test\ps> $?                                // 戻り値を確認
True
PS D:\Downloads\lastexitcode_test\ps>
```
上記の通り、終了コードを`0`で指定した結果、`$?`が**True**となりました。

これまでの結果から、PowerShellで外部コマンドを実行した場合、終了コードを指定しないと「 **True** 」となる、
一方、終了コードを`0`で指定すると`$?`が「 **True** 」になり、`0`以外で指定すると`$?`が「 **False** 」になる事がわかりました。
外部コマンド + `$?`の組み合わせは、かなり独特な動きとなる為、外部コマンドのエラー制御で`$?`は使用しない方が良いと思われる。
### 戻り値（$LastExitCode）の検証
#### 直接コマンドを実行した場合
```:OKパターンの戻り値を確認
PS C:\WINDOWS\system32> Write-Host "PS-OKAY!"   // 直接コマンドを実行
PS-OKAY!
PS C:\WINDOWS\system32>
PS C:\WINDOWS\system32> $LastExitCode           // 戻り値を確認
PS C:\WINDOWS\system32>
```
```:NGパターンの戻り値を確認
PS C:\WINDOWS\system32> Not-Exists-Command       // 直接コマンドを実行
Not-Exists-Command : 用語 'Not-Exists-Command' は、コマンドレット、関数、スクリプト ファイル、または操作可能なプログラム
の名前として認識されません。名前が正しく記述されていることを確認し、パスが含まれている場合はそのパスが正しいことを確認
してから、再試行してください。
発生場所 行:1 文字:1
+ Not-Exists-Command
+ ~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ObjectNotFound: (Not-Exists-Command:String) [], CommandNotFoundException
    + FullyQualifiedErrorId : CommandNotFoundException

PS C:\WINDOWS\system32>
PS C:\WINDOWS\system32> $LastExitCode           // 戻り値を確認
PS C:\WINDOWS\system32>
```
#### 外部コマンド（スクリプトファイル）を実行した場合
```:OKパターンの戻り値を確認
PS D:\Downloads\lastexitcode_test\ps> .\ok-pattern.ps1
PS-OKAY!
PS D:\Downloads\lastexitcode_test\ps>
PS D:\Downloads\lastexitcode_test\ps> $?
True
PS D:\Downloads\lastexitcode_test\ps>
```
```:NGパターンの戻り値を確認
PS D:\Downloads\lastexitcode_test\ps> .\ng-pattern.ps1
Not-Exists-Command : 用語 'Not-Exists-Command' は、コマンドレット、関数、スクリプト ファイル、または操作可能なプログラム
の名前として認識されません。名前が正しく記述されていることを確認し、パスが含まれている場合はそのパスが正しいことを確認
してから、再試行してください。
発生場所 D:\Downloads\lastexitcode_test\ps\ng-pattern.ps1:1 文字:1
+ Not-Exists-Command
+ ~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ObjectNotFound: (Not-Exists-Command:String) [], CommandNotFoundException
    + FullyQualifiedErrorId : CommandNotFoundException

PS D:\Downloads\lastexitcode_test\ps>
PS D:\Downloads\lastexitcode_test\ps> $?
True
PS D:\Downloads\lastexitcode_test\ps>
```
```:NGパターン（＋終了コード=404で指定）の戻り値を確認
PS D:\Downloads\lastexitcode_test\ps> .\ng-pattern_set-exitcode.ps1
Not-Exists-Command : 用語 'Not-Exists-Command' は、コマンドレット、関数、スクリプト ファイル、または操作可能なプログラム
の名前として認識されません。名前が正しく記述されていることを確認し、パスが含まれている場合はそのパスが正しいことを確認
してから、再試行してください。
発生場所 D:\Downloads\lastexitcode_test\ps\ng-pattern_set-exitcode.ps1:1 文字:1
+ Not-Exists-Command
+ ~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ObjectNotFound: (Not-Exists-Command:String) [], CommandNotFoundException
    + FullyQualifiedErrorId : CommandNotFoundException

PS D:\Downloads\lastexitcode_test\ps>
PS D:\Downloads\lastexitcode_test\ps> $?
False
PS D:\Downloads\lastexitcode_test\ps>
```
ps1ファイルで終了コードを`404`で指定してみた結果、`$?`が**False**になりました。
では、終了コードを`0`で指定してみて実行するとどうなるか下記で確認してみました。
```:NGパターン（＋終了コード=0で指定）の戻り値を確認
PS D:\Downloads\lastexitcode_test\ps> .\ng-pattern_set-exitcode.ps1
Not-Exists-Command : 用語 'Not-Exists-Command' は、コマンドレット、関数、スクリプト ファイル、または操作可能なプログラム
の名前として認識されません。名前が正しく記述されていることを確認し、パスが含まれている場合はそのパスが正しいことを確認
してから、再試行してください。
発生場所 D:\Downloads\lastexitcode_test\ps\ng-pattern_set-exitcode.ps1:1 文字:1
+ Not-Exists-Command
+ ~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ObjectNotFound: (Not-Exists-Command:String) [], CommandNotFoundException
    + FullyQualifiedErrorId : CommandNotFoundException

PS D:\Downloads\lastexitcode_test\ps>
PS D:\Downloads\lastexitcode_test\ps> echo $?
True
PS D:\Downloads\lastexitcode_test\ps>
```
上記の通り、終了コードを`0`で指定した結果、`$?`が**True**となりました。
