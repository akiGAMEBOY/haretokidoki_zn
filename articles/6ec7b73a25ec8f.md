---
title: "Windows PowerShell 6.0.0以降をコマンドでインストールする方法"
emoji: "🔮"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["windows", "powershell"]
published: false
---

Windowsでは、標準のPowerShell 5.1よりも新しいバージョンのインストールを推奨しています。
最新版のPowerShellを実際に使ってみると、処理時間が短縮したり機能が強化されたりと、
バージョンアップのメリットを実感できます。

最新のPowerShellをインストールする方法は色々あります。一番知られているのは Microsoft Store アプリに公開されている「[PowerShellアプリ](https://apps.microsoft.com/detail/9MZ1SNWT0N5D)」経由でインストールする方法でしょう。

今回は、wingetコマンドでPowerShellをインストールする方法をまとめてみました。

## この記事のターゲット

- Windows PowerShell 5.1よりも大きいバージョン（6.0.0以降）を導入したい方
    - バージョン6.0.0 ～ 6.2.6：PowerShell Core
    - バージョン7.0.0以降     ：PowerShell
- 導入方法をCLI（コマンド・コマンドレット）で行いたい方

## コマンドでインストールするメリット

コマンドのメリットとしては、処理時間の高速化や指定したバージョンでインストールが可能などがあります。
複数台のパソコンにセットアップが必要な場合は非常に重宝する方法だと思います。

## 検証環境

```powershell:OSとPowerShellのバージョン
# OSのバージョン情報
PS C:\Users\XXXX> $osInfo = Get-CimInstance -ClassName Win32_OperatingSystem
>>
>> # OS名、バージョン、ビルド番号を取得
>> $osName = $osInfo.Caption
>> $osVersion = $osInfo.Version
>> $osBuild = $osInfo.BuildNumber
>>
>> # 見やすくフォーマットして表示
>> Write-Host "OS 名            : $osName" -ForegroundColor Green
>> Write-Host "バージョン       : $osVersion" -ForegroundColor Cyan
>> Write-Host "ビルド番号       : $osBuild" -ForegroundColor Cyan
OS 名            : Microsoft Windows 10 Pro
バージョン       : 10.0.19045
ビルド番号       : 19045
PS C:\Users\XXXX>

# PowerShellのバージョン情報
PS C:\Users\XXXX> $PSVersionTable

Name                           Value
----                           -----
PSVersion                      5.1.19041.5486
PSEdition                      Desktop
PSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}
BuildVersion                   10.0.19041.5486
CLRVersion                     4.0.30319.42000
WSManStackVersion              3.0
PSRemotingProtocolVersion      2.3
SerializationVersion           1.1.0.1


PS C:\Users\XXXX>
```

## 対応方法

切り戻しとしてアンインストールもコマンドで行えるのであわせて紹介します。

### 事前設定：フォントと文字コードの変更

コマンドでインストールする方法は多岐に渡りますが、今回は`winget`というコマンドを使って作業を行います。
`winget`コマンドには下記2点の注意点があります。

- `winget`コマンド結果は、文字コードが「UTF-8」で出力されること
- Windows PowerShellウィンドウのフォントは文字コードが`UTF-8`で出力されるため、文字コードとフォントの設定を変更

初期値では日本語のUTF-8に対応おらず、そのまま`winget`コマンドを実行してしまうと文字化けが発生してしまうので、
あらかじめ設定変更します。

#### フォント設定の変更

![Windows PowerShell ウィンドウのシステムメニュー](https://storage.googleapis.com/zenn-user-upload/4e8b4aa47a7c-20250317.png)

1. スタートメニューから "Windows PowerShell" を選択し起動
1. Windows PowerShell ウィンドウ のタイトルバーを右クリック
1. コンテキストメニュー（またはショートカットメニュー）より「プロパティ」を選択
   元のサイズに戻す(R)
　 移動(M)
　 サイズ変更(S)
　 最小化(N)
　 最大化(X)
　 閉じる(C)
　 編集(E)
　 規定値(D)
　 プロパティ(P) 👈 これを選択
1. "フォントタブ" にある `フォント(F)` で 「`ＭＳ ゴシック`」or「`BIZ UDゴシック`」を設定

1. OKボタンをクリック

:::details 上記のGUI操作をすべてショートカットキーで対応する方法

1. 「⊞Winキー ＋ R」で"ファイル名を指定して実行"を起動
1. "ファイル名を指定して実行"の`名前(O)`欄に「powershell」を入力しEnterキー
1. （Windows PowerShell ウィンドウ が起動したことを確認）
1. 「Alt + スペース」でWindows PowerShell のシステムメニューを開く
    （PowerToysを導入している場合は、[PowerToys Run](https://learn.microsoft.com/ja-jp/windows/powertoys/run)が起動してしまうので無効化が必要）

1. 「P」を入力しプロパティを表示

1. 「Alt ＋ F」でフォント設定をアクティブに

1. 指定のフォントを選択

1. Enterキーで設定が反映

:::

#### 文字コードの変更


    

Windows 

## コマンドでPowerShellをインストールする方法

### Windows PowerShellのフォントを変更

日本語でのwingetコマンドは文字コードUTF-8の日本語を出力します。
そのため、下記の作業を実施しないと出力されるメッセージが文字化けしてしまうので注意！

:::details 上記をキーボード操作で対応する方法

1. 「Winキー ＋ R」でファイル名を指定して実行を起動

1. 名前(O)欄に「powershell」と入力しEnterキー

1. （Windows PowerShell ウィンドウが起動したことを確認）

1. Alt + スペースキー でシステムメニューを開く
   （PowerToysを導入している場合は、PowerToysRunが起動してしまう。）

1. 「P」を入力しプロパティを表示

1. 「Alt ＋ F」でフォント設定をアクティブに

1. 指定のフォントを選択

1. Enterキーで設定が反映

:::


```powershell
# コンソールのエンコーディングをUTF-8に設定
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
```

### 何も指定せずにインストール

:::message
**文字化けする場合**

前述している[フォントと文字コードの変更](#事前設定：フォントと文字コードの変更)を参照し、wingetコマンドが正常に表示できるようにしてください。
:::

```powershell
# インストールするコマンド
winget install --id Microsoft.PowerShell
```

**実際に実行した結果**

ユーザーアカウント制御が表示された場合は「はい」

```powershell
```

はじめてwingetコマンドでPowerShellをインストールした場合は、下記2点がインストール。
- Windows Package Manager Source (winget) V2
- PowerShell 7-x64

**すでにインストールされている場合**

```powershell
PS C:\Users\XXXX> winget install --id Microsoft.PowerShell
既存のパッケージが既にインストールされています。インストールされているパッケージ...をアップグレードしようとしています
利用可能なアップグレードが見つかりませんでした。
構成されたソースから入手できる新しいパッケージ バージョンはありません。
PS C:\Users\XXXX>
```

wingetを使用する為には、Microsoft Store アプリの「アプリ インストーラー」のインストールが必要。
手動でインストールしなくても自動でインストールされるはず。

### バージョンの指定してインストール

```powershell
winget install --id Microsoft.PowerShell --version "指定するバージョン"
```

:::details インストール可能なバージョンを一覧表示する方法

```powershell:バージョン一覧を取得するコマンド
winget show --id Microsoft.PowerShell --versions
```

```powershell:wingetでインストール可能なバージョンを表示（）
PS C:\Users\XXXX> winget show --id Microsoft.PowerShell --versions
ソースを更新できませんでした: winget
ソースの検索中にエラーが発生しました;結果は含まれません: msstore
見つかりました PowerShell [Microsoft.PowerShell]
バージョン
----------
7.5.0.0
7.4.7.0
7.4.6.0
7.4.5.0
7.4.4.0
7.4.3.0
7.4.2.0
7.4.1.0
7.4.0.0
7.3.11.0
7.3.10.0
7.3.9.0
7.3.8.0
7.3.7.0
7.3.6.0
7.3.5.0
7.3.4.0
7.3.3.0
7.3.2.0
7.3.1.0
7.3.0.0
7.2.24.0
7.2.23.0
7.2.22.0
7.2.21.0
7.2.18.0
7.2.17.0
7.2.16.0
7.2.14.0
7.2.13.0
7.2.12.0
7.2.10.0
7.2.9.0
7.2.8.0
7.2.7.0
7.2.6.0
7.2.5.0
7.2.4.0
7.2.3.0
7.2.2.0
7.2.1.0
7.2.0.0
7.1.5.0
7.1.4.0
7.1.3.0
7.1.2.0
7.1.1.0
7.1.0.0
7.0.13.0
7.0.8.0
7.0.6.0
7.0.5.0
7.0.4.0
7.0.3.0
7.0.2.0
7.0.1.0
7.0.0.0
6.2.6.0
6.2.5.0
6.2.4.0
6.2.3.0
6.2.2.0
6.2.1.0
6.2.0.0
6.1.6.0
6.1.5.0
6.1.4.0
6.1.3.0
6.1.2.0
6.1.1.0
6.1.0.0
6.0.5.0
6.0.4.0
6.0.3.0
6.0.2.0
6.0.1.0
6.0.0.0
PS C:\Users\XXXX>
```

:::

### Functionで実行

```powershell:Function
Function Install-WingetPackage {
    param (
        [Parameter(Mandatory = $false)]
        [string]$PackageId, # インストール対象のパッケージ ID（任意）

        [Parameter(Mandatory = $false)]
        [string]$Version # 指定があればそのバージョンをインストール
    )

    $statusCode = 0

    # コンソールのエンコーディングをUTF-8に設定
    [Console]::OutputEncoding = [System.Text.Encoding]::UTF8

    # パッケージ ID が指定されていない場合、パッケージリストを取得
    if (-Not $PackageId) {
        Write-Host "利用可能なパッケージのリストを取得中..." -ForegroundColor Cyan
        Write-Host "検索するクエリを入力してください (例: browser)"
        $query = Read-Host
        $wingetListOutput = (winget search -q $query | Out-String)

        if (-Not $wingetListOutput) {
            Write-Error "winget コマンドが実行できないか、パッケージリストを取得できませんでした。"
            $statusCode = -11
            return $statusCode
        }

        # パッケージリストを整形して表示
        $lines = ($wingetListOutput -split "`r?`n")
        $availablePackages = $lines | Where-Object { $_ -match "^\S+\s+\S+" } # 名前と ID を含む行だけ残す

        if (-Not $availablePackages) {
            Write-Error "利用可能なパッケージが見つかりませんでした。クエリを変更して再試行してください。"
            $statusCode = -12
            return $statusCode
        }

        Write-Host "以下のパッケージが利用可能です（名前、ID）:" -ForegroundColor Green
        $availablePackages | ForEach-Object { Write-Host $_ }

        # ユーザーに ID を入力させる
        Write-Host "インストールするパッケージの ID を入力してください"
        $PackageId = Read-Host
        if (-Not $PackageId) {
            Write-Error "パッケージ ID が入力されませんでした。処理を終了します。"
            $statusCode = -13
            return $statusCode
        }
    }

    # 選択されたパッケージのバージョンを確認
    Write-Host "利用可能なバージョンを確認中 ($PackageId)..." -ForegroundColor Cyan
    $wingetOutput = (winget show --id $PackageId --versions | Out-String)

    if (-Not $wingetOutput) {
        Write-Error "パッケージ '$PackageId' が見つかりませんでした。"
        $statusCode = -21
        return $statusCode
    }

    # バージョン一覧を抽出
    $lines = ($wingetOutput -split "`r?`n")
    $availableVersions = ($lines -replace "\s+", "" | Where-Object { $_ -ne "" -and $_ -match "^\d" } | Sort-Object)

    if (-Not $availableVersions) {
        Write-Error "利用可能なバージョンを取得できませんでした。"
        $statusCode = -22
        return $statusCode
    }

    Write-Host "以下のバージョンが選択可能です:" -ForegroundColor Green
    $availableVersions | ForEach-Object { Write-Host $_ }

    # ユーザーにバージョンを入力させる（空の場合は最新版を使用）
    Write-Host "インストールするバージョンを入力してください（空の場合は最新バージョンを選択）"
    $selectedVersion = Read-Host

    # バージョンが未指定の場合、最新版を選択
    if (-Not $selectedVersion) {
        $selectedVersion = $availableVersions[-1]
        Write-Host "最新版 '$selectedVersion' をインストールします。" -ForegroundColor Yellow
    } elseif (-Not ($availableVersions -contains $selectedVersion)) {
        Write-Error "指定されたバージョン '$selectedVersion' は利用可能なリストにありません。"
        $statusCode = -23
        return $statusCode
    }

    Write-Host "$PackageId のバージョン $selectedVersion をインストールします..." -ForegroundColor Cyan

    # 標準出力を破棄してインストール処理を実行
    (winget install --id $PackageId --version $selectedVersion --silent | Out-Null)
    $wingetExitcode = $LASTEXITCODE

    if ($wingetExitcode -eq 0) {
        Write-Host "$PackageId バージョン $selectedVersion のインストールが完了しました。" -ForegroundColor Green
    } else {
        Write-Error "インストール中にエラーが発生しました。winget 終了コード: $wingetExitcode"
        $statusCode = -24
        return $statusCode
    }

    return $statusCode
}
```

```powershell
# 実行例
$statusCode = Install-WingetPackage
Write-Output "終了コード: $statusCode"
Write-Output "Enterキーで終了します。"
Read-Host > $null
```

## アンインストール

```
winget list --id Microsoft.PowerShell

```

```powershell:ある場合
PS C:\Users\XXXX> winget list --id Microsoft.PowerShell
入力条件に一致するインストール済みのパッケージが見つかりませんでした。
PS C:\Users\XXXX>
```

```powershell:ない場合
PS C:\Users\XXXX> winget list --id Microsoft.PowerShell
入力条件に一致するインストール済みのパッケージが見つかりませんでした。
PS C:\Users\XXXX>
PS C:\Users\XXXX> $LASTEXITCODE
-1978335212
PS C:\Users\XXXX>
```

```
winget uninstall --id Microsoft.PowerShell

```

## 参考文献

すべてコマンドでアップデートするやつ
