---
title: "Windows PowerShell 6.0.0以降をコマンドでインストールする方法"
emoji: "🦔"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["windows", "powershell"]
published: false
---

Windowsでは、PowerShell 5.1よりも新しいバージョンのインストールを推奨しています。
実際にバージョンアップ版のPowerShellを使ってみると、処理時間が短縮したり機能が強化されたりなど、
機能強化を実感できるでしょう。

PowerShellの6.0.0以降のインストールする場合は、以前は時間がかかっていた処理もみた感触も機能が強化されたり、macOSやLinux環境でも動作するようになっています。

今回は のバージョンをWindowsに標準で入っている Windows PowerShell（バージョン 5.1.0）PowerShell Core（6.0.0 ～ 6.2.6）もしくはPowerShell（7.0.0以降）をコマンドでインストールする方法

## コマンドでPowerShellをインストールする方法

### Windows PowerShellのフォントを変更

日本語でのwingetコマンドは文字コードUTF-8の日本語を出力します。
そのため、下記の作業を実施しないと出力されるメッセージが文字化けしてしまうので注意！

Windows PowerShellウィンドウのタイトルバーを右クリック
→ 元のサイズに戻す(R)
　 移動(M)
　 サイズ変更(S)
　 最小化(N)
　 最大化(X)
　 閉じる(C)
　 編集(E)
　 規定値(D)
　 プロパティ(P) 👈 選択

フォントタブ → フォント「ＭＳ ゴシック」or「BIZ UDゴシック」

:::details 上記をキーボード操作で対応する方法

1. 「Winキー ＋ R」でファイル名を指定して実行を起動

1. 名前(O)欄に「powershell」と入力しEnterキー

1. （Windows PowerShell ウィンドウが起動したことを確認）

1. Alt + スペースキー でシステムメニューを開く
   （PowerToysを導入している場合は、PowerToysRunが起動してしまう。）

1. 「P」を入力しプロパティを表示

1. 「Alt ＋ F」でフォント設定をアクティブに

1. 指定のフォントを選択

1. Enterキーで設定が反映

:::


```powershell
# コンソールのエンコーディングをUTF-8に設定
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
```

### 何も指定せずにインストール

```powershell
# コンソールのエンコーディングをUTF-8に設定
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
# インストールするコマンド
winget install --id Microsoft.PowerShell
```

**実際に実行した結果**

```powershell
```

**すでにインストールされている場合**

```powershell
PS C:\Users\XXXX> winget install --id Microsoft.PowerShell
既存のパッケージが既にインストールされています。インストールされているパッケージ...をアップグレードしようとしています
利用可能なアップグレードが見つかりませんでした。
構成されたソースから入手できる新しいパッケージ バージョンはありません。
PS C:\Users\XXXX>
```

wingetを使用する為には、Microsoft Store アプリの「アプリ インストーラー」のインストールが必要。
手動でインストールしなくても自動でインストールされるはず。

### バージョンの指定してインストール

```powershell
winget install --id Microsoft.PowerShell --version "指定するバージョン"
```

:::details インストール可能なバージョンを一覧表示する方法

```powershell:バージョン一覧を取得するコマンド
winget show --id Microsoft.PowerShell --versions
```

```powershell:wingetでインストール可能なバージョンを表示（）
PS C:\Users\XXXX> winget show --id Microsoft.PowerShell --versions
ソースを更新できませんでした: winget
ソースの検索中にエラーが発生しました;結果は含まれません: msstore
見つかりました PowerShell [Microsoft.PowerShell]
バージョン
----------
7.5.0.0
7.4.7.0
7.4.6.0
7.4.5.0
7.4.4.0
7.4.3.0
7.4.2.0
7.4.1.0
7.4.0.0
7.3.11.0
7.3.10.0
7.3.9.0
7.3.8.0
7.3.7.0
7.3.6.0
7.3.5.0
7.3.4.0
7.3.3.0
7.3.2.0
7.3.1.0
7.3.0.0
7.2.24.0
7.2.23.0
7.2.22.0
7.2.21.0
7.2.18.0
7.2.17.0
7.2.16.0
7.2.14.0
7.2.13.0
7.2.12.0
7.2.10.0
7.2.9.0
7.2.8.0
7.2.7.0
7.2.6.0
7.2.5.0
7.2.4.0
7.2.3.0
7.2.2.0
7.2.1.0
7.2.0.0
7.1.5.0
7.1.4.0
7.1.3.0
7.1.2.0
7.1.1.0
7.1.0.0
7.0.13.0
7.0.8.0
7.0.6.0
7.0.5.0
7.0.4.0
7.0.3.0
7.0.2.0
7.0.1.0
7.0.0.0
6.2.6.0
6.2.5.0
6.2.4.0
6.2.3.0
6.2.2.0
6.2.1.0
6.2.0.0
6.1.6.0
6.1.5.0
6.1.4.0
6.1.3.0
6.1.2.0
6.1.1.0
6.1.0.0
6.0.5.0
6.0.4.0
6.0.3.0
6.0.2.0
6.0.1.0
6.0.0.0
PS C:\Users\XXXX>
```

:::

## アンインストール

```
winget list --id Microsoft.PowerShell

```

```powershell:ある場合
PS C:\Users\XXXX> winget list --id Microsoft.PowerShell
入力条件に一致するインストール済みのパッケージが見つかりませんでした。
PS C:\Users\XXXX>
```

```powershell:ない場合
PS C:\Users\XXXX> winget list --id Microsoft.PowerShell
入力条件に一致するインストール済みのパッケージが見つかりませんでした。
PS C:\Users\XXXX>
PS C:\Users\XXXX> $LASTEXITCODE
-1978335212
PS C:\Users\XXXX>
```

```
winget uninstall --id Microsoft.PowerShell

```

$statusCode = 0

# コンソールのエンコーディングをUTF-8に設定
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8

# 利用可能なバージョンを取得して処理するスクリプト
Write-Host "利用可能な PowerShell バージョンを確認中..." -ForegroundColor Cyan

# winget の結果をUTF-8で明示的に読み取る
$wingetOutput = winget show --id Microsoft.PowerShell --versions | Out-String

if (-Not $wingetOutput) {
    Write-Error "winget コマンドが実行できないか、PowerShell パッケージが見つかりませんでした。"
    $statusCode = -11
}

if ($statusCode -eq 0) {
	# 出力を改行で分割し、先頭の不要部分を除去
	$lines = $wingetOutput -split "`r?`n"
	$availableVersions = $lines[2..($lines.Length - 1)] -replace "\s+", "" | Where-Object { $_ -ne "" }

	if (-Not $availableVersions) {
	    Write-Error "利用可能なバージョンを取得できませんでした。"
	    $statusCode = -21
	}
}

if ($statusCode -eq 0) {
	# 利用可能なバージョン一覧を表示
	Write-Host "以下のバージョンが利用可能です:" -ForegroundColor Green
	$availableVersions | ForEach-Object { Write-Host $_ }

	# ユーザーにバージョンを選択させる
	Write-Host "インストールするバージョンを入力してください（例: 7.5.0.0）"
	$selectedVersion = Read-Host > $null

	# 入力値が有効か確認
	if (-Not ($availableVersions -contains $selectedVersion)) {
	    Write-Error "指定されたバージョン '$selectedVersion' は利用可能なリストに含まれていません。"
	    $statusCode = -31
	}
}

if ($statusCode -eq 0) {
	# 選択したバージョンをインストール
	Write-Host "PowerShell バージョン $selectedVersion をインストールします..." -ForegroundColor Cyan
	winget install --id Microsoft.PowerShell --version $selectedVersion --silent

	# インストール完了メッセージ
	if ($LASTEXITCODE -eq 0) {
	    Write-Host "PowerShell バージョン $selectedVersion のインストールが完了しました。" -ForegroundColor Green
	} else {
	    Write-Error "インストール中にエラーが発生しました。"
	}
}

Write-Output "Enterキーで終了します。"
Read-Host > $null

exit $statusCode


```powershell:Function
Function Install-PowerShell {
    # PowerShell Core（6.0.0 ～ 6.2.6）もしくは PowerShell（7.0.0以降）をインストールする関数

    param (
        [Parameter(Mandatory = $false)]
        [string]$Id = "Microsoft.PowerShell" # デフォルトのパッケージID
    )

    $statusCode = 0

    # コンソールのエンコーディングをUTF-8に設定
    [Console]::OutputEncoding = [System.Text.Encoding]::UTF8

    Write-Host "利用可能な PowerShell バージョンを確認中..." -ForegroundColor Cyan

    # winget の結果をUTF-8で明示的に読み取る
    $wingetOutput = winget show --id $Id --versions | Out-String

    if (-Not $wingetOutput) {
        Write-Error "winget コマンドが実行できないか、PowerShell パッケージが見つかりませんでした。"
        return -11
    }

    # 出力を改行で分割し、不要な部分を除去
    $lines = $wingetOutput -split "`r?`n"
    $availableVersions = $lines[2..($lines.Length - 1)] -replace "\s+", "" | Where-Object { $_ -ne "" }

    if (-Not $availableVersions) {
        Write-Error "利用可能なバージョンを取得できませんでした。"
        return -21
    }

    # 利用可能なバージョン一覧を表示
    Write-Host "以下のバージョンが利用可能です:" -ForegroundColor Green
    $availableVersions | ForEach-Object { Write-Host $_ }

    # ユーザーにバージョンを選択させる
    $selectedVersion = Read-Host "インストールするバージョンを入力してください（例: 7.5.0.0）"

    # 入力値が有効か確認
    if (-Not ($availableVersions -contains $selectedVersion)) {
        Write-Error "指定されたバージョン '$selectedVersion' は利用可能なリストに含まれていません。"
        return -31
    }

    # 選択したバージョンをインストール
    Write-Host "PowerShell バージョン $selectedVersion をインストールします..." -ForegroundColor Cyan
    winget install --id $Id --version $selectedVersion --silent

    # インストール完了メッセージ
    if ($LASTEXITCODE -eq 0) {
        Write-Host "PowerShell バージョン $selectedVersion のインストールが完了しました。" -ForegroundColor Green
    } else {
        Write-Error "インストール中にエラーが発生しました。"
        return -41
    }

    # 正常終了コードを返す
    return 0
}

# 実行例
$statusCode = Install-PowerShell
Write-Output "終了コード: $statusCode"
Write-Output "Enterキーで終了します。"
Read-Host > $null
```
