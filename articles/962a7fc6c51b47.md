---
title: "PowerShellã§ æ–‡å­—ã‚³ãƒ¼ãƒ‰ ãŠã‚ˆã³ BOMä»˜ã ã‚’åˆ¤å®šã™ã‚‹è‡ªä½œFunction"
emoji: "ğŸ“"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["powershell"]
published: true
---
## æ¦‚è¦

æ—¥æœ¬èªã‚’ã¯ã˜ã‚ã¨ã™ã‚‹ãƒãƒ«ãƒãƒã‚¤ãƒˆã‚’å«ã‚€ãƒ‡ãƒ¼ã‚¿ã§ã¯ã€æ–‡å­—ã‚³ãƒ¼ãƒ‰ã«æ‚©ã¾ã•ã‚Œã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã€‚

ä»Šå›ã¯ã‚¿ã‚¤ãƒˆãƒ«é€šã‚Šã€PowerShellã®Functionã‚’2ã¤è‡ªä½œã—ã¦ã¿ã¾ã—ãŸã€‚
ã“ã‚Œã‚‰ã«ã‚ˆã‚Š æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’åˆ¤å®š ã¨ BOMä»˜ãã‹åˆ¤å®š ã®2ã¤ãŒå®Ÿç¾ã§ãã¾ã™ã€‚

## ã“ã®è¨˜äº‹ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ

- PowerShell ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ–¹
- ãƒ•ã‚¡ã‚¤ãƒ«ã®æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’åˆ¤å®šã—ãŸã„æ–¹
- ãƒ•ã‚¡ã‚¤ãƒ«ã®æ–‡å­—ã‚³ãƒ¼ãƒ‰ã§BOMä»˜ãã‹åˆ¤å®šã—ãŸã„æ–¹

## è‡ªä½œã—ãŸFunction

ä½œæˆã—ãŸFunctionã§ã¯ã€`Write-Host`ã§åˆ¤å®šã—ãŸçµæœã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚
PowerShellã‚¹ã‚¯ãƒªãƒ—ãƒˆã«çµ„ã¿è¾¼ã‚€å ´åˆã€`System.Boolean`ã§è¿”ã™ã‚ˆã†ãªFunctionã®æ–¹ãŒä¾¿åˆ©ã ã¨æ€ã†ã®ã§ã€
å¿…è¦ã«å¿œã˜ã¦ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¦ãã ã•ã„ã€‚

### ãƒ•ã‚¡ã‚¤ãƒ«ã®æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’åˆ¤å®šã§ãã‚‹Function

:::message
**ã“ã®Functionã§åˆ¤å®šã§ãã‚‹æ–‡å­—ã‚³ãƒ¼ãƒ‰ã«ã¯é™ã‚ŠãŒã‚ã‚Šã¾ã™**

ã‚³ã‚³ã§ç´¹ä»‹ã—ã¦ã„ã‚‹Functionã§ã¯ `System.IO.StreamReader` ã‚’ä½¿ã£ã¦æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’åˆ¤å®šã—ã¦ã„ã¾ã™ãŒã€
åˆ¤å®šã§ãã‚‹æ–‡å­—ã‚³ãƒ¼ãƒ‰ã«é™ã‚ŠãŒã‚ã‚Šã¾ã™ã€‚

ãŸã¨ãˆã°ã€æ—¥æœ¬ã§ãŠãªã˜ã¿ã® `Shift_JIS` ãªã©ã®åˆ¤å®šã¯ã§ãã¾ã›ã‚“ã€‚

ãã“ã§åˆ¥ã®è¨˜äº‹ã§ã‚ˆã‚Šé«˜åº¦ãªåˆ¤å®šãŒå¯èƒ½ãªPythonã®chardetãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã£ãŸPowerShell Functionã‚’ä½œæˆã—ã¾ã—ãŸã€‚
ãªãŠã€ã“ã®Functionã‚’å®Ÿè¡Œã™ã‚‹å‰ã«Pythonã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

[é–¢é€£è¨˜äº‹ï¼šPowerShellã‹ã‚‰Pythonã®chardetã‚’ä½¿ã£ã¦æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’åˆ¤å®š](https://zenn.dev/haretokidoki/articles/aea5b45679d966)

:::

```powershell:è‡ªä½œFunctionã€ŒGet-PsEncodingã€
# æ–‡å­—ã‚³ãƒ¼ãƒ‰ã®åˆ¤å®š
Function Get-PsEncoding {
	param (
		[Parameter(Mandatory=$true)][System.String]$targetfile
	)
	$stream_reader = [System.IO.StreamReader] $targetfile
	$profile_encoding = $stream_reader.CurrentEncoding
	$stream_reader.Close()

	Write-Host "EncodingName: [$($profile_encoding.EncodingName)]"
}
```

### ãƒ•ã‚¡ã‚¤ãƒ«ã®æ–‡å­—ã‚³ãƒ¼ãƒ‰ã§BOMä»˜ãã‹åˆ¤å®šã§ãã‚‹Function

```powershell:è‡ªä½œFunctionã€ŒCheck-BOMStatusã€
Function Check-BOMStatus {
    param (
        [Parameter(Mandatory=$true)][System.String]$targetfile
    )
    if (-Not (Test-Path $targetfile)) {
        Write-Host 'The target file does not exist.' -ForegroundColor Red
        return
    }
    
    # BOMã®ãƒã‚¤ãƒˆã‚·ãƒ¼ã‚±ãƒ³ã‚¹
    $UTF7_BOM1 = [System.Byte[]](0x2B,0x2F,0x76,0x38)
    $UTF7_BOM2 = [System.Byte[]](0x2B,0x2F,0x76,0x39)
    $UTF7_BOM3 = [System.Byte[]](0x2B,0x2F,0x76,0x2B)
    $UTF7_BOM4 = [System.Byte[]](0x2B,0x2F,0x76,0x2F)
    $UTF8_BOM = [System.Byte[]](0xEF,0xBB,0xBF)
    $UTF16BE_BOM = [System.Byte[]](0xFE,0xFF)
    $UTF16LE_BOM = [System.Byte[]](0xFF,0xFE)
    $UTF32BE_BOM = [System.Byte[]](0x00,0x00,0xFE,0xFF)
    $UTF32LE_BOM = [System.Byte[]](0xFF,0xFE,0x00,0x00)
    
    # å…ˆé ­è¡Œã‚’ãƒã‚¤ãƒˆã§èª­ã¿è¾¼ã¿å…ˆé ­ã‹ã‚‰3ãƒã‚¤ãƒˆåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    [System.Byte[]]$first_4bytes = (Get-Content -Path $targetfile -Encoding Byte -TotalCount 4)
    [System.Byte[]]$first_3bytes = $first_4bytes[0..2]
    [System.Byte[]]$first_2bytes = $first_4bytes[0..1]
    
    # å…ˆé ­ãƒã‚¤ãƒˆã§BOMä»˜ãã‹åˆ¤å®š
    # UTF-7
    if (($null -eq (Compare-Object $first_4bytes $UTF7_BOM1)) -Or
        ($null -eq (Compare-Object $first_4bytes $UTF7_BOM2)) -Or
        ($null -eq (Compare-Object $first_4bytes $UTF7_BOM3)) -Or
        ($null -eq (Compare-Object $first_4bytes $UTF7_BOM4))) {
        Write-Host "[$($targetfile)] is UTF-7 BOM."
    }
    # UTF-8
    elseif ($null -eq (Compare-Object $first_3bytes $UTF8_BOM -SyncWindow 0)) {
        Write-Host "[$($targetfile)] is UTF-8 BOM."
    }
    # UTF-16 BE
    elseif ($null -eq (Compare-Object $first_2bytes $UTF16BE_BOM -SyncWindow 0)) {
        Write-Host "[$($targetfile)] is UTF-16 BE BOM."
    }
    # UTF-16 LE
    elseif ($null -eq (Compare-Object $first_2bytes $UTF16LE_BOM -SyncWindow 0)) {
        Write-Host "[$($targetfile)] is UTF-16 LE BOM."
    }
    # UTF-32 BE
    elseif ($null -eq (Compare-Object $first_4bytes $UTF32BE_BOM -SyncWindow 0)) {
        Write-Host "[$($targetfile)] is UTF-32 BE BOM."
    }
    # UTF-32 LE
    elseif ($null -eq (Compare-Object $first_4bytes $UTF32LE_BOM -SyncWindow 0)) {
        Write-Host "[$($targetfile)] is UTF-32 LE BOM."
    }
    else {
        Write-Host "[$($targetfile)] is not BOM." -ForegroundColor Red
    }
}
```

### å‚è€ƒæƒ…å ±

https://learn.microsoft.com/ja-jp/powershell/module/microsoft.powershell.utility/compare-object
https://chaipa.hateblo.jp/entry/20081124/1227514306
https://ja.wikipedia.org/wiki/ãƒã‚¤ãƒˆé †ãƒãƒ¼ã‚¯

## ã¾ã¨ã‚

- `System.IO.StreamReader`ã‚’ä½¿ã£ã¦**æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’åˆ¤å®š**
- å…ˆé ­ã®ãƒã‚¤ãƒˆæ•°ã‚’èª­ã¿å–ã‚Š**BOMä»˜ãã‹åˆ¤å®š**
    UTF-7ã®å ´åˆï¼šå…ˆé ­4ãƒã‚¤ãƒˆã«ã‚ˆã‚Šåˆ¤æ–­
    UTF-8ã®å ´åˆï¼šå…ˆé ­3ãƒã‚¤ãƒˆã«ã‚ˆã‚Šåˆ¤æ–­
    UTF-16ã®å ´åˆï¼šå…ˆé ­2ãƒã‚¤ãƒˆã«ã‚ˆã‚Šåˆ¤æ–­
    UTF-32ã®å ´åˆï¼šå…ˆé ­4ãƒã‚¤ãƒˆã«ã‚ˆã‚Šåˆ¤æ–­

## é–¢é€£è¨˜äº‹

https://zenn.dev/haretokidoki/articles/aea5b45679d966
https://haretokidoki-blog.com/pasocon_powershell-startup/
https://zenn.dev/haretokidoki/articles/7e6924ff0cc960
