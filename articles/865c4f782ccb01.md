---
title: "[PowerShell]対象Excelファイル内のシートを任意の名前でコピーするFunction"
emoji: "😺"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["powershell"]
published: false
---

```powershell:
# 正しいシート名かチェック
function Test-ExcelSheetname {
    param(
        [Parameter(Mandatory=$true)][System.String]$SheetName
    )
    
    # 名前が空白でないかチェック
    if ([string]::IsNullOrWhiteSpace($SheetName.Trim())) {
        Write-Warning '空白である（Nullや空文字を含む）'
        return $false
    }

    # 文字数が31文字以内かチェック
    if ($SheetName.Length -gt 31) {
        Write-Warning '文字数が31文字以内ではない'
        return $false
    }

    # 禁止された文字を含むかチェック
    if ($SheetName -match "[:\\\/\?\*\[\]]") {
        Write-Warning 'コロン(:)または円記号(\)、スラッシュ(/)、疑問符(?)、アスタリスク(*)、左右の角かっこ([])が含まれている'
        return $false
    }

    return $true
}
# 文字列の拡張子をチェック
function Test-FileExtension {
    param (
        [Parameter(Mandatory=$true)][System.String]$FullFilename,
        [Parameter(Mandatory=$true)][System.String[]]$Extensions
    )

    # 文字列の存在チェック
    #   空文字・空白・Nullチェック
    if ([System.String]::IsNullOrWhiteSpace($FullFilename.Trim())) {
        Write-Error 'チェック対象の文字列に値が設定されていません。'
        return $false
    }
    #   ピリオドを含んでいるかチェック
    if ($FullFilename -notmatch '\.') {
        Write-Error 'チェック対象の文字列にピリオドが含まれていません。'
        return $false
    }
    #   ピリオドの位置が先頭、または末尾でないことをチェック
    $dotIndex = $FullFilename.LastIndexOf('.')
    if (($dotIndex -eq 0) -or
        ($dotIndex -eq $FullFilename.Length - 1)) {
        Write-Error 'チェック対象の文字列が正しいファイル名の表記ではありません。'
        return $false
    }

    # 配列内のチェック
    foreach ($item in $Extensions) {
        # Nullまたは空文字、空白のチェック
        if ([System.String]::IsNullOrWhiteSpace($item.Trim())) {
            Write-Warning '拡張子の配列内で値が設定されていないデータがあります。'
            return $false
        }
        # 先頭文字がピリオドから始まるかチェック
        if ($item -notmatch '^\.') {
            Write-Warning '拡張子の配列内に先頭文字がピリオドで始まっていないデータがあります。'
            return $false
        }
    }

    # 拡張子のチェック
    #   拡張子を取得
    [System.String]$fileExtension = $FullFilename -replace '.*(\..*)', '$1'

    #   拡張子の比較
    $isHit = $false
    foreach ($item in $Extensions) {
        # チェック対象の拡張子と比較する拡張子が合致した場合
        if ($fileExtension -eq $item) {
            $isHit = $true
            break
        }
    }

    # 判定した結果
    return $isHit
}
# ExcelのCOMオブジェクトを開放する処理
function Release-ExcelObjects {
    param (
        [Microsoft.Office.Interop.Excel.ApplicationClass]$ExcelObject,
        [System.__ComObject]$WorkbookObject
    )

    # ワークブックのオブジェクトがある場合は開放
    if ($null -ne $WorkbookObject) {
        [System.Runtime.InteropServices.Marshal]::ReleaseComObject($WorkbookObject)
    }
    # エクセルのオブジェクトがある場合は開放
    if ($null -ne $ExcelObject) {
        [System.Runtime.InteropServices.Marshal]::ReleaseComObject($ExcelObject)
    }

    # ガベージコレクションを強制的に実行
    [System.GC]::Collect()
    [System.GC]::WaitForPendingFinalizers()
}

# 対象のファイル内にあるシートを指定の名前でコピーするFunction
function Copy-ExcelSheet {
    param (
        [System.String]$Path,
        [System.String]$CopyFrom,
        [System.String]$CopyTo
    )

    # 入力チェック
    if (-not (Test-Path $Path)) {
        Write-Warning "対象パスが有効ではありません。[対象パス: $($Path)]"
        return
    }
    # 拡張子のチェック
    elseif (-not (Test-FileExtension $Path @('.xls', '.xlsx'))) {
        Write-Warning "対象パスのファイルがExcelファイルではありません。[対象パス: $($Path)]"
        return
    }
    # シート名の値チェック（空文字・シート名として使用可能な文字列）
    elseif (-not (Test-ExcelSheetname $CopyFrom)) {
        Write-Warning "コピー元のシート名が適正な値ではありません。[コピー元シート名: $($CopyFrom)]]"
        return
    }
    elseif (-not (Test-ExcelSheetname $CopyTo)) {
        Write-Warning "コピー先のシート名が適正な値ではありません。[コピー先シート名: $($CopyTo)]]"
        return
    }
    # シートの存在チェック

    # COMオブジェクトを参照
    $excel = New-Object -ComObject Excel.Application
    $excel.Visible = $false
    $excel.DisplayAlerts = $false

    # 対象ファイルを開く処理
    try {
        $workbook = $excel.Workbooks.Open($Path)
    }
    catch {
        Write-Error "Excelファイルを開く処理でエラーが発生しました。[対象パス: $($Path)]"
        Release-ExcelObjects($excel, $workbook)
        return
    }
    
    # コピー元のシートを参照
    try {
        $fromSheet = $workbook.Worksheets.Item($CopyFrom)
    }
    catch {
        Write-Error "コピー元のシート参照でエラーが発生しました。[対象パス: $($Path), コピー元のシート名: $($CopyFrom)]"
        Release-ExcelObjects($excel, $workbook)
        return
    }

    # シートのコピー処理
    try {
        $fromSheet.Copy($fromSheet)
    }
    catch {
        Write-Error "シートコピー処理でエラーが発生しました。[対象パス: $($Path), コピー元のシート名: $($CopyFrom)]"
    }

    # コピーしたシート名を変更（コピー後にアクティブシートが対象シートになることが前提）
    try {
        $excel.ActiveSheet.Name = $CopyTo
    }
    catch {
        Write-Error "コピーしたシート名の変更処理でエラーが発生しました。[対象パス: $($Path), コピー元のシート名: $($CopyFrom), コピー先のシート名: $($CopyTo)]"
    }

    $workbook.Close($false)
    $excel.Quit()

    # COMオブジェクトを解放
    [System.Runtime.InteropServices.Marshal]::ReleaseComObject($workbook)
    [System.Runtime.InteropServices.Marshal]::ReleaseComObject($excel)
    [System.GC]::Collect()
    [System.GC]::WaitForPendingFinalizers()
}
```

$excel = New-Object -ComObject Excel.Application
$excel.Visible = $true

# 既存のExcelファイルを開く
$workbook = $excel.Workbooks.Open("D:\Downloads\inputExcel.xlsx")

# コピーしたいシートを選択（ここでは'シート1'と仮定）
$sheetToCopy = $workbook.Worksheets.Item("Sheet1")

# 新しいシートを作成し、選択したシートをコピー
$sheetToCopy.Copy($sheetToCopy)

# コピーされたシートの名前を変更（ここでは'コピーしたシート'と仮定）
$excel.ActiveSheet.Name = "コピーしたシート"

# 変更を保存し、Excelファイルを閉じる
$workbook.Save()
$workbook.Close()

# Excelインスタンスを閉じる
$excel.Quit()

