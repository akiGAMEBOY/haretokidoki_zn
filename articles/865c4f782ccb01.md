---
title: "[PowerShell]Excelãƒ•ã‚¡ã‚¤ãƒ«ã®æŒ‡å®šã—ãŸã‚·ãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹Function"
emoji: "ðŸ˜º"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["powershell"]
published: false
---

```powershell:
#################################################################################
# å‡¦ç†åã€€ | Test-FileLocked
# æ©Ÿèƒ½ã€€ã€€ | ãƒ•ã‚¡ã‚¤ãƒ«ãŒé–‹ã‹ã‚Œã¦ã„ã‚‹ã‹ï¼ˆãƒ­ãƒƒã‚¯çŠ¶æ…‹ã‚’ï¼‰ç¢ºèª
#          | å‚è€ƒæƒ…å ±ï¼šhttps://zenn.dev/haretokidoki/articles/b4f4399570000a
#--------------------------------------------------------------------------------
# æˆ»ã‚Šå€¤ã€€ | Boolean
#     ã€€ã€€ |  True: ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã„ã¦ã„ã‚‹çŠ¶æ…‹ï¼ˆãƒ­ãƒƒã‚¯çŠ¶æ…‹ï¼‰, False: é–‹ã„ã¦ã„ãªã„çŠ¶æ…‹
# å¼•æ•°ã€€ã€€ | -
#################################################################################
function Test-FileLocked {
    param (
        [Parameter(Mandatory=$true)][System.String]$Path
    )

    if (-Not(Test-Path $Path)) {
        Write-Error 'å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚' -ErrorAction Stop
    }

    # ç›¸å¯¾ãƒ‘ã‚¹ã ã¨Openãƒ¡ã‚½ãƒƒãƒ‰ãŒæ­£å¸¸å‹•ä½œã—ãªã„ç‚ºã€çµ¶å¯¾ãƒ‘ã‚¹ã«å¤‰æ›
    $fullPath = (Resolve-Path -Path $Path -ErrorAction SilentlyContinue).Path

    $fileLocked = $false
    try {
        # èª­ã¿å–ã‚Šå°‚ç”¨ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãå‡¦ç†ã‚’å®Ÿè¡Œ
        $fileStream = [System.IO.File]::Open($fullPath, 'Open', 'ReadWrite', 'None')
    }
    catch {
        # ãƒ•ã‚¡ã‚¤ãƒ«ãŒé–‹ã‘ãªã„å ´åˆã€ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã¨åˆ¤æ–­
        $fileLocked = $true
    }
    finally {
        if ($null -ne $fileStream) {
            $fileStream.Close()
        }
    }

    return $fileLocked
}
# æ­£ã—ã„ã‚·ãƒ¼ãƒˆåã‹ãƒã‚§ãƒƒã‚¯
function Test-ExcelSheetname {
    param(
        [Parameter(Mandatory=$true)][System.String]$SheetName
    )
    
    # åå‰ãŒç©ºç™½ã§ãªã„ã‹ãƒã‚§ãƒƒã‚¯
    if ([string]::IsNullOrWhiteSpace($SheetName.Trim())) {
        Write-Warning 'ç©ºç™½ã§ã‚ã‚‹ï¼ˆNullã‚„ç©ºæ–‡å­—ã‚’å«ã‚€ï¼‰'
        return $false
    }

    # æ–‡å­—æ•°ãŒ31æ–‡å­—ä»¥å†…ã‹ãƒã‚§ãƒƒã‚¯
    if ($SheetName.Length -gt 31) {
        Write-Warning 'æ–‡å­—æ•°ãŒ31æ–‡å­—ä»¥å†…ã§ã¯ãªã„'
        return $false
    }

    # ç¦æ­¢ã•ã‚ŒãŸæ–‡å­—ã‚’å«ã‚€ã‹ãƒã‚§ãƒƒã‚¯
    if ($SheetName -match "[:\\\/\?\*\[\]]") {
        Write-Warning 'ã‚³ãƒ­ãƒ³(:)ã¾ãŸã¯å††è¨˜å·(\)ã€ã‚¹ãƒ©ãƒƒã‚·ãƒ¥(/)ã€ç–‘å•ç¬¦(?)ã€ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯(*)ã€å·¦å³ã®è§’ã‹ã£ã“([])ãŒå«ã¾ã‚Œã¦ã„ã‚‹'
        return $false
    }

    return $true
}
# æ–‡å­—åˆ—ã®æ‹¡å¼µå­ã‚’ãƒã‚§ãƒƒã‚¯
function Test-FileExtension {
    param (
        [Parameter(Mandatory=$true)][System.String]$FullFilename,
        [Parameter(Mandatory=$true)][System.String[]]$Extensions
    )

    # æ–‡å­—åˆ—ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
    #   ç©ºæ–‡å­—ãƒ»ç©ºç™½ãƒ»Nullãƒã‚§ãƒƒã‚¯
    if ([System.String]::IsNullOrWhiteSpace($FullFilename.Trim())) {
        Write-Error 'ãƒã‚§ãƒƒã‚¯å¯¾è±¡ã®æ–‡å­—åˆ—ã«å€¤ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚'
        return $false
    }
    #   ãƒ”ãƒªã‚ªãƒ‰ã‚’å«ã‚“ã§ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if ($FullFilename -notmatch '\.') {
        Write-Error 'ãƒã‚§ãƒƒã‚¯å¯¾è±¡ã®æ–‡å­—åˆ—ã«ãƒ”ãƒªã‚ªãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚'
        return $false
    }
    #   ãƒ”ãƒªã‚ªãƒ‰ã®ä½ç½®ãŒå…ˆé ­ã€ã¾ãŸã¯æœ«å°¾ã§ãªã„ã“ã¨ã‚’ãƒã‚§ãƒƒã‚¯
    $dotIndex = $FullFilename.LastIndexOf('.')
    if (($dotIndex -eq 0) -or
        ($dotIndex -eq $FullFilename.Length - 1)) {
        Write-Error 'ãƒã‚§ãƒƒã‚¯å¯¾è±¡ã®æ–‡å­—åˆ—ãŒæ­£ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«åã®è¡¨è¨˜ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚'
        return $false
    }

    # é…åˆ—å†…ã®ãƒã‚§ãƒƒã‚¯
    foreach ($item in $Extensions) {
        # Nullã¾ãŸã¯ç©ºæ–‡å­—ã€ç©ºç™½ã®ãƒã‚§ãƒƒã‚¯
        if ([System.String]::IsNullOrWhiteSpace($item.Trim())) {
            Write-Warning 'æ‹¡å¼µå­ã®é…åˆ—å†…ã§å€¤ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚'
            return $false
        }
        # å…ˆé ­æ–‡å­—ãŒãƒ”ãƒªã‚ªãƒ‰ã‹ã‚‰å§‹ã¾ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if ($item -notmatch '^\.') {
            Write-Warning 'æ‹¡å¼µå­ã®é…åˆ—å†…ã«å…ˆé ­æ–‡å­—ãŒãƒ”ãƒªã‚ªãƒ‰ã§å§‹ã¾ã£ã¦ã„ãªã„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚'
            return $false
        }
    }

    # æ‹¡å¼µå­ã®ãƒã‚§ãƒƒã‚¯
    #   æ‹¡å¼µå­ã‚’å–å¾—
    [System.String]$fileExtension = $FullFilename -replace '.*(\..*)', '$1'

    #   æ‹¡å¼µå­ã®æ¯”è¼ƒ
    $isHit = $false
    foreach ($item in $Extensions) {
        # ãƒã‚§ãƒƒã‚¯å¯¾è±¡ã®æ‹¡å¼µå­ã¨æ¯”è¼ƒã™ã‚‹æ‹¡å¼µå­ãŒåˆè‡´ã—ãŸå ´åˆ
        if ($fileExtension -eq $item) {
            $isHit = $true
            break
        }
    }

    # åˆ¤å®šã—ãŸçµæžœ
    return $isHit
}
# ã‚·ãƒ¼ãƒˆã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
Function Test-ExcelSheetExists {
    param(
        [System.String]$Path,
        [System.String]$CheckSheet
    )

    $sheetExists = $false

    try {
        $excelApp = New-Object -ComObject Excel.Application
        $excelApp.Visible = $false
        $excelApp.DisplayAlerts = $false
        $workBooks = $excelApp.Workbooks
        $workBook = $workBooks.Open($Path)
        $workSheets = $workBook.Sheets

        foreach ($workSheet in $workSheets) {
            if ($workSheet.Name -eq $CheckSheet) {
                $sheetExists = $true
                break
            }
        }
    }
    catch {
        Write-Error "ã‚·ãƒ¼ãƒˆã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ã§äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚[è©³ç´°: $($_.Exception.Messsage)]"
    }
    finally {
        # ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ã¾ã§è§£æ”¾
        if ($null -ne $workSheet) {
            [System.Runtime.Interopservices.Marshal]::ReleaseComObject($workSheet) > $null
            $workSheet = $null
            Remove-Variable workSheet -ErrorAction SilentlyContinue
        }
        if ($null -ne $workSheets) {
            [System.Runtime.Interopservices.Marshal]::ReleaseComObject($workSheets) > $null
            $workSheets = $null
            Remove-Variable workSheets -ErrorAction SilentlyContinue
        }
        if ($null -ne $workBook) {
            # ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ã®ä¿å­˜ã—ãªã„ã§çµ‚äº†
            $workBook.Close($false)
            
            [System.Runtime.Interopservices.Marshal]::ReleaseComObject($workBook) > $null
            $workBook = $null
            Remove-Variable workBook -ErrorAction SilentlyContinue
        }
        if ($null -ne $workBooks) {
            [System.Runtime.Interopservices.Marshal]::ReleaseComObject($workBooks) > $null
            $workBooks = $null
            Remove-Variable workBooks -ErrorAction SilentlyContinue
        }

        # Excelã‚¢ãƒ—ãƒªçµ‚äº†
        if ($null -ne $excelApp) {
            [System.GC]::Collect()
            [System.GC]::WaitForPendingFinalizers()
            [System.GC]::Collect()

            $excelApp.Quit()
            [System.Runtime.Interopservices.Marshal]::ReleaseComObject($excelApp) > $null
            $excelApp = $null
            Remove-Variable excelApp -ErrorAction SilentlyContinue

            [System.GC]::Collect()
            [System.GC]::WaitForPendingFinalizers()
            [System.GC]::Collect()
        }
    }

    return $sheetExists
}

# å¯¾è±¡ã®ãƒ•ã‚¡ã‚¤ãƒ«å†…ã«ã‚ã‚‹ã‚·ãƒ¼ãƒˆã‚’æŒ‡å®šã®åå‰ã§ã‚³ãƒ”ãƒ¼ã™ã‚‹Function
function Copy-ExcelSheet {
    param (
        [System.String]$Path,
        [System.String]$CopyFrom,
        [System.String]$CopyTo
    )

    # å…¥åŠ›ãƒã‚§ãƒƒã‚¯
    if (-not (Test-Path $Path)) {
        Write-Warning "å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ãŒæœ‰åŠ¹ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚[å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«: $($Path)]"
        return
    }
    # æ‹¡å¼µå­ã®ãƒã‚§ãƒƒã‚¯
    elseif (-not (Test-FileExtension $Path @('.xls', '.xlsx'))) {
        Write-Warning "å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ãŒExcelãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚[å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«: $($Path)]"
        return
    }
    # ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
    elseif (Test-FileLocked($Path)) {
        Write-Warning "å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ãŒé–‹ã‹ã‚Œã¦ã„ã¾ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‰ã˜ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚[å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«: $($Path)]"
        return
    }
    # ã‚·ãƒ¼ãƒˆåã®å€¤ãƒã‚§ãƒƒã‚¯ï¼ˆç©ºæ–‡å­—ãƒ»ã‚·ãƒ¼ãƒˆåã¨ã—ã¦ä½¿ç”¨å¯èƒ½ãªæ–‡å­—åˆ—ï¼‰
    elseif (-not (Test-ExcelSheetname $CopyFrom)) {
        Write-Warning "ã‚³ãƒ”ãƒ¼å…ƒã®ã‚·ãƒ¼ãƒˆåãŒé©æ­£ãªå€¤ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚[ã‚³ãƒ”ãƒ¼å…ƒã‚·ãƒ¼ãƒˆå: $($CopyFrom)]]"
        return
    }
    elseif (-not (Test-ExcelSheetname $CopyTo)) {
        Write-Warning "ã‚³ãƒ”ãƒ¼å…ˆã®ã‚·ãƒ¼ãƒˆåãŒé©æ­£ãªå€¤ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚[ã‚³ãƒ”ãƒ¼å…ˆã‚·ãƒ¼ãƒˆå: $($CopyTo)]]"
        return
    }
    # ã‚³ãƒ”ãƒ¼å…ƒã‚·ãƒ¼ãƒˆã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
    elseif (-not (Test-ExcelSheetExists $Path $CopyFrom)) {
        Write-Warning "ã‚³ãƒ”ãƒ¼å…ƒã®ã‚·ãƒ¼ãƒˆåãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚[å¯¾è±¡ãƒ‘ã‚¹: $($Path), ã‚³ãƒ”ãƒ¼å…ƒã‚·ãƒ¼ãƒˆå: $($CopyFrom)]]"
        return
    }
    # ã‚³ãƒ”ãƒ¼å…ˆã‚·ãƒ¼ãƒˆã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
    elseif (Test-ExcelSheetExists $Path $CopyTo) {
        Write-Warning "ã‚³ãƒ”ãƒ¼å…ˆã¨ã—ã¦æŒ‡å®šã—ã¦ã„ã‚‹ã‚·ãƒ¼ãƒˆåãŒã™ã§ã«å­˜åœ¨ã—ã¾ã™ã€‚[å¯¾è±¡ãƒ‘ã‚¹: $($Path), ã‚³ãƒ”ãƒ¼å…ˆã‚·ãƒ¼ãƒˆå: $($CopyTo)]]"
        return
    }

    # ã‚·ãƒ¼ãƒˆã®ã‚³ãƒ”ãƒ¼å‡¦ç†
    $excelApp = $null
    $workBooks = $null
    $workBook = $null
    $workSheets = $null
    $workSheet = $null
    $cells = $null
    $cell = $null

    try {
        # COMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‚ç…§
        $excelApp = New-Object -ComObject Excel.Application
        $excelApp.Visible = $false
        $excelApp.DisplayAlerts = $false

        # å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãå‡¦ç†
        $workBooks = $excelApp.Workbooks
        $workBook = $workBooks.Open($Path)
                
        # ã‚³ãƒ”ãƒ¼å…ƒã®ã‚·ãƒ¼ãƒˆã‚’å‚ç…§
        $workSheets = $workBook.Worksheets
        $workSheet = $workSheets.Item($CopyFrom)

        # ã‚·ãƒ¼ãƒˆã®ã‚³ãƒ”ãƒ¼å‡¦ç†
        $workSheet.Copy($workSheet)

        # ã‚³ãƒ”ãƒ¼ã—ãŸã‚·ãƒ¼ãƒˆåã‚’å¤‰æ›´ï¼ˆã‚³ãƒ”ãƒ¼å¾Œã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ãƒˆãŒå¯¾è±¡ã‚·ãƒ¼ãƒˆã«ãªã‚‹ã“ã¨ãŒå‰æï¼‰
        $BeforeSheetname = $excelApp.ActiveSheet.Name
        $excelApp.ActiveSheet.Name = $CopyTo
    }

    catch {
        Write-Error "ã‚·ãƒ¼ãƒˆã®ã‚³ãƒ”ãƒ¼å‡¦ç†ã§äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚[è©³ç´°: $($_.Exception.Message), å ´æ‰€: $($_.InvocationInfo.MyCommand.Name)]"
    }

    finally {
        # ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ã¾ã§è§£æ”¾
        if ($null -ne $workSheet) {
            [System.Runtime.Interopservices.Marshal]::ReleaseComObject($workSheet) > $null
            $workSheet = $null
            Remove-Variable workSheet -ErrorAction SilentlyContinue
        }
        if ($null -ne $workSheets) {
            [System.Runtime.Interopservices.Marshal]::ReleaseComObject($workSheets) > $null
            $workSheets = $null
            Remove-Variable workSheets -ErrorAction SilentlyContinue
        }
        if ($null -ne $workBook) {
            # ä¿å­˜ã—ã¦çµ‚äº†
            $workBook.Close($true)

            [System.Runtime.Interopservices.Marshal]::ReleaseComObject($workBook) > $null
            $workBook = $null
            Remove-Variable workBook -ErrorAction SilentlyContinue
        }
        if ($null -ne $workBooks) {
            [System.Runtime.Interopservices.Marshal]::ReleaseComObject($workBooks) > $null
            $workBooks = $null
            Remove-Variable workBooks -ErrorAction SilentlyContinue
        }

        # Excelã‚¢ãƒ—ãƒªçµ‚äº†
        if ($null -ne $excelApp) {
            [System.GC]::Collect()
            [System.GC]::WaitForPendingFinalizers()
            [System.GC]::Collect()

            $excelApp.Quit()
            [System.Runtime.Interopservices.Marshal]::ReleaseComObject($excelApp) > $null
            $excelApp = $null
            Remove-Variable excelApp -ErrorAction SilentlyContinue

            [System.GC]::Collect()
            [System.GC]::WaitForPendingFinalizers()
            [System.GC]::Collect()
        }
    }
}
```

## é–¢é€£è¨˜äº‹

https://haretokidoki-blog.com/pasocon_powershell-startup/
https://zenn.dev/haretokidoki/articles/7e6924ff0cc960
https://zenn.dev/haretokidoki/articles/fb6830f9155de5
