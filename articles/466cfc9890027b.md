---
title: "[PowerShell]ExcelのCOMオブジェクトを開放するFunction"
emoji: "🐥"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["powershell", "excel"]
published: false
---
## 概要

モジュールで使った後の解放処理をFunctionに

## 対応方法

```powershell:
# ExcelのCOMオブジェクトを開放する処理
function Release-ExcelObjects {
    param (
        [Microsoft.Office.Interop.Excel.ApplicationClass]$ExcelObject,
        [System.__ComObject]$WorkbookObject
    )

    # ワークブックのオブジェクトがある場合は開放
    if ($null -ne $WorkbookObject) {
        # ワークブックが閉じられていることを確認
        if (-not ($WorkbookObject.Saved)) {
            Write-Error 'ワークブックが開かれている状態です。'
            return
        }
        [System.Runtime.InteropServices.Marshal]::ReleaseComObject($WorkbookObject)
    }
    # エクセルのオブジェクトがある場合は開放
    if ($null -ne $ExcelObject) {
        # Excelアプリが閉じれらていることを確認
        if ($ExcelObject.Workbooks.Count -gt 0) {
            Write-Error 'Excelアプリが開かれている状態です。'
            return
        }
        [System.Runtime.InteropServices.Marshal]::ReleaseComObject($ExcelObject)
    }

    # ガベージコレクションを強制的に実行
    [System.GC]::Collect()
    [System.GC]::WaitForPendingFinalizers()
}
```


https://zenn.dev/pfirsich/articles/8eb131db9eba3d