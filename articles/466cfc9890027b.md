---
title: "[PowerShell]ExcelCOMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè§£æ”¾ã§å†åˆ©ç”¨ã—ã‚„ã™ã„æ–¹æ³•ã‚’èª¿ã¹ãŸã‘ã©"
emoji: "ğŸ¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["powershell", "excel"]
published: false
---
## æ¦‚è¦

PowerShellã§Excelã‚’åˆ¶å¾¡ã™ã‚‹éš›ã«Excelã®[COMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ](https://e-words.jp/w/COM.html)ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
ã“ã®COMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§PowerShellã§ã‚‚ExcelãŒæ“ä½œå¯èƒ½ã¨ãªã‚Šã¾ã™ãŒã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’çµ‚äº†ã™ã‚‹éš›ã«è‡ªå‹•ã§ãƒ—ãƒ­ã‚»ã‚¹ã‚’é–‹æ”¾ã—ã¦ãã‚Œã¾ã›ã‚“ã€‚

[ã“ã¡ã‚‰](https://zenn.dev/pfirsich/articles/8eb131db9eba3d) ã‚„ [ã“ã¡ã‚‰](https://qiita.com/mima_ita/items/aa811423d8c4410eca71) ã®è¨˜äº‹ã«ã‚ã‚‹é€šã‚Šã€æ˜ç¤ºçš„ã«ãƒ—ãƒ­ã‚»ã‚¹ã‚’é–‹æ”¾ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ãã“ã§ Excelã®COMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã® è§£æ”¾å‡¦ç†ã®Function ã‚„ çµ‚äº†å‡¦ç†ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚¯ ã‚’ä½¿ç”¨ã—ãŸæ–¹æ³•ã‚’æ¤œè¨¼ã—ã¾ã—ãŸãŒã€
çµå±€ã€å…ƒã®è¨˜äº‹ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹æ–¹æ³•ã§è½ã¡ç€ã„ãŸã¨ã„ã†è¨˜äº‹ã§ã™ã€‚

## ã“ã®è¨˜äº‹ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ

- PowerShellã§ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã€ŒImportExcelã€ã‚’ä½¿ã„ãŸã„æ–¹
- ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«çµŒç”±ã§Excelã®COMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‘¼ã³å‡ºã—çµ‚äº†å‡¦ç†ã‚’ã‚¹ãƒãƒ¼ãƒˆã«å¯¾å¿œã—ãŸã„ã¨è€ƒãˆã¦ã„ã‚‹æ–¹
    çµå±€ã€ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚

## å¯¾å¿œæ–¹æ³•

:::message
**ã‚ˆã‚Šè‰¯ã„æ–¹æ³•ã‚’ã”å­˜ã˜ã®æœ‰è­˜è€…ã®æ–¹ãŒã„ã‚Œã°ã‚³ãƒ¡ãƒ³ãƒˆãã ã•ã„ï¼**

å†åˆ©ç”¨ã—ã‚„ã™ã„æ–¹æ³•ã‚’æ‰‹ã‚’å‹•ã‹ã—ã¦ç¢ºèªã—ã¦ã¿ãŸã‚‚ã®ã®ã€Functionã‚„ScriptBlockã¨ã„ã£ãŸæ‰‹æ®µã§ã¯ã€Excelã®COMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®è§£æ”¾å‡¦ç†ã¯ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚

ã‚‚ã£ã¨åŠ¹ç‡ã‚ˆã„æ–¹æ³•ã§Excelã®COMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‹æ”¾ã™ã‚‹å‡¦ç†ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹æœ‰è­˜è€…ã®æ–¹ãŒã„ã‚Œã°ã€
ã‚³ãƒ¡ãƒ³ãƒˆã§ã‚„ã•ã—ãæ•™ãˆã¦é ‚ã‘ã‚‹ã¨å¬‰ã—ã„ã§ã™ã€‚
:::

### æˆåŠŸï¼šè§£æ”¾å‡¦ç†ã‚’ç›´æ¥ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã™ã‚‹æ–¹æ³•ï¼ˆæˆåŠŸã€‚ã¨ã„ã†ã‹å…ƒè¨˜äº‹ã®ã¾ã¾ï¼‰

å‰è¿°ã—ãŸã¨ãŠã‚Šã€å…ƒã®è¨˜äº‹é€šã‚Šã®æ–¹æ³•ã§ã™ã€‚

Try/Catch/Finallyã®ã†ã¡ã€Tryã§Excelã®COMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å‘¼ã³å‡ºã—ã‚„Excelæ“ä½œã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚
Catchã¯ã€ã‚¨ãƒ©ãƒ¼å‡¦ç†ã€‚Finallyã§Excelã®COMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‹æ”¾ã™ã‚‹å‡¦ç†ã‚’ç›´æ¥ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¨ã„ã†æµã‚Œã€‚

```powershell:
$excelApp = $null
$workBooks = $null
$workBook = $null
$workSheets = $null
$workSheet = $null
$cells = $null
$cell = $null
try {
    # Excelã®ãƒ¡ã‚¤ãƒ³å‡¦ç†
    $excelApp = New-Object -ComObject Excel.Application
    $excelApp.Visible = $false
    $excelApp.DisplayAlerts = $false

    $workBooks = $excelApp.Workbooks
    $workBook = $workBooks.Open("å¯¾è±¡Excelãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹")

    $workSheets = $workBook.Worksheets
    $workSheet = $workSheets.Item("ã‚·ãƒ¼ãƒˆå")

    $cells = $workSheet.Cells
    $cell = $cells.Item(1,1)

    $cellValue = $cell.Value2

    Write-Host "A1ã®å€¤: $($cellValue)"
}
catch {
    # ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
    Write-Error "äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚[è©³ç´°: $($_.Exception.Message)]"
}
finally {
    # ã‚»ãƒ«ã‹ã‚‰ãƒ–ãƒƒã‚¯ã¾ã§è§£æ”¾
    if ($null -ne $cell) {
        [System.Runtime.Interopservices.Marshal]::ReleaseComObject($cell) > $null
        $cell = $null
        Remove-Variable cell -ErrorAction SilentlyContinue
    }
    if ($null -ne $cells) {
        [System.Runtime.Interopservices.Marshal]::ReleaseComObject($cells) > $null
        $cells = $null
        Remove-Variable cells -ErrorAction SilentlyContinue
    }
    if ($null -ne $workSheet) {
        [System.Runtime.Interopservices.Marshal]::ReleaseComObject($workSheet) > $null
        $workSheet = $null
        Remove-Variable workSheet -ErrorAction SilentlyContinue
    }
    if ($null -ne $workSheets) {
        [System.Runtime.Interopservices.Marshal]::ReleaseComObject($workSheets) > $null
        $workSheets = $null
        Remove-Variable workSheets -ErrorAction SilentlyContinue
    }
    if ($null -ne $workBook) {
        # ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ã®ä¿å­˜ã—ãªã„ã§çµ‚äº†
        $workBook.Close($false)

        [System.Runtime.Interopservices.Marshal]::ReleaseComObject($workBook) > $null
        $workBook = $null
        Remove-Variable workBook -ErrorAction SilentlyContinue
    }
    if ($null -ne $workBooks) {
        [System.Runtime.Interopservices.Marshal]::ReleaseComObject($workBooks) > $null
        $workBooks = $null
        Remove-Variable workBooks -ErrorAction SilentlyContinue
    }

    # Excelã‚¢ãƒ—ãƒªçµ‚äº†
    if ($null -ne $excelApp) {
        [System.GC]::Collect()
        [System.GC]::WaitForPendingFinalizers()
        [System.GC]::Collect()

        $excelApp.Quit()
        [System.Runtime.Interopservices.Marshal]::ReleaseComObject($excelApp) > $null
        $excelApp = $null
        Remove-Variable excelApp -ErrorAction SilentlyContinue

        [System.GC]::Collect()
        [System.GC]::WaitForPendingFinalizers()
        [System.GC]::Collect()
    }
}
```

### å¤±æ•—ï¼šè§£æ”¾å‡¦ç†ã®ã¿ã‚’Functionã§å®šç¾©ã—å®Ÿè¡Œã—ãŸãŒè§£æ”¾ä¸å¯

ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã™ã‚‹å‰ã«ã©ã†ãªã‚‹ã‹ã‚ã‹ã£ã¦ã„ãŸã‚‚ã®ã®å®Ÿéš›ã«ä½œæˆã—ã¦å‹•ã‹ã—ã¦ã¿ã¾ã—ãŸã€‚
å¼•æ•°ã§COMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ç‚ºã€ã“ã®Functionå¤–ã§å‘¼ã³å‡ºã—ãŸCOMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯è§£æ”¾ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚

```powershell:Function
# Excel COMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®è§£æ”¾
Function Release-ExcelObjects {
    param (
        [Parameter(Mandatory=$true)][Microsoft.Office.Interop.Excel.ApplicationClass]$Excel,
        [System.__ComObject]$Workbooks=$null,
        [System.__ComObject]$Workbook=$null,
        [System.__ComObject]$WorkSheets=$null,
        [System.__ComObject]$WorkSheet=$null,
        [System.__ComObject]$Cells=$null,
        [System.__ComObject]$Cell=$null
    )

    if ($ExcelObject.Workbooks.Count -gt 0) {
        Write-Error 'Excelã‚¢ãƒ—ãƒªãŒé–‹ã‹ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ã§ã™ã€‚'
        return
    }

    # è§£æ”¾
    if ($null -ne $Cell) {
        [System.Runtime.InteropServices.Marshal]::ReleaseComObject($Cell)
        $Cell = $null
        Remove-Variable Cell -ErrorAction SilentlyContinue
    }
    if ($null -ne $Cells) {
        [System.Runtime.InteropServices.Marshal]::ReleaseComObject($Cells)
        $Cells = $null
        Remove-Variable Cells -ErrorAction SilentlyContinue
    }
    if ($null -ne $WorkSheet) {
        [System.Runtime.InteropServices.Marshal]::ReleaseComObject($WorkSheet)
        $WorkSheet = $null
        Remove-Variable WorkSheet -ErrorAction SilentlyContinue
    }
    if ($null -ne $WorkSheets) {
        [System.Runtime.InteropServices.Marshal]::ReleaseComObject($WorkSheets)
        $WorkSheets = $null
        Remove-Variable WorkSheets -ErrorAction SilentlyContinue
    }
    if ($null -ne $WorkBook) {
        [System.Runtime.InteropServices.Marshal]::ReleaseComObject($WorkBook)
        $WorkBook = $null
        Remove-Variable WorkBook -ErrorAction SilentlyContinue
    }
    if ($null -ne $WorkBooks) {
        [System.Runtime.InteropServices.Marshal]::ReleaseComObject($WorkBooks)
        $WorkBooks = $null
        Remove-Variable WorkBooks -ErrorAction SilentlyContinue
    }

    [System.GC]::Collect()
    [System.GC]::WaitForPendingFinalizers()
    [System.GC]::Collect()

    $Excel.Quit()

    if ($null -ne $Excel) {
        [System.Runtime.InteropServices.Marshal]::ReleaseComObject($Excel)
        $Excel = $null
        Remove-Variable Excel -ErrorAction SilentlyContinue
    }
    
    # ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å¼·åˆ¶çš„ã«å®Ÿè¡Œ
    [System.GC]::Collect()
    [System.GC]::WaitForPendingFinalizers()
    [System.GC]::Collect()
}
```

### å¤±æ•—ï¼šExcelçµ‚äº†å‡¦ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã‚’å®šç¾© -> Invoke-Commandã§å®Ÿè¡Œã—ãŸãŒè§£æ”¾ä¸å¯

ãŠãã‚‰ãFunctionã¨åŒã˜çµæœã«ãªã‚‹ã ã‚ã†ã¨æ€ã„æ¤œè¨¼ã—ã€æƒ³å®šé€šã‚Šè§£æ”¾å¤±æ•—ã€‚

```powershell:
# ExcelCOMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®çµ‚äº†ã‚’ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã§å®šç¾©
$ExitExcelObjects = {
    param (
        [Parameter(Mandatory=$true)][Microsoft.Office.Interop.Excel.ApplicationClass]$Excel,
        [System.__ComObject]$Workbooks=$null,
        [System.__ComObject]$Workbook=$null,
        [System.__ComObject]$WorkSheets=$null,
        [System.__ComObject]$WorkSheet=$null,
        [System.__ComObject]$Cells=$null,
        [System.__ComObject]$Cell=$null
    )

    $WorkBook.Close($false)

    # ã‚»ãƒ«ã‹ã‚‰ãƒ–ãƒƒã‚¯ã¾ã§è§£æ”¾
    if ($null -ne $Cell) {
        [System.Runtime.Interopservices.Marshal]::ReleaseComObject($Cell) > $null
        $Cell = $null
        Remove-Variable Cell -ErrorAction SilentlyContinue
    }
    if ($null -ne $Cells) {
        [System.Runtime.Interopservices.Marshal]::ReleaseComObject($Cells) > $null
        $Cells = $null
        Remove-Variable Cells -ErrorAction SilentlyContinue
    }
    if ($null -ne $WorkSheet) {
        [System.Runtime.Interopservices.Marshal]::ReleaseComObject($WorkSheet) > $null
        $WorkSheet = $null
        Remove-Variable WorkSheet -ErrorAction SilentlyContinue
    }
    if ($null -ne $WorkSheets) {
        [System.Runtime.Interopservices.Marshal]::ReleaseComObject($WorkSheets) > $null
        $WorkSheets = $null
        Remove-Variable WorkSheets -ErrorAction SilentlyContinue
    }
    if ($null -ne $WorkBook) {
        [System.Runtime.Interopservices.Marshal]::ReleaseComObject($WorkBook) > $null
        $WorkBook = $null
        Remove-Variable WorkBook -ErrorAction SilentlyContinue
    }
    if ($null -ne $WorkBooks) {
        [System.Runtime.Interopservices.Marshal]::ReleaseComObject($WorkBooks) > $null
        $WorkBooks = $null
        Remove-Variable WorkBooks -ErrorAction SilentlyContinue
    }

    [System.GC]::Collect()
    [System.GC]::WaitForPendingFinalizers()
    [System.GC]::Collect()

    $Excel.Quit()
    [System.Runtime.Interopservices.Marshal]::ReleaseComObject($Excel) > $null
    $Excel = $null
    Remove-Variable Excel -ErrorAction SilentlyContinue

    [System.GC]::Collect()
    [System.GC]::WaitForPendingFinalizers()
    [System.GC]::Collect()
}

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã®å®Ÿè¡Œ
Invoke-Command -ScriptBlock $ExitExcelObjects -ArgumentList $excel, $books, $book, $sheets, $sheet, $cells, $cell
```

## å‚è€ƒæƒ…å ±

https://zenn.dev/pfirsich/articles/8eb131db9eba3d
https://qiita.com/mima_ita/items/aa811423d8c4410eca71

## ã¾ã¨ã‚

- 

## é–¢é€£è¨˜äº‹

https://haretokidoki-blog.com/pasocon_powershell-startup/
https://zenn.dev/haretokidoki/articles/7e6924ff0cc960
https://zenn.dev/haretokidoki/articles/fb6830f9155de5
