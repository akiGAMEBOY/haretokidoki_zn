---
title: "[PowerShell]Excelã®COMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‹æ”¾ã™ã‚‹Function"
emoji: "ðŸ¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["powershell", "excel"]
published: false
---
## æ¦‚è¦

ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ä½¿ã£ãŸå¾Œã®è§£æ”¾å‡¦ç†ã‚’Functionã«

## å¯¾å¿œæ–¹æ³•

```powershell:æœ€åˆã«æƒ³åƒã—ãŸFunction
# Excel COMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®è§£æ”¾
function Release-ExcelObjects {
    param (
        [Microsoft.Office.Interop.Excel.ApplicationClass]$Excel,
        [System.__ComObject]$Workbooks,
        [System.__ComObject]$Workbook,
        [System.__ComObject]$WorkSheets,
        [System.__ComObject]$WorkSheet,
        [System.__ComObject]$Cells,
        [System.__ComObject]$Cell
    )

    if ($ExcelObject.Workbooks.Count -gt 0) {
        Write-Error 'Excelã‚¢ãƒ—ãƒªãŒé–‹ã‹ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ã§ã™ã€‚'
        return
    }

    # è§£æ”¾
    if ($null -ne $Cell) {
        [System.Runtime.InteropServices.Marshal]::ReleaseComObject($Cell)
        $Cell = $null
        Remove-Variable Cell -ErrorAction SilentlyContinue
    }
    if ($null -ne $Cells) {
        [System.Runtime.InteropServices.Marshal]::ReleaseComObject($Cells)
        $Cells = $null
        Remove-Variable Cells -ErrorAction SilentlyContinue
    }
    if ($null -ne $WorkSheet) {
        [System.Runtime.InteropServices.Marshal]::ReleaseComObject($WorkSheet)
        $WorkSheet = $null
        Remove-Variable WorkSheet -ErrorAction SilentlyContinue
    }
    if ($null -ne $WorkSheets) {
        [System.Runtime.InteropServices.Marshal]::ReleaseComObject($WorkSheets)
        $WorkSheets = $null
        Remove-Variable WorkSheets -ErrorAction SilentlyContinue
    }
    if ($null -ne $WorkBook) {
        [System.Runtime.InteropServices.Marshal]::ReleaseComObject($WorkBook)
        $WorkBook = $null
        Remove-Variable WorkBook -ErrorAction SilentlyContinue
    }
    if ($null -ne $WorkBooks) {
        [System.Runtime.InteropServices.Marshal]::ReleaseComObject($WorkBooks)
        $WorkBooks = $null
        Remove-Variable WorkBooks -ErrorAction SilentlyContinue
    }

    [System.GC]::Collect()
    [System.GC]::WaitForPendingFinalizers()
    [System.GC]::Collect()

    $Excel.Quit()

    if ($null -ne $Excel) {
        [System.Runtime.InteropServices.Marshal]::ReleaseComObject($Excel)
        $Excel = $null
        Remove-Variable Excel -ErrorAction SilentlyContinue
    }
    
    # ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å¼·åˆ¶çš„ã«å®Ÿè¡Œ
    [System.GC]::Collect()
    [System.GC]::WaitForPendingFinalizers()
    [System.GC]::Collect()
}
```

ä¸Šè¨˜ã ã¨ã€Functionã®å¼•æ•°ã§ä½¿ç”¨ã™ã‚‹COMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«é–¢ã—ã¦ã‚‚ã€è§£æ”¾ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ç‚ºã€
Functionã™ã‚‹å¿…è¦æ€§ãŒãªããªã‚‹ã€‚

ãã“ã§ã€Functionã§ã¯ãªãScriptBlockã«ã—ã¦å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã€‚

```powershell:
# ExcelCOMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®çµ‚äº†ã‚’ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã§å®šç¾©
$ExitExcelObjects = {
    param (
        [Microsoft.Office.Interop.Excel.ApplicationClass]$Excel,
        [System.__ComObject]$Workbooks,
        [System.__ComObject]$Workbook,
        [System.__ComObject]$WorkSheets,
        [System.__ComObject]$WorkSheet,
        [System.__ComObject]$Cells,
        [System.__ComObject]$Cell
    )

    $WorkBook.Close($false)

    # ã‚»ãƒ«ã‹ã‚‰ãƒ–ãƒƒã‚¯ã¾ã§è§£æ”¾
    [System.Runtime.Interopservices.Marshal]::ReleaseComObject($Cell) > $null
    [System.Runtime.Interopservices.Marshal]::ReleaseComObject($Cells) > $null
    [System.Runtime.Interopservices.Marshal]::ReleaseComObject($WorkSheet) > $null
    [System.Runtime.Interopservices.Marshal]::ReleaseComObject($WorkSheets) > $null
    [System.Runtime.Interopservices.Marshal]::ReleaseComObject($WorkBook) > $null
    [System.Runtime.Interopservices.Marshal]::ReleaseComObject($WorkBooks) > $null

    $Cell = $null
    Remove-Variable Cell -ErrorAction SilentlyContinue
    $Cells = $null
    Remove-Variable Cells -ErrorAction SilentlyContinue
    $WorkSheet = $null
    Remove-Variable WorkSheet -ErrorAction SilentlyContinue
    $WorkSheets = $null
    Remove-Variable WorkSheets -ErrorAction SilentlyContinue
    $WorkBook = $null
    Remove-Variable WorkBook -ErrorAction SilentlyContinue
    $WorkBooks = $null
    Remove-Variable WorkBooks -ErrorAction SilentlyContinue

    [System.GC]::Collect()
    [System.GC]::WaitForPendingFinalizers()
    [System.GC]::Collect()

    $Excel.Quit()
    [System.Runtime.Interopservices.Marshal]::ReleaseComObject($Excel) > $null
    $Excel = $null
    Remove-Variable Excel -ErrorAction SilentlyContinue

    [System.GC]::Collect()
    [System.GC]::WaitForPendingFinalizers()
    [System.GC]::Collect()

}

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã®å®Ÿè¡Œ
Invoke-Command -ScriptBlock $ExitExcelObjects -ArgumentList $excel $books $book $sheets $sheet $cells $cell
```

ä¸Šè¨˜ã«é–¢ã—ã¦ã‚‚å¼•æ•°ã§æ¸¡ã—ãŸã‚‚ã®ã‚’é–‹æ”¾ã™ã‚‹å¿…è¦ãŒã‚ã‚Šæ„å‘³ãŒãªã„ã€‚
ã‚„ã¯ã‚Šãã®ã¾ã¾å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã¨ã„ã†äº‹ãŒã‚ã‹ã£ãŸã€‚

ä¸‹è¨˜ã¯ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®è§£æ”¾ã‚’Tryãƒ»Catchã®Fainallyã«å…¥ã‚Œã‚‹äº‹ã§ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã«ã‚‚
è§£æ”¾ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã‚ˆã†ã«ã—ãŸã‚³ãƒ¼ãƒ‰ã€‚

```powershell:
try {
    # Excelã®ãƒ¡ã‚¤ãƒ³å‡¦ç†
}
catch {
    # ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
}
finally {
    # ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ã‹ã‚‰ã‚»ãƒ«ã¾ã§ã®è§£æ”¾å‡¦ç†
    $workBook.Close($false)

    # ã‚»ãƒ«ã‹ã‚‰ãƒ–ãƒƒã‚¯ã¾ã§è§£æ”¾
    [System.Runtime.Interopservices.Marshal]::ReleaseComObject($cell) > $null
    [System.Runtime.Interopservices.Marshal]::ReleaseComObject($cells) > $null
    [System.Runtime.Interopservices.Marshal]::ReleaseComObject($workSheet) > $null
    [System.Runtime.Interopservices.Marshal]::ReleaseComObject($workSheets) > $null
    [System.Runtime.Interopservices.Marshal]::ReleaseComObject($workBook) > $null
    [System.Runtime.Interopservices.Marshal]::ReleaseComObject($workBooks) > $null

    $cell = $null
    Remove-Variable Cell -ErrorAction SilentlyContinue
    $cells = $null
    Remove-Variable Cells -ErrorAction SilentlyContinue
    $workSheet = $null
    Remove-Variable WorkSheet -ErrorAction SilentlyContinue
    $workSheets = $null
    Remove-Variable WorkSheets -ErrorAction SilentlyContinue
    $workBook = $null
    Remove-Variable WorkBook -ErrorAction SilentlyContinue
    $workBooks = $null
    Remove-Variable WorkBooks -ErrorAction SilentlyContinue

    # Excelã‚¢ãƒ—ãƒªçµ‚äº†
    [System.GC]::Collect()
    [System.GC]::WaitForPendingFinalizers()
    [System.GC]::Collect()

    $excelApp.Quit()
    [System.Runtime.Interopservices.Marshal]::ReleaseComObject($excelApp) > $null
    $excelApp = $null
    Remove-Variable excelApp -ErrorAction SilentlyContinue

    [System.GC]::Collect()
    [System.GC]::WaitForPendingFinalizers()
    [System.GC]::Collect()
}
```

https://zenn.dev/pfirsich/articles/8eb131db9eba3d
