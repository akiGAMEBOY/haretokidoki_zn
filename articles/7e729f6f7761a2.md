---
title: "[PowerShell]TREEコマンドと同じ結果を出力するFunction"
emoji: "🌊"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["powershell"]
published: false
---

```powershell
function Get-FolderTree {
    param (
        [string]$Path
    )

    function Show-Tree {
        param (
            [string]$CurrentPath,
            [hashtable]$Levels
        )

        $items = Get-ChildItem -Path $CurrentPath | Sort-Object { -not $_.PSIsContainer }, Name
        $count = $items.Count
        $index = 0

        foreach ($item in $items) {
            $index++
            $isLastItem = $index -eq $count
            $level = $Levels.Count
            $Levels[$level] = $isLastItem
            $indent = ""

            for ($i = 0; $i -lt $level; $i++) {
                $indent += if ($Levels[$i]) { "     " } else { "│    " }
            }

            $line = if ($isLastItem) { "└─ " } else { "├─ " }

            if ($item.PSIsContainer) {
                Write-Output "$indent$line< $item >"
                Show-Tree -CurrentPath $item.FullName -Levels $Levels
            } else {
                Write-Output "$indent$line$item"
            }

            $Levels.Remove($level)
        }
    }

    if (Test-Path -Path $Path) {
        $Levels = @{}
        Show-Tree -CurrentPath $Path -Levels $Levels
    } else {
        Write-Output "指定されたパスは存在しません: $Path"
    }
}

# Example usage
Get-FolderTree -Path "C:\Program Files\WindowsPowerShell\Modules\ImportExcel"
```

TREEコマンドの問題点。そのまま実行するとフォルダーのみ表示される。
ファイルもひょうじするためには「TREE /F」が必要。

ディレクトリとファイルの区別がつきにくい。
これは、オプションをしていすることで変更できるようにしたい。

また、可能であれば、クリップボードに出力結果をコピーしたい。

また、かのうであれば、インタラクティブモードを導入しユーザーが操作によりディレクトリを展開したり折りたたんだりするようにしてみたい。

下記コード、Windows Formsを使用することで実現できた。
オプションなどにより切り分けができるとよい。

```powershell
function Out-TreeView {
    param (
        [System.String]$Path,
        [System.String[]]$WindowSize = @(600, 450),
        [System.Single]$FontSize = 9.5
    )

    # 内部関数：フォルダーのツリー構造を取得する関数
    function Get-FolderTree {
        param (
            [System.String]$Path,
            [Windows.Forms.TreeNode]$ParentNode
        )
        $items = (Get-ChildItem -Path $Path)
        foreach ($item in $items) {
            $node = New-Object Windows.Forms.TreeNode
            $node.Text = $item.Name
            $node.Tag = $item.FullName
            if ($item.PSIsContainer) {
                $node.BackColor = [System.Drawing.Color]::DarkBlue
                $node.ForeColor = [System.Drawing.Color]::AliceBlue
                Get-FolderTree -Path $item.FullName -ParentNode $node
            } else {
                $node.ForeColor = [System.Drawing.Color]::Black
            }
            $ParentNode.Nodes.Add($node) > $null
        }
    }

    # フォームの作成
    Add-Type -AssemblyName System.Windows.Forms
    Add-Type -AssemblyName System.Drawing

    $mainForm = New-Object Windows.Forms.Form
    $mainForm.Text = "$($Path) - Out-TreeView"
    $mainForm.Size = New-Object Drawing.Size($WindowSize[0], $WindowSize[1])
    $mainForm.Icon = [System.Drawing.Icon]::ExtractAssociatedIcon("$PSHOME\powershell.exe")
    
    # ステータスバーの作成
    $statusBar = New-Object Windows.Forms.StatusBar
    $mainForm.Controls.Add($statusBar)

    # ツリービューの作成
    $treeView = New-Object Windows.Forms.TreeView
    [System.Int32]$witdhSize = [System.Int32]$WindowSize[0] * 0.957
    [System.Int32]$heightSize = [System.Int32]$WindowSize[1] * 0.845
    $treeView.Size = New-Object Drawing.Size($witdhSize, $heightSize)
    $treeView.Location = New-Object Drawing.Point(5, 5)
    $treeView.Anchor = `
    [System.Windows.Forms.AnchorStyles]::Top -bor `
    [System.Windows.Forms.AnchorStyles]::Bottom -bor `
    [System.Windows.Forms.AnchorStyles]::Left -bor `
    [System.Windows.Forms.AnchorStyles]::Right
    $treeView.Font = New-Object System.Drawing.Font("Microsoft Sans Serif", $FontSize)

    # ルートノードの作成
    $root = New-Object Windows.Forms.TreeNode
    $root.Text = $Path
    $root.Tag = $Path
    $root.BackColor = [System.Drawing.Color]::DarkBlue
    $root.ForeColor = [System.Drawing.Color]::AliceBlue
    $treeView.Nodes.Add($root) > $null

    # ツリー構造の取得
    Get-FolderTree -Path $root.Tag -ParentNode $root

    # ノード選択イベントの設定
    $treeView.add_AfterSelect({
        param ($sender, $e)
        $item = Get-Item -Path $e.Node.Tag
        $statusBar.Text = "$($item.Name) - Last Modified: $($item.LastWriteTime)"
    })

    # フォームにツリービューを追加
    $mainForm.Controls.Add($treeView)

    # フォームの表示
    $mainForm.Add_Shown({$mainForm.Activate()})
    $mainForm.ShowDialog() > $null
}

# Functionを実行
Out-TreeView 'D:\Downloads'
```

2つの方法を記載後、それぞれの機能を踏襲しているコードを書くとわかりやすいかも。
