---
title: "[PowerShell]指定したモジュールの導入有無を確認するFunction"
emoji: "🗺"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["powershell"]
published: false
---
## 概要

PowerShellは、追加でモジュールを導入（インストール）することで、実現可能な機能が拡張されます。
拡張される機能はインストールするモジュールによって異なります。

今回は、PowerShellスクリプトにおいて、指定のモジュールがインストールされているか
チェックできるFunctionを作成したので紹介。

## この記事のターゲット

- PowerShellユーザーの方
- PowerShellスクリプトなどで指定したモジュールの導入有無を確認したい方

## 対応方法

:::message
**注意事項：モジュールをインストールする際は、管理者権限が必要**

言葉のとおり、コマンドレット「`Install-Module`」で新しくモジュールを導入する場合は、
直接コマンドで導入するのであれば、コンソール（PowerShellウィンドウ や Windowsターミナルなど）の起動時、
PowerShellスクリプトであれば、スクリプトの実行時に **管理者権限が必要** です。

管理者権限の実行方法はさまざまな手段がありますが、代表的な方法は下記のとおりです。

- コンソールを管理者権限で起動する場合
    1. PowerShellウィンドウ、または[Windowsターミナル](https://www.microsoft.com/store/productId/9N0DX20HK701) を右クリック
    2. “管理者として実行”を選択
- PowerShellスクリプトを管理者権限で実行する場合
    1. 対象のバッチファイル(`*.bat`)、もしくはPowerShellスクリプトファイル(`*.ps1`) を右クリック
    2. “管理者として実行”を選択

:::

### PowerShellで指定したモジュール名で導入有無をチェックするFunction

チェックのみ（`Get-Module`）だけであれば、下記の通り管理者権限は不要。

```powershell:
# モジュールの導入有無を確認
function Test-Module {
    param (
        [System.String]$ModuleName
    )
    $module = (Get-Module -ListAvailable -Name $ModuleName)
    if ($module) {
        return $true
    } else {
        return $false
    }
}
```

チェックの結果、指定のモジュールを導入していない場合にインストールする処理は下記の通り。
このコードの場合、モジュールのインストールを伴う処理内容となる為、**管理者権限が必要** です。

```powershell:
#################################################################################
# 処理名　 | Test-IsAdmin
# 機能　　 | PowerShellが管理者として実行しているか確認
#          | 参考情報：https://zenn.dev/haretokidoki/articles/67788ca9b47b27
#--------------------------------------------------------------------------------
# 戻り値　 | Boolean（True: 管理者権限あり, False: 管理者権限なし）
# 引数　　 | -
#################################################################################
function Test-IsAdmin {
    $win_id = [System.Security.Principal.WindowsIdentity]::GetCurrent()
    $win_principal = new-object System.Security.Principal.WindowsPrincipal($win_id)
    $admin_permission = [System.Security.Principal.WindowsBuiltInRole]::Administrator
    return $win_principal.IsInRole($admin_permission)
}
# ImportExcel モジュールのインストール
$moduleName = 'ImportExcel'
if (-Not(Test-Module $moduleName)) {
    if (-Not(Test-IsAdmin)) {
        Write-Warning '管理者権限がない為、モジュールのインストールができません。処理を中断します。'
        return
    }
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
    Install-Module -Name $moduleName -Scope CurrentUser -Force
    Write-Host "$($moduleName) モジュールをインストールしました。"
} else {
    Write-Host "$($moduleName) モジュールは既にインストールされています。"
}
```

## まとめ

- 指定したモジュール名が導入されているか戻り値「`bool`（`$True` or `$False`）」で確認できるFunctionを自作できた
- 作成したFunctionで判定した結果が未導入（`$False`）でインストールコマンド（`Install-Module` ）を実行する場合は、**管理者権限が必要**
- 
