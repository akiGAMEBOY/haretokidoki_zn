---
title: "PowerShellの文字コードを設定するFunctionを作成しました"
emoji: "🎉"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["powershell"]
published: false
---
## 概要

文字コードがUTF-8で出力されるコマンド、wingetのコマンド結果を変数に代入した後、
Write-Hostコマンドレットで変数の中身を確認すると文字化けで表示されてしまいました。

コードにすると下記の通り。

```powershell:
```

変数に入れず、そのままコマンドを実行すると正常に表示されます。

この現象を調べた結果、PowerShellでコンソール出力する際の文字コードの規定値（`[console]::OutputEncoding`）が `Shift JIS`になっている事が原因のようでした。

この設定をUTF-8に変更する解決方法と、ついでにPowerShellの文字コードまわりの設定を一括で変更できるFunctionを紹介します。

## この記事のターゲット

- PowerShellのコンソール表示で文字化けしてしまった方
- 解決方法の文字コードを変更するコマンドを知りたい方
- PowerShellの文字コードまわりの設定を一括で変更できるFunctionを確認したい方

## 解決方法

今回、文字化けしてしまったコマンドは、`winget upgrade` です。
この`winget`コマンドの文字コードは「UTF-8」のようで下記のコマンドでコンソール出力時の文字コードを「UTF-8」に合わせた結果、解決しました。

```powershell:コピー用
[console]::OutputEncoding = [System.Text.Encoding]::"設定したい文字コード"
```

```powershell:文字コードをUTF-8に変更する場合
[console]::OutputEncoding = [System.Text.Encoding]::UTF8
```

:::details 設定できる文字コードの一覧

|設定可能な文字コード|説明|
|---|---|
|ASCII|ASCII (7 ビット) 文字セットのエンコーディングを取得します。|
|BigEndianUnicode|ビッグ エンディアンのバイト順を使用する UTF-16 形式のエンコーディングを取得します。|
|Default|この .NET 実装の既定のエンコードを取得します。<br>* PowerShell 5.x（Desktop） だと `Shift JIS`。PowerShell 7.x（Core）だと`UTF-8`。|
|Latin1|Latin1 文字セット (ISO-8859-1) のエンコードを取得します。|
|Unicode|リトル エンディアン バイト順を使用する UTF-16 形式のエンコーディングを取得します。|
|UTF32|リトル エンディアン バイト順を使用する UTF-32 形式のエンコーディングを取得します。|
|UTF7|UTF-7 形式のエンコーディングを取得します。|
|UTF8|UTF-8 形式のエンコーディングを取得します。|
*表：`System.Text.Encoding`で設定できる文字コードの一覧*

- 参考情報
    https://learn.microsoft.com/ja-jp/dotnet/api/system.text.encoding#properties

:::

## 原因

:::message
**注意：ここで記載されいてる原因は、推測・想像の範囲内で記載されています**

詳しいロジックを説明している公式文書を見つける事ができなかったので、ある程度きりわけした結果をまとめて記載しています。
記載されている情報が誤っている可能性があるので情報の取扱いにはご注意ください。
:::

### 変数に代入したときに文字化けしてしまう原因

コマンドで出力される文字コードが「UTF-8」でしたが、コンソール出力の文字コードが「Shift JIS」だった為、
変数の代入時に文字化けが発生してしまったようです。

ただ、コンソール出力の文字コード設定「`[console]::OutputEncoding`」が厳密にどのようなロジックで関わり、
変数代入時に文字化けするのか、よくわかりませんでした。

おそらく、変数に代入されるまでは下記のような流れだと推測しています。

1. コマンド実行
1. コマンド出力結果がコンソール文字コードに基づきShift JISで表示される
    （**ここで文字化けが発生**）
1. 文字化け表示された出力結果をそのまま変数に代入
1. 中身が文字化けしている変数が完成

### 変数に入れないでそのまま実行すると正常に表示される理由

変数に代入する時は文字化けするのに、なぜそのまま表示されるときも文字化けしないのかは、
よくわかりませんでした。

かなり当てずっぽうな見解ですが、もしかすると`winget`コマンド側でコンソールにそのまま表示される際、
何かしらの文字コードの制御がかかり、正常表示されているのかもしれません。
（[`winget`のソース](https://github.com/microsoft/winget-cli)を読めば何かわかるかもしれません。）

## PowerShellの文字コードまわりを一括変更するFunction

ネットで検索した結果、[こちら](https://qiita.com/e4rfx/items/3772ecb58b6918ed5348)でPowerShellの文字コードの設定を一括で変更してくれるFunctionが紹介されていました。

ただ、このFunctionは記事内にもある通り、PowerShellのDesktop Edition（5.x以前）の環境で想定されたコードでした。

PowerShell のCore Edition（6.0以降）の環境では、`[System.Text.Encoding]::Default`の結果が`sjis`ではなく`utf8`となる為、
想定の動作と異なるようでした。

PowerShell Coreでも使用できるよう記事を参考に微修正したので紹介します。

```powershell:作成したFunction
function SetPsOutputEncoding {
    param (
        [System.String]$charcode = 'reset_encoding'
    )

    switch ($charcode) {
        # 文字エンコードをUTF8に設定する
        'utf8' {
            $PSDefaultParameterValues['*:Encoding'] = 'utf8'
            $global:OutputEncoding = [System.Text.Encoding]::UTF8
            [console]::OutputEncoding = [System.Text.Encoding]::UTF8
        }
        # 文字エンコードをShift JIS（SJIS）に設定する
        'sjis' {
            $PSDefaultParameterValues['*:Encoding'] = 'default' # この変数ではShift JISのパラメーターがなく指定できない。Coreでは、デフォルトがUTF-8となってしまう。
            $global:OutputEncoding = [System.Text.Encoding]::GetEncoding('shift_jis')
            [console]::OutputEncoding = [System.Text.Encoding]::GetEncoding('shift_jis')
        }
        # 文字エンコードをASCIIに設定する
        'ascii' {
            $PSDefaultParameterValues.Remove('*:Encoding')
            $global:OutputEncoding = [System.Text.Encoding]::ASCII
            [console]::OutputEncoding = [System.Text.Encoding]::ASCII
        }
        # デフォルトパラメータの文字エンコード指定を解除する
        'rm_encoding' {
            $PSDefaultParameterValues.Remove('*:Encoding')
        }
        # 文字エンコード設定を初期状態に戻す
        'reset_encoding' {
            $PSDefaultParameterValues.Remove('*:Encoding')

            If ($PSVersionTable.PSEdition -eq 'Core') {
                # Core の場合
                $global:OutputEncoding = [System.Text.Encoding]::UTF8
                [console]::OutputEncoding = [System.Text.Encoding]::GetEncoding('shift_jis')
            }
            else {
                # Core 以外の場合（PowerShell 5.Xなど）
                $global:OutputEncoding = [System.Text.Encoding]::ASCII
                [console]::OutputEncoding = [System.Text.Encoding]::GetEncoding('shift_jis')
                # ↑PowerShell 5.x の場合、[System.Text.Encoding]::Default でも Shift JISを設定可能だが、
                # 　ここではあえてGetEncodingで文字コードを指定
            }
            
            # タイトルの表示切替Function呼び出し（コメントアウト解除は任意）
            # (https://zenn.dev/haretokidoki/articles/67788ca9b47b27)
            # ChangeWindowTitle
        }
    }
}

# 実行テスト
SetPsOutputEncoding 'utf8'
```

## Bing AI

:::details Bing AI
> 
> 
> powershell で文字コードを設定する際の下記項目について、説明してください。
> ・$PSDefaultParameterValues['*:Encoding']
> ・$global:OutputEncoding
> ・[console]::OutputEncoding
-----
> 
> 
> こんにちは、これは Bing です。😊
> 
> powershell で文字コードを設定する際の下記項目について、以下のように説明できます。
> 
> - `$PSDefaultParameterValues['*:Encoding']` は、コンソールに出力する文字コードの規定値を設定するための変数です。例えば、`$PSDefaultParameterValues['Out-File:Encoding'] = 'utf8'` とすると、`Out-File` コマンドレットの `Encoding` パラメーターの既定値が `utf8` になります¹。
> - `$global:OutputEncoding` は、powershell から外部プログラムに出力する際の文字エンコードを設定するための変数です。例えば、`$global:OutputEncoding = [System.Text.Encoding]::GetEncoding('shift_jis')` とすると、外部プログラムに渡す出力がシフトJISになります²。
> - `[console]::OutputEncoding` は、powershell のコンソールに出力する際の文字エンコードを設定するためのプロパティです。例えば、`[console]::OutputEncoding = [System.Text.Encoding]::GetEncoding('shift_jis')` とすると、コンソールに表示する出力がシフトJISになります³。
> 
> これらの項目は、それぞれ異なる目的や範囲で文字エンコードを変更するために使用されます。文字化けを防ぐためには、適切な文字エンコードを選択する必要があります。⁴
> 
> 参考になれば幸いです。😊
> 
> ソース: Bing との会話 2024/1/15
> (1) 文字エンコードについて - PowerShell | Microsoft Learn. https://learn.microsoft.com/ja-jp/powershell/module/microsoft.powershell.core/about/about_character_encoding?view=powershell-7.4.
> (2) PowerShellの文字コードを変更する #Windows - Qiita. https://qiita.com/Yorcna/items/d015ebe4fae50882e3a1.
> (3) Powershellの文字化けを直す方法 - おれさまラボ. https://bing.com/search?q=powershell+%e6%96%87%e5%ad%97%e3%82%b3%e3%83%bc%e3%83%89+%e8%a8%ad%e5%ae%9a.
> (4) Powershellの文字化けを直す方法 - おれさまラボ. https://www.oresamalabo.net/entry/2021/09/15/003143.
:::

:::details
> 
> 
> PowerShellで実行したコマンドの結果を変数に代入する際、規定値の文字コードを教えてください。
> また、その文字コードを変更する方法も合わせて教えてください。
-----
> 
> 
> PowerShellで実行したコマンドの結果を変数に代入する際の文字コードと変更方法についてお答えします。😊
> 
> PowerShellでコマンドの実行結果を変数に代入するには、`$()`や`$result = コマンド`などの方法があります。¹² このとき、変数に代入される文字コードは、PowerShellのバージョンや実行環境によって異なります。³
> 
> 一般的には、PowerShell 5.1以前では、変数に代入される文字コードは**UTF-16 LE**です。³ PowerShell 6.0以降では、変数に代入される文字コードは**UTF-8**です。⁴
> 
> 変数に代入される文字コードを変更する方法は、以下のようになります。³⁴
> 
> - PowerShell 5.1以前では、`[System.Text.Encoding]::Default`や`[System.Text.Encoding]::UTF8`などのエンコーディングオブジェクトを使って、変数に代入する前にコマンドの出力を変換する必要があります。例えば、システムの既定の文字コードで変数に代入するには、以下のようにします。
> ```powershell
> $result = [System.Text.Encoding]::Default.GetString([System.Text.Encoding]::Unicode.GetBytes(コマンド))
> ```
> - PowerShell 6.0以降では、`$OutputEncoding`変数を使って、変数に代入する前にコマンドの出力の文字コードを指定することができます。例えば、システムの既定の文字コードで変数に代入するには、以下のようにします。
> ```powershell
> $OutputEncoding = [System.Text.Encoding]::Default
> $result = コマンド
> ```
> 
> 以上が、PowerShellで実行したコマンドの結果を変数に代入する際の文字コードと変更方法についての回答です。参考になれば幸いです。🙏
> 
> ¹: 【PowerShell】コマンド出力結果を変数に入力する方法 - Qiita
> ²: PowerShell > 実行結果の変数への代入 | 型 | 参照 - Qiita
> ³: PowerShellでコマンド結果を変数に入れる方法 - teratail【テラテイル】
> ⁴: PowerShell 6.0で変わった文字コード関連の仕様 - Qiita
> 
> ソース: Bing との会話 2024/1/18
> (1) 【PowerShell】コマンド出力結果を変数に入力する方法 - Qiita. https://qiita.com/empty948/items/f5908a2960af46e9b793.
> (2) PowerShell > 実行結果の変数への代入 | 型 | 参照 - Qiita. https://qiita.com/7of9/items/48e20f7430162c5a5883.
> (3) バッチファイルでコマンドの実行結果を変数に代入する - treedown .... https://blog.treedown.net/entry/2020/04/02/010000.
> (4) powershellでコマンド結果を変数に入れる方法 - teratail【テラ .... https://teratail.com/questions/73783.
> (5) 【簡単】コマンドの実行結果を変数に入れる方法 | ゆる .... https://hacker.trickstorm.com/?p=1252.
> (6) undefined. http://www.atmarkit.co.jp/ait/articles/0607/26/news118.html.
> (7) undefined. http://www.atmarkit.
:::
