---
title: "[PowerShell]wingetコマンドの結果を変数に代入すると文字化けする場合"
emoji: "🎉"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["powershell"]
published: false
---
## 概要

文字コードがUTF-8で出力されるコマンド、wingetのコマンド結果を変数に代入し、
Write-Hostコマンドレットで変数の中身を確認すると文字化けしてしまいました。

PowerShellコンソールの文字コードを変更することで文字化けを回避する事ができました。

## この記事のターゲット

- PowerShellユーザーの方
- wingetコマンドの結果を変数にいれて文字化けせずにコンソール出力したい方
- PowerShellの文字コードまわりの設定を一括変更可能なFunctionを知りたい方

## 事象

実際に文字化けが発生した状況は下記のとおりです。

```powershell:wingetコマンド結果が入った変数を出力すると文字化け
# Windowsパッケージマネージャー、wingetコマンドでアップデート状況の結果を変数に代入
PS C:\Users\"ユーザー名"> $result = (winget upgrade)
PS C:\Users\"ユーザー名">

# 変数の内容を表示すると文字化け発生。
# 表示結果をみると改行コードも正しく認識できていない為、本来複数行ある結果が1行で表示されている。
PS C:\Users\"ユーザー名"> Write-Host $result
    -     \                                                                                                                               -     \                                                                                                                           蜷榊燕                                               ID                              繝舌・ 繧ｸ繝ｧ繝ｳ     蛻ｩ逕ｨ蜿ｯ閭ｽ       繧ｽ繝ｼ繧ｹ ----------------------------------------------------------------------------------------------------------------------- CrystalDiskInfo 8.17.14 (64 繝薙ャ繝・                CrystalDewWorld.CrystalDiskInfo 8.17.14        9.2.1          winget DBeaver 23.0.2                                     dbeaver.dbeaver                 23.0.2         23.3.2         winget Docker Desktop                                     Docker.DockerDesktop            4.18.0         4.26.1         winget GIMP 2.10.34                                       GIMP.GIMP                       2.10.34        2.10.36        winget Git                                                Git.Git                         2.40.0         2.43.0         winget Kubernetes - Minikube - A Local Kubernetes Develo窶ｦ Kubernetes.minikube             1.30.1         1.32.0         winget Microsoft Visual Studio 2010 Tools for Office Run窶ｦ Microsoft.VSTOR                 10.0.50903     10.0.60912.00  winget SourceTree                                         Atlassian.Sourcetree            3.4.12         3.4.16         winget Tera Term 4.106                                    TeraTermProject.teraterm        4.106          4.108          winget Tesseract-OCR - open source OCR engine             UB-Mannheim.TesseractOCR        5.3.1.20230401 5.3.3.20231005 winget VLC media player                                   VideoLAN.VLC                    3.0.18         3.0.20         winget WinMerge 2.16.28.0 x64                             WinMerge.WinMerge               2.16.28.0      2.16.36        winget Microsoft Visual C++ 2015-2022 Redistributable (x窶ｦ Microsoft.VCRedist.2015+.x64    14.36.32532.0  14.38.33130.0  winget Oracle VM VirtualBox 7.0.6                         Oracle.VirtualBox               7.0.6          7.0.12         winget PowerShell 7.3.10.0-x64                            Microsoft.PowerShell            7.3.10.0       7.4.1.0        winget MySQL Workbench 8.0 CE                             Oracle.MySQLWorkbench           8.0.28         8.0.34         winget Dell Display Manager                               Dell.DisplayManager             < 2.0          2.2.0.43       winget Node.js                                            OpenJS.NodeJS.LTS               18.16.0        20.10.0        winget Microsoft Visual C++ 2015-2022 Redistributable (x窶ｦ Microsoft.VCRedist.2015+.x64    14.34.31938.0  14.38.33130.0  winget Microsoft Visual C++ 2013 Redistributable (x86) -窶ｦ Microsoft.VCRedist.2013.x64     12.0.30501.0   12.0.40664.0   winget 20 繧｢繝・・繧ｰ繝ｬ繝ｼ繝峨ｒ蛻ｩ逕ｨ縺ｧ縺阪∪縺吶・
PS C:\Users\"ユーザー名">
```

なお、変数に入れずに、そのままコマンドを実行すると正常に表示されます。

## 原因

:::message
**注意：原因は特定できていません。解決結果からの推測・想像が含まれています。**

`[console]::OutputEncoding`周りで詳しいロジックの説明がある公式文書は見つかりませんでした。
今回、解決した結果から推測や想像して記載しています。
:::

この現象を調べた結果、PowerShellでコンソール出力する際の文字コードの規定値（`[console]::OutputEncoding`）が `Shift JIS`になっている事が原因のようでした。

回避方法としては、この設定を`UTF-8`に変更する方法で解決できます。

:::details 推測・想像の内容：変数代入 → 変数出力 → 文字化け の流れ

コンソール出力の文字コード設定「`[console]::OutputEncoding`」が厳密にどのようなロジックで関わり、
変数代入時に文字化けするのか、特定できていません。

おそらく、変数に代入されるまでは下記のような流れで文字化けが発生したのだと思います。

1. コマンド実行
1. コマンド出力結果がコンソール文字コードに基づき`Shift JIS`で表示される
    （**ここで文字化けが発生**）
1. 文字化けで表示された出力結果を変数に代入
1. 変数をコンソール出力すると文字化け発生！

:::

:::details わからない点：直接コマンドを実行すると文字化けしない

文字コードが `Shift JIS` の状態で変数に代入すると文字化けしている件は、発生した現象や文字コードを `UTF-8` に変更し解決した結果からコンソール出力の文字コードが原因だったのだと判断できます。
ただ、同じく `Shift JIS` の状態にもかかわらず、直接コマンドを実行したケースでは、文字化けしませんでした。
この現象について調べてみましたが、情報が見つからず原因を特定することができませんでした。

何も確証がなく当てずっぽうな見解ですが、`winget`コマンド側でそのままコンソール出力する際にだけ、
コマンド側で文字コードの制御処理が動き、自動で文字コードの変換が行われて正常に表示されているのかもしれません。
（[`winget`のソース](https://github.com/microsoft/winget-cli)を読めば何かわかる…かも）

:::

## 解決方法

解決方法を2つ紹介します。まずは、ピンポイントで問題の箇所を変更する方法。

### \[console\]::OutputEncodingを“Shift JIS”から“UTF-8”にする方法

今回、文字化けしてしまったコマンドは、`winget upgrade` 。
この`winget`コマンドの文字コードは「`UTF-8`」のようで下記のコマンドでコンソール出力時の文字コードを「`UTF-8`」に合わせた結果、解決しました。

```powershell:コンソール出力の文字コードをUTF-8に変更する方法
[console]::OutputEncoding = [System.Text.Encoding]::UTF8
```

:::details 設定できる文字コードの一覧 < クリックで折りたたみが開く >

他の文字コードにも変更可能です。

```powershell:コピー用
[console]::OutputEncoding = [System.Text.Encoding]::"設定したい文字コード"
```

- `System.Text.Encoding`で設定できる文字コードの一覧
    |設定可能な文字コード|説明|
    |---|---|
    |ASCII|ASCII (7 ビット) 文字セットのエンコーディングを取得します。|
    |BigEndianUnicode|ビッグ エンディアンのバイト順を使用する UTF-16 形式のエンコーディングを取得します。|
    |Default|この .NET 実装の既定のエンコードを取得します。<br>* PowerShell 5.x（Desktop） だと `Shift JIS`。PowerShell 7.x（Core）だと`UTF-8`。|
    |Latin1|Latin1 文字セット (ISO-8859-1) のエンコードを取得します。|
    |Unicode|リトル エンディアン バイト順を使用する UTF-16 形式のエンコーディングを取得します。|
    |UTF32|リトル エンディアン バイト順を使用する UTF-32 形式のエンコーディングを取得します。|
    |UTF7|UTF-7 形式のエンコーディングを取得します。|
    |UTF8|UTF-8 形式のエンコーディングを取得します。|

- 参考情報
    https://learn.microsoft.com/ja-jp/dotnet/api/system.text.encoding#properties

:::

### PowerShellにおける文字コードまわりの設定を一括変更するFunction

ネットで検索した結果、[こちら](https://qiita.com/e4rfx/items/3772ecb58b6918ed5348)でPowerShellの文字コードの設定を一括で変更可能なFunctionが紹介されていました。

ただ、このFunctionは、PowerShellのDesktop Edition（5.x以前）の環境で想定されているソースコードでした。

PowerShell のCore Edition（6.0以降）の環境では、`[System.Text.Encoding]::Default`の結果が`sjis`ではなく`utf8`となる為、
意図する動作と異なっています。

今回、PowerShell Coreでも使用できるFunctionを作成してみました。

```powershell:PowerShellの文字コードまわりを一括変更するFunction
Function SetPsOutputEncoding {
    param (
        [System.String]$charcode = 'reset_encoding'
    )

    switch ($charcode) {
        # 文字エンコードをUTF8に設定する
        'utf8' {
            $PSDefaultParameterValues['*:Encoding'] = 'utf8'
            $global:OutputEncoding = [System.Text.Encoding]::UTF8
            [console]::OutputEncoding = [System.Text.Encoding]::UTF8
        }
        # 文字エンコードをShift JIS（SJIS）に設定する
        'sjis' {
            $PSDefaultParameterValues['*:Encoding'] = 'default' # この変数ではShift JISのパラメーターがないので指定できない。Coreでは、デフォルトのUTF-8で設定されてしまう。
            $global:OutputEncoding = [System.Text.Encoding]::GetEncoding('shift_jis')
            [console]::OutputEncoding = [System.Text.Encoding]::GetEncoding('shift_jis')
        }
        # 文字エンコードをASCIIに設定する
        'ascii' {
            $PSDefaultParameterValues.Remove('*:Encoding')
            $global:OutputEncoding = [System.Text.Encoding]::ASCII
            [console]::OutputEncoding = [System.Text.Encoding]::ASCII
        }
        # デフォルトパラメータの文字エンコード指定を解除する
        'rm_encoding' {
            $PSDefaultParameterValues.Remove('*:Encoding')
        }
        # 文字エンコード設定を初期状態に戻す
        'reset_encoding' {
            $PSDefaultParameterValues.Remove('*:Encoding')

            If ($PSVersionTable.PSEdition -eq 'Core') {
                # Core の場合
                $global:OutputEncoding = [System.Text.Encoding]::UTF8
                [console]::OutputEncoding = [System.Text.Encoding]::GetEncoding('shift_jis')
            }
            else {
                # Core 以外の場合（PowerShell 5.1 以前）
                $global:OutputEncoding = [System.Text.Encoding]::ASCII
                [console]::OutputEncoding = [System.Text.Encoding]::GetEncoding('shift_jis')
            }
        }
    }

    # タイトルの表示切替Function呼び出し（コメントアウト解除は任意）
    # [https://zenn.dev/haretokidoki/articles/67788ca9b47b27](https://zenn.dev/haretokidoki/articles/67788ca9b47b27)
    # ChangeWindowTitle
}

# 実行テスト
SetPsOutputEncoding 'utf8'
```

## まとめ

- 事象
    `winget update`コマンドを変数に入れてからコンソール表示すると文字化けが発生。
- 原因
    コンソール出力時の文字コード（`[console]::OutputEncoding`）の規定値`Shift JIS`となっていて、`winget`コマンドで表示される`UTF-8`と食い違いがあったから。
- 解決方法
    コンソール出力時の文字コード（`[console]::OutputEncoding`）の設定を`UTF-8`に変更する。

    ```powershell:コンソール出力の文字コードをUTF-8に変更する方法
    [console]::OutputEncoding = [System.Text.Encoding]::UTF8
    ```
