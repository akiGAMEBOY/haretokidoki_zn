---
title: "PowerShellウィンドウで文字コードをセットするFunction"
emoji: "🎉"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---

## winget upgrade の結果を変数に入れると文字化け

PowerShellのCLIウィンドウ（またはコンソール、ターミナル）の初期値が[console]::OutputEncoding は Shift JIS で、$OutputEncoding は UTF8 となり、
コマンド出力では、UTF8。コンソール表示では、Shift JIS で食い違いが発生しており文字化けていた模様。

検索した結果、双方の文字コードを合わせるFunctionを作成していた方がいたので参考にさせていただいた。
https://qiita.com/e4rfx/items/3772ecb58b6918ed5348

```powershell:参考情報を元に作成したFunction
function SetOutputEncoding {
    param (
        [System.String]$char_code = 'reset_encoding'
    )

    switch ($char_code) {
        # 文字エンコードをUTF8に設定する
        'utf8' {
            $PSDefaultParameterValues['*:Encoding'] = 'utf8'
            $global:OutputEncoding = [System.Text.Encoding]::UTF8
            [console]::OutputEncoding = [System.Text.Encoding]::UTF8
            # タイトルの表示切替Function呼び出し
        }
        # 文字エンコードをShift JIS（SJIS）に設定する
        'sjis' {
            $PSDefaultParameterValues['*:Encoding'] = 'sjis'
            $global:OutputEncoding = [System.Text.Encoding]::GetEncoding('shift_jis')
            [console]::OutputEncoding = [System.Text.Encoding]::GetEncoding('shift_jis')
            # タイトルの表示切替Function呼び出し
        }
        # 文字エンコードをASCIIに設定する
        'ascii' {
            $PSDefaultParameterValues.Remove('*:Encoding')
            $global:OutputEncoding = [System.Text.Encoding]::ASCII
            [console]::OutputEncoding = [System.Text.Encoding]::ASCII
            # タイトルの表示切替Function呼び出し
        }
        # デフォルトパラメータの文字エンコード指定を解除する
        'rm_encoding' {
            $PSDefaultParameterValues.Remove('*:Encoding')
            # タイトルの表示切替Function呼び出し
        }
        # 文字エンコード設定を初期状態に戻す
        'reset_encoding' {
            $PSDefaultParameterValues.Remove('*:Encoding')

            If ($PSVersionTable.PSEdition -eq 'Core') {
                # Core の場合
                $global:OutputEncoding = [System.Text.Encoding]::UTF8
                [console]::OutputEncoding = [System.Text.Encoding]::GetEncoding('shift_jis')
            }
            else {
                # Core 以外の場合（PowerShell 5.Xなど）
                $global:OutputEncoding = [System.Text.Encoding]::ASCII
                [console]::OutputEncoding = [System.Text.Encoding]::Default     # shift_jis
            }
            
            # タイトルの表示切替Function呼び出し
            # (https://zenn.dev/haretokidoki/articles/67788ca9b47b27)
        }
    }
}

# 実行テスト
SetOutputEncoding 'utf8'
```

## Bing AI

:::details Bing AI
> 
> 
> powershell で文字コードを設定する際の下記項目について、説明してください。
> ・$PSDefaultParameterValues['*:Encoding']
> ・$global:OutputEncoding
> ・[console]::OutputEncoding
-----
> 
> 
> こんにちは、これは Bing です。😊
> 
> powershell で文字コードを設定する際の下記項目について、以下のように説明できます。
> 
> - `$PSDefaultParameterValues['*:Encoding']` は、文字エンコードを指定できるコマンドレットの既定値を設定するための変数です。例えば、`$PSDefaultParameterValues['Out-File:Encoding'] = 'utf8'` とすると、`Out-File` コマンドレットの `Encoding` パラメーターの既定値が `utf8` になります¹。
> - `$global:OutputEncoding` は、powershell から外部プログラムに出力する際の文字エンコードを設定するための変数です。例えば、`$global:OutputEncoding = [System.Text.Encoding]::GetEncoding('shift_jis')` とすると、外部プログラムに渡す出力がシフトJISになります²。
> - `[console]::OutputEncoding` は、powershell のコンソールに出力する際の文字エンコードを設定するためのプロパティです。例えば、`[console]::OutputEncoding = [System.Text.Encoding]::GetEncoding('shift_jis')` とすると、コンソールに表示する出力がシフトJISになります³。
> 
> これらの項目は、それぞれ異なる目的や範囲で文字エンコードを変更するために使用されます。文字化けを防ぐためには、適切な文字エンコードを選択する必要があります。⁴
> 
> 参考になれば幸いです。😊
> 
> ソース: Bing との会話 2024/1/15
> (1) 文字エンコードについて - PowerShell | Microsoft Learn. https://learn.microsoft.com/ja-jp/powershell/module/microsoft.powershell.core/about/about_character_encoding?view=powershell-7.4.
> (2) PowerShellの文字コードを変更する #Windows - Qiita. https://qiita.com/Yorcna/items/d015ebe4fae50882e3a1.
> (3) Powershellの文字化けを直す方法 - おれさまラボ. https://bing.com/search?q=powershell+%e6%96%87%e5%ad%97%e3%82%b3%e3%83%bc%e3%83%89+%e8%a8%ad%e5%ae%9a.
> (4) Powershellの文字化けを直す方法 - おれさまラボ. https://www.oresamalabo.net/entry/2021/09/15/003143.
:::
