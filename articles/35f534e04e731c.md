---
title: "Markdown-テーブル形式 と Excelファイル を相互変換するスクリプト"
emoji: "🎉"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["powershell"]
published: false
---
調べた限り、Pythonスクリプトで実現できそうだが、PowerShellのみで実現できるんだったら、
自作Functionを作成すると便利そう。

Markdownの表を解析してExcelに変換するためのPowerShellスクリプトを以下に示します。このスクリプトは、Markdownファイル内の表を検出し、それをExcelファイルに変換します。`ImportExcel`モジュールを使用して、Excelファイルの生成を行います。

```powershell
# ImportExcel モジュールがインストールされているか確認し、必要に応じてインストールします
if (-not (Get-Module -ListAvailable -Name ImportExcel)) {
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
    Install-Module -Name ImportExcel -Scope CurrentUser
    Write-Host "ImportExcel モジュールをインストールしました。"
} else {
    Write-Host "ImportExcel モジュールは既にインストールされています。"
}

# Markdownファイルのパス
$markdownPath = "D:\Downloads\inputMarkdownTable.md"

# Excelファイルの出力パス
$excelPath = "D:\Downloads\outputExcelData.xlsx"

# Markdownファイルを読み込みます
$markdownContent = Get-Content $markdownPath -Raw

# 表を解析する関数を定義します
Function Convert-MarkdownTableToExcel {
    param(
        [Parameter(Mandatory=$true)]
        [string]$markdownContent
    )

    # 表の開始と終了を検出する正規表現
    $tableRegex = '(?smi)^\|.*(?<!\\)\|.*$'
    $headerSplitRegex = '^\|?(.*?)(?<!\\)\|$'
    $rowSplitRegex = '^\|(.+?)(?<!\\)\|$'

    # 表の内容を抽出します
    $tables = @()
    [regex]::Matches($markdownContent, $tableRegex) | ForEach-Object {
        $tableText = $_.Value

        # ヘッダーを解析します
        $headerCount = 0
        $rows = @()

        $tableText -split "`n" | ForEach-Object {
            if ($headerCount -eq 0) {
                $header = [regex]::Split($_, '(?<!\\)\|')
                $header = $header[1..($header.Length-2)] # 最初と最後の空の要素を削除
                $headerCount += 1
            }
            elseif ($headerCount -eq 1) {
                # ヘッダーとコンテンツの区切り行をスキップ
                $headerCount += 1
            }
            else {
                $row = [regex]::Split($_, '(?<!\\)\|')
                $row = $row[1..($row.Length-2)] # 最初と最後の空の要素を削除
                if ($row.Count -eq $header.Count) {
                    $rows += ,$row
                }
            }
        }

        # 各行をオブジェクトに変換します
        $rows | ForEach-Object {
            $rowObject = New-Object psobject
            for ($i = 0; $i -lt $header.Count; $i++) {
                $rowObject | Add-Member -MemberType NoteProperty -Name $header[$i].Trim() -Value $_[$i].Trim()
            }
            $tables += ,$rowObject
        }
    }

    return $tables
}

# 表を解析します
$tables = Convert-MarkdownTableToExcel -markdownContent $markdownContent

if ($null -eq $tables) {
    Write-Error 'Markdown形式のファイルを読み取りましたが、データが空でした。'
    return
}

# Excelファイルが開かれているか確認します
function Test-FileLock {
    param (
        [Parameter(Mandatory=$true)][string]$Path
    )

    $fileLocked = $false
    try {
        # ファイルを開いてみてロックされているかテストします
        $file = [System.IO.File]::Open($Path, 'Open', 'Read', 'None')
        $file.Close()
    } catch {
        # ファイルが開けない場合はロックされていると判断します
        $fileLocked = $true
    }
    return $fileLocked
}

if (Test-Path -Path $excelPath) {
    # ファイルがロックされているかテストします
    if (Test-FileLock -path $excelPath) {
        Write-Host "Excelファイルが開かれています。ファイルを閉じてから再試行してください。"
        return
    }

    $userInput = Read-Host 'ファイルを上書きしますか？ (Yes/No)'
    $yesPatterns = "[Yy][Ee][Ss]|[Yy]"
    $noPatterns = "[Nn][Oo]|[Nn]"
    $isYes = $false
    for ($i = 0; $i -lt 2; $i++) {
        if ($userInput -match $yesPatterns) {
            $isYes = $true    
            break
        }
        else {
            Write-Host "ファイルの上書き保存をキャンセルしました。"
            return
        }
    }
    if (-Not ($isYes)) {
        Write-Warning '試行回数を超過しました。'
        return
    }

    # ユーザーが「はい」を選択した場合、ファイルを上書き保存します
    try {
        $tables | Export-Excel -Path $excelPath -Show
        Write-Host "ファイルを上書き保存しました。"
    }
    catch {
        Write-Error '上書きでExcelファイルを出力する処理でエラーが発生。'
    }
}
else {
    # 新規保存
    try {
        $tables | Export-Excel -Path $excelPath -Show
        Write-Host "新規でファイルを保存しました。"
    }
    catch {
        Write-Error '新規でExcelファイルを出力する処理でエラーが発生。'
    }
}
```

このスクリプトは、Markdownファイル内の表を検出し、それぞれの表をExcelファイルに変換するためのものです。表の解析は正規表現を使用して行われ、各行は配列に変換されます。その後、`Export-Excel` コマンドレットを使用して、解析したデータをExcelファイルに出力します。

スクリプトを実行する前に、`ImportExcel`モジュールがインストールされていることを確認してください。また、スクリプト内のファイルパスは適宜変更してください。このスクリプトは基本的な例であり、実際のMarkdownファイルの構造に応じてカスタマイズが必要になる場合があります。🔧
