---
title: "[PowerShell]“Markdownのテーブル形式”と“Excelファイル”を相互変換できるスクリプト"
emoji: "🌐"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["powershell", "markdown", "excel"]
published: false
---
## 概要

Excel のアドオンをはじめとする仕事効率化のツールを導入すると、「Excelファイル から Markdown形式のテーブル への変換」は簡単に実現できましたが、
2024年6月現在、調べたかぎり「Markdown形式のテーブル から Excelファイル への変換」についてはオンラインWebツール や Pythonスクリプト を使用する必要がありました。

とくにオンラインWebツールを使用する際、機密情報を含むデータのアップロードは危険です。
また、Pythonスクリプトを実行する場合は、（そこまで難しくないですが）実行環境が必要だったりします。

そこで今回、Windows環境において標準搭載されているPowerShellで実現する方法を紹介します。

## この記事のターゲット

- Windows OS ユーザーの方
- Markdown形式のテーブル から Excelファイル に変換したい方
    または、
- Excelファイル から Markdown形式のテーブル に変換したい方

## 対応方法

Windows OSでは、すぐにPowerShellを使用することが可能です。
ただ、今回作成したPowerShellコードでは、Excelを取り扱うために専用のモジュールを事前に導入が必要。

なお、そのモジュール「ImportExcel」をインストールする際は、管理者権限でコマンドレット「`Install-Module`」を実行する必要があります。

### 事前準備

下記のコードを事前に実行することで、モジュール「ImportExcel」のインストールが可能です。
実行するPowerShellウィンドウを“管理者として実行”していない場合はエラーが発生します。

```powershell:PowerShellでExcelファイルが使えるようになるモジュール「ImportExcel」
# モジュールの導入有無を確認
function Test-Module {
    param (
        [System.String]$ModuleName
    )
    $module = (Get-Module -ListAvailable -Name $ModuleName)
    if ($module) {
        return $true
    } else {
        return $false
    }
}
#################################################################################
# 処理名　 | Test-IsAdmin
# 機能　　 | PowerShellが管理者として実行しているか確認
#          | 参考情報：https://zenn.dev/haretokidoki/articles/67788ca9b47b27
#--------------------------------------------------------------------------------
# 戻り値　 | Boolean（True: 管理者権限あり, False: 管理者権限なし）
# 引数　　 | -
#################################################################################
function Test-IsAdmin {
    $win_id = [System.Security.Principal.WindowsIdentity]::GetCurrent()
    $win_principal = new-object System.Security.Principal.WindowsPrincipal($win_id)
    $admin_permission = [System.Security.Principal.WindowsBuiltInRole]::Administrator
    return $win_principal.IsInRole($admin_permission)
}

# ImportExcel モジュールのインストール
$moduleName = 'ImportExcel'
if (-Not(Test-Module $moduleName)) {
    if (-Not(Test-IsAdmin)) {
        Write-Warning '管理者権限がない為、モジュールのインストールができません。処理を中断します。'
        return
    }
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
    Install-Module -Name $moduleName -Scope CurrentUser -Force
    Write-Host "$($moduleName) モジュールをインストールしました。"
} else {
    Write-Host "$($moduleName) モジュールは既にインストールされています。"
}
```

::::details モジュール「ImportExcel」をアンインストールしたい場合の手順

モジュール「ImportExcel」が不要となった場合、下記のコマンドレットでモジュールのアンインストールが可能。
なお、インストール時と同様に**管理者権限が必要**です。

```powershell:コピー用
Uninstall-Module -Name ImportExcel -AllVersions
```

`Uninstall-Module`コマンドレットは `Install-Module` と同様、管理者権限が必要なコマンドです。
以降の作業では、PowerShellウィンドウを管理者として実行することで、管理者権限のある状態で実行しました。

```powershell:実際の実行結果（管理者権限で実行）
# アンインストール前：モジュールが存在すること
PS C:\WINDOWS\system32> Get-Module -ListAvailable -Name ImportExcel


    ディレクトリ: D:\Documents\WindowsPowerShell\Modules


ModuleType Version    Name                                ExportedCommands
---------- -------    ----                                ----------------
Script     7.8.9      ImportExcel                         {Add-ConditionalFormatting, Add-ExcelChart, Add-ExcelDataV...


PS C:\WINDOWS\system32>
# アンインストール実行
PS C:\WINDOWS\system32> Uninstall-Module -Name ImportExcel -AllVersions
PS C:\WINDOWS\system32>
# アンインストール後：モジュールがアンインストールされたこと
PS C:\WINDOWS\system32> Get-Module -ListAvailable -Name ImportExcel
PS C:\WINDOWS\system32>
```

:::details 参考情報：モジュール「ImportExcel」の使用直後にアンインストールしようとするとエラーが発生

今回紹介している変換するコードを実行した直後、モジュール「ImportExcel」を`Uninstall-Module`でアンインストールしょうとすると下記のエラーが発生しました。

```powershell:発生したエラー
PS C:\WINDOWS\system32> Uninstall-Module ImportExcel
警告: バージョン '7.8.9' のモジュール 'ImportExcel'
は現在使用中です。アプリケーションを終了した後で、操作をやり直してください。
PackageManagement\Uninstall-Package : モジュール 'ImportExcel' は現在使用中か、必要なアクセス許可がありません。
発生場所 C:\Program Files\WindowsPowerShell\Modules\PowerShellGet\1.0.0.1\PSModule.psm1:2194 文字:21
+ ...        $null = PackageManagement\Uninstall-Package @PSBoundParameters
+                    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : InvalidOperation: (Microsoft.Power...ninstallPackage:UninstallPackage) [Uninstall-Packag
   e]、Exception
    + FullyQualifiedErrorId : ModuleIsInUse,Uninstall-Package,Microsoft.PowerShell.PackageManagement.Cmdlets.Uninstall
   Package

PS C:\WINDOWS\system32>
```

エラーが発生するのは、モジュールを使用した時のみ発生する事を確認済み。
おそらく、モジュールの解放処理で問題があるようです。明示的にモジュールを開放する方法を探しましたが、
見つけられませんでした。

かっこ悪いですが、このようなケースになった場合は、変換処理を実行したコンソール（PowerShellウィンドウ や Windowsターミナルなど）を一度、閉じてから再度、コンソールを立ち上げて `Uninstall-Module`を実行すると正常終了します。

:::

::::

### Markdown形式のテーブル から Excelファイルに変換できるコード

```powershell:Markdown形式 から Excelファイル に変換
# モジュール「ImportExcel」をインストール済みである事
function Test-Module {
    param (
        [System.String]$ModuleName
    )
    $module = (Get-Module -ListAvailable -Name $ModuleName)
    if ($module) {
        return $true
    } else {
        return $false
    }
}

★編集中

$fromMarkdownPath = 'D:\Downloads\inputMarkdownTable.md'

# Markdownファイルを読み込みます
$markdownContents = (Get-Content $fromMarkdownPath -Raw)

# 表を解析する関数を定義します
Function Convert-MarkdownToExcel {
    param (
        [Parameter(Mandatory=$true)]
        [string]$InputContents
    )

    # 表の開始と終了を検出する正規表現
    $tableRegex = '(?smi)^\|.*(?<!\\)\|.*$'
    $headerSplitRegex = '^\|?(.*?)(?<!\\)\|$'
    $rowSplitRegex = '^\|(.+?)(?<!\\)\|$'

    # 表の内容を抽出します
    $excelTables = @()
    [regex]::Matches($markdownContents, $tableRegex) | ForEach-Object {
        $tableText = $_.Value

        # ヘッダーを解析します
        $headerCount = 0
        $rows = @()

        $tableText -split "`n" | ForEach-Object {
            if ($headerCount -eq 0) {
                $header = [regex]::Split($_, '(?<!\\)\|')
                $header = $header[1..($header.Length-2)] # 最初と最後の空の要素を削除
                $headerCount += 1
            }
            elseif ($headerCount -eq 1) {
                # ヘッダーとコンテンツの区切り行をスキップ
                $headerCount += 1
            }
            else {
                $row = [regex]::Split($_, '(?<!\\)\|')
                $row = $row[1..($row.Length-2)] # 最初と最後の空の要素を削除
                if ($row.Count -eq $header.Count) {
                    $rows += ,$row
                }
            }
        }

        # 各行をオブジェクトに変換します
        $rows | ForEach-Object {
            $rowObject = New-Object psobject
            for ($i = 0; $i -lt $header.Count; $i++) {
                $rowObject | Add-Member -MemberType NoteProperty -Name $header[$i].Trim() -Value $_[$i].Trim()
            }
            $excelTables += ,$rowObject
        }
    }

    return $excelTables
}

# 表を解析します
$excelTables = (Convert-MarkdownToExcel -InputContents $markdownContents)

if ($null -eq $excelTables) {
    Write-Error 'Markdown形式のファイルを読み取りましたが、データが空でした。'
    return
}

# Excelファイルが開かれているか確認します
function Test-FileLock {
    param (
        [Parameter(Mandatory=$true)][string]$Path
    )

    $fileLocked = $false
    try {
        # ファイルを開いてみてロックされているかテストします
        $file = [System.IO.File]::Open($Path, 'Open', 'Read', 'None')
        $file.Close()
    } catch {
        # ファイルが開けない場合はロックされていると判断します
        $fileLocked = $true
    }
    return $fileLocked
}

$toExcelPath = 'D:\Downloads\outputExcelData.xlsx'

if (Test-Path -Path $toExcelPath) {
    # ファイルがロックされているかテストします
    if (Test-FileLock -path $toExcelPath) {
        Write-Host 'Excelファイルが開かれています。ファイルを閉じてから再試行してください。'
        return
    }

    $userInput = Read-Host 'ファイルを上書きしますか？ (Yes/No)'
    $yesPatterns = '[Yy][Ee][Ss]|[Yy]'
    $noPatterns = '[Nn][Oo]|[Nn]'
    $isYes = $false
    for ($i = 0; $i -lt 2; $i++) {
        if ($userInput -match $yesPatterns) {
            $isYes = $true    
            break
        }
        else {
            Write-Host 'ファイルの上書き保存をキャンセルしました。'
            return
        }
    }
    if (-Not ($isYes)) {
        Write-Warning '試行回数を超過しました。'
        return
    }

    # ユーザーが「はい」を選択した場合、ファイルを上書き保存します
    try {
        $excelTables | Export-Excel -Path $toExcelPath -Show
        Write-Host 'ファイルを上書き保存しました。'
    }
    catch {
        Write-Error '上書きでExcelファイルを出力する処理でエラーが発生。'
    }
}
else {
    # 新規保存
    try {
        $excelTables | Export-Excel -Path $toExcelPath -Show
        Write-Host "新規でファイルを保存しました。"
    }
    catch {
        Write-Error '新規でExcelファイルを出力する処理でエラーが発生。'
    }
}
```

### Excelファイル から Markdown形式のテーブル に変換できるコード

```powershell:Excelファイル から Markdown形式 に変換
$fromExcelPath = 'D:\Downloads\inputExcelData.xlsx'

function Convert-ExcelToMarkdown {
    param (
        [Parameter(Mandatory=$true)]
        [string]$InputExcel
    )

    # Excelファイルを読み込みます
    $excelData = Import-Excel -Path $InputExcel

    # Markdown形式のテーブルを構築します
    $markdownTables = ''
    #$headers = $excelData | Get-Member -MemberType NoteProperty | Select-Object -ExpandProperty Name
    $headers = $excelData[0].PSObject.Properties.Name

    # ヘッダー行を追加します
    $markdownTables += '| ' + ($headers -join ' | ') + ' |' + "`n"

    # 区切り行を追加します
    $markdownTables += '| ' + (($headers | ForEach-Object { '---' }) -join ' | ') + ' |' + "`n"

    # データ行を追加します
    foreach ($row in $excelData) {
        $rowData = @()
        foreach ($header in $headers) {
            #$cellValue = $row."$header" -replace '\|', '\|' # パイプ文字を正しくエスケープ
            $cellValue = $row."$header"
            $rowData += $cellValue
        }
        $markdownTables += '| ' + ($rowData -join ' | ') + ' |' + "`n"
    }

    return $markdownTables
}

# Markdown形式のテーブルに変換します
$markdownTables = Convert-ExcelToMarkdown -InputExcel $fromExcelPath

$toMarkdownPath = 'D:\Downloads\outputMarkdownTable.md'

# 結果をファイルに出力します
$markdownTables | Out-File -FilePath $toMarkdownPath -Encoding utf8

Write-Host 'ExcelファイルからMarkdown形式に変換しました。'
```
