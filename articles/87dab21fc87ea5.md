---
title: "PowerShellã§æŒ‡å®šã—ãŸã‚·ãƒ¼ãƒˆåãŒExcelãƒ•ã‚¡ã‚¤ãƒ«å†…ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹Function"
emoji: "ğŸ‘Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["powershell", "excel"]
published: false
---
## æ¦‚è¦

```powershell:
# Excel COMã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®è§£æ”¾
function Release-ExcelObjects {
    param (
        [Microsoft.Office.Interop.Excel.ApplicationClass]$Excel,
        [System.__ComObject]$Workbooks,
        [System.__ComObject]$Workbook,
        [System.__ComObject]$WorkSheets,
        [System.__ComObject]$WorkSheet,
        [System.__ComObject]$Cells,
        [System.__ComObject]$Cell
    )

    if ($ExcelObject.Workbooks.Count -gt 0) {
        Write-Error 'Excelã‚¢ãƒ—ãƒªãŒé–‹ã‹ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ã§ã™ã€‚'
        return
    }

    # è§£æ”¾
    if ($null -ne $Cell) {
        [System.Runtime.InteropServices.Marshal]::ReleaseComObject($Cell)
        $Cell = $null
        Remove-Variable Cell -ErrorAction SilentlyContinue
    }
    if ($null -ne $Cells) {
        [System.Runtime.InteropServices.Marshal]::ReleaseComObject($Cells)
        $Cells = $null
        Remove-Variable Cells -ErrorAction SilentlyContinue
    }
    if ($null -ne $WorkSheet) {
        [System.Runtime.InteropServices.Marshal]::ReleaseComObject($WorkSheet)
        $WorkSheet = $null
        Remove-Variable WorkSheet -ErrorAction SilentlyContinue
    }
    if ($null -ne $WorkSheets) {
        [System.Runtime.InteropServices.Marshal]::ReleaseComObject($WorkSheets)
        $WorkSheets = $null
        Remove-Variable WorkSheets -ErrorAction SilentlyContinue
    }
    if ($null -ne $WorkBook) {
        [System.Runtime.InteropServices.Marshal]::ReleaseComObject($WorkBook)
        $WorkBook = $null
        Remove-Variable WorkBook -ErrorAction SilentlyContinue
    }
    if ($null -ne $WorkBooks) {
        [System.Runtime.InteropServices.Marshal]::ReleaseComObject($WorkBooks)
        $WorkBooks = $null
        Remove-Variable WorkBooks -ErrorAction SilentlyContinue
    }

    [System.GC]::Collect()
    [System.GC]::WaitForPendingFinalizers()
    [System.GC]::Collect()

    $Excel.Quit()

    if ($null -ne $Excel) {
        [System.Runtime.InteropServices.Marshal]::ReleaseComObject($Excel)
        $Excel = $null
        Remove-Variable Excel -ErrorAction SilentlyContinue
    }
    
    # ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å¼·åˆ¶çš„ã«å®Ÿè¡Œ
    [System.GC]::Collect()
    [System.GC]::WaitForPendingFinalizers()
    [System.GC]::Collect()
}

# ã‚·ãƒ¼ãƒˆã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
Function Test-ExcelSheetExists {
    param(
        [System.String]$Path,
        [System.String]$CheckSheet
    )
    $excel = New-Object -ComObject Excel.Application
    $excel.Visible = $false
    $workbook = $excel.Workbooks.Open($Path)

    $sheetExists = $false
    foreach ($worksheet in $workbook.Sheets) {
        if ($worksheet.Name -eq $CheckSheet) {
            $sheetExists = $true
            break
        }
    }

    $workbook.Close($false)
    $excel.Quit()
    Release-ExcelObjects $excel $workbook

    return $sheetExists
}
```
