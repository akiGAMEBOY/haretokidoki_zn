---
title: "PowerShellã§æŒ‡å®šã—ãŸã‚·ãƒ¼ãƒˆåãŒExcelãƒ•ã‚¡ã‚¤ãƒ«å†…ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹Function"
emoji: "ğŸ‘Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["powershell", "excel"]
published: false
---
## æ¦‚è¦

```powershell:
$ExitExcelObjects = {
    param (
        [Parameter(Mandatory=$true)][Microsoft.Office.Interop.Excel.ApplicationClass]$Excel,
        [System.__ComObject]$Workbooks=$null,
        [System.__ComObject]$Workbook=$null,
        [System.__ComObject]$WorkSheets=$null,
        [System.__ComObject]$WorkSheet=$null,
        [System.__ComObject]$Cells=$null,
        [System.__ComObject]$Cell=$null
    )

    $WorkBook.Close($false)

    # ã‚»ãƒ«ã‹ã‚‰ãƒ–ãƒƒã‚¯ã¾ã§è§£æ”¾
    if ($null -ne $Cell) {
        [System.Runtime.Interopservices.Marshal]::ReleaseComObject($Cell) > $null
        $Cell = $null
        Remove-Variable Cell -ErrorAction SilentlyContinue
    }
    if ($null -ne $Cells) {
        [System.Runtime.Interopservices.Marshal]::ReleaseComObject($Cells) > $null
        $Cells = $null
        Remove-Variable Cells -ErrorAction SilentlyContinue
    }
    if ($null -ne $WorkSheet) {
        [System.Runtime.Interopservices.Marshal]::ReleaseComObject($WorkSheet) > $null
        $WorkSheet = $null
        Remove-Variable WorkSheet -ErrorAction SilentlyContinue
    }
    if ($null -ne $WorkSheets) {
        [System.Runtime.Interopservices.Marshal]::ReleaseComObject($WorkSheets) > $null
        $WorkSheets = $null
        Remove-Variable WorkSheets -ErrorAction SilentlyContinue
    }
    if ($null -ne $WorkBook) {
        [System.Runtime.Interopservices.Marshal]::ReleaseComObject($WorkBook) > $null
        $WorkBook = $null
        Remove-Variable WorkBook -ErrorAction SilentlyContinue
    }
    if ($null -ne $WorkBooks) {
        [System.Runtime.Interopservices.Marshal]::ReleaseComObject($WorkBooks) > $null
        $WorkBooks = $null
        Remove-Variable WorkBooks -ErrorAction SilentlyContinue
    }

    [System.GC]::Collect()
    [System.GC]::WaitForPendingFinalizers()
    [System.GC]::Collect()

    $Excel.Quit()
    [System.Runtime.Interopservices.Marshal]::ReleaseComObject($Excel) > $null
    $Excel = $null
    Remove-Variable Excel -ErrorAction SilentlyContinue

    [System.GC]::Collect()
    [System.GC]::WaitForPendingFinalizers()
    [System.GC]::Collect()

}

# ã‚·ãƒ¼ãƒˆã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
Function Test-ExcelSheetExists {
    param(
        [System.String]$Path,
        [System.String]$CheckSheet
    )

    $sheetExists = $false

    try {
        $excelApp = New-Object -ComObject Excel.Application
        $excelApp.Visible = $false
        $workBooks = $excelApp.Workbooks
        $workBook = $workBooks.Open($Path)
        $workSheets = $workBook.Sheets

        foreach ($workSheet in $workSheets) {
            if ($workSheet.Name -eq $CheckSheet) {
                $sheetExists = $true
                break
            }
        }
    }
    catch {
        Write-Error 'Excelæ“ä½œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚'
    }
    finally {
        # ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã®å®Ÿè¡Œ
        Invoke-Command -ScriptBlock $ExitExcelObjects -ArgumentList $excelApp, $workBooks, $workBook, $workSheets, $workSheet
    }

    return $sheetExists
}
```
