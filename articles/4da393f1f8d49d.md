---
title: "è‡ªä½œFunctionã‚’è‡ªå‹•ã§PowerShellãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«å®šç¾©ã™ã‚‹ã‚³ãƒ¼ãƒ‰"
emoji: "ğŸ’³"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["powershell"]
published: true
---
## æ¦‚è¦

[ã“ã¡ã‚‰](https://zenn.dev/haretokidoki/articles/1632e92c37ea98)ã®è¨˜äº‹ã§ãƒ‡ãƒ¼ã‚¿å‹ã‚’ç¢ºèªã§ãã‚‹Functionã‚’è‡ªä½œã—ã¾ã—ãŸã€‚
ã“ã®ã‚ˆã†ãªè‡ªä½œFunctionã¯ã€PowerShellã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«å®šç¾©ã™ã‚‹äº‹ã§ç°¡å˜ã«å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚

ãŸã ã€ç’°å¢ƒãŒå¤‰ã‚ã‚‹åº¦ã«PowerShellã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®šç¾©ã™ã‚‹å¿…è¦ãŒã‚ã£ãŸç‚ºã€é¢å€’ã«æ„Ÿã˜ã¦ã„ã¾ã—ãŸã€‚

ã“ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã€ä»Šå›ã¯è‡ªä½œã—ãŸFunctionã‚’èª­ã¿è¾¼ã¿ã€PowerShellã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«è‡ªå‹•ã§å®šç¾©ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¾ã—ãŸã€‚
ãªãŠã€è‡ªä½œã—ãŸFunctionã‚’èª­ã¿è¾¼ã‚€æ–¹æ³•ã¯ã€ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã—ãŸã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚€æ–¹æ³• ã¨ å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼é…ä¸‹ã®ps1ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€æ–¹æ³• ã®2é€šã‚Šã§æº–å‚™ã—ã¾ã—ãŸã€‚

## ã“ã®è¨˜äº‹ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ

- PowerShellãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ–¹
- è‡ªä½œã—ãŸFunctionã‚’è‡ªå‹•ã§PowerShellãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`$PROFILE`ï¼‰ã«å®šç¾©ã—ãŸã„æ–¹

## ç’°å¢ƒ

```powershell:$PSVersionTable
PS C:\Users\"ãƒ¦ãƒ¼ã‚¶ãƒ¼å"> $PSVersionTable

Name                           Value
----                           -----
PSVersion                      5.1.19041.4170
PSEdition                      Desktop
PSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}
BuildVersion                   10.0.19041.4170
CLRVersion                     4.0.30319.42000
WSManStackVersion              3.0
PSRemotingProtocolVersion      2.3
SerializationVersion           1.1.0.1


PS C:\Users\"ãƒ¦ãƒ¼ã‚¶ãƒ¼å">
```

## è‡ªå‹•ã§PowerShellãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—è‡ªä½œFunctionã‚’å®šç¾©ã™ã‚‹ã‚³ãƒ¼ãƒ‰

å†’é ­ã«è¨˜è¼‰ã—ãŸé€šã‚Šã€ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã—ãŸè‡ªä½œFunction ã¨ å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼é…ä¸‹ã«ã‚ã‚‹ps1ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®è‡ªä½œFunction ã®2ã¤ã‹ã‚‰èª­ã¿è¾¼ã¿ã€PowerShellã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«å®šç¾©ã—ã¾ã™ã€‚

å„ã€…ã®ç”¨é€”ã«ã‚ã‚ã›ã¦ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¦ãã ã•ã„ã€‚

```powershell:ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
# PowerShellãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ˜ãƒƒãƒ€ãƒ¼
[System.String[]]$header = 
@"
#################################################################################
# PowerShellãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«
# ï¼ˆ$($PROFILE)ï¼‰
#
#################################################################################

"@

# ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã—ã¦ã„ã‚‹è‡ªä½œFunction
[System.String[]]$ps_source = 
@'

ã€ã“ã“ã«è‡ªä½œFunctionã‚’ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã™ã‚‹ã€‘

'@ -split "`r`n"

# ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ç”¨ã®PowerShellã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆ$PROFILEï¼‰ãŒãªã„å ´åˆã¯ã€æ–°è¦ä½œæˆ
if (-Not(Test-Path $PROFILE)) {
    # LFå¤‰æ›
    $header = $header -Replace "`r`n", "`n"
    # æ–‡å­—ã‚³ãƒ¼ãƒ‰ã¯ UTF-8 BOMä»˜ã ã§æ–°è¦ä½œæˆ
    $utf8Encoding = New-Object System.Text.UTF8Encoding $true
    [System.IO.File]::WriteAllText($PROFILE, $header, $utf8Encoding)
}

# ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ« ãŒ UTF-8 BOMä»˜ã ã§ã‚ã‚‹ã‹ç¢ºèª
$UTF8_BOM = [System.Byte[]](0xEF,0xBB,0xBF)
[System.Byte[]]$first_3bytes = (Get-Content -Path $PROFILE -Encoding Byte -TotalCount 3)
if (-Not($null -eq (Compare-Object $first_3bytes $UTF8_BOM -SyncWindow 0))) {
    Write-Host "ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®PowerShellã‚¹ã‚¯ãƒªãƒ—ãƒˆ[$PROFILE]ã®æ–‡å­—ã‚³ãƒ¼ãƒ‰ãŒã€ŒUTF-8 BOMä»˜ãã€ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚" -ForegroundColor Red
    Write-Host "å‡¦ç†ã‚’ä¸­æ–­ã—ã¾ã™ã€‚" -ForegroundColor Red
    return
}

# ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã—ãŸè‡ªä½œFunctionï¼ˆ$ps_sourceï¼‰ã‚’ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½è¨˜
[System.String]$name = ''
[System.Boolean]$is_skip = $false
$func_lines = $ps_source -split "`n" | Where-Object { $_ -match "^Function " }
if ($func_lines.Count -gt 0) {
    foreach ($line in $func_lines) {
        $name = ($line -split ' ' | Select-Object -First 2)
        If (Select-String -Path $PROFILE -Pattern $name) {
            Write-Host 'ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã—ãŸã‚³ãƒ¼ãƒ‰ï¼ˆ$ps_sourceï¼‰ã®FunctionãŒãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«å®šç¾©æ¸ˆã¿ã§ã™ã€‚ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã—ãŸè‡ªä½œFunctionã®è¿½è¨˜å‡¦ç†ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚'
            Write-Host "ï¼ˆãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«ç™»éŒ²æ¸ˆã¿ã®Functionå: [$name]ï¼‰"
            $is_skip = $true
            break
        }
    }
    # ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã—ãŸè‡ªä½œFunctionã‚’è¿½è¨˜
    if (-Not($is_skip)) {
        # LFå¤‰æ›
        $ps_source = $ps_source -Replace "`r`n", "`n"
        Add-Content -Path $PROFILE -Value $ps_source
    }
}

# ps1ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ ¼ç´ã™ã‚‹å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ãŒãªã„å ´åˆã¯ã€ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’ä½œæˆ
[System.String]$psfolder_path = "$PROFILE\..\user-defined-ps"
if (-Not(Test-Path $psfolder_path)) {
    # ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’ä½œæˆ
    New-Item -Path $psfolder_path -ItemType 'directory' -Force > $null
}
$psfolder_path = (Convert-Path $psfolder_path)
# å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼å†…ã®è‡ªä½œFunctionã‚’ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½è¨˜
$name = ''
$is_skip = $false
# å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼é…ä¸‹ã«ps1ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆã¯ã€ã“ã®å‡¦ç†ãŒæœ€çµ‚å‡¦ç†ã¨ãªã‚‹ãŸã‚æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³
if (-Not(Test-Path "$psfolder_path\*.ps1")) {
    Write-Host "å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ [$psfolder_path] ã«ps1ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å‡¦ç†ã‚’çµ‚äº†ã—ã¾ã™ã€‚" 
    return
}

[System.String]$psfolder_source = (Get-Content "$psfolder_path\*.ps1" -Raw)
$func_lines = $psfolder_source -split "`n" | Where-Object { $_ -match "^Function " }
if ($func_lines.Count -gt 0) {
    foreach ($line in $func_lines) {
        $name = ($line -split ' ' | Select-Object -First 2)
        If (Select-String -Path $PROFILE -Pattern $name) {
            Write-Host 'å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼å†…ã®FunctionãŒãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«å®šç¾©æ¸ˆã¿ã§ã™ã€‚å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã«ã‚ã‚‹è‡ªä½œFunctionã®è¿½è¨˜å‡¦ç†ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚ã€‚'
            Write-Host "ï¼ˆãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«ç™»éŒ²æ¸ˆã¿ã®Functionå: [$name]ï¼‰"
            $is_skip = $true
            break
        }
    }
    # å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã«ã‚ã‚‹è‡ªä½œFunctionã®è¿½è¨˜
    if (-Not($is_skip)) {
        # LFå¤‰æ›
        $psfolder_source = $psfolder_source -Replace "`r`n", "`n"
        Add-Content -Path $PROFILE -Value $psfolder_source
    }
}
```

:::details å®Ÿä¾‹ï¼ˆå®Ÿéš›ã«ç§ãŒä½œæˆã—ãŸFunctionã‚’ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã—ãŸä¾‹ï¼‰

```powershell:ã‚³ãƒ¼ãƒ‰ï¼ˆå®Ÿéš›ã«ç§ãŒä½œæˆã—ãŸFunctionã‚’ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã—ãŸä¾‹ï¼‰
# PowerShellãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ˜ãƒƒãƒ€ãƒ¼
[System.String[]]$header = 
@"
#################################################################################
# PowerShellãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«
# ï¼ˆ$($PROFILE)ï¼‰
#
#################################################################################

"@

# ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã—ã¦ã„ã‚‹è‡ªä½œFunction
[System.String[]]$ps_source = 
@'

#################################################################################
# å‡¦ç†åã€€ | VerificationEnv
# æ©Ÿèƒ½ã€€ã€€ | PowerShellç’°å¢ƒãƒã‚§ãƒƒã‚¯
#          | å‚è€ƒæƒ…å ±ï¼šhttps://zenn.dev/haretokidoki/articles/fac8e50fbe9dcd
#--------------------------------------------------------------------------------
# æˆ»ã‚Šå€¤ã€€ | MESSAGECODEï¼ˆenumï¼‰
# å¼•æ•°ã€€ã€€ | ãªã—
#################################################################################
# ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ enumè¨­å®š
Add-Type -TypeDefinition @"
    public enum MESSAGECODE {
        Successful = 0,
        Abend,
        Cancel,
        Error_NotCore,
        Error_NotSupportedVersion,
        Error_NotWindows
    }
"@
Function VerificationEnv {
    [MESSAGECODE]$return_code = [MESSAGECODE]::Successful

    # ç’°å¢ƒæƒ…å ±ã‚’å–å¾—
    [System.Collections.Hashtable]$ps_ver = $PSVersionTable

    # ç’°å¢ƒã®åˆ¤å®šï¼šCoreã§ã¯ãªã„å ´åˆï¼ˆ5.1ã ã¨'Desktop'ã¨ãªã‚‹ï¼‰
    if ($ps_ver.PSEdition -ne 'Core') {
        $return_code = [MESSAGECODE]::Error_NotCore
        Write-Host 'Coreï¼ˆ6.0ä»¥é™ï¼‰ã®ç’°å¢ƒã§ã¯ãªã„' -ForegroundColor Red
    }
    # ç’°å¢ƒã®åˆ¤å®šï¼šãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒ7ã‚ˆã‚Šå°ã•ã„å ´åˆ
    elseif ($ps_ver.PSVersion.Major -lt 7) {
        $return_code = [MESSAGECODE]::Error_NotSupportedVersion
        Write-Host 'Coreï¼ˆ6.0ä»¥é™ï¼‰ã®ç’°å¢ƒã ãŒã€7ä»¥ä¸Š ã®ç’°å¢ƒã§ã¯ãªã„' -ForegroundColor Red
    }
    # ç’°å¢ƒã®åˆ¤å®šï¼šWindows OSã§ã¯ãªã„å ´åˆï¼ˆPowerShell Coreã®ã¿ä½¿ç”¨ã§ãã‚‹è‡ªå‹•å¤‰æ•°ï¼‰
    elseif (-Not($IsWindows)) {
        $return_code = [MESSAGECODE]::Error_NotWindows
        Write-Host 'Coreï¼ˆ6.0ä»¥é™ï¼‰ã®ç’°å¢ƒã§ã€ã‹ã¤ 7ä»¥ä¸Š ã®ç’°å¢ƒã ãŒã€Windows OS ã®ç’°å¢ƒã§ã¯ãªã„' -ForegroundColor Red
    }
    else {
        Write-Host 'Coreï¼ˆ6.0ä»¥é™ï¼‰ã®ç’°å¢ƒã§ã€ã‹ã¤ 7ä»¥ä¸Š ã®ç’°å¢ƒã€Windows OS ã®ç’°å¢ƒã§ã‚ã‚‹'
    }

    return $return_code
}

#################################################################################
# å‡¦ç†åã€€ | Get-Datatype
# æ©Ÿèƒ½ã€€ã€€ | å¤‰æ•°ã®ãƒ‡ãƒ¼ã‚¿å‹ã‚’ç¢ºèª
#          | å‚è€ƒæƒ…å ±ï¼šhttps://zenn.dev/haretokidoki/articles/1632e92c37ea98
#--------------------------------------------------------------------------------
# æˆ»ã‚Šå€¤ã€€ | ãƒ‡ãƒ¼ã‚¿å‹ã‚’è¡¨ç¤ºï¼ˆé …ç›®1:BaseTypeã€é …ç›®2ï¼šTypeï¼‰
# å¼•æ•°ã€€ã€€ | $variable èª¿æŸ»å¯¾è±¡ã®å¤‰æ•°
#################################################################################
Function Get-Datatype {
	param (
	    [Parameter(Mandatory=$true)]$variable
	)

    # æ–‡å­—åˆ—é…åˆ—ã‚’å®£è¨€
	[System.String[]]$rowdata = @(
		$variable.GetType().BaseType.FullName,      # å¤‰æ•°ã®ãƒ™ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—
		$variable.GetType().FullName                # å¤‰æ•°ã®ãƒ‡ãƒ¼ã‚¿å‹
	)
	
    # PSCustomObjectã§é …ç›®åã‚’è¨­å®š
	$types_table = [PSCustomObject]@{
		BaseType = $rowdata[0]
		DataType = $rowdata[1]
	}

    # ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§è¡¨ç¤º
    $types_table | Format-Table -Property BaseType, DataType -AutoSize -Wrap
}

#################################################################################
# å‡¦ç†åã€€ | isAdminPowerShell
# æ©Ÿèƒ½ã€€ã€€ | PowerShellãŒç®¡ç†è€…ã¨ã—ã¦å®Ÿè¡Œã—ã¦ã„ã‚‹ã‹ç¢ºèª
#          | å‚è€ƒæƒ…å ±ï¼šhttps://zenn.dev/haretokidoki/articles/67788ca9b47b27
#--------------------------------------------------------------------------------
# æˆ»ã‚Šå€¤ã€€ | Booleanï¼ˆTrue: ç®¡ç†è€…æ¨©é™ã‚ã‚Š, False: ç®¡ç†è€…æ¨©é™ãªã—ï¼‰
# å¼•æ•°ã€€ã€€ | -
#################################################################################
Function isAdminPowerShell {
    $win_id = [System.Security.Principal.WindowsIdentity]::GetCurrent()
    $win_principal = new-object System.Security.Principal.WindowsPrincipal($win_id)
    $admin_permission = [System.Security.Principal.WindowsBuiltInRole]::Administrator
    return $win_principal.IsInRole($admin_permission)
}

#################################################################################
# å‡¦ç†åã€€ | GetPsCharcode
# æ©Ÿèƒ½ã€€ã€€ | PowerShellã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
#          | å‚è€ƒæƒ…å ±ï¼šhttps://zenn.dev/haretokidoki/articles/67788ca9b47b27
#--------------------------------------------------------------------------------
# æˆ»ã‚Šå€¤ã€€ | ps_charcode[]
#          |  - é …ç›®01 æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’æŒ‡å®šã§ãã‚‹ã‚³ãƒãƒ³ãƒ‰ãƒ¬ãƒƒãƒˆã®æ—¢å®šå€¤
#          |  - é …ç›®02 PowerShellã‹ã‚‰å¤–éƒ¨ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«æ¸¡ã™æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã®è¨­å®š
#          |  - é …ç›®01 PowerShellã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã™ã‚‹æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã®è¨­å®š
# å¼•æ•°ã€€ã€€ | -
#################################################################################
Function GetPsCharcode {
    [System.String[]]$ps_charcode = @()
    $ps_charcode = @(
        # æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’æŒ‡å®šã§ãã‚‹ã‚³ãƒãƒ³ãƒ‰ãƒ¬ãƒƒãƒˆã®æ—¢å®šå€¤
        ($PSDefaultParameterValues['*:Encoding']),
        # PowerShellã‹ã‚‰å¤–éƒ¨ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«æ¸¡ã™æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã®è¨­å®š
        ($global:OutputEncoding).WebName,
        # PowerShellã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã™ã‚‹æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã®è¨­å®š
        ([console]::OutputEncoding).WebName
    )

    return $ps_charcode
}

#################################################################################
# å‡¦ç†åã€€ | ChangeWindowTitle
# æ©Ÿèƒ½ã€€ã€€ | PowerShellã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ã‚¿ã‚¤ãƒˆãƒ«å¤‰æ›´ï¼ˆæ–‡å­—ã‚³ãƒ¼ãƒ‰ã¨PowerShellã®ç®¡ç†è€…æ¨©é™æœ‰ç„¡ã‚’è¿½åŠ ï¼‰
#          | å‚è€ƒæƒ…å ±ï¼šhttps://zenn.dev/haretokidoki/articles/67788ca9b47b27
#--------------------------------------------------------------------------------
# æˆ»ã‚Šå€¤ã€€ | -
# å¼•æ•°ã€€ã€€ | -
#################################################################################
# PowerShellã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ã‚¿ã‚¤ãƒˆãƒ«å¤‰æ›´
Function ChangeWindowTitle {
    # åŒºåˆ‡ã‚Šæ–‡å­—ã®è¨­å®š
    [System.String]$pos1 = '|'
    [System.String]$pos2 = ';'

    # ç¾åœ¨ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—
    [System.String]$title = $Host.UI.RawUI.WindowTitle
    [System.String]$base_title = $title

    # æ—¢ã«ã“ã®Functionã§ã‚¿ã‚¤ãƒˆãƒ«å¤‰æ›´ã—ã¦ã„ã‚‹å ´åˆã€ä¸€ç•ªå·¦ã«ã‚ã‚‹æ–‡å­—åˆ—ã‚’æŠ½å‡º
    [System.String[]]$title_array = $title.Split($pos1)
    if ($title_array.Length -ne 0) {
        $base_title = ($title_array[0]).TrimEnd()
    }

    # ç¾åœ¨ã®æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã‚¿ã‚¤ãƒˆãƒ«ã«è¿½åŠ 
    [System.String[]]$ps_charcode = GetPsCharcode

    [System.String]$change_title = $base_title
    if (isAdminPowerShell) {
        # ç®¡ç†è€…ã¨ã—ã¦å®Ÿè¡Œã—ã¦ã„ã‚‹å ´åˆ
        $change_title = $base_title + " $pos1 " +
                        "DefaultParameter='$($ps_charcode[0])'" + " $pos2 " +
                        "GlobalEncoding='$($ps_charcode[1])'" + " $pos2 " +
                        "ConsoleEncoding='$($ps_charcode[2])'" + " $pos2 " +
                        "#Administrator"
    }
    else {
        # ç®¡ç†è€…ã¨ã—ã¦å®Ÿè¡Œã—ã¦ã„ãªã„å ´åˆ
        $change_title = $base_title + " $pos1 " +
                        "DefaultParameter='$($ps_charcode[0])'" + " $pos2 " +
                        "GlobalEncoding='$($ps_charcode[1])'" + " $pos2 " +
                        "ConsoleEncoding='$($ps_charcode[2])'" + " $pos2 " +
                        "#Not_Administrator"
    }
    $Host.UI.RawUI.WindowTitle = $change_title

    # å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    Write-Host 'ã‚¿ã‚¤ãƒˆãƒ«ã«â€œæ–‡å­—ã‚³ãƒ¼ãƒ‰â€ã¨â€œç®¡ç†è€…æ¨©é™ã®æœ‰ç„¡â€ã®æƒ…å ±ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚' -ForegroundColor Cyan
}

#################################################################################
# å‡¦ç†åã€€ | SetPsOutputEncoding
# æ©Ÿèƒ½ã€€ã€€ | PowerShellã«ãŠã‘ã‚‹è¤‡æ•°ã®æ–‡å­—ã‚³ãƒ¼ãƒ‰è¨­å®šã‚’ä¸€æ‹¬å¤‰æ›´
#          | å‚è€ƒæƒ…å ±ï¼šhttps://zenn.dev/haretokidoki/articles/8946231076f129
#--------------------------------------------------------------------------------
# æˆ»ã‚Šå€¤ã€€ | -
# å¼•æ•°ã€€ã€€ | $charcodeï¼ˆå¼•æ•°ã‚’çœç•¥ã—ãŸå ´åˆã¯ã€'reset_encoding'ã§è¨­å®šï¼‰
# ã€€ã€€ã€€ã€€ |  - 'utf8'          : UTF-8ã«è¨­å®š
# ã€€ã€€ã€€ã€€ |  - 'sjis'          : Shift-JISã«è¨­å®š
# ã€€ã€€ã€€ã€€ |  - 'ascii'         : US-ASCIIã«è¨­å®š
# ã€€ã€€ã€€ã€€ |  - 'rm_encoding'   : ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ãƒ©ãƒ¼ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’å‰Šé™¤
# ã€€ã€€ã€€ã€€ |  - 'reset_encoding': è¦å®šå€¤ã«æˆ»ã™
#################################################################################
Function SetPsOutputEncoding {
    param (
        [System.String]$charcode = 'reset_encoding'
    )

    switch ($charcode) {
        # æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’UTF8ã«è¨­å®šã™ã‚‹
        'utf8' {
            $PSDefaultParameterValues['*:Encoding'] = 'utf8'
            $global:OutputEncoding = [System.Text.Encoding]::UTF8
            [console]::OutputEncoding = [System.Text.Encoding]::UTF8
        }
        # æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’Shift JISï¼ˆSJISï¼‰ã«è¨­å®šã™ã‚‹
        'sjis' {
            # $PSDefaultParameterValues['*:Encoding'] = 'default'ã«ã¤ã„ã¦
            #   ã“ã®è¨­å®šã¯Coreä»¥å¤–ï¼ˆ5.1ä»¥å‰ï¼‰ã®ç’°å¢ƒã§ã®ã¿Shift JISã§è¨­å®šã•ã‚Œã‚‹ã€‚
            #   Coreç’°å¢ƒã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯ã€UTF-8ã§ã‚ã‚ŠUTF-8ã§è¨­å®šã•ã‚Œã¦ã—ã¾ã†ã€‚
            #   ã¾ãŸã€Shift JISã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚‚å­˜åœ¨ã—ãªã„ç‚ºã€Coreç’°å¢ƒã§Shift JISã®è¨­å®šã¯ä¸å¯ã¨ãªã‚‹ã€‚
            $PSDefaultParameterValues['*:Encoding'] = 'default'
            $global:OutputEncoding = [System.Text.Encoding]::GetEncoding('shift_jis')
            [console]::OutputEncoding = [System.Text.Encoding]::GetEncoding('shift_jis')
        }
        # æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’ASCIIã«è¨­å®šã™ã‚‹
        'ascii' {
            $PSDefaultParameterValues.Remove('*:Encoding')
            $global:OutputEncoding = [System.Text.Encoding]::ASCII
            [console]::OutputEncoding = [System.Text.Encoding]::ASCII
        }
        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æŒ‡å®šã‚’è§£é™¤ã™ã‚‹
        'rm_encoding' {
            $PSDefaultParameterValues.Remove('*:Encoding')
        }
        # æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰è¨­å®šã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
        'reset_encoding' {
            $PSDefaultParameterValues.Remove('*:Encoding')

            If ($PSVersionTable.PSEdition -eq 'Core') {
                # Core ã®å ´åˆ
                $global:OutputEncoding = [System.Text.Encoding]::UTF8
                [console]::OutputEncoding = [System.Text.Encoding]::GetEncoding('shift_jis')
            }
            else {
                # Core ä»¥å¤–ã®å ´åˆï¼ˆPowerShell 5.1 ä»¥å‰ï¼‰
                $global:OutputEncoding = [System.Text.Encoding]::ASCII
                [console]::OutputEncoding = [System.Text.Encoding]::GetEncoding('shift_jis')
            }
        }
    }
    # ã‚¿ã‚¤ãƒˆãƒ«ã®è¡¨ç¤ºåˆ‡æ›¿Functionå‘¼ã³å‡ºã—
    ChangeWindowTitle
}

#################################################################################
# å‡¦ç†åã€€ | Get-PsEncoding
# æ©Ÿèƒ½ã€€ã€€ | PowerShellã§ãƒ•ã‚¡ã‚¤ãƒ«ã®æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’åˆ¤å®š
#          | å‚è€ƒæƒ…å ±ï¼šhttps://zenn.dev/haretokidoki/articles/962a7fc6c51b47
#--------------------------------------------------------------------------------
# æˆ»ã‚Šå€¤ã€€ | -
# å¼•æ•°ã€€ã€€ | $targetfile å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
#################################################################################
Function Get-PsEncoding {
	param (
		[Parameter(Mandatory=$true)][System.String]$targetfile
	)
	$stream_reader = [System.IO.StreamReader] $targetfile
	$profile_encoding = $stream_reader.CurrentEncoding
	$stream_reader.Close()

	Write-Host "EncodingName: [$($profile_encoding.EncodingName)]"
}

#################################################################################
# å‡¦ç†åã€€ | Check-BOMStatus
# æ©Ÿèƒ½ã€€ã€€ | PowerShellã§ãƒ•ã‚¡ã‚¤ãƒ«ã®æ–‡å­—ã‚³ãƒ¼ãƒ‰ã«ãŠã‘ã‚‹BOMã‚’åˆ¤å®š
#          | å‚è€ƒæƒ…å ±ï¼šhttps://zenn.dev/haretokidoki/articles/962a7fc6c51b47
#--------------------------------------------------------------------------------
# æˆ»ã‚Šå€¤ã€€ | -
# å¼•æ•°ã€€ã€€ | $targetfile å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
#################################################################################
Function Check-BOMStatus {
    param (
        [Parameter(Mandatory=$true)][System.String]$targetfile
    )
    if (-Not (Test-Path $targetfile)) {
        Write-Host 'The target file does not exist.' -ForegroundColor Red
        return
    }
    
    # BOMã®ãƒã‚¤ãƒˆã‚·ãƒ¼ã‚±ãƒ³ã‚¹
    $UTF7_BOM1 = [System.Byte[]](0x2B,0x2F,0x76,0x38)
    $UTF7_BOM2 = [System.Byte[]](0x2B,0x2F,0x76,0x39)
    $UTF7_BOM3 = [System.Byte[]](0x2B,0x2F,0x76,0x2B)
    $UTF7_BOM4 = [System.Byte[]](0x2B,0x2F,0x76,0x2F)
    $UTF8_BOM = [System.Byte[]](0xEF,0xBB,0xBF)
    $UTF16BE_BOM = [System.Byte[]](0xFE,0xFF)
    $UTF16LE_BOM = [System.Byte[]](0xFF,0xFE)
    $UTF32BE_BOM = [System.Byte[]](0x00,0x00,0xFE,0xFF)
    $UTF32LE_BOM = [System.Byte[]](0xFF,0xFE,0x00,0x00)
    
    # å…ˆé ­è¡Œã‚’ãƒã‚¤ãƒˆã§èª­ã¿è¾¼ã¿å…ˆé ­ã‹ã‚‰3ãƒã‚¤ãƒˆåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    [System.Byte[]]$first_4bytes = (Get-Content -Path $targetfile -Encoding Byte -TotalCount 4)
    [System.Byte[]]$first_3bytes = $first_4bytes[0..2]
    [System.Byte[]]$first_2bytes = $first_4bytes[0..1]
    
    # å…ˆé ­ãƒã‚¤ãƒˆã§BOMä»˜ãã‹åˆ¤å®š
    # UTF-7
    if (($null -eq (Compare-Object $first_4bytes $UTF7_BOM1)) -Or
        ($null -eq (Compare-Object $first_4bytes $UTF7_BOM2)) -Or
        ($null -eq (Compare-Object $first_4bytes $UTF7_BOM3)) -Or
        ($null -eq (Compare-Object $first_4bytes $UTF7_BOM4))) {
        Write-Host "[$($targetfile)] is UTF-7 BOM."
    }
    # UTF-8
    elseif ($null -eq (Compare-Object $first_3bytes $UTF8_BOM -SyncWindow 0)) {
        Write-Host "[$($targetfile)] is UTF-8 BOM."
    }
    # UTF-16 BE
    elseif ($null -eq (Compare-Object $first_2bytes $UTF16BE_BOM -SyncWindow 0)) {
        Write-Host "[$($targetfile)] is UTF-16 BE BOM."
    }
    # UTF-16 LE
    elseif ($null -eq (Compare-Object $first_2bytes $UTF16LE_BOM -SyncWindow 0)) {
        Write-Host "[$($targetfile)] is UTF-16 LE BOM."
    }
    # UTF-32 BE
    elseif ($null -eq (Compare-Object $first_4bytes $UTF32BE_BOM -SyncWindow 0)) {
        Write-Host "[$($targetfile)] is UTF-32 BE BOM."
    }
    # UTF-32 LE
    elseif ($null -eq (Compare-Object $first_4bytes $UTF32LE_BOM -SyncWindow 0)) {
        Write-Host "[$($targetfile)] is UTF-32 LE BOM."
    }
    else {
        Write-Host "[$($targetfile)] is not BOM." -ForegroundColor Red
    }
}

#################################################################################
# å‡¦ç†åã€€ | Get-PyEncoding
# æ©Ÿèƒ½ã€€ã€€ | Pythonã§ãƒ•ã‚¡ã‚¤ãƒ«ã®æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’åˆ¤å®š
#          | å‚è€ƒæƒ…å ±ï¼šhttps://zenn.dev/haretokidoki/articles/aea5b45679d966
#--------------------------------------------------------------------------------
# æˆ»ã‚Šå€¤ã€€ | -
# å¼•æ•°ã€€ã€€ | $targetfile å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
#################################################################################
Function Get-PyEncoding {
    param (
        [Parameter(Mandatory=$true)][System.String]$targetfile
    )

    # python ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª
    if (-Not(Get-Command 'python' -ErrorAction SilentlyContinue)) {
        Write-Host 'Python is not install.' -ForegroundColor Red
        return
    }

    # å­˜åœ¨ãƒã‚§ãƒƒã‚¯
    if (-Not(Test-Path $targetfile)) {
        Write-Host "[$targetfile] does not exist." -ForegroundColor Red
        return
    }

    # çµ¶å¯¾ãƒ‘ã‚¹ã«å¤‰æ›
    [System.String]$fullpath_targetfile = (Convert-Path $targetfile)
    
    # ãƒ‡ãƒ¼ã‚¿ç¨®é¡ã®ãƒã‚§ãƒƒã‚¯
    if (-Not(Test-Path $fullpath_targetfile -PathType Leaf)) {
        Write-Host "[$fullpath_targetfile] is not a file." -ForegroundColor Red
        return
    }

    # Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã‚³ãƒ¼ãƒ‰
    [System.String[]]$py_source = 
@"
import subprocess
import sys

# chardet ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
try:
    import chardet
except ImportError:
    subprocess.check_call([sys.executable, '-m', 'pip', 'install', 'chardet', '--user'])
    import chardet

# æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’åˆ¤å®šã™ã‚‹Function
def determine_encoding(file_path):
    with open(file_path, 'rb') as file:
        raw_data = file.read()
        result = chardet.detect(raw_data)
        print(f"Detected encoding for [{file_path}] is {result['encoding']} with {result['confidence']*100}% confidence.")

# ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã®å¼•æ•°ã‚’å–å¾—
file_path = sys.argv[1]

# å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã®æ–‡å­—åˆ—ã‚’åˆ¤å®š
determine_encoding(file_path)

"@ -split "`r`n"

    # Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æº–å‚™
    #   Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ ¼ç´ã™ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ãŒãªã„å ´åˆã¯ã€æ–°è¦ä½œæˆ
    [System.String]$pyfolder_path = "$PROFILE\..\user-defined-py"
    if (-Not(Test-Path $pyfolder_path)) {
        New-Item -Path $pyfolder_path -ItemType 'directory' -Force > $null
    }
    $pyfolder_path = (Convert-Path $pyfolder_path)
    #   ä»Šå›å®Ÿè¡Œã™ã‚‹Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒãªã„å ´åˆã¯ã€æ–°è¦ä½œæˆ
    [System.String]$pyscript_path = "$pyfolder_path\chardet_runner.py"
    if (-Not(Test-Path $pyscript_path)) {
        # ãªãœã‹LFã‚³ãƒ¼ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿ã§ã‚ã‚‹ãŸã‚ã€CRLFã«å¤‰æ›
        $py_source = $py_source -Replace "`n", "`r`n"
        $utf8Encoding = New-Object System.Text.UTF8Encoding
        [System.IO.File]::WriteAllText($pyscript_path, $py_source, $utf8Encoding)
    }

    # Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ
    try {
        python $pyscript_path $fullpath_targetfile
    }
    catch {
        Write-Host 'Python script execution error.'
        return
    }
}

'@ -split "`r`n"

# ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ç”¨ã®PowerShellã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆ$PROFILEï¼‰ãŒãªã„å ´åˆã¯ã€æ–°è¦ä½œæˆ
if (-Not(Test-Path $PROFILE)) {
    # LFå¤‰æ›
    $header = $header -Replace "`r`n", "`n"
    # æ–‡å­—ã‚³ãƒ¼ãƒ‰ã¯ UTF-8 BOMä»˜ã ã§æ–°è¦ä½œæˆ
    $utf8Encoding = New-Object System.Text.UTF8Encoding $true
    [System.IO.File]::WriteAllText($PROFILE, $header, $utf8Encoding)
}

# ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ« ãŒ UTF-8 BOMä»˜ã ã§ã‚ã‚‹ã‹ç¢ºèª
$UTF8_BOM = [System.Byte[]](0xEF,0xBB,0xBF)
[System.Byte[]]$first_3bytes = (Get-Content -Path $PROFILE -Encoding Byte -TotalCount 3)
if (-Not($null -eq (Compare-Object $first_3bytes $UTF8_BOM -SyncWindow 0))) {
    Write-Host "ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®PowerShellã‚¹ã‚¯ãƒªãƒ—ãƒˆ[$PROFILE]ã®æ–‡å­—ã‚³ãƒ¼ãƒ‰ãŒã€ŒUTF-8 BOMä»˜ãã€ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚" -ForegroundColor Red
    Write-Host "å‡¦ç†ã‚’ä¸­æ–­ã—ã¾ã™ã€‚" -ForegroundColor Red
    return
}

# ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã—ãŸè‡ªä½œFunctionï¼ˆ$ps_sourceï¼‰ã‚’ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½è¨˜
[System.String]$name = ''
[System.Boolean]$is_skip = $false
$func_lines = $ps_source -split "`n" | Where-Object { $_ -match "^Function " }
if ($func_lines.Count -gt 0) {
    foreach ($line in $func_lines) {
        $name = ($line -split ' ' | Select-Object -First 2)
        If (Select-String -Path $PROFILE -Pattern $name) {
            Write-Host 'ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã—ãŸã‚³ãƒ¼ãƒ‰ï¼ˆ$ps_sourceï¼‰ã®FunctionãŒãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«å®šç¾©æ¸ˆã¿ã§ã™ã€‚ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã—ãŸè‡ªä½œFunctionã®è¿½è¨˜å‡¦ç†ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚'
            Write-Host "ï¼ˆãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«ç™»éŒ²æ¸ˆã¿ã®Functionå: [$name]ï¼‰"
            $is_skip = $true
            break
        }
    }
    # ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã—ãŸè‡ªä½œFunctionã‚’è¿½è¨˜
    if (-Not($is_skip)) {
        # LFå¤‰æ›
        $ps_source = $ps_source -Replace "`r`n", "`n"
        Add-Content -Path $PROFILE -Value $ps_source
    }
}

# ps1ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ ¼ç´ã™ã‚‹å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ãŒãªã„å ´åˆã¯ã€ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’ä½œæˆ
[System.String]$psfolder_path = "$PROFILE\..\user-defined-ps"
if (-Not(Test-Path $psfolder_path)) {
    # ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’ä½œæˆ
    New-Item -Path $psfolder_path -ItemType 'directory' -Force > $null
}
$psfolder_path = (Convert-Path $psfolder_path)
# å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼å†…ã®è‡ªä½œFunctionã‚’ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½è¨˜
$name = ''
$is_skip = $false
# å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼é…ä¸‹ã«ps1ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆã¯ã€ã“ã®å‡¦ç†ãŒæœ€çµ‚å‡¦ç†ã¨ãªã‚‹ãŸã‚æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³
if (-Not(Test-Path "$psfolder_path\*.ps1")) {
    Write-Host "å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ [$psfolder_path] ã«ps1ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å‡¦ç†ã‚’çµ‚äº†ã—ã¾ã™ã€‚" 
    return
}

[System.String]$psfolder_source = (Get-Content "$psfolder_path\*.ps1" -Raw)
$func_lines = $psfolder_source -split "`n" | Where-Object { $_ -match "^Function " }
if ($func_lines.Count -gt 0) {
    foreach ($line in $func_lines) {
        $name = ($line -split ' ' | Select-Object -First 2)
        If (Select-String -Path $PROFILE -Pattern $name) {
            Write-Host 'å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼å†…ã®FunctionãŒãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«å®šç¾©æ¸ˆã¿ã§ã™ã€‚å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã«ã‚ã‚‹è‡ªä½œFunctionã®è¿½è¨˜å‡¦ç†ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚ã€‚'
            Write-Host "ï¼ˆãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«ç™»éŒ²æ¸ˆã¿ã®Functionå: [$name]ï¼‰"
            $is_skip = $true
            break
        }
    }
    # å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã«ã‚ã‚‹è‡ªä½œFunctionã®è¿½è¨˜
    if (-Not($is_skip)) {
        # LFå¤‰æ›
        $psfolder_source = $psfolder_source -Replace "`r`n", "`n"
        Add-Content -Path $PROFILE -Value $psfolder_source
    }
}
```

ã“ã®å†…å®¹ã‚’PowerShellã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§å®Ÿè¡Œã™ã‚‹ã¨ã€ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã—ãŸè‡ªä½œFunctionãŒãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«åæ˜ ã•ã‚Œã€
ä¸‹è¨˜ã®çµæœãŒè¿”ã£ã¦ãã¾ã™ã€‚

ãªãŠã€ä»Šå›ã¯å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼é…ä¸‹ã«ps1ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ ¼ç´ã›ãšã«å®Ÿè¡Œã—ã¾ã—ãŸã€‚å®Ÿè¡Œçµæœã‹ã‚‰ã‚‚ã€ãã®æ—¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚

```powershell:å®Ÿéš›ã®å®Ÿè¡Œçµæœï¼ˆPowerShellã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®çµæœï¼‰
å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ [D:\Documents\WindowsPowerShell\user-defined-ps]  ã«ps1ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å‡¦ç†ã‚’çµ‚äº†ã—ã¾ã™ã€‚
PS C:\Users\"ãƒ¦ãƒ¼ã‚¶ãƒ¼å">
```

ä¸‹è¨˜ãŒå®Ÿè¡Œå¾Œã€ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã—ãŸã‚³ãƒ¼ãƒ‰ãŒåæ˜ ã•ã‚ŒãŸãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ã€‚
ãªãŠã€ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§èª­ã¿è¾¼ã¿ã•ã‚Œã¾ã›ã‚“ã€‚PowerShellã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’èµ·å‹•ã™ã‚‹æ™‚ã«ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ãŸã‚ã€ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’å¤‰æ›´ã—ãŸå ´åˆã¯PowerShellã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’å†èµ·å‹•ã—ã¦ãã ã•ã„ã€‚


```powershell:ã€ŒMicrosoft.PowerShell_profile.ps1ã€
#################################################################################
# PowerShellãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«
# ï¼ˆD:\Documents\WindowsPowerShell\Microsoft.PowerShell_profile.ps1ï¼‰
#
#################################################################################

#################################################################################
# å‡¦ç†åã€€ | VerificationEnv
# æ©Ÿèƒ½ã€€ã€€ | PowerShellç’°å¢ƒãƒã‚§ãƒƒã‚¯
#          | å‚è€ƒæƒ…å ±ï¼šhttps://zenn.dev/haretokidoki/articles/fac8e50fbe9dcd
#--------------------------------------------------------------------------------
# æˆ»ã‚Šå€¤ã€€ | MESSAGECODEï¼ˆenumï¼‰
# å¼•æ•°ã€€ã€€ | ãªã—
#################################################################################
# ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ enumè¨­å®š
Add-Type -TypeDefinition @"
    public enum MESSAGECODE {
        Successful = 0,
        Abend,
        Cancel,
        Error_NotCore,
        Error_NotSupportedVersion,
        Error_NotWindows
    }
"@
Function VerificationEnv {
    [MESSAGECODE]$return_code = [MESSAGECODE]::Successful

    # ç’°å¢ƒæƒ…å ±ã‚’å–å¾—
    [System.Collections.Hashtable]$ps_ver = $PSVersionTable

    # ç’°å¢ƒã®åˆ¤å®šï¼šCoreã§ã¯ãªã„å ´åˆï¼ˆ5.1ã ã¨'Desktop'ã¨ãªã‚‹ï¼‰
    if ($ps_ver.PSEdition -ne 'Core') {
        $return_code = [MESSAGECODE]::Error_NotCore
        Write-Host 'Coreï¼ˆ6.0ä»¥é™ï¼‰ã®ç’°å¢ƒã§ã¯ãªã„' -ForegroundColor Red
    }
    # ç’°å¢ƒã®åˆ¤å®šï¼šãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒ7ã‚ˆã‚Šå°ã•ã„å ´åˆ
    elseif ($ps_ver.PSVersion.Major -lt 7) {
        $return_code = [MESSAGECODE]::Error_NotSupportedVersion
        Write-Host 'Coreï¼ˆ6.0ä»¥é™ï¼‰ã®ç’°å¢ƒã ãŒã€7ä»¥ä¸Š ã®ç’°å¢ƒã§ã¯ãªã„' -ForegroundColor Red
    }
    # ç’°å¢ƒã®åˆ¤å®šï¼šWindows OSã§ã¯ãªã„å ´åˆï¼ˆPowerShell Coreã®ã¿ä½¿ç”¨ã§ãã‚‹è‡ªå‹•å¤‰æ•°ï¼‰
    elseif (-Not($IsWindows)) {
        $return_code = [MESSAGECODE]::Error_NotWindows
        Write-Host 'Coreï¼ˆ6.0ä»¥é™ï¼‰ã®ç’°å¢ƒã§ã€ã‹ã¤ 7ä»¥ä¸Š ã®ç’°å¢ƒã ãŒã€Windows OS ã®ç’°å¢ƒã§ã¯ãªã„' -ForegroundColor Red
    }
    else {
        Write-Host 'Coreï¼ˆ6.0ä»¥é™ï¼‰ã®ç’°å¢ƒã§ã€ã‹ã¤ 7ä»¥ä¸Š ã®ç’°å¢ƒã€Windows OS ã®ç’°å¢ƒã§ã‚ã‚‹'
    }

    return $return_code
}

#################################################################################
# å‡¦ç†åã€€ | Get-Datatype
# æ©Ÿèƒ½ã€€ã€€ | å¤‰æ•°ã®ãƒ‡ãƒ¼ã‚¿å‹ã‚’ç¢ºèª
#          | å‚è€ƒæƒ…å ±ï¼šhttps://zenn.dev/haretokidoki/articles/1632e92c37ea98
#--------------------------------------------------------------------------------
# æˆ»ã‚Šå€¤ã€€ | ãƒ‡ãƒ¼ã‚¿å‹ã‚’è¡¨ç¤ºï¼ˆé …ç›®1:BaseTypeã€é …ç›®2ï¼šTypeï¼‰
# å¼•æ•°ã€€ã€€ | $variable èª¿æŸ»å¯¾è±¡ã®å¤‰æ•°
#################################################################################
Function Get-Datatype {
    param (
        [Parameter(Mandatory=$true)]$variable
    )

    # æ–‡å­—åˆ—é…åˆ—ã‚’å®£è¨€
    [System.String[]]$rowdata = @(
        $variable.GetType().BaseType.FullName,      # å¤‰æ•°ã®ãƒ™ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—
        $variable.GetType().FullName                # å¤‰æ•°ã®ãƒ‡ãƒ¼ã‚¿å‹
    )
    
    # PSCustomObjectã§é …ç›®åã‚’è¨­å®š
    $types_table = [PSCustomObject]@{
        BaseType = $rowdata[0]
        DataType = $rowdata[1]
    }

    # ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§è¡¨ç¤º
    $types_table | Format-Table -Property BaseType, DataType -AutoSize -Wrap
}

#################################################################################
# å‡¦ç†åã€€ | isAdminPowerShell
# æ©Ÿèƒ½ã€€ã€€ | PowerShellãŒç®¡ç†è€…ã¨ã—ã¦å®Ÿè¡Œã—ã¦ã„ã‚‹ã‹ç¢ºèª
#          | å‚è€ƒæƒ…å ±ï¼šhttps://zenn.dev/haretokidoki/articles/67788ca9b47b27
#--------------------------------------------------------------------------------
# æˆ»ã‚Šå€¤ã€€ | Booleanï¼ˆTrue: ç®¡ç†è€…æ¨©é™ã‚ã‚Š, False: ç®¡ç†è€…æ¨©é™ãªã—ï¼‰
# å¼•æ•°ã€€ã€€ | -
#################################################################################
Function isAdminPowerShell {
    $win_id = [System.Security.Principal.WindowsIdentity]::GetCurrent()
    $win_principal = new-object System.Security.Principal.WindowsPrincipal($win_id)
    $admin_permission = [System.Security.Principal.WindowsBuiltInRole]::Administrator
    return $win_principal.IsInRole($admin_permission)
}

#################################################################################
# å‡¦ç†åã€€ | GetPsCharcode
# æ©Ÿèƒ½ã€€ã€€ | PowerShellã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
#          | å‚è€ƒæƒ…å ±ï¼šhttps://zenn.dev/haretokidoki/articles/67788ca9b47b27
#--------------------------------------------------------------------------------
# æˆ»ã‚Šå€¤ã€€ | ps_charcode[]
#          |  - é …ç›®01 æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’æŒ‡å®šã§ãã‚‹ã‚³ãƒãƒ³ãƒ‰ãƒ¬ãƒƒãƒˆã®æ—¢å®šå€¤
#          |  - é …ç›®02 PowerShellã‹ã‚‰å¤–éƒ¨ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«æ¸¡ã™æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã®è¨­å®š
#          |  - é …ç›®01 PowerShellã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã™ã‚‹æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã®è¨­å®š
# å¼•æ•°ã€€ã€€ | -
#################################################################################
Function GetPsCharcode {
    [System.String[]]$ps_charcode = @()
    $ps_charcode = @(
        # æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’æŒ‡å®šã§ãã‚‹ã‚³ãƒãƒ³ãƒ‰ãƒ¬ãƒƒãƒˆã®æ—¢å®šå€¤
        ($PSDefaultParameterValues['*:Encoding']),
        # PowerShellã‹ã‚‰å¤–éƒ¨ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«æ¸¡ã™æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã®è¨­å®š
        ($global:OutputEncoding).WebName,
        # PowerShellã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã™ã‚‹æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã®è¨­å®š
        ([console]::OutputEncoding).WebName
    )

    return $ps_charcode
}

#################################################################################
# å‡¦ç†åã€€ | ChangeWindowTitle
# æ©Ÿèƒ½ã€€ã€€ | PowerShellã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ã‚¿ã‚¤ãƒˆãƒ«å¤‰æ›´ï¼ˆæ–‡å­—ã‚³ãƒ¼ãƒ‰ã¨PowerShellã®ç®¡ç†è€…æ¨©é™æœ‰ç„¡ã‚’è¿½åŠ ï¼‰
#          | å‚è€ƒæƒ…å ±ï¼šhttps://zenn.dev/haretokidoki/articles/67788ca9b47b27
#--------------------------------------------------------------------------------
# æˆ»ã‚Šå€¤ã€€ | -
# å¼•æ•°ã€€ã€€ | -
#################################################################################
# PowerShellã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ã‚¿ã‚¤ãƒˆãƒ«å¤‰æ›´
Function ChangeWindowTitle {
    # åŒºåˆ‡ã‚Šæ–‡å­—ã®è¨­å®š
    [System.String]$pos1 = '|'
    [System.String]$pos2 = ';'

    # ç¾åœ¨ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—
    [System.String]$title = $Host.UI.RawUI.WindowTitle
    [System.String]$base_title = $title

    # æ—¢ã«ã“ã®Functionã§ã‚¿ã‚¤ãƒˆãƒ«å¤‰æ›´ã—ã¦ã„ã‚‹å ´åˆã€ä¸€ç•ªå·¦ã«ã‚ã‚‹æ–‡å­—åˆ—ã‚’æŠ½å‡º
    [System.String[]]$title_array = $title.Split($pos1)
    if ($title_array.Length -ne 0) {
        $base_title = ($title_array[0]).TrimEnd()
    }

    # ç¾åœ¨ã®æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã‚¿ã‚¤ãƒˆãƒ«ã«è¿½åŠ 
    [System.String[]]$ps_charcode = GetPsCharcode

    [System.String]$change_title = $base_title
    if (isAdminPowerShell) {
        # ç®¡ç†è€…ã¨ã—ã¦å®Ÿè¡Œã—ã¦ã„ã‚‹å ´åˆ
        $change_title = $base_title + " $pos1 " +
                        "DefaultParameter='$($ps_charcode[0])'" + " $pos2 " +
                        "GlobalEncoding='$($ps_charcode[1])'" + " $pos2 " +
                        "ConsoleEncoding='$($ps_charcode[2])'" + " $pos2 " +
                        "#Administrator"
    }
    else {
        # ç®¡ç†è€…ã¨ã—ã¦å®Ÿè¡Œã—ã¦ã„ãªã„å ´åˆ
        $change_title = $base_title + " $pos1 " +
                        "DefaultParameter='$($ps_charcode[0])'" + " $pos2 " +
                        "GlobalEncoding='$($ps_charcode[1])'" + " $pos2 " +
                        "ConsoleEncoding='$($ps_charcode[2])'" + " $pos2 " +
                        "#Not_Administrator"
    }
    $Host.UI.RawUI.WindowTitle = $change_title

    # å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    Write-Host 'ã‚¿ã‚¤ãƒˆãƒ«ã«â€œæ–‡å­—ã‚³ãƒ¼ãƒ‰â€ã¨â€œç®¡ç†è€…æ¨©é™ã®æœ‰ç„¡â€ã®æƒ…å ±ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚' -ForegroundColor Cyan
}

#################################################################################
# å‡¦ç†åã€€ | SetPsOutputEncoding
# æ©Ÿèƒ½ã€€ã€€ | PowerShellã«ãŠã‘ã‚‹è¤‡æ•°ã®æ–‡å­—ã‚³ãƒ¼ãƒ‰è¨­å®šã‚’ä¸€æ‹¬å¤‰æ›´
#          | å‚è€ƒæƒ…å ±ï¼šhttps://zenn.dev/haretokidoki/articles/8946231076f129
#--------------------------------------------------------------------------------
# æˆ»ã‚Šå€¤ã€€ | -
# å¼•æ•°ã€€ã€€ | $charcodeï¼ˆå¼•æ•°ã‚’çœç•¥ã—ãŸå ´åˆã¯ã€'reset_encoding'ã§è¨­å®šï¼‰
# ã€€ã€€ã€€ã€€ |  - 'utf8'          : UTF-8ã«è¨­å®š
# ã€€ã€€ã€€ã€€ |  - 'sjis'          : Shift-JISã«è¨­å®š
# ã€€ã€€ã€€ã€€ |  - 'ascii'         : US-ASCIIã«è¨­å®š
# ã€€ã€€ã€€ã€€ |  - 'rm_encoding'   : ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ãƒ©ãƒ¼ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’å‰Šé™¤
# ã€€ã€€ã€€ã€€ |  - 'reset_encoding': è¦å®šå€¤ã«æˆ»ã™
#################################################################################
Function SetPsOutputEncoding {
    param (
        [System.String]$charcode = 'reset_encoding'
    )

    switch ($charcode) {
        # æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’UTF8ã«è¨­å®šã™ã‚‹
        'utf8' {
            $PSDefaultParameterValues['*:Encoding'] = 'utf8'
            $global:OutputEncoding = [System.Text.Encoding]::UTF8
            [console]::OutputEncoding = [System.Text.Encoding]::UTF8
        }
        # æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’Shift JISï¼ˆSJISï¼‰ã«è¨­å®šã™ã‚‹
        'sjis' {
            # $PSDefaultParameterValues['*:Encoding'] = 'default'ã«ã¤ã„ã¦
            #   ã“ã®è¨­å®šã¯Coreä»¥å¤–ï¼ˆ5.1ä»¥å‰ï¼‰ã®ç’°å¢ƒã§ã®ã¿Shift JISã§è¨­å®šã•ã‚Œã‚‹ã€‚
            #   Coreç’°å¢ƒã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯ã€UTF-8ã§ã‚ã‚ŠUTF-8ã§è¨­å®šã•ã‚Œã¦ã—ã¾ã†ã€‚
            #   ã¾ãŸã€Shift JISã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚‚å­˜åœ¨ã—ãªã„ç‚ºã€Coreç’°å¢ƒã§Shift JISã®è¨­å®šã¯ä¸å¯ã¨ãªã‚‹ã€‚
            $PSDefaultParameterValues['*:Encoding'] = 'default'
            $global:OutputEncoding = [System.Text.Encoding]::GetEncoding('shift_jis')
            [console]::OutputEncoding = [System.Text.Encoding]::GetEncoding('shift_jis')
        }
        # æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’ASCIIã«è¨­å®šã™ã‚‹
        'ascii' {
            $PSDefaultParameterValues.Remove('*:Encoding')
            $global:OutputEncoding = [System.Text.Encoding]::ASCII
            [console]::OutputEncoding = [System.Text.Encoding]::ASCII
        }
        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æŒ‡å®šã‚’è§£é™¤ã™ã‚‹
        'rm_encoding' {
            $PSDefaultParameterValues.Remove('*:Encoding')
        }
        # æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰è¨­å®šã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
        'reset_encoding' {
            $PSDefaultParameterValues.Remove('*:Encoding')

            If ($PSVersionTable.PSEdition -eq 'Core') {
                # Core ã®å ´åˆ
                $global:OutputEncoding = [System.Text.Encoding]::UTF8
                [console]::OutputEncoding = [System.Text.Encoding]::GetEncoding('shift_jis')
            }
            else {
                # Core ä»¥å¤–ã®å ´åˆï¼ˆPowerShell 5.1 ä»¥å‰ï¼‰
                $global:OutputEncoding = [System.Text.Encoding]::ASCII
                [console]::OutputEncoding = [System.Text.Encoding]::GetEncoding('shift_jis')
            }
        }
    }
    # ã‚¿ã‚¤ãƒˆãƒ«ã®è¡¨ç¤ºåˆ‡æ›¿Functionå‘¼ã³å‡ºã—
    ChangeWindowTitle
}

#################################################################################
# å‡¦ç†åã€€ | Get-PsEncoding
# æ©Ÿèƒ½ã€€ã€€ | PowerShellã§ãƒ•ã‚¡ã‚¤ãƒ«ã®æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’åˆ¤å®š
#          | å‚è€ƒæƒ…å ±ï¼šhttps://zenn.dev/haretokidoki/articles/962a7fc6c51b47
#--------------------------------------------------------------------------------
# æˆ»ã‚Šå€¤ã€€ | -
# å¼•æ•°ã€€ã€€ | $targetfile å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
#################################################################################
Function Get-PsEncoding {
    param (
        [Parameter(Mandatory=$true)][System.String]$targetfile
    )
    $stream_reader = [System.IO.StreamReader] $targetfile
    $profile_encoding = $stream_reader.CurrentEncoding
    $stream_reader.Close()

    Write-Host "EncodingName: [$($profile_encoding.EncodingName)]"
}

#################################################################################
# å‡¦ç†åã€€ | Check-BOMStatus
# æ©Ÿèƒ½ã€€ã€€ | PowerShellã§ãƒ•ã‚¡ã‚¤ãƒ«ã®æ–‡å­—ã‚³ãƒ¼ãƒ‰ã«ãŠã‘ã‚‹BOMã‚’åˆ¤å®š
#          | å‚è€ƒæƒ…å ±ï¼šhttps://zenn.dev/haretokidoki/articles/962a7fc6c51b47
#--------------------------------------------------------------------------------
# æˆ»ã‚Šå€¤ã€€ | -
# å¼•æ•°ã€€ã€€ | $targetfile å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
#################################################################################
Function Check-BOMStatus {
    param (
        [Parameter(Mandatory=$true)][System.String]$targetfile
    )
    if (-Not (Test-Path $targetfile)) {
        Write-Host 'The target file does not exist.' -ForegroundColor Red
        return
    }
    
    # BOMã®ãƒã‚¤ãƒˆã‚·ãƒ¼ã‚±ãƒ³ã‚¹
    $UTF7_BOM1 = [System.Byte[]](0x2B,0x2F,0x76,0x38)
    $UTF7_BOM2 = [System.Byte[]](0x2B,0x2F,0x76,0x39)
    $UTF7_BOM3 = [System.Byte[]](0x2B,0x2F,0x76,0x2B)
    $UTF7_BOM4 = [System.Byte[]](0x2B,0x2F,0x76,0x2F)
    $UTF8_BOM = [System.Byte[]](0xEF,0xBB,0xBF)
    $UTF16BE_BOM = [System.Byte[]](0xFE,0xFF)
    $UTF16LE_BOM = [System.Byte[]](0xFF,0xFE)
    $UTF32BE_BOM = [System.Byte[]](0x00,0x00,0xFE,0xFF)
    $UTF32LE_BOM = [System.Byte[]](0xFF,0xFE,0x00,0x00)
    
    # å…ˆé ­è¡Œã‚’ãƒã‚¤ãƒˆã§èª­ã¿è¾¼ã¿å…ˆé ­ã‹ã‚‰3ãƒã‚¤ãƒˆåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    [System.Byte[]]$first_4bytes = (Get-Content -Path $targetfile -Encoding Byte -TotalCount 4)
    [System.Byte[]]$first_3bytes = $first_4bytes[0..2]
    [System.Byte[]]$first_2bytes = $first_4bytes[0..1]
    
    # å…ˆé ­ãƒã‚¤ãƒˆã§BOMä»˜ãã‹åˆ¤å®š
    # UTF-7
    if (($null -eq (Compare-Object $first_4bytes $UTF7_BOM1)) -Or
        ($null -eq (Compare-Object $first_4bytes $UTF7_BOM2)) -Or
        ($null -eq (Compare-Object $first_4bytes $UTF7_BOM3)) -Or
        ($null -eq (Compare-Object $first_4bytes $UTF7_BOM4))) {
        Write-Host "[$($targetfile)] is UTF-7 BOM."
    }
    # UTF-8
    elseif ($null -eq (Compare-Object $first_3bytes $UTF8_BOM -SyncWindow 0)) {
        Write-Host "[$($targetfile)] is UTF-8 BOM."
    }
    # UTF-16 BE
    elseif ($null -eq (Compare-Object $first_2bytes $UTF16BE_BOM -SyncWindow 0)) {
        Write-Host "[$($targetfile)] is UTF-16 BE BOM."
    }
    # UTF-16 LE
    elseif ($null -eq (Compare-Object $first_2bytes $UTF16LE_BOM -SyncWindow 0)) {
        Write-Host "[$($targetfile)] is UTF-16 LE BOM."
    }
    # UTF-32 BE
    elseif ($null -eq (Compare-Object $first_4bytes $UTF32BE_BOM -SyncWindow 0)) {
        Write-Host "[$($targetfile)] is UTF-32 BE BOM."
    }
    # UTF-32 LE
    elseif ($null -eq (Compare-Object $first_4bytes $UTF32LE_BOM -SyncWindow 0)) {
        Write-Host "[$($targetfile)] is UTF-32 LE BOM."
    }
    else {
        Write-Host "[$($targetfile)] is not BOM." -ForegroundColor Red
    }
}

#################################################################################
# å‡¦ç†åã€€ | Get-PyEncoding
# æ©Ÿèƒ½ã€€ã€€ | Pythonã§ãƒ•ã‚¡ã‚¤ãƒ«ã®æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’åˆ¤å®š
#          | å‚è€ƒæƒ…å ±ï¼šhttps://zenn.dev/haretokidoki/articles/aea5b45679d966
#--------------------------------------------------------------------------------
# æˆ»ã‚Šå€¤ã€€ | -
# å¼•æ•°ã€€ã€€ | $targetfile å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
#################################################################################
Function Get-PyEncoding {
    param (
        [Parameter(Mandatory=$true)][System.String]$targetfile
    )

    # python ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª
    if (-Not(Get-Command 'python' -ErrorAction SilentlyContinue)) {
        Write-Host 'Python is not install.' -ForegroundColor Red
        return
    }

    # å­˜åœ¨ãƒã‚§ãƒƒã‚¯
    if (-Not(Test-Path $targetfile)) {
        Write-Host "[$targetfile] does not exist." -ForegroundColor Red
        return
    }

    # çµ¶å¯¾ãƒ‘ã‚¹ã«å¤‰æ›
    [System.String]$fullpath_targetfile = (Convert-Path $targetfile)
    
    # ãƒ‡ãƒ¼ã‚¿ç¨®é¡ã®ãƒã‚§ãƒƒã‚¯
    if (-Not(Test-Path $fullpath_targetfile -PathType Leaf)) {
        Write-Host "[$fullpath_targetfile] is not a file." -ForegroundColor Red
        return
    }

    # Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã‚³ãƒ¼ãƒ‰
    [System.String[]]$py_source = 
@"
import subprocess
import sys

# chardet ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
try:
    import chardet
except ImportError:
    subprocess.check_call([sys.executable, '-m', 'pip', 'install', 'chardet', '--user'])
    import chardet

# æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’åˆ¤å®šã™ã‚‹Function
def determine_encoding(file_path):
    with open(file_path, 'rb') as file:
        raw_data = file.read()
        result = chardet.detect(raw_data)
        print(f"Detected encoding for [{file_path}] is {result['encoding']} with {result['confidence']*100}% confidence.")

# ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã®å¼•æ•°ã‚’å–å¾—
file_path = sys.argv[1]

# å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã®æ–‡å­—åˆ—ã‚’åˆ¤å®š
determine_encoding(file_path)

"@ -split "`r`n"

    # Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æº–å‚™
    #   Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ ¼ç´ã™ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ãŒãªã„å ´åˆã¯ã€æ–°è¦ä½œæˆ
    [System.String]$pyfolder_path = "$PROFILE\..\user-defined-py"
    if (-Not(Test-Path $pyfolder_path)) {
        New-Item -Path $pyfolder_path -ItemType 'directory' -Force > $null
    }
    $pyfolder_path = (Convert-Path $pyfolder_path)
    #   ä»Šå›å®Ÿè¡Œã™ã‚‹Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒãªã„å ´åˆã¯ã€æ–°è¦ä½œæˆ
    [System.String]$pyscript_path = "$pyfolder_path\chardet_runner.py"
    if (-Not(Test-Path $pyscript_path)) {
        $utf8Encoding = New-Object System.Text.UTF8Encoding
        [System.IO.File]::WriteAllText($pyscript_path, $py_source, $utf8Encoding)
    }

    # Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ
    try {
        python $pyscript_path $fullpath_targetfile
    }
    catch {
        Write-Host 'Python script execution error.'
        return
    }
}

```

:::

## ã¾ã¨ã‚

- ä¸‹è¨˜ã®2ã¤ã‹ã‚‰è‡ªä½œFunctionã‚’èª­ã¿è¾¼ã¿ã€PowerShellã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«å®šç¾©ã§ããŸï¼
    - ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã—ãŸè‡ªä½œFunction
    - å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼é…ä¸‹ã«ã‚ã‚‹ps1ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®è‡ªä½œFunction

## é–¢é€£è¨˜äº‹

https://zenn.dev/haretokidoki/articles/1632e92c37ea98
https://haretokidoki-blog.com/pasocon_powershell-startup/
https://zenn.dev/haretokidoki/articles/7e6924ff0cc960
