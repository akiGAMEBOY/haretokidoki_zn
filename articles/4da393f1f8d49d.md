---
title: "PowerShellプロファイルを自動登録するスクリプト（自作Functionの追加で使用）"
emoji: "🕌"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["powershell"]
published: false
---
## 概要

[こちら](https://zenn.dev/haretokidoki/articles/1632e92c37ea98)の記事でデータ型を確認できるFunctionを自作しました。
このような自作Functionは、PowerShellのプロファイルに登録する事で、起動するたびに定義しなくても簡単に呼び出すことができます。

ただ、環境が変わり新しいパソコンで作業する事になった場合、再度プロファイル登録や自作したFunctionをコーディングする必要があり面倒に感じていました。

この問題を解決する為、今回はPowerShellスクリプトで自作したFunctionのPowerShellスクリプトファイル（*.ps1）を読み込み、
プロファイルの定義に追加するPowerShellスクリプトを作成しました。

## コード

```:kick.bat
SET RETURNCODE=0
@REM PowerShell Core インストール確認
SET PSFILEPATH="%~dp0\source\powershell\Main.ps1"
WHERE /Q pwsh
IF %ERRORLEVEL% == 0 (
    @REM PowerShell Core で実行する場合
    pwsh -NoProfile -ExecutionPolicy Unrestricted -File "%~dp0\source\powershell\Main.ps1"
    @REM pwsh -NoProfile -ExecutionPolicy RemoteSigned -File "%~dp0\source\powershell\Main.ps1"
) ELSE (
    @REM PowerShell 5.1  で実行する場合
    powershell -NoProfile -ExecutionPolicy Unrestricted -File "%~dp0\source\powershell\Main.ps1"
    @REM powershell -NoProfile -ExecutionPolicy RemoteSigned -File "%~dp0\source\powershell\Main.ps1"
)

SET RETURNCODE=%ERRORLEVEL%

ECHO.
ECHO 処理が終了しました。
ECHO いずれかのキーを押すとウィンドウが閉じます。
PAUSE > NUL
EXIT %RETURNCODE%
```

```powershell:
[System.String]$target_folder = $args[0]

if ($target_folder -eq '') {
    $target_folder = "$($Env:USERPROFILE)\Documents"    # 初期値「C:\Users\"ユーザー名"\Documents」
}

# 対象のフォルダーパスを指定
$targetFolderPath = "C:\Path\To\Your\Functions"

# PowerShellのプロファイルファイルのパスを取得
$profilePath = $PROFILE

# 対象フォルダー内の.ps1ファイルを検索し、それぞれのファイルに対して処理を実行
Get-ChildItem -Path $targetFolderPath -Filter *.ps1 | ForEach-Object {
    # ファイルからFunction定義を読み込む
    $functionDefinitions = Get-Content $_.FullName

    # プロファイルにFunction定義を追加
    Add-Content -Path $profilePath -Value $functionDefinitions
}

# プロファイルに追加されたFunctionを確認
Write-Host "以下のFunctionがプロファイルに追加されました:"
Get-Content $profilePath | Select-String -Pattern "function"
```

## Copilot

PowerShellで自作のFunctionをプロファイルに追加するスクリプトを作成するには、以下の手順を実行します。

1. 対象のフォルダーにある`.ps1`ファイルを検索します。
2. 各`.ps1`ファイルを読み込み、その中にあるFunction定義を取得します。
3. 取得したFunction定義をPowerShellのプロファイルに追加します。

以下に、このプロセスを実行するPowerShellスクリプトの例を示します。

```powershell:
# 対象のフォルダーパスを指定
$targetFolderPath = "C:\Path\To\Your\Functions"

# PowerShellのプロファイルファイルのパスを取得
$profilePath = $PROFILE

# 対象フォルダー内の.ps1ファイルを検索し、それぞれのファイルに対して処理を実行
Get-ChildItem -Path $targetFolderPath -Filter *.ps1 | ForEach-Object {
    # ファイルからFunction定義を読み込む
    $functionDefinitions = Get-Content $_.FullName

    # プロファイルにFunction定義を追加
    Add-Content -Path $profilePath -Value $functionDefinitions
}

# プロファイルに追加されたFunctionを確認
Write-Host "以下のFunctionがプロファイルに追加されました:"
Get-Content $profilePath | Select-String -Pattern "function"
```

このスクリプトは、指定されたフォルダー内のすべての`.ps1`ファイルを検索し、それぞれのファイルからFunction定義を読み込んで、PowerShellのプロファイルに追加します。最後に、プロファイルに追加されたFunctionの一覧を表示します。

スクリプトを実行する前に、`$targetFolderPath`変数に自作Functionが格納されているフォルダーのパスを設定してください。また、このスクリプトは既存のプロファイルに追加するため、プロファイルが存在しない場合は事前に作成するか、スクリプトにプロファイルの作成処理を追加する必要があります。

このスクリプトは、PowerShellのプロファイルに直接Functionを追加するため、実行する際には十分な権限が必要です。また、プロファイルを変更することはシステムに影響を与える可能性があるため、注意して実行してください。\<|/im_end|>
