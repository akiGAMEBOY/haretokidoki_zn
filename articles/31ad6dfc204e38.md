---
title: "“ping -t”のようにPowerShellで連続してping疎通する方法"
emoji: "📌"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---
## 概要

コマンドプロンプトでは、コマンド「`ping -t "IPアドレス、またはホスト名"`」で連続してPing疎通可能です。
このコマンドプロンプトのコマンドは、PowerShellでも呼び出せるため、今まで不都合はなかったのですが、
プロンプト表示がレガシーすぎるなと、ずっと感じていました。

今回は、コマンドプロンプトではなくPowerShellのコマンドレットを使用し、
`Ctrl + C`などのブレーク送信をするまで連続してping疎通する方法の紹介です。

## この記事のターゲット

- PowerShell ユーザーの方
- PowerShellで連続してping疎通する方法

## 今まで使用していたコマンドプロンプトのコマンド「ping -t」

下記が実際に実行した結果です。

```cmd:コマンドプロンプトで連続ping疎通する
Microsoft Windows [Version 10.0.19045.4046]
(c) Microsoft Corporation. All rights reserved.

C:\Users\"ユーザー名">ping -t www.bing.com

e86303.dscx.akamaiedge.net [23.52.106.66]に ping を送信しています 32 バイトのデータ:
23.52.106.66 からの応答: バイト数 =32 時間 =25ms TTL=55
23.52.106.66 からの応答: バイト数 =32 時間 =23ms TTL=55
23.52.106.66 からの応答: バイト数 =32 時間 =22ms TTL=55
23.52.106.66 からの応答: バイト数 =32 時間 =22ms TTL=55
23.52.106.66 からの応答: バイト数 =32 時間 =23ms TTL=55
23.52.106.66 からの応答: バイト数 =32 時間 =23ms TTL=55
23.52.106.66 からの応答: バイト数 =32 時間 =22ms TTL=55
23.52.106.66 からの応答: バイト数 =32 時間 =23ms TTL=55
23.52.106.66 からの応答: バイト数 =32 時間 =28ms TTL=55

23.52.106.66 の ping 統計:
    パケット数: 送信 = 9、受信 = 9、損失 = 0 (0% の損失)、
ラウンド トリップの概算時間 (ミリ秒):
    最小 = 22ms、最大 = 28ms、平均 = 23ms
Ctrl+C
^C
C:\Users\"ユーザー名">
```

なかなかレガシーな感じですよね。

pingコマンドに限らずPowerShellではコマンドプロンプトのコマンドをそのまま使用できます。
今までサーバーやパソコンを再起動した際に、この連続してping疎通を行える「`ping -t`」コマンドを私用してきましたが、
PowerShellにおけるポート疎通確認の方法を調べた時（[こちらの記事](https://zenn.dev/haretokidoki/articles/1c671247e9523c)）に `Test-Connection` や `Test-NetConnection` という通信系のコマンドレットがある事を知りました。

それらのコマンドレットを使用するとPowerShellでも連続しping疎通する事ができそうだったので、調べてみました。

## PowerShellで連続しping疎通する方法

結論、バージョン毎に実現方法がかわります。

- PowerShell 7.3以降
    `Test-Connection`の動作が破壊的に変更（仕様変更）されてオプションにRepeatが追加されました。
    そのオプションを使用する事で連続してping疎通が可能です。

- PowerShell 7.3よりも前
    ★






PS5.1と7.3以降のPowerShellでは、Test-Connectionの仕様が変更。

7.3以降では、Test-ConnectionにRepeatオプションがあるが、
5.1を含む7.2以前では、そのオプションはない。

```powershell:
Function PingRepeat{
    param(
        [System.String]$target_host = 'localhost',
        [System.Int32]$interval = 1000
    )
    # ブレーク送信されるまで繰り返し
    while ($true) {
        try {
            # ping実行
            [System.Management.ManagementObject]$ping_data = Test-Connection $target_host -Count 1 -ErrorAction Stop
        }
        catch {
            Write-Host "Test-Connectionコマンドレットでエラー：$($_.Exception.Message)" -ForegroundColor Red
            break
        }
        
        # 現在時刻を取得
        [System.String]$now_datetime = Get-Date -Format "yyyy/MM/dd HH:mm:ss.fff"
        # 結果を表示
        Write-Output "$now_datetime, $target, $($ping_data.ResponseTime) ms"
        # 間隔をあける
        Start-Sleep -Milliseconds $interval
    }
}
```

```powershell:実際に「PingRepeat」Functionを実行
PS C:\Users\"ユーザー名"> PingRepeat www.bing.com
2024/02/22 13:39:52.273, www.bing.com, 26 ms
2024/02/22 13:39:53.329, www.bing.com, 50 ms
2024/02/22 13:39:54.379, www.bing.com, 24 ms
2024/02/22 13:39:55.667, www.bing.com, 247 ms
2024/02/22 13:39:56.733, www.bing.com, 48 ms
2024/02/22 13:39:57.821, www.bing.com, 62 ms
2024/02/22 13:39:58.846, www.bing.com, 20 ms
2024/02/22 13:39:59.896, www.bing.com, 20 ms
PS C:\Users\"ユーザー名">
```

PowerShellを使いpingを連続で実行
https://qiita.com/akira6592/items/236939ad62bd1f98371e

:::details Bing AIにTest-Connection と Test-NetConnection の相違点・使い分け方を聞く 
> 
> 
> PowerShellにおける下記のコマンドレット2点の相違点と使い分け方を教えて
> ・Test-Connection
> ・Test-NetConnection
　
> 
> 　
> こんにちは、これはBingです。PowerShellのコマンドレットについてのご質問ありがとうございます。😊
> 
> Test-ConnectionとTest-NetConnectionは、ネットワーク接続をテストするためのコマンドレットですが、いくつかの違いがあります。¹²
> 
> - Test-Connectionは、ICMPエコーリクエスト（ping）を使用して、リモートコンピューターとの接続性を確認します。⁴ また、-Sourceパラメーターを使用して、リモートコンピューターから別のリモートコンピューターへの接続性もテストできます。¹ Test-Connectionは、TestConnectionCommand+PingStatusオブジェクトを返すので、PowerShellで詳細に調べることができます。⁴
> - Test-NetConnectionは、Test-Connectionの後継コマンドレットで、より多くのネットワークテストを提供します。¹ 例えば、-Portパラメーターを指定すると、TCPポートへの接続をテストできます。³ また、-TraceRouteパラメーターを使用すると、トレースルートを実行できます。¹ Test-NetConnectionは、TestConnectionResultオブジェクトを返すので、PowerShellで詳細に調べることができます。¹
> 
> Test-ConnectionとTest-NetConnectionの使い分け方は、以下のようになります。
> 
> - ICMPエコーリクエスト（ping）での接続性のみを確認したい場合は、Test-Connectionを使用します。
> - TCPポートやトレースルートなど、より詳細なネットワークテストを行いたい場合は、Test-NetConnectionを使用します。
> - リモートコンピューターから別のリモートコンピューターへの接続性をテストしたい場合は、Test-Connectionの-Sourceパラメーターを使用します。
> 
> 以上が、PowerShellのTest-ConnectionとTest-NetConnectionの相違点と使い分け方になります。ご参考になれば幸いです。😊
> 
> ソース: Bing との会話 2023/12/20
> (1) Test-NetConnection vs. Test-Connection – Testing a network .... https://4sysops.com/archives/test-netconnection-vs-test-connection-testing-a-network-connection-with-powershell/.
> (2) Windowsからのポート疎通を確認する方法の比較 #Windows - Qiita. https://qiita.com/NUMA09/items/a20147f79e9caedb1add.
> (3) Test-Connection (Microsoft.PowerShell.Management .... https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.management/test-connection?view=powershell-7.4.
> (4) Test for connection to the internet in a powershell script?. https://stackoverflow.com/questions/76716193/test-for-connection-to-the-internet-in-a-powershell-script.
> (5) Come testare la connessione di rete da PowerShell [TurboLab.it]. https://turbolab.it/windows-10/come-testare-connessione-rete-powershell-3877.
:::
