---
title: "“ping -t”のようにPowerShellで連続してping疎通する方法"
emoji: "📌"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["windows", "powershell", "cmd"]
published: false
---
## 概要

コマンドプロンプトでは、コマンド「`ping -t "IPアドレス、またはホスト名"`」で連続してPing疎通可能です。
このコマンドプロンプトのコマンドは、PowerShellでも呼び出せるため、今まで不都合はなかったのですが、
プロンプト表示がレガシーすぎるなと、ずっと感じていました。

今回は、コマンドプロンプトではなくPowerShellのコマンドレットを使用し、
`Ctrl + C`などのブレーク送信をするまで連続してping疎通する方法の紹介です。

## この記事のターゲット

- PowerShell ユーザーの方
- PowerShellで連続してping疎通する方法

## 今まで使用していたコマンドプロンプトのコマンド「ping -t」

下記が実際に実行した結果です。

```:コマンドプロンプトで連続してping疎通
Microsoft Windows [Version 10.0.19045.4046]
(c) Microsoft Corporation. All rights reserved.

C:\Users\"ユーザー名">ping -t www.bing.com

e86303.dscx.akamaiedge.net [23.52.106.66]に ping を送信しています 32 バイトのデータ:
23.52.106.66 からの応答: バイト数 =32 時間 =25ms TTL=55
23.52.106.66 からの応答: バイト数 =32 時間 =23ms TTL=55
23.52.106.66 からの応答: バイト数 =32 時間 =22ms TTL=55
23.52.106.66 からの応答: バイト数 =32 時間 =22ms TTL=55
23.52.106.66 からの応答: バイト数 =32 時間 =23ms TTL=55
23.52.106.66 からの応答: バイト数 =32 時間 =23ms TTL=55
23.52.106.66 からの応答: バイト数 =32 時間 =22ms TTL=55
23.52.106.66 からの応答: バイト数 =32 時間 =23ms TTL=55
23.52.106.66 からの応答: バイト数 =32 時間 =28ms TTL=55

23.52.106.66 の ping 統計:
    パケット数: 送信 = 9、受信 = 9、損失 = 0 (0% の損失)、
ラウンド トリップの概算時間 (ミリ秒):
    最小 = 22ms、最大 = 28ms、平均 = 23ms
Ctrl+C
^C
C:\Users\"ユーザー名">
```

なかなかレガシーな感じですよね。

PowerShellでは、pingコマンドに限らずコマンドプロンプトのコマンドをそのまま使用できます。
今までサーバーやパソコンを再起動した際に、この「`ping -t`」コマンドを使用してきましたが、
PowerShellにおけるポート疎通確認の方法を調べた際（[こちらの記事](https://zenn.dev/haretokidoki/articles/1c671247e9523c)）に `Test-Connection` や `Test-NetConnection` という通信系のコマンドレットがある事を知りました。

それらのコマンドレットを使用するとPowerShellでも実現できそうだったので、今回ふかぼりして調べてみました。

## PowerShellで連続しping疎通する方法

結論から。バージョン毎に実現方法がかわります。

- PowerShell 7.2以前
    Windows 10/11 で標準インストールされている`5.1`やPowerShell Coreの`6.0 ～ 6.2`、`7.0 ～ 7.2`が対象。
    `Test-Connection`や`Test-NetConnection`など**PowerShellのコマンドレットのみでは実現できません**。
    コマンドレットだけで対応する場合は、独自のFunctioonを作成するなどの対応が考えられます。

- PowerShell 7.3以降
    `Test-Connection`の動作が破壊的に変更（仕様変更）されてオプションに`Repeat`が追加されました。
    その**オプションを使用する事で連続してping疎通が可能**です。

### PowerShell 7.2以前で連続してping疎通する方法

コマンドレットにオプションがないので、今間までどおりコマンドプロンプトの「`ping -t`」のほうがはやいですが、
どうしてもPowerShellのコマンドだけで実現したい場合、独自のFunctionの作成が必要です。

実際にFunctionを作成してみました。

```powershell:PowerShell 7.2以前：独自のFunctionを作成
# Functionの定義
Function PingRepeat{
    param(
        [System.String]$target_host = 'localhost',
        [System.Int32]$interval = 1000
    )
    # ブレーク送信されるまで繰り返し
    while ($true) {
        try {
            # ping実行
            [Microsoft.PowerShell.Commands.TestConnectionCommand+PingStatus]$ping_data = Test-Connection $target_host -Count 1 -ErrorAction Stop
            # 画面に結果表示
            [System.String]$now_datetime = Get-Date -Format "yyyy/MM/dd HH:mm:ss.fff"
            if ($null -eq $ping_data.ResponseTime) {
                Write-Output "$now_datetime, $target_host, 0 ms"
            }
            else {
                Write-Output "$now_datetime, $target_host, $($ping_data.ResponseTime) ms"
            }
        }
        catch {
            Write-Host "エラー：$($_.Exception.Message)" -ForegroundColor Red
            # 「ping -t」の挙動に合わせて疎あ通がとれなくても続行する
            # 疎通できなかった場合に処理を中断したい場合は、ここで「break」を実行
            # break
        }
        # 間隔をあける
        Start-Sleep -Milliseconds $interval
    }
}
```

```powershell:PowerShell 7.2以前：独自Functionを実行
PS C:\Users\"ユーザー名"> PingRepeat www.bing.com
2024/02/22 13:39:52.273, www.bing.com, 26 ms
2024/02/22 13:39:53.329, www.bing.com, 50 ms
2024/02/22 13:39:54.379, www.bing.com, 24 ms
2024/02/22 13:39:55.667, www.bing.com, 247 ms
2024/02/22 13:39:56.733, www.bing.com, 48 ms
2024/02/22 13:39:57.821, www.bing.com, 62 ms
2024/02/22 13:39:58.846, www.bing.com, 20 ms
2024/02/22 13:39:59.896, www.bing.com, 20 ms
PS C:\Users\"ユーザー名">
```

`ping -t`では、`Ctrl + C`でping疎通を中断した際に統計結果が表示されるので、
正直、劣化版`ping -t`っていう感じですね 😅

## PowerShell 7.3以降で連続してping疎通する方法

前述している通り、バージョン7.3で破壊的変更（仕様動作の変更）があり、その変更でオプション「`-Repeat`」が実装されました。

```powershell:PowerShell 7.3以降：新たに実装されたオプションをつけて実行
PS C:\Users\"ユーザー名"> Test-Connection www.bing.com -Repeat

   Destination: www.bing.com

Ping Source           Address                   Latency BufferSize Status
                                                   (ms)        (B)
---- ------           -------                   ------- ---------- ------
   1 xxxxxxxx         23.52.106.99                   22         32 Success
   2 xxxxxxxx         23.52.106.99                   23         32 Success
   3 xxxxxxxx         23.52.106.99                   20         32 Success
   4 xxxxxxxx         23.52.106.99                   19         32 Success
   5 xxxxxxxx         23.52.106.99                   76         32 Success
   6 xxxxxxxx         23.52.106.99                   20         32 Success
   7 xxxxxxxx         23.52.106.99                   20         32 Success
   8 xxxxxxxx         23.52.106.99                   20         32 Success
PS C:\Users\"ユーザー名">
```

Sourceにある`xxxxxxxx`は実際にはコンピューター名が入りますが、マスキングしています。
Test-Connectionコマンドレットによるping結果は見やすいですね。

## まとめ

- PowerShellコマンドレットで「pint -t」を実現する方法は、
- PowerShellのバージョンによってTest-
