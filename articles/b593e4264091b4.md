---
title: "ç”ŸæˆAIï¼ˆãƒ†ã‚­ã‚¹ãƒˆå‹LLMï¼‰ã¨APIé€£æºã™ã‚‹PowerShellé–¢æ•°ã‚’ä½œã£ã¦ã¿ãŸ"
emoji: "ğŸ™"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["powershell", "ç”ŸæˆAI", "LLM", "API"]
published: false
---

### å®Œæˆã—ãŸPowerShellé–¢æ•° `Invoke-AI` (Google Gemini API ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)

```powershell
function Invoke-AI {
<#
.SYNOPSIS
    ä¸»è¦ãªLLMãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®APIã«è³ªå•ã‚’é€ä¿¡ã—ã€å›ç­”ã‚’å–å¾—ã—ã¾ã™ã€‚
.DESCRIPTION
    ã“ã®é–¢æ•°ã¯ã€Google(Gemini), OpenAI(GPT), Anthropic(Claude)ã®APIã¨é€£æºã—ã€
    æŒ‡å®šã•ã‚ŒãŸè³ªå•ã«å¯¾ã™ã‚‹å›ç­”ã‚’è¿”ã—ã¾ã™ã€‚
    ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€å¯›å¤§ãªç„¡æ–™æ ã‚’æŒã¤Googleã®Gemini 1.5 Flashãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
.PARAMETER Question
    AIã«é€ä¿¡ã™ã‚‹è³ªå•ã®æ–‡å­—åˆ—ã€‚ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‹ã‚‰ã®å…¥åŠ›ã‚‚å¯èƒ½ã§ã™ã€‚
.PARAMETER Provider
    ä½¿ç”¨ã™ã‚‹LLMãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’é¸æŠã—ã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ 'Google' ã§ã™ã€‚
    ( 'Google', 'OpenAI', 'Anthropic' )
.PARAMETER Model
    ä½¿ç”¨ã™ã‚‹å…·ä½“çš„ãªãƒ¢ãƒ‡ãƒ«åã‚’æŒ‡å®šã—ã¾ã™ã€‚æŒ‡å®šã—ãªã„å ´åˆã¯ã€å„ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®
    ã‚³ã‚¹ãƒˆåŠ¹ç‡ã®è‰¯ã„ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ‡ãƒ«ãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
.PARAMETER ApiKey
    APIã‚­ãƒ¼ã‚’ç›´æ¥æŒ‡å®šã—ã¾ã™ã€‚æŒ‡å®šã—ãªã„å ´åˆã¯ã€ç’°å¢ƒå¤‰æ•°ã‹ã‚‰è‡ªå‹•ã§èª­ã¿è¾¼ã¾ã‚Œã¾ã™ã€‚
    ( $env:GOOGLE_API_KEY, $env:OPENAI_API_KEY, $env:ANTHROPIC_API_KEY )
.EXAMPLE
    # ç„¡æ–™æ ãŒä½¿ãˆã‚‹Google Geminiã«è³ªå•ã™ã‚‹ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
    Invoke-AI "PowerShellã§ç¾åœ¨æ™‚åˆ»ã‚’ISO 8601å½¢å¼ã§å–å¾—ã™ã‚‹æ–¹æ³•ã¯ï¼Ÿ"

.EXAMPLE
    # OpenAIã®GPT-4oã‚’ä½¿ã£ã¦è³ªå•ã™ã‚‹
    Invoke-AI "ã“ã®é–¢æ•°ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°æ¡ˆã‚’ææ¡ˆã—ã¦" -Provider OpenAI -Model gpt-4o

.EXAMPLE
    # Anthropicã®Claude 3 Haikuã‚’ä½¿ã„ã€ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§è³ªå•ã‚’æ¸¡ã™
    "æ—¥æœ¬ã®ç¥æ—¥ä¸€è¦§ã‚’ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã§æ•™ãˆã¦" | Invoke-AI -Provider Anthropic

.LINK
    Google AI Studio API Keys: https://aistudio.google.com/app/apikey
    OpenAI API Keys: https://platform.openai.com/api-keys
    Anthropic API Keys: https://console.anthropic.com/settings/keys
#>
    [CmdletBinding()]
    param(
        [Parameter(Mandatory = $true, Position = 0, ValueFromPipeline = $true)]
        [string]$Question,

        [Parameter()]
        [ValidateSet('Google', 'OpenAI', 'Anthropic')]
        [string]$Provider = 'Google',

        [Parameter()]
        [string]$Model,

        [Parameter()]
        [string]$ApiKey
    )

    $providerInfo = @{
        Google = @{
            DefaultModel = "gemini-1.5-flash-latest"
            ApiKeyEnvVar = "GOOGLE_API_KEY"
        }
        OpenAI = @{
            DefaultModel = "gpt-3.5-turbo"
            ApiKeyEnvVar = "OPENAI_API_KEY"
        }
        Anthropic = @{
            DefaultModel = "claude-3-haiku-20240307"
            ApiKeyEnvVar = "ANTHROPIC_API_KEY"
        }
    }

    # ãƒ¢ãƒ‡ãƒ«ãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã‘ã‚Œã°ã€ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨
    if ([string]::IsNullOrEmpty($Model)) {
        $Model = $providerInfo[$Provider].DefaultModel
    }

    # APIã‚­ãƒ¼ãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã‘ã‚Œã°ã€ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—
    if ([string]::IsNullOrEmpty($ApiKey)) {
        $apiKeyName = $providerInfo[$Provider].ApiKeyEnvVar
        $ApiKey = Get-Content "env:\$apiKeyName" -ErrorAction SilentlyContinue
    }

    if ([string]::IsNullOrEmpty($ApiKey)) {
        Write-Error "APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚-ApiKeyãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æŒ‡å®šã™ã‚‹ã‹ã€ç’°å¢ƒå¤‰æ•° $($providerInfo[$Provider].ApiKeyEnvVar) ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚"
        return
    }

    Write-Host "ğŸ¤– $Provider ($Model) ã«å•ã„åˆã‚ã›ä¸­..." -ForegroundColor Gray

    $headers = @{}
    $apiUrl = ""
    $body = ""

    # ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã”ã¨ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’çµ„ã¿ç«‹ã¦ã‚‹
    switch ($Provider) {
        "Google" {
            $apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/${Model}:generateContent?key=${ApiKey}"
            $headers = @{
                "Content-Type" = "application/json"
            }
            $body = @{
                contents = @(
                    @{
                        parts = @(
                            @{
                                text = $Question
                            }
                        )
                    }
                )
            } | ConvertTo-Json -Depth 5
        }
        "OpenAI" {
            $apiUrl = "https://api.openai.com/v1/chat/completions"
            $headers = @{
                "Authorization" = "Bearer $ApiKey"
                "Content-Type"  = "application/json"
            }
            $body = @{
                model    = $Model
                messages = @(
                    @{
                        role    = "user"
                        content = $Question
                    }
                )
            } | ConvertTo-Json
        }
        "Anthropic" {
            $apiUrl = "https://api.anthropic.com/v1/messages"
            $headers = @{
                "x-api-key"         = $ApiKey
                "anthropic-version" = "2023-06-01"
                "content-type"      = "application/json"
            }
            $body = @{
                model      = $Model
                max_tokens = 4096
                messages   = @(
                    @{
                        role    = "user"
                        content = $Question
                    }
                )
            } | ConvertTo-Json
        }
    }

    try {
        $response = Invoke-RestMethod -Uri $apiUrl -Method Post -Headers $headers -Body $body -ErrorAction Stop
        
        $aiAnswer = ""
        switch ($Provider) {
            "Google"    { $aiAnswer = $response.candidates[0].content.parts[0].text }
            "OpenAI"    { $aiAnswer = $response.choices[0].message.content }
            "Anthropic" { $aiAnswer = $response.content[0].text }
        }
        return $aiAnswer.Trim()
    }
    catch {
        $errorDetail = $_.Exception.Response.GetResponseStream()
        $reader = New-Object System.IO.StreamReader($errorDetail)
        $errorText = $reader.ReadToEnd()
        Write-Error "APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚è©³ç´°: $errorText"
        return $null
    }
}
```

### ã“ã®é–¢æ•°ã®ä½¿ã„æ–¹

#### 1. äº‹å‰æº–å‚™ï¼šGoogleã®APIã‚­ãƒ¼ã‚’è¨­å®š

[Google AI Studio](https://aistudio.google.com/app/apikey)ã§APIã‚­ãƒ¼ã‚’å–å¾—ã—ã€PowerShellã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã—ã¾ã™ã€‚

```powershell
$env:GOOGLE_API_KEY = "AIzaSyxxxxxxxxxxxxxxxxxxxxxxxxxxx" # â† ã‚ãªãŸã®APIã‚­ãƒ¼ã«ç½®ãæ›ãˆã¦ãã ã•ã„
```
*(ä»–ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ã„ãŸã„å ´åˆã¯ã€ãã‚Œãã‚Œã®ã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„: `$env:OPENAI_API_KEY`, `$env:ANTHROPIC_API_KEY`)*

#### 2. é–¢æ•°ã®èª­ã¿è¾¼ã¿

ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã‚’ `Invoke-AI.ps1` ã®ã‚ˆã†ãªåå‰ã§ä¿å­˜ã—ã€` . .\Invoke-AI.ps1 ` ã‚³ãƒãƒ³ãƒ‰ã§èª­ã¿è¾¼ã¿ã¾ã™ã€‚
ï¼ˆPowerShellã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ« `$PROFILE` ã«ä¿å­˜ã™ã‚‹ã¨ã€ã„ã¤ã§ã‚‚ä½¿ãˆã¦ä¾¿åˆ©ã§ã™ã€‚ï¼‰

#### 3. é–¢æ•°ã®å®Ÿè¡Œä¾‹

**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆGoogle Geminiï¼‰ã§å®Ÿè¡Œ**
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½•ã‚‚æŒ‡å®šã—ãªã„å ´åˆã€è‡ªå‹•çš„ã«Google Gemini APIãŒä½¿ã‚ã‚Œã¾ã™ã€‚
```powershell
Invoke-AI "ç¾åœ¨åœ°ã®å¤©æ°—ã¨æ°—æ¸©ã‚’æ•™ãˆã¦"
```

**ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§å®Ÿè¡Œï¼ˆã“ã¡ã‚‰ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§GeminiãŒä½¿ã‚ã‚Œã¾ã™ï¼‰**
```powershell
"ã“ã®æ–‡ç« ã‚’è¦ç´„ã—ã¦ãã ã•ã„ï¼š(ã“ã“ã«é•·ã„æ–‡ç« )..." | Invoke-AI
```

**åˆ¥ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’ä½¿ã„ãŸã„å ´åˆ**
`-Provider` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒ‡å®šã™ã‚Œã°ã€ã„ã¤ã§ã‚‚ä»–ã®ã‚µãƒ¼ãƒ“ã‚¹ã«åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚
```powershell
# OpenAIã«åˆ‡ã‚Šæ›¿ãˆ
Invoke-AI "Pythonã§ç°¡å˜ãªWebã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¦ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦" -Provider OpenAI

# Anthropicã«åˆ‡ã‚Šæ›¿ãˆ
Invoke-AI "ã“ã®è‹±æ–‡ã‚’è‡ªç„¶ãªæ—¥æœ¬èªã«ç¿»è¨³ã—ã¦ï¼š(è‹±æ–‡)..." -Provider Anthropic
```

ã“ã‚Œã§ã€æ™®æ®µä½¿ã„ã¯ç„¡æ–™æ ã®åºƒã„Google Gemini APIã‚’æ´»ç”¨ã—ã¤ã¤ã€å¿…è¦ã«å¿œã˜ã¦ä»–ã®é«˜æ€§èƒ½ãªãƒ¢ãƒ‡ãƒ«ã«ã‚‚ç°¡å˜ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã€éå¸¸ã«å®Ÿç”¨çš„ãªAIé–¢æ•°ãŒå®Œæˆã—ã¾ã—ãŸã€‚
