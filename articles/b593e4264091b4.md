---
title: "ãƒ†ã‚­ã‚¹ãƒˆå‹LLMã¨APIé€£æºã™ã‚‹PowerShellé–¢æ•°ã‚’ä½œã£ã¦ã¿ãŸ"
emoji: "ğŸ‘©â€ğŸ’»"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["powershell", "ç”ŸæˆAI", "LLM", "API"]
published: false
---

```powershell
function Invoke-AI {
<#
.SYNOPSIS
    ä¸»è¦ãªLLMãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®APIã«è³ªå•ã‚’é€ä¿¡ã—ã€å›ç­”ã‚’å–å¾—ã—ã¾ã™ã€‚
.DESCRIPTION
    Google, OpenAI, Perplexity, Anthropicã®APIã¨é€£æºã—ã€æŒ‡å®šã•ã‚ŒãŸè³ªå•ã«å¯¾ã™ã‚‹å›ç­”ã‚’è¿”ã—ã¾ã™ã€‚
    ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ‡ãƒ«ã¯ã€ã‚³ã‚¹ãƒˆã‚’æœ€å°é™ã«æŠ‘ãˆã‚‹ã‚ˆã†ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚
#>
    [CmdletBinding()]
    [OutputType([string])]
    param(
        [Parameter(Mandatory = $true, Position = 0, ValueFromPipeline = $true)]
        [string]$Question,

        [Parameter()]
        [ValidateSet('Google', 'OpenAI', 'Perplexity', 'Anthropic')]
        [string]$Provider = 'Google',

        [Parameter()]
        [string]$Model,

        [Parameter()]
        [string]$ApiKey
    )

    # ---------------------------------------------------------------
    # ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã”ã¨ã®è¨­å®šã¨APIå‘¼ã³å‡ºã—ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®šç¾©
    # ---------------------------------------------------------------
    $providers = @{
        Google = [PSCustomObject]@{
            DefaultModel = "gemini-1.5-flash-latest"
            ApiKeyEnvVar = "GOOGLE_API_KEY"
            BuildRequest = {
                param($ApiKey, $Model, $Question)
                $apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/${Model}:generateContent"
                $headers = @{ "Content-Type" = "application/json"; "x-goog-api-key" = $ApiKey }
                $body = @{ contents = @( @{ parts = @( @{ text = $Question } ) } ) } | ConvertTo-Json -Depth 5
                return @{ Uri = $apiUrl; Method = 'Post'; Headers = $headers; Body = $body }
            }
            ParseResponse = { param($Response) $Response.candidates[0].content.parts[0].text }
        }
        OpenAI = [PSCustomObject]@{
            DefaultModel = "gpt-3.5-turbo"
            ApiKeyEnvVar = "OPENAI_API_KEY"
            BuildRequest = {
                param($ApiKey, $Model, $Question)
                $apiUrl = "https://api.openai.com/v1/chat/completions"
                $headers = @{ "Authorization" = "Bearer $ApiKey"; "Content-Type" = "application/json" }
                $body = @{ model = $Model; messages = @(@{ role = "user"; content = $Question }) } | ConvertTo-Json
                return @{ Uri = $apiUrl; Method = 'Post'; Headers = $headers; Body = $body }
            }
            ParseResponse = { param($Response) $Response.choices[0].message.content }
        }
        Perplexity = [PSCustomObject]@{
            DefaultModel = "pplx-7b-online"
            ApiKeyEnvVar = "PERPLEXITY_API_KEY"
            BuildRequest = {
                param($ApiKey, $Model, $Question)
                $apiUrl = "https://api.perplexity.ai/chat/completions"
                $headers = @{ "Authorization" = "Bearer $ApiKey"; "Content-Type" = "application/json" }
                $body = @{ model = $Model; messages = @(@{ role = "user"; content = $Question }) } | ConvertTo-Json
                return @{ Uri = $apiUrl; Method = 'Post'; Headers = $headers; Body = $body }
            }
            ParseResponse = { param($Response) $Response.choices[0].message.content }
        }
        Anthropic = [PSCustomObject]@{
            DefaultModel = "claude-3-haiku-20240307"
            ApiKeyEnvVar = "ANTHROPIC_API_KEY"
            ApiVersion   = "2023-06-01"
            BuildRequest = {
                param($ApiKey, $Model, $Question, $ApiVersion)
                $apiUrl = "https://api.anthropic.com/v1/messages"
                $headers = @{ "x-api-key" = $ApiKey; "anthropic-version" = $ApiVersion; "content-type" = "application/json" }
                $body = @{ model = $Model; max_tokens = 4096; messages = @(@{ role = "user"; content = $Question }) } | ConvertTo-Json
                return @{ Uri = $apiUrl; Method = 'Post'; Headers = $headers; Body = $body }
            }
            ParseResponse = { param($Response) $Response.content[0].text }
        }
    }

    if (-not $providers.ContainsKey($Provider)) { Write-Error "..."; return }
    $selectedProvider = $providers[$Provider]
    if ([string]::IsNullOrEmpty($Model)) {
        $Model = $selectedProvider.DefaultModel
    }
    if ([string]::IsNullOrEmpty($ApiKey)) {
        $apiKeyName = $selectedProvider.ApiKeyEnvVar
        $ApiKey = Get-Content "env:\$apiKeyName" -ErrorAction SilentlyContinue
    }
    if ([string]::IsNullOrEmpty($ApiKey)) {
        $apiKeyEnvVarName = $selectedProvider.ApiKeyEnvVar
        Write-Error "APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚-ApiKeyãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æŒ‡å®šã™ã‚‹ã‹ã€ç’°å¢ƒå¤‰æ•° `$env:$apiKeyEnvVarName` ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚"
        return
    }
    Write-Host "ğŸ¤– $Provider ($Model) ã«å•ã„åˆã‚ã›ä¸­..." -ForegroundColor Gray
    try {
        $requestParams = @{ ApiKey = $ApiKey; Model = $Model; Question = $Question }
        if ($selectedProvider.PSObject.Properties.Name -contains 'ApiVersion') {
            $requestParams.ApiVersion = $selectedProvider.ApiVersion
        }
        $requestSplat = & $selectedProvider.BuildRequest @requestParams
        $response = Invoke-RestMethod @requestSplat -TimeoutSec 60 -ErrorAction Stop
        $aiAnswer = & $selectedProvider.ParseResponse -Response $response
        return $aiAnswer.Trim()
    }
    catch {
        $errorDetail = $_.Exception.Response.GetResponseStream()
        $reader = New-Object System.IO.StreamReader($errorDetail)
        $errorText = $reader.ReadToEnd()
        Write-Error "APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚è©³ç´°: $errorText"
        return $null
    }
}
```

## ä»•æ§˜

::::details PowerShellé–¢æ•°ã€ŒInvoke-AIã€ã®ä»•æ§˜

### 1. æ¦‚è¦

`Invoke-AI` ã¯ã€ä¸»è¦ãªLLMï¼ˆå¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ï¼‰ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®APIã¨é€£æºã—ã€PowerShellä¸Šã§å¯¾è©±çš„ã«AIã‹ã‚‰ã®å›ç­”ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®å¤šæ©Ÿèƒ½ãªé–¢æ•°ã§ã™ã€‚

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€å¯›å¤§ãªç„¡æ–™æ ã‚’æŒã¤Googleã®Gemini APIã‚’åˆ©ç”¨ã—ã¾ã™ãŒã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§OpenAI, Perplexity, Anthropicã®APIã«ã‚‚ç°¡å˜ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

### 2. æ©Ÿèƒ½

- **ãƒãƒ«ãƒãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼å¯¾å¿œ:** 4ã¤ã®ä¸»è¦ãªLLMãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’ã‚µãƒãƒ¼ãƒˆã€‚
  - Google (Gemini) - **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ**
  - OpenAI (GPT)
  - Perplexity
  - Anthropic (Claude)
- **ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹:** `Invoke-AI "è³ªå•å†…å®¹"` ã®ã‚ˆã†ã«ã€ã‚³ãƒãƒ³ãƒ‰ä¸€ã¤ã§ç°¡å˜ã«AIã‚’å‘¼ã³å‡ºã›ã¾ã™ã€‚
- **ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å…¥åŠ›å¯¾å¿œ:** `Get-Content file.txt | Invoke-AI` ã®ã‚ˆã†ã«ã€ä»–ã®ã‚³ãƒãƒ³ãƒ‰ã®å‡ºåŠ›ã‚’ç›´æ¥AIã«æ¸¡ã™ã“ã¨ãŒã§ãã¾ã™ã€‚
- **æŸ”è»Ÿãªãƒ¢ãƒ‡ãƒ«é¸æŠ:** å„ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãŒæä¾›ã™ã‚‹æ§˜ã€…ãªãƒ¢ãƒ‡ãƒ«ï¼ˆé«˜æ€§èƒ½ãƒ¢ãƒ‡ãƒ«ã€é«˜é€Ÿãƒ¢ãƒ‡ãƒ«ãªã©ï¼‰ã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æŒ‡å®šå¯èƒ½ã§ã™ã€‚
- **è‡ªå‹•APIã‚­ãƒ¼æ¤œå‡º:** PowerShellã®ç’°å¢ƒå¤‰æ•°ã‹ã‚‰APIã‚­ãƒ¼ã‚’è‡ªå‹•ã§èª­ã¿è¾¼ã¿ã¾ã™ã€‚

### 3. ä½¿ã„æ–¹

#### 3.1. äº‹å‰æº–å‚™ï¼šAPIã‚­ãƒ¼ã®è¨­å®š

åˆ©ç”¨ã—ãŸã„ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®APIã‚­ãƒ¼ã‚’å–å¾—ã—ã€å¯¾å¿œã™ã‚‹ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã—ã¾ã™ã€‚ã“ã®è¨­å®šã¯PowerShellã‚»ãƒƒã‚·ãƒ§ãƒ³ã”ã¨ã«å¿…è¦ã§ã™ã€‚ï¼ˆæ’ä¹…çš„ã«è¨­å®šã™ã‚‹ã«ã¯ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜è¿°ã—ã¾ã™ï¼‰

```powershell
# Google Gemini (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
$env:GOOGLE_API_KEY = "AIzaSy..."

# OpenAI
$env:OPENAI_API_KEY = "sk-..."

# Perplexity
$env:PERPLEXITY_API_KEY = "ppl-..."

# Anthropic
$env:ANTHROPIC_API_KEY = "sk-ant-..."
```

#### 3.2. é–¢æ•°ã®èª­ã¿è¾¼ã¿

é–¢æ•°ãŒè¨˜è¿°ã•ã‚ŒãŸ `.ps1` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€ã‚«ãƒ¬ãƒ³ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã«èª­ã¿è¾¼ã¿ã¾ã™ã€‚

```powershell
. .\Invoke-AI.ps1
```

:::details ãƒ’ãƒ³ãƒˆ: ã“ã®é–¢æ•°ã‚’PowerShellã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`$PROFILE`ï¼‰ã«è¨˜è¿°ã™ã‚‹ã¨ã€ã„ã¤ã§ã‚‚åˆ©ç”¨å¯èƒ½ã«

è‡ªä½œã—ãŸFunctionã‚’ã‚ã‚‰ã‹ã˜ã‚PowerShellã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«ç™»éŒ²ã™ã‚‹ã“ã¨ã§ã€ç°¡å˜ã«è‡ªä½œFunctionã‚’å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®ç™»éŒ²æ–¹æ³•ã«ã¤ã„ã¦ã¯ã€[ã“ã¡ã‚‰](https://zenn.dev/haretokidoki/articles/e2a6c521035d94#å‚è€ƒæƒ…å ±ï¼špowershellã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ã£ãŸãƒ—ãƒ­ã‚»ã‚¹ç’°å¢ƒå¤‰æ•°ã®è¨­å®šæ–¹æ³•)ã®è¨˜äº‹å†…ã«ã€Œå‚è€ƒæƒ…å ±ï¼špowershellã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ã£ãŸãƒ—ãƒ­ã‚»ã‚¹ç’°å¢ƒå¤‰æ•°ã®è¨­å®šæ–¹æ³•ã€ã¨ã—ã¦ç´¹ä»‹ã—ã¦ã„ã¾ã™ã€‚

å¿…è¦ã«å¿œã˜ã¦ã€ä»Šå›ã®ç´¹ä»‹ã—ã¦ã„ã‚‹è‡ªä½œFunctionã‚’ç™»éŒ²ï¼ˆå®šç¾©ï¼‰ã—ã¦ãã ã•ã„ã€‚

@[card](https://zenn.dev/haretokidoki/articles/e2a6c521035d94#å‚è€ƒæƒ…å ±ï¼špowershellã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ã£ãŸãƒ—ãƒ­ã‚»ã‚¹ç’°å¢ƒå¤‰æ•°ã®è¨­å®šæ–¹æ³•)

:::

#### 3.3. å®Ÿè¡Œä¾‹

##### åŸºæœ¬çš„ãªä½¿ã„æ–¹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: Google Geminiï¼‰

```powershell
Invoke-AI "PowerShellã§ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒƒã‚·ãƒ¥å€¤ã‚’å–å¾—ã™ã‚‹æ–¹æ³•ã¯ï¼Ÿ"
```

##### ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®åˆ‡ã‚Šæ›¿ãˆ

`-Provider` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã§ã€ä½¿ç”¨ã™ã‚‹AIã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚

```powershell
# æœ€æ–°æƒ…å ±ã‚’æ¤œç´¢ã§ãã‚‹Perplexityã‚’åˆ©ç”¨
Invoke-AI "ä»Šæ—¥ã®ITæ¥­ç•Œã®ãƒˆãƒƒãƒ—ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’3ã¤æ•™ãˆã¦" -Provider Perplexity

# OpenAIã®GPT-4oã‚’åˆ©ç”¨
Invoke-AI "ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã—ã¦" -Provider OpenAI -Model gpt-4o
```

##### ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’åˆ©ç”¨ã—ãŸå…¥åŠ›

```powershell
Get-Content .\error.log | Invoke-AI "ã“ã®ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®è¦ç‚¹ã‚’3ã¤ã«ã¾ã¨ã‚ã¦"
```

### 4. ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼è©³ç´°

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ | å¿…é ˆ | å‹ | èª¬æ˜ |
| :--- | :--- | :--- | :--- |
| **`Question`** | ã¯ã„ | `[string]` | AIã«é€ä¿¡ã™ã‚‹è³ªå•ã®æ–‡å­—åˆ—ã€‚ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‹ã‚‰ã®å…¥åŠ›ã‚‚å—ã‘ä»˜ã‘ã¾ã™ã€‚ |
| **`Provider`** | ã„ã„ãˆ | `[string]` | ä½¿ç”¨ã™ã‚‹LLMãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’é¸æŠã—ã¾ã™ã€‚<br>**æ—¢å®šå€¤:** `Google`<br>**é¸æŠè‚¢:** `Google`, `OpenAI`, `Perplexity`, `Anthropic` |
| **`Model`** | ã„ã„ãˆ | `[string]` | ä½¿ç”¨ã™ã‚‹å…·ä½“çš„ãªãƒ¢ãƒ‡ãƒ«åã‚’æŒ‡å®šã—ã¾ã™ã€‚çœç•¥ã—ãŸå ´åˆã€å„ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ‡ãƒ«ãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ |
| **`ApiKey`** | ã„ã„ãˆ | `[string]` | APIã‚­ãƒ¼ã‚’ç›´æ¥æŒ‡å®šã—ã¾ã™ã€‚çœç•¥ã—ãŸå ´åˆã€å¯¾å¿œã™ã‚‹ç’°å¢ƒå¤‰æ•°ã‹ã‚‰è‡ªå‹•ã§èª­ã¿è¾¼ã¾ã‚Œã¾ã™ã€‚ |

### 5. å„ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ‡ãƒ«

`-Model` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’çœç•¥ã—ãŸå ´åˆã€ä»¥ä¸‹ã®ãƒ¢ãƒ‡ãƒ«ãŒè‡ªå‹•çš„ã«é¸æŠã•ã‚Œã¾ã™ã€‚

| Provider | Default Model |
| :--- | :--- |
| Google | `gemini-1.5-flash-latest` |
| OpenAI | `gpt-4o` |
| Perplexity | `pplx-7b-online` |
| Anthropic | `claude-3-haiku-20240307` |

### 6. APIã‚­ãƒ¼å–å¾—å…ˆãƒªãƒ³ã‚¯

- **Google AI Studio:** [https://aistudio.google.com/app/apikey](https://aistudio.google.com/app/apikey)
- **OpenAI:** [https://platform.openai.com/api-keys](https://platform.openai.com/api-keys)
- **Perplexity AI:** [https://docs.perplexity.ai/](https://docs.perplexity.ai/)
- **Anthropic:** [https://console.anthropic.com/settings/keys](https://console.anthropic.com/settings/keys)

::::

## å‚è€ƒæ–‡çŒ®

https://aistudio.google.com/app/apikey
https://platform.openai.com/docs/overview?lang=curl
https://docs.perplexity.ai/getting-started/overview
https://docs.anthropic.com/en/api/overview