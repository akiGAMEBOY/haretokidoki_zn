---
title: "生成AI（テキスト型LLM）とAPI連携するPowerShell関数を作ってみた"
emoji: "🐙"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["powershell", "生成AI", "LLM", "API"]
published: false
---

### 完成したPowerShell関数 `Invoke-AI` (Google Gemini API デフォルト)

```powershell
function Invoke-AI {
<#
.SYNOPSIS
    主要なLLMプロバイダーのAPIに質問を送信し、回答を取得します。
.DESCRIPTION
    この関数は、Google(Gemini), OpenAI(GPT), Anthropic(Claude)のAPIと連携し、
    指定された質問に対する回答を返します。
    デフォルトでは、寛大な無料枠を持つGoogleのGemini 1.5 Flashモデルを使用します。
.PARAMETER Question
    AIに送信する質問の文字列。パイプラインからの入力も可能です。
.PARAMETER Provider
    使用するLLMプロバイダーを選択します。デフォルトは 'Google' です。
    ( 'Google', 'OpenAI', 'Anthropic' )
.PARAMETER Model
    使用する具体的なモデル名を指定します。指定しない場合は、各プロバイダーの
    コスト効率の良いデフォルトモデルが使用されます。
.PARAMETER ApiKey
    APIキーを直接指定します。指定しない場合は、環境変数から自動で読み込まれます。
    ( $env:GOOGLE_API_KEY, $env:OPENAI_API_KEY, $env:ANTHROPIC_API_KEY )
.EXAMPLE
    # 無料枠が使えるGoogle Geminiに質問する (デフォルト)
    Invoke-AI "PowerShellで現在時刻をISO 8601形式で取得する方法は？"

.EXAMPLE
    # OpenAIのGPT-4oを使って質問する
    Invoke-AI "この関数のリファクタリング案を提案して" -Provider OpenAI -Model gpt-4o

.EXAMPLE
    # AnthropicのClaude 3 Haikuを使い、パイプラインで質問を渡す
    "日本の祝日一覧をマークダウンで教えて" | Invoke-AI -Provider Anthropic

.LINK
    Google AI Studio API Keys: https://aistudio.google.com/app/apikey
    OpenAI API Keys: https://platform.openai.com/api-keys
    Anthropic API Keys: https://console.anthropic.com/settings/keys
#>
    [CmdletBinding()]
    param(
        [Parameter(Mandatory = $true, Position = 0, ValueFromPipeline = $true)]
        [string]$Question,

        [Parameter()]
        [ValidateSet('Google', 'OpenAI', 'Anthropic')]
        [string]$Provider = 'Google',

        [Parameter()]
        [string]$Model,

        [Parameter()]
        [string]$ApiKey
    )

    $providerInfo = @{
        Google = @{
            DefaultModel = "gemini-1.5-flash-latest"
            ApiKeyEnvVar = "GOOGLE_API_KEY"
        }
        OpenAI = @{
            DefaultModel = "gpt-3.5-turbo"
            ApiKeyEnvVar = "OPENAI_API_KEY"
        }
        Anthropic = @{
            DefaultModel = "claude-3-haiku-20240307"
            ApiKeyEnvVar = "ANTHROPIC_API_KEY"
        }
    }

    # モデルが指定されていなければ、プロバイダーのデフォルトモデルを使用
    if ([string]::IsNullOrEmpty($Model)) {
        $Model = $providerInfo[$Provider].DefaultModel
    }

    # APIキーが指定されていなければ、環境変数から取得
    if ([string]::IsNullOrEmpty($ApiKey)) {
        $apiKeyName = $providerInfo[$Provider].ApiKeyEnvVar
        $ApiKey = Get-Content "env:\$apiKeyName" -ErrorAction SilentlyContinue
    }

    if ([string]::IsNullOrEmpty($ApiKey)) {
        Write-Error "APIキーが設定されていません。-ApiKeyパラメータで指定するか、環境変数 $($providerInfo[$Provider].ApiKeyEnvVar) を設定してください。"
        return
    }

    Write-Host "🤖 $Provider ($Model) に問い合わせ中..." -ForegroundColor Gray

    $headers = @{}
    $apiUrl = ""
    $body = ""

    # プロバイダーごとにリクエストを組み立てる
    switch ($Provider) {
        "Google" {
            $apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/${Model}:generateContent?key=${ApiKey}"
            $headers = @{
                "Content-Type" = "application/json"
            }
            $body = @{
                contents = @(
                    @{
                        parts = @(
                            @{
                                text = $Question
                            }
                        )
                    }
                )
            } | ConvertTo-Json -Depth 5
        }
        "OpenAI" {
            $apiUrl = "https://api.openai.com/v1/chat/completions"
            $headers = @{
                "Authorization" = "Bearer $ApiKey"
                "Content-Type"  = "application/json"
            }
            $body = @{
                model    = $Model
                messages = @(
                    @{
                        role    = "user"
                        content = $Question
                    }
                )
            } | ConvertTo-Json
        }
        "Anthropic" {
            $apiUrl = "https://api.anthropic.com/v1/messages"
            $headers = @{
                "x-api-key"         = $ApiKey
                "anthropic-version" = "2023-06-01"
                "content-type"      = "application/json"
            }
            $body = @{
                model      = $Model
                max_tokens = 4096
                messages   = @(
                    @{
                        role    = "user"
                        content = $Question
                    }
                )
            } | ConvertTo-Json
        }
    }

    try {
        $response = Invoke-RestMethod -Uri $apiUrl -Method Post -Headers $headers -Body $body -ErrorAction Stop
        
        $aiAnswer = ""
        switch ($Provider) {
            "Google"    { $aiAnswer = $response.candidates[0].content.parts[0].text }
            "OpenAI"    { $aiAnswer = $response.choices[0].message.content }
            "Anthropic" { $aiAnswer = $response.content[0].text }
        }
        return $aiAnswer.Trim()
    }
    catch {
        $errorDetail = $_.Exception.Response.GetResponseStream()
        $reader = New-Object System.IO.StreamReader($errorDetail)
        $errorText = $reader.ReadToEnd()
        Write-Error "APIリクエストでエラーが発生しました。詳細: $errorText"
        return $null
    }
}
```

### この関数の使い方

#### 1. 事前準備：GoogleのAPIキーを設定

[Google AI Studio](https://aistudio.google.com/app/apikey)でAPIキーを取得し、PowerShellターミナルで環境変数に設定します。

```powershell
$env:GOOGLE_API_KEY = "AIzaSyxxxxxxxxxxxxxxxxxxxxxxxxxxx" # ← あなたのAPIキーに置き換えてください
```
*(他のサービスを使いたい場合は、それぞれのキーを設定してください: `$env:OPENAI_API_KEY`, `$env:ANTHROPIC_API_KEY`)*

#### 2. 関数の読み込み

上記のコードを `Invoke-AI.ps1` のような名前で保存し、` . .\Invoke-AI.ps1 ` コマンドで読み込みます。
（PowerShellのプロファイル `$PROFILE` に保存すると、いつでも使えて便利です。）

#### 3. 関数の実行例

**デフォルト（Google Gemini）で実行**
パラメータを何も指定しない場合、自動的にGoogle Gemini APIが使われます。
```powershell
Invoke-AI "現在地の天気と気温を教えて"
```

**パイプラインで実行（こちらもデフォルトでGeminiが使われます）**
```powershell
"この文章を要約してください：(ここに長い文章)..." | Invoke-AI
```

**別のプロバイダーを使いたい場合**
`-Provider` パラメータを指定すれば、いつでも他のサービスに切り替えられます。
```powershell
# OpenAIに切り替え
Invoke-AI "Pythonで簡単なWebサーバーを立てるコードを書いて" -Provider OpenAI

# Anthropicに切り替え
Invoke-AI "この英文を自然な日本語に翻訳して：(英文)..." -Provider Anthropic
```

これで、普段使いは無料枠の広いGoogle Gemini APIを活用しつつ、必要に応じて他の高性能なモデルにも簡単にアクセスできる、非常に実用的なAI関数が完成しました。
