---
title: "テキスト型LLMとAPI連携するPowerShell関数を作ってみた"
emoji: "👩‍💻"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["powershell", "生成AI", "LLM", "API"]
published: false
---

```powershell
function Invoke-AI {
<#
.SYNOPSIS
    主要なLLMプロバイダーのAPIに質問を送信し、回答を取得します。
.DESCRIPTION
    Google, OpenAI, Perplexity, AnthropicのAPIと連携し、指定された質問に対する回答を返します。
    デフォルトモデルは、コストを最小限に抑えるように設定されています。
#>
    [CmdletBinding()]
    [OutputType([string])]
    param(
        [Parameter(Mandatory = $true, Position = 0, ValueFromPipeline = $true)]
        [string]$Question,

        [Parameter()]
        [ValidateSet('Google', 'OpenAI', 'Perplexity', 'Anthropic')]
        [string]$Provider = 'Google',

        [Parameter()]
        [string]$Model,

        [Parameter()]
        [string]$ApiKey
    )

    # ---------------------------------------------------------------
    # プロバイダーごとの設定とAPI呼び出しロジックを定義
    # ---------------------------------------------------------------
    $providers = @{
        Google = [PSCustomObject]@{
            DefaultModel = "gemini-1.5-flash-latest"
            ApiKeyEnvVar = "GOOGLE_API_KEY"
            BuildRequest = {
                param($ApiKey, $Model, $Question)
                $apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/${Model}:generateContent"
                $headers = @{ "Content-Type" = "application/json"; "x-goog-api-key" = $ApiKey }
                $body = @{ contents = @( @{ parts = @( @{ text = $Question } ) } ) } | ConvertTo-Json -Depth 5
                return @{ Uri = $apiUrl; Method = 'Post'; Headers = $headers; Body = $body }
            }
            ParseResponse = { param($Response) $Response.candidates[0].content.parts[0].text }
        }
        OpenAI = [PSCustomObject]@{
            DefaultModel = "gpt-3.5-turbo"
            ApiKeyEnvVar = "OPENAI_API_KEY"
            BuildRequest = {
                param($ApiKey, $Model, $Question)
                $apiUrl = "https://api.openai.com/v1/chat/completions"
                $headers = @{ "Authorization" = "Bearer $ApiKey"; "Content-Type" = "application/json" }
                $body = @{ model = $Model; messages = @(@{ role = "user"; content = $Question }) } | ConvertTo-Json
                return @{ Uri = $apiUrl; Method = 'Post'; Headers = $headers; Body = $body }
            }
            ParseResponse = { param($Response) $Response.choices[0].message.content }
        }
        Perplexity = [PSCustomObject]@{
            DefaultModel = "pplx-7b-online"
            ApiKeyEnvVar = "PERPLEXITY_API_KEY"
            BuildRequest = {
                param($ApiKey, $Model, $Question)
                $apiUrl = "https://api.perplexity.ai/chat/completions"
                $headers = @{ "Authorization" = "Bearer $ApiKey"; "Content-Type" = "application/json" }
                $body = @{ model = $Model; messages = @(@{ role = "user"; content = $Question }) } | ConvertTo-Json
                return @{ Uri = $apiUrl; Method = 'Post'; Headers = $headers; Body = $body }
            }
            ParseResponse = { param($Response) $Response.choices[0].message.content }
        }
        Anthropic = [PSCustomObject]@{
            DefaultModel = "claude-3-haiku-20240307"
            ApiKeyEnvVar = "ANTHROPIC_API_KEY"
            ApiVersion   = "2023-06-01"
            BuildRequest = {
                param($ApiKey, $Model, $Question, $ApiVersion)
                $apiUrl = "https://api.anthropic.com/v1/messages"
                $headers = @{ "x-api-key" = $ApiKey; "anthropic-version" = $ApiVersion; "content-type" = "application/json" }
                $body = @{ model = $Model; max_tokens = 4096; messages = @(@{ role = "user"; content = $Question }) } | ConvertTo-Json
                return @{ Uri = $apiUrl; Method = 'Post'; Headers = $headers; Body = $body }
            }
            ParseResponse = { param($Response) $Response.content[0].text }
        }
    }

    if (-not $providers.ContainsKey($Provider)) { Write-Error "..."; return }
    $selectedProvider = $providers[$Provider]
    if ([string]::IsNullOrEmpty($Model)) {
        $Model = $selectedProvider.DefaultModel
    }
    if ([string]::IsNullOrEmpty($ApiKey)) {
        $apiKeyName = $selectedProvider.ApiKeyEnvVar
        $ApiKey = Get-Content "env:\$apiKeyName" -ErrorAction SilentlyContinue
    }
    if ([string]::IsNullOrEmpty($ApiKey)) {
        $apiKeyEnvVarName = $selectedProvider.ApiKeyEnvVar
        Write-Error "APIキーが設定されていません。-ApiKeyパラメータで指定するか、環境変数 `$env:$apiKeyEnvVarName` を設定してください。"
        return
    }
    Write-Host "🤖 $Provider ($Model) に問い合わせ中..." -ForegroundColor Gray
    try {
        $requestParams = @{ ApiKey = $ApiKey; Model = $Model; Question = $Question }
        if ($selectedProvider.PSObject.Properties.Name -contains 'ApiVersion') {
            $requestParams.ApiVersion = $selectedProvider.ApiVersion
        }
        $requestSplat = & $selectedProvider.BuildRequest @requestParams
        $response = Invoke-RestMethod @requestSplat -TimeoutSec 60 -ErrorAction Stop
        $aiAnswer = & $selectedProvider.ParseResponse -Response $response
        return $aiAnswer.Trim()
    }
    catch {
        $errorDetail = $_.Exception.Response.GetResponseStream()
        $reader = New-Object System.IO.StreamReader($errorDetail)
        $errorText = $reader.ReadToEnd()
        Write-Error "APIリクエストでエラーが発生しました。詳細: $errorText"
        return $null
    }
}
```

## 仕様

::::details PowerShell関数「Invoke-AI」の仕様

### 1. 概要

`Invoke-AI` は、主要なLLM（大規模言語モデル）プロバイダーのAPIと連携し、PowerShell上で対話的にAIからの回答を取得するための多機能な関数です。

デフォルトでは、寛大な無料枠を持つGoogleのGemini APIを利用しますが、パラメータを指定することでOpenAI, Perplexity, AnthropicのAPIにも簡単に切り替えることが可能です。

### 2. 機能

- **マルチプロバイダー対応:** 4つの主要なLLMプロバイダーをサポート。
  - Google (Gemini) - **デフォルト**
  - OpenAI (GPT)
  - Perplexity
  - Anthropic (Claude)
- **シンプルなインターフェース:** `Invoke-AI "質問内容"` のように、コマンド一つで簡単にAIを呼び出せます。
- **パイプライン入力対応:** `Get-Content file.txt | Invoke-AI` のように、他のコマンドの出力を直接AIに渡すことができます。
- **柔軟なモデル選択:** 各プロバイダーが提供する様々なモデル（高性能モデル、高速モデルなど）をパラメータで指定可能です。
- **自動APIキー検出:** PowerShellの環境変数からAPIキーを自動で読み込みます。

### 3. 使い方

#### 3.1. 事前準備：APIキーの設定

利用したいプロバイダーのAPIキーを取得し、対応する環境変数に設定します。この設定はPowerShellセッションごとに必要です。（恒久的に設定するにはプロファイルに記述します）

```powershell
# Google Gemini (デフォルト)
$env:GOOGLE_API_KEY = "AIzaSy..."

# OpenAI
$env:OPENAI_API_KEY = "sk-..."

# Perplexity
$env:PERPLEXITY_API_KEY = "ppl-..."

# Anthropic
$env:ANTHROPIC_API_KEY = "sk-ant-..."
```

#### 3.2. 関数の読み込み

関数が記述された `.ps1` ファイルを、カレントセッションに読み込みます。

```powershell
. .\Invoke-AI.ps1
```

:::details ヒント: この関数をPowerShellのプロファイル（`$PROFILE`）に記述すると、いつでも利用可能に

自作したFunctionをあらかじめPowerShellのプロファイルに登録することで、簡単に自作Functionを呼び出せるようになります。

プロファイルの登録方法については、[こちら](https://zenn.dev/haretokidoki/articles/e2a6c521035d94#参考情報：powershellのプロファイルを使ったプロセス環境変数の設定方法)の記事内に「参考情報：powershellのプロファイルを使ったプロセス環境変数の設定方法」として紹介しています。

必要に応じて、今回の紹介している自作Functionを登録（定義）してください。

@[card](https://zenn.dev/haretokidoki/articles/e2a6c521035d94#参考情報：powershellのプロファイルを使ったプロセス環境変数の設定方法)

:::

#### 3.3. 実行例

##### 基本的な使い方（デフォルト: Google Gemini）

```powershell
Invoke-AI "PowerShellでファイルのハッシュ値を取得する方法は？"
```

##### プロバイダーの切り替え

`-Provider` パラメーターで、使用するAIを切り替えます。

```powershell
# 最新情報を検索できるPerplexityを利用
Invoke-AI "今日のIT業界のトップニュースを3つ教えて" -Provider Perplexity

# OpenAIのGPT-4oを利用
Invoke-AI "このスクリプトをリファクタリングして" -Provider OpenAI -Model gpt-4o
```

##### パイプラインを利用した入力

```powershell
Get-Content .\error.log | Invoke-AI "このエラーログの要点を3つにまとめて"
```

### 4. パラメーター詳細

| パラメーター | 必須 | 型 | 説明 |
| :--- | :--- | :--- | :--- |
| **`Question`** | はい | `[string]` | AIに送信する質問の文字列。パイプラインからの入力も受け付けます。 |
| **`Provider`** | いいえ | `[string]` | 使用するLLMプロバイダーを選択します。<br>**既定値:** `Google`<br>**選択肢:** `Google`, `OpenAI`, `Perplexity`, `Anthropic` |
| **`Model`** | いいえ | `[string]` | 使用する具体的なモデル名を指定します。省略した場合、各プロバイダーのデフォルトモデルが使用されます。 |
| **`ApiKey`** | いいえ | `[string]` | APIキーを直接指定します。省略した場合、対応する環境変数から自動で読み込まれます。 |

### 5. 各プロバイダーのデフォルトモデル

`-Model` パラメーターを省略した場合、以下のモデルが自動的に選択されます。

| Provider | Default Model |
| :--- | :--- |
| Google | `gemini-1.5-flash-latest` |
| OpenAI | `gpt-4o` |
| Perplexity | `pplx-7b-online` |
| Anthropic | `claude-3-haiku-20240307` |

### 6. APIキー取得先リンク

- **Google AI Studio:** [https://aistudio.google.com/app/apikey](https://aistudio.google.com/app/apikey)
- **OpenAI:** [https://platform.openai.com/api-keys](https://platform.openai.com/api-keys)
- **Perplexity AI:** [https://docs.perplexity.ai/](https://docs.perplexity.ai/)
- **Anthropic:** [https://console.anthropic.com/settings/keys](https://console.anthropic.com/settings/keys)

::::

## 参考文献

https://aistudio.google.com/app/apikey
https://platform.openai.com/docs/overview?lang=curl
https://docs.perplexity.ai/getting-started/overview
https://docs.anthropic.com/en/api/overview