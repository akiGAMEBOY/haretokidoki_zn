---
title: "[PowerShell]複数のサーバーに対し指定したポートで疎通確認する方法"
emoji: "🤖"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["powershell"]
published: false
---

```powershell:PowerShellバージョン
PS C:\Users\"ユーザー名"> $PSVersionTable

Name                           Value
----                           -----
PSVersion                      7.3.10
PSEdition                      Core
GitCommitId                    7.3.10
OS                             Microsoft Windows 10.0.19045
Platform                       Win32NT
PSCompatibleVersions           {1.0, 2.0, 3.0, 4.0…}
PSRemotingProtocolVersion      2.3
SerializationVersion           1.1.0.1
WSManStackVersion              3.0

PS C:\Users\"ユーザー名">
```

```powershell:自身のパソコンに対しポート「8080」で疎通確認
PS C:\Users\"ユーザー名"> Test-NetConnection localhost -port 8080
WARNING: TCP connect to (::1 : 8080) failed
WARNING: TCP connect to (127.0.0.1 : 8080) failed

ComputerName           : localhost
RemoteAddress          : ::1
RemotePort             : 8080
InterfaceAlias         : Loopback Pseudo-Interface 1
SourceAddress          : ::1
PingSucceeded          : True
PingReplyDetails (RTT) : 0 ms
TcpTestSucceeded       : False


PS C:\Users\"ユーザー名">
```

```powershell:自身のパソコンに対しポート「8000」で疎通確認
PS C:\Users\"ユーザー名"> Test-NetConnection localhost -port 8000

ComputerName     : localhost
RemoteAddress    : ::1
RemotePort       : 8000
InterfaceAlias   : Loopback Pseudo-Interface 1
SourceAddress    : ::1
TcpTestSucceeded : True


PS C:\Users\"ユーザー名"> 
```

```powershell:google.comに対しポート「443（HTTPS）」で疎通確認
PS C:\Users\"ユーザー名"> Test-NetConnection google.com -port 443

ComputerName     : google.com
RemoteAddress    : 142.250.206.206
RemotePort       : 443
InterfaceAlias   : イーサネット
SourceAddress    : 192.168.XXX.XXX
TcpTestSucceeded : True


PS C:\Users\"ユーザー名">
```

```powershell:smtp.google.comに対しポート「25（SMTP）」で疎通確認
PS C:\Users\"ユーザー名"> Test-NetConnection smtp.gmail.com -port 25

ComputerName     : smtp.gmail.com
RemoteAddress    : 64.233.187.109
RemotePort       : 25
InterfaceAlias   : イーサネット
SourceAddress    : 192.168.XXX.XXX
TcpTestSucceeded : True


PS C:\Users\"ユーザー名">  
```

たとえば、ホスト名 と ポート番号 のデータが格納されている2次元配列を繰り返し実行して、
ポートの疎通確認を行う場合、

```powershell:PowerShell CLI でポートの疎通確認する方法
$port_check_lists = @(
    @('localhost','8080'),
    @('localhost','8000'),
    @('google.com','443'),
    @('smtp.google.com','25')
)

for($i = 0; $i -lt $port_check_lists.Count; $i++) {
    $target_row = $port_check_lists[$i]

    Test-NetConnection $target_row[0] -Port $target_row[1]
}
```

```powershell:PowerShell CLI でポートの疎通確認する方法
# Function 定義
Function CheckPortMultipleServers {
    param (
        [System.String[,]]$port_check_lists
    )

    for($i = 0; $i -lt $port_check_lists.Count; $i++) {
        Write-Host "[`$i,0]: $($port_check_lists[$i,0]), [`$i,1]: $($port_check_lists[$i,1])"
        Test-NetConnection $port_check_lists[$i,0] -Port $port_check_lists[$i,1]    
    }
}

# Function 実行
# この渡し方だとFunctionに引き渡した後、2次元配列として処理されなかった。
# $server_lists = @(
#     @('localhost','8080'),
#     @('localhost','8000'),
#     @('google.com','443'),
#     @('smtp.google.com','25')
# )
$server_lists = New-Object "System.String[,]" 4,2
$server_lists[0,0] = 'localhost'
$server_lists[0,1] = '8080'
$server_lists[1,0] = 'localhost'
$server_lists[1,1] = '8000'
$server_lists[2,0] = 'google.com'
$server_lists[2,1] = '443'
$server_lists[3,0] = 'smtp.google.com'
$server_lists[3,1] = '25'
CheckPortMultipleServers $server_lists
```

## 参考記事

### PowerShellのFunctionにおいて2次元配列を引数で渡す場合

https://qiita.com/Mount/items/d10ff1eb41617f4b8368
