---
title: "[PowerShell]è¤‡æ•°ã®ã‚µãƒ¼ãƒãƒ¼ã«å¯¾ã—æŒ‡å®šã—ãŸãƒãƒ¼ãƒˆã§ç–é€šç¢ºèªã™ã‚‹æ–¹æ³•"
emoji: "ğŸ›£"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["powershell", "port"]
published: true
---
## æ¦‚è¦

ç›£è¦–å¯¾è±¡ã¨ãªã£ã¦ã„ãªã„ç¤¾å†…ã‚µãƒ¼ãƒãƒ¼ã«å¯¾ã—ã€ä»»æ„ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãƒãƒ¼ãƒˆã®ç–é€šç¢ºèªã‚’è¡Œã„ãŸãã€
PowerShellã§å®Ÿç¾å¯èƒ½ãªæ–¹æ³•ã‚’èª¿ã¹ã¾ã—ãŸã€‚

## ã“ã®è¨˜äº‹ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ

- PowerShellãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ–¹
- PowerShellã§ãƒãƒ¼ãƒˆã®ç–é€šç¢ºèªã‚’è¡Œã„ãŸã„æ–¹
- ã•ã‚‰ã«è¤‡æ•°ã®ã‚µãƒ¼ãƒãƒ¼ã«å¯¾ã—ã¦ãƒãƒ¼ãƒˆã®ç–é€šç¢ºèªã‚’è¡Œã„ãŸã„æ–¹

## ç’°å¢ƒ

### OSã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³

Windows 10 Proç’°å¢ƒ

```powershell:Get-WmiObjectã‚³ãƒãƒ³ãƒ‰
PS C:\Users\"ãƒ¦ãƒ¼ã‚¶ãƒ¼å"> Get-CimInstance CIM_OperatingSystem

SystemDirectory     Organization BuildNumber RegisteredUser SerialNumber            Version
---------------     ------------ ----------- -------------- ------------            -------
C:\WINDOWS\system32              19045       XXXXX          00000-00000-00000-AAAAA 10.0.19045
                                             ^^^^^          ^^^^^ ^^^^^ ^^^^^ ^^^^^
                                             â†‘ãƒã‚¹ã‚¯       â†‘ãƒã‚¹ã‚¯

PS C:\Users\"ãƒ¦ãƒ¼ã‚¶ãƒ¼å">
```

- å‚è€ƒè¨˜äº‹ï¼šPowerShell Core ã§ã¯Get-WmiObjectã‹ã‚‰Get-CimInstanceã«å¤‰æ›´
    https://www.vwnet.jp/windows/PowerShell/2021061301/PowerShellCore6xWMI.htm

- å‚è€ƒè¨˜äº‹ï¼šWin32_OperatingSystem ã‚¯ãƒ©ã‚¹ã¯ CIM_OperatingSystem ã«å¤‰æ›´
    https://learn.microsoft.com/ja-jp/windows/win32/cimwin32prov/cim-operatingsystem

### PowerShellã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³

```powershell:PowerShellã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³
PS C:\Users\"ãƒ¦ãƒ¼ã‚¶ãƒ¼å"> $PSVersionTable

Name                           Value
----                           -----
PSVersion                      7.3.10
PSEdition                      Core
GitCommitId                    7.3.10
OS                             Microsoft Windows 10.0.19045
Platform                       Win32NT
PSCompatibleVersions           {1.0, 2.0, 3.0, 4.0â€¦}
PSRemotingProtocolVersion      2.3
SerializationVersion           1.1.0.1
WSManStackVersion              3.0

PS C:\Users\"ãƒ¦ãƒ¼ã‚¶ãƒ¼å">
```

## å¯¾å¿œæ–¹æ³•

**ã‚³ãƒãƒ³ãƒ‰ï¼ˆPowerShell CLIï¼‰ã§å®Ÿè¡Œ** ã¨ **Functionã‚’ä½¿ã£ã¦å®Ÿè¡Œ** ã¨ã„ã†ä»£è¡¨çš„ãª2ã¤ã®æ–¹æ³•ã‚’ç´¹ä»‹ã€‚

**ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ã—ã¦å®šç¾©ã—å®Ÿè¡Œã™ã‚‹æ–¹æ³•** ãŒçŸ¥ã‚ŠãŸã„æ–¹ã¯ã€[ã“ã¡ã‚‰ã®è¨˜äº‹](https://zenn.dev/haretokidoki/articles/84aea5bddf2dd6)ã‚’å‚ç…§ã€‚
https://zenn.dev/haretokidoki/articles/84aea5bddf2dd6

### ãƒãƒ¼ãƒˆã®ç–é€šç¢ºèªãŒã§ãã‚‹ã‚³ãƒãƒ³ãƒ‰ãƒ¬ãƒƒãƒˆ

ã‚³ãƒãƒ³ãƒ‰ãƒ¬ãƒƒãƒˆã€Œ`Test-NetConnection`ã€ã‚’ä½¿ã†äº‹ã§å®Ÿç¾å¯èƒ½ã§ã™ã€‚

```powershell:ã‚³ãƒ”ãƒ¼ç”¨
Test-NetConnection "å¯¾è±¡ã‚µãƒ¼ãƒãƒ¼ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆã¾ãŸã¯ãƒ›ã‚¹ãƒˆåï¼‰" -Port "ç¢ºèªã—ãŸã„ãƒãƒ¼ãƒˆç•ªå·"
```

```powershell:google.comã«å¯¾ã—ãƒãƒ¼ãƒˆã€Œ443ï¼ˆHTTPSï¼‰ã€ã§ç–é€šç¢ºèª
PS C:\Users\"ãƒ¦ãƒ¼ã‚¶ãƒ¼å"> Test-NetConnection google.com -Port 443

ComputerName     : google.com
RemoteAddress    : 142.250.206.206
RemotePort       : 443
InterfaceAlias   : ã‚¤ãƒ¼ã‚µãƒãƒƒãƒˆ
SourceAddress    : 192.168.XXX.XXX
TcpTestSucceeded : True


PS C:\Users\"ãƒ¦ãƒ¼ã‚¶ãƒ¼å">
```

### è¤‡æ•°ã®ã‚µãƒ¼ãƒãƒ¼ã«å¯¾ã—ã¦ãƒãƒ¼ãƒˆç–é€šç¢ºèªãŒå®Ÿç¾ã§ãã‚‹æ–¹æ³•

#### ã‚³ãƒãƒ³ãƒ‰ï¼ˆPowerShell CLIï¼‰ã§å®Ÿè¡Œ

IPã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆã¾ãŸã¯ãƒ›ã‚¹ãƒˆåï¼‰ ã¨ ãƒãƒ¼ãƒˆç•ªå· ãŒã‚»ãƒƒãƒˆã«ãªã£ã¦ã„ã‚‹2æ¬¡å…ƒé…åˆ—ã‚’ç¹°ã‚Šè¿”ã—å®Ÿè¡Œã™ã‚‹äº‹ã§ã€
è¤‡æ•°ã®ã‚µãƒ¼ãƒãƒ¼ã«å¯¾ã—ã¦ç–é€šç¢ºèªãŒå¯èƒ½ã¨ãªã‚‹ã€‚

```powershell:ã‚³ãƒ”ãƒ¼ç”¨
$port_check_lists = @(
    @('localhost','8080'),
    @('localhost','8000'),
    @('google.com','443'),
    @('smtp.google.com','25')
)

for($i = 0; $i -lt $port_check_lists.Count; $i++) {
    $target_row = $port_check_lists[$i]

    Test-NetConnection $target_row[0] -Port $target_row[1]
}
```

Test-NetConnectionã‚³ãƒãƒ³ãƒ‰ãƒ¬ãƒƒãƒˆã§ã¯ã€ã€Œ`TcpTestSucceeded` ãŒ `True`ã€ã ã¨æ­£å¸¸çµ‚äº†ã§ã€
ç•°å¸¸çµ‚äº†ã ã¨ã€Œ`TcpTestSucceeded` ãŒ `False`ã€ã¨ãªã‚Šã¾ã™ã€‚

```powershell:å®Ÿè¡Œçµæœ
PS C:\Users\"ãƒ¦ãƒ¼ã‚¶ãƒ¼å"> $port_check_lists = @(
>>     @('localhost','8080'),
>>     @('localhost','8000'),
>>     @('google.com','443'),
>>     @('smtp.google.com','25')
>> )
>>
>> for($i = 0; $i -lt $port_check_lists.Count; $i++) {
>>     $target_row = $port_check_lists[$i]
>>
>>     Test-NetConnection $target_row[0] -Port $target_row[1]
>> }
WARNING: TCP connect to (::1 : 8080) failed
WARNING: TCP connect to (127.0.0.1 : 8080) failed

ComputerName           : localhost
RemoteAddress          : ::1
RemotePort             : 8080
InterfaceAlias         : Loopback Pseudo-Interface 1
SourceAddress          : ::1
PingSucceeded          : True
PingReplyDetails (RTT) : 0 ms
TcpTestSucceeded       : False

ComputerName     : localhost
RemoteAddress    : ::1
RemotePort       : 8000
InterfaceAlias   : Loopback Pseudo-Interface 1
SourceAddress    : ::1
TcpTestSucceeded : True

ComputerName     : google.com
RemoteAddress    : 142.250.206.206
RemotePort       : 443
InterfaceAlias   : ã‚¤ãƒ¼ã‚µãƒãƒƒãƒˆ
SourceAddress    : 192.168.XXX.XXX
TcpTestSucceeded : True

ComputerName     : smtp.google.com
RemoteAddress    : 64.233.188.26
RemotePort       : 25
InterfaceAlias   : ã‚¤ãƒ¼ã‚µãƒãƒƒãƒˆ
SourceAddress    : 192.168.XXX.XXX
TcpTestSucceeded : True


PS C:\Users\"ãƒ¦ãƒ¼ã‚¶ãƒ¼å">  
```

#### Functionã‚’ä½¿ã£ã¦å®Ÿè¡Œ

ã‚¸ãƒ£ã‚°é…åˆ— ã‚„ å¤šæ¬¡å…ƒé…åˆ—ï¼ˆãƒªãƒ†ãƒ©ãƒ«é…åˆ—ï¼‰ã«ã¤ã„ã¦ã¯ã€[ã“ã¡ã‚‰ã®è¨˜äº‹](https://zenn.dev/haretokidoki/articles/f79a5bb769973f)ã§ç´¹ä»‹ã€‚

https://zenn.dev/haretokidoki/articles/f79a5bb769973f

```powershell:ã‚¸ãƒ£ã‚°é…åˆ—ã€Œ @() ã€ã§å®£è¨€ã—ãŸå¤‰æ•°ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ
# Function å®šç¾©
Function CheckPortMultipleServers {
    Param (
        [System.String[][]]$port_check_lists
    )

    for($i = 0; $i -lt $port_check_lists.Length; $i++) {
	    $target_row = $port_check_lists[$i]
	    Test-NetConnection $target_row[0] -Port $target_row[1]
	}
}

# Function å®Ÿè¡Œ
[System.String[][]]$server_lists = @(
    @('localhost','8080'),
    @('localhost','8000'),
    @('google.com','443'),
    @('smtp.google.com','25')
)
CheckPortMultipleServers $server_lists
```

```powershell:å¤šæ¬¡å…ƒé…åˆ—ã€Œ [,] ã€ã§å®£è¨€ã—ãŸå¤‰æ•°ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ
# Function å®šç¾©
Function CheckPortMultipleServers {
    Param (
        [System.String[,]]$port_check_lists
    )

    for($i = 0; $i -lt $port_check_lists[0,1].Length; $i++) {
        Test-NetConnection $port_check_lists[$i,0] -Port $port_check_lists[$i,1]
    }
}

# Function å®Ÿè¡Œ
$server_lists = New-Object "System.String[,]" 4,2
$server_lists[0,0] = 'localhost'
$server_lists[0,1] = '8080'
$server_lists[1,0] = 'localhost'
$server_lists[1,1] = '8000'
$server_lists[2,0] = 'google.com'
$server_lists[2,1] = '443'
$server_lists[3,0] = 'smtp.google.com'
$server_lists[3,1] = '25'
CheckPortMultipleServers $server_lists
```

## å‚è€ƒè¨˜äº‹

- Microsoftå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼šTest-NetConnection
    <https://learn.microsoft.com/en-us/powershell/module/nettcpip/test-netconnection>

- PowerShellã®Functionã«ãŠã„ã¦2æ¬¡å…ƒé…åˆ—ã‚’å¼•æ•°ã§æ¸¡ã™å ´åˆ
    <https://qiita.com/Mount/items/d10ff1eb41617f4b8368>

- Microsoftå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼šé…åˆ—ã«ã¤ã„ã¦
    <https://learn.microsoft.com/ja-jp/powershell/module/microsoft.powershell.core/about/about_arrays>

## ã¾ã¨ã‚

- ãƒãƒ¼ãƒˆã®ç–é€šç¢ºèªãŒã§ãã‚‹ã‚³ãƒãƒ³ãƒ‰ãƒ¬ãƒƒãƒˆ
    `Test-NetConnection "å¯¾è±¡ã‚µãƒ¼ãƒãƒ¼ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆã¾ãŸã¯ãƒ›ã‚¹ãƒˆåï¼‰" -Port "ç¢ºèªã—ãŸã„ãƒãƒ¼ãƒˆç•ªå·"`ã«ã‚ˆã‚Šå®Ÿç¾
- è¤‡æ•°ã®ã‚µãƒ¼ãƒãƒ¼ã«å¯¾ã—ã¦ãƒãƒ¼ãƒˆç–é€šç¢ºèªãŒå®Ÿç¾ã§ãã‚‹æ–¹æ³•
    1. ç–é€šç¢ºèªãƒªã‚¹ãƒˆã‚’2æ¬¡å…ƒé…åˆ—ã§ä½œæˆ
        IPã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆã¾ãŸã¯ãƒ›ã‚¹ãƒˆåï¼‰ ã¨ ãƒãƒ¼ãƒˆç•ªå· ãŒã‚»ãƒƒãƒˆã«ãªã£ãŸé…åˆ—ã€‚
    2. foræ–‡ã§æ–‡å­—åˆ—é…åˆ—ã‚’ç¹°ã‚Šè¿”ã—å€‹ã€…ã«Test-NetConnectionã‚’å®Ÿè¡Œ
        Functionã§å—ã‘å–ã£ãŸé…åˆ—ã®ç¨®é¡ï¼ˆã‚¸ãƒ£ã‚°é…åˆ—ã€ã¾ãŸã¯ãƒªãƒ†ãƒ©ãƒ«é…åˆ—ï¼‰ã«ã‚ˆã‚Šé‹ç”¨æ–¹æ³•ã«å·®ç•°ãŒã‚ã‚‹ã®ã§æ³¨æ„ï¼

## é–¢é€£è¨˜äº‹

https://zenn.dev/haretokidoki/articles/31ad6dfc204e38
https://haretokidoki-blog.com/pasocon_powershell-startup/
https://zenn.dev/haretokidoki/articles/7e6924ff0cc960
