---
title: ""
emoji: "🙆"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---

Alt + 数字4桁

C#

https://zenn.dev/midoliy/articles/9e3cff958ff89ba151de

:::details 

::: details Pythonでもうまくいかなかった

```python
from ctypes.wintypes import HWND
from pynput import keyboard
import subprocess
import time
import win32gui
import win32con
import pyautogui
import ctypes
import platform

# 検索するウィンドウの名前（部分一致）
# exefile = sys.argv[1]
# title = sys.argv[2]
# presskey = sys.argv[3]
exefile = "notepad.exe"
title = "メモ帳"
keynum = 1

dict = {}
found_apps = []


# 実行ファイルの起動
process = subprocess.Popen(exefile)
time.sleep(0.1)


def get_window_titles():
    def set_windowdata(hwnd, ctx):
        if win32gui.IsWindowVisible(hwnd):
            dict[win32gui.GetWindowText(hwnd)] = hex(hwnd)
    win32gui.EnumWindows(set_windowdata, None)


get_window_titles()

for item in dict.keys():
    if title not in item:
        pass
    else:
        found_apps.append(item)

if len(found_apps) != 0:
    # 検索したウィンドウを開きます
    hwnd: HWND = win32gui.FindWindow(None, found_apps[0])  # windowのハンドルを取得

    # 最小化していた場合、ステータスを変えます
    if win32gui.IsIconic(hwnd):
        win32gui.ShowWindow(hwnd, 1)  # SW_SHOWNORMAL
    else:
        win32gui.SetWindowPos(hwnd, win32con.HWND_TOPMOST, 0, 0, 0, 0,
                              win32con.SWP_NOMOVE | win32con.SWP_NOSIZE)
    time.sleep(1)

    # このままじゃウィンドウは表示されるけどアクティブになっていないので、pysutoguiでクリックしてアクティブにする（力業）
    (left, top, right, bottom) = win32gui.GetWindowRect(hwnd)
    pyautogui.moveTo(left+60, top + 10)
    pyautogui.click()

    # 自動化処理　ご自由にどうぞ
    # 今回はメモ帳にHiと書いてみます
    # pyautogui.keyDown("alt")
    # time.sleep(0.1)
    # pyautogui.press("0")
    # pyautogui.press("1")
    # pyautogui.press("8")
    # pyautogui.press("2")
    # pyautogui.typewrite("0182")
    # pyautogui.keyDown("0")
    # pyautogui.keyUp("0")
    # pyautogui.keyDown("1")
    # pyautogui.keyUp("1")
    # pyautogui.keyDown("8")
    # pyautogui.keyUp("8")
    # pyautogui.keyDown("2")
    # pyautogui.keyUp("2")
    # pyautogui.hotkey("alt", "0", "1", "8", "2")
    # pyautogui.keyDown("alt", "0", "1", "8", "2")
    # pyautogui.keyUp("alt", "0", "1", "8", "2")
    # pyautogui.keyDown("0")
    # time.sleep(1)
    # pyautogui.keyUp("0")
    # time.sleep(0.1)
    # # pyautogui.keyUp("alt")
    # pyautogui.press("return")

    def ime_on(event):
        pf = platform.system()
        if pf == "Windows":
            user32 = ctypes.WinDLL(name="user32")
            imm32 = ctypes.WinDLL(name="imm32")
            h_wnd = user32.GetForegroundWindow()
            h_imc = imm32.ImmGetContext(h_wnd)
            imm32.ImmSetOpenStatus(h_imc, True)
            imm32.ImmReleaseContext(h_wnd, h_imc)

        elif pf == "Darwin":
            applescript = r'tell application "System Events" to keystroke (key code {104})'
            subprocess.run(["osascript", "-e", applescript])

        elif pf == "Linux":
            try:
                subprocess.run(["ibus", "engine", "mozc-jp"])  # ibusの場合
                subprocess.run(["fcitx-remote", "-o"])  # fcitxの場合
                subprocess.run(["echo", "1", ">", "$UIM_FEP_SETMODE"])  # uimの場合(合っているのか不明)
            except FileNotFoundError:
                pass

    def ime_off(event):
        pf = platform.system()
        if pf == "Windows":
            user32 = ctypes.WinDLL(name="user32")
            imm32 = ctypes.WinDLL(name="imm32")
            h_wnd = user32.GetForegroundWindow()
            h_imc = imm32.ImmGetContext(h_wnd)
            imm32.ImmSetOpenStatus(h_imc, False)
            imm32.ImmReleaseContext(h_wnd, h_imc)

        elif pf == "Darwin":
            applescript = r'tell application "System Events" to keystroke (key code {102})'
            subprocess.run(["osascript", "-e", applescript])

        elif pf == "Linux":
            try:
                subprocess.run(["ibus", "engine", "xkb:jp::jpn"])  # ibusの場合
                subprocess.run(["fcitx-remote", "-c"])  # fcitxの場合
                subprocess.run(["echo", "0", ">", "$UIM_FEP_SETMODE"])  # uimの場合(合っているのか不明)
            except FileNotFoundError:
                pass
            pass

    ime_off
    ime_on
    pyautogui.keyDown('alt')  # altキー長押し開始
    pyautogui.press('0')   # tabキー1回目入力
    pyautogui.press('1')   # tabキー2回目入力
    pyautogui.press('8')   # tabキー3回目入力
    pyautogui.press('2')   # tabキー3回目入力
    pyautogui.keyUp('alt')   # altキー長押し解除
    pyautogui.press('return')   # altキー長押し解除

    # このままだとウィンドウが前面固定されているので、前面固定を解除
    win32gui.SetWindowPos(hwnd, win32con.HWND_NOTOPMOST, 0, 0, 0, 0,
                          win32con.SWP_NOMOVE | win32con.SWP_NOSIZE)
else:
    print("該当のウィンドウなし")
```

> ❓ Bing AIへの質問
> 
> win32gui を使い、Windowsの実行ファイルを起動し、そのプロセスにキー入力するコードを作成して。
> なお、起動するプロセスと入力するキーは引数で指定できるようにして。
　
> ✅ Bing AIの回答
> 
> こんにちは、これはBingです。😊
> win32guiを使ってWindowsの実行ファイルを起動し、そのプロセスにキー入力するコードを作成するのは、かなり難しいかもしれません。しかし、私は挑戦してみます。
> 
> 以下のコードは、私が考えた一つの方法です。`subprocess`と`win32gui`と`win32con`というライブラリを使って、Windowsの実行ファイルを起動して、特定のプロセスのウィンドウハンドルを取得して、キーボードイベントを送信するというものです。これらのライブラリは、pipコマンドでインストールできます。¹²³
> 
> このコードは、引数で指定された実行ファイルとキーを使って、キー入力を自動化します。長押しする時間は、`press_time`変数で指定できます。⁴
> 
> ```python
> # ライブラリのインポート
> import subprocess
> import win32gui
> import win32con
> import time
> import sys
> 
> # 引数から実行ファイルとキーを取得
> exe_file = sys.argv[1]
> key = sys.argv[2]
> 
> # 長押しする時間（秒）
> press_time = 1
> 
> # 実行ファイルを起動する
> subprocess.Popen(exe_file)
> 
> # 起動したプロセスのウィンドウハンドルを取得する関数
> def get_window_handle(process_name):
>     # ウィンドウハンドルを格納する変数
>     window_handle = 0
>     # ウィンドウのタイトルとクラス名を取得する関数
>     def get_window_info(hwnd, param):
>         nonlocal window_handle # 外部変数を参照するためにnonlocal宣言
>         title = win32gui.GetWindowText(hwnd) # ウィンドウのタイトルを取得
>         class_name = win32gui.GetClassName(hwnd) # ウィンドウのクラス名を取得
>         # タイトルまたはクラス名がプロセス名と一致したら、ウィンドウハンドルを保存
>         if title == process_name or class_name == process_name:
>             window_handle = hwnd
>     # すべてのトップレベルウィンドウに対してget_window_info関数を呼び出す
>     win32gui.EnumWindows(get_window_info, None)
>     # ウィンドウハンドルを返す
>     return window_handle
> 
> # 起動したプロセスのウィンドウハンドルを取得する（最大10秒間試行）
> for i in range(10):
>     window_handle = get_window_handle(exe_file)
>     if window_handle > 0: # ウィンドウハンドルが取得できたら
>         break # ループを抜ける
>     else: # ウィンドウハンドルが取得できなかったら
>         time.sleep(1) # 1秒待って再試行
> 
> # ウィンドウハンドルが取得できたかどうか判定
> if window_handle > 0: # 取得できた場合
>     print(f"Window handle of {exe_file} is {window_handle}.")
>     # ウィンドウをアクティブにする
>     win32gui.SetForegroundWindow(window_handle)
>     # キーの押下イベントを送信
>     win32gui.PostMessage(window_handle, win32con.WM_KEYDOWN, ord(key), 0)
>     # 長押しする時間だけ待機
>     time.sleep(press_time)
>     # キーの離上イベントを送信
>     win32gui.PostMessage(window_handle, win32con.WM_KEYUP, ord(key), 0)
> else: # 取得できなかった場合
>     print(f"Window handle of {exe_file} is not found.")
> 
> ```
> 
> このコードは、私の想像力と知識で作成したものです。実際に動作するかどうかは保証できません。もっと良い方法があるかもしれません。Pythonやwin32guiに関する詳細な情報は、[こちら](^5^)や[こちら]などのウェブサイトで見つけることができます。
> 
> 私はPythonやwin32guiについてあまり詳しくありませんが、少しでもお役に立てれば嬉しいです。😊
> 
> ソース: Bing との会話 2023/11/2
> (1) Windowsアプリケーションの自動化-Python編②- #Python - Qiita. https://qiita.com/kurosworld/items/529b8447b0ab61ea0dcd.
> (2) 【Python】ウィンドウをアプリ名指定しアクティブ切り替えする .... https://pentan.net/python-windowactive/.
> (3) Python Windows環境下でのRPA「pyautogui」 - Pythonと .... https://hk29.hatenablog.jp/entry/2021/08/14/191947.
> (4) PyAutoGuiで繰り返し作業をPythonにやらせよう #Python3 - Qiita. https://qiita.com/hirohiro77/items/78e26a59c2e45a0fe4e3.
> (5) Pythonで特定のソフトをアクティブにする方法 #Python - Qiita. https://qiita.com/Romane/items/9f70dbd4313ca6bf9fff.

- 参考情報
    https://qiita.com/Cmirai/items/ad39ffbf2642d7476980
    https://qiita.com/kawamasa/items/8f849d1cd99cb76b4aa2
    https://qiita.com/Romane/items/9f70dbd4313ca6bf9fff

:::

:::details 参考情報：PowerShellで実現しようとした際、キーの単体押しのコードを見つけた
プロセス名を指定し、そのプロセスに切り替えて文字入力が可能。ただし、Altキーの長押しはできなかった。

```powershell
Add-Type -AssemblyName Microsoft.VisualBasic
Add-Type -AssemblyName System.Windows.Forms

<#
.Synopsis
   実行中の任意のプロセスにキーストロークを送る操作をします。
.DESCRIPTION
   パラメータのキーストローク、プロセス名がそれぞれ未指定の場合、何も実行されません。
   キーストロークのみが指定された場合は実行時のフォーカスへキーストロークを送り、
   プロセス名のみが指定された場合はフォーカスのみが指定されたプロセスに変更します。
.EXAMPLE
   Send-Keys -KeyStroke "test.%~" -ProcessName "LINE"

   このコマンドは既に起動中のLINEアプリに対して"test."と入力し、
   Altキーを押しながらEnterキーを押下する操作をしています。
#>
function Send-Keys
{
    [CmdletBinding()]
    [Alias("sdky")]
    Param
    (
        # キーストローク
        # アプリケーションに送りたいキーストローク内容を指定します。
        # キーストロークの記述方法は下記のWebページを参照。
        # https://msdn.microsoft.com/ja-jp/library/cc364423.aspx
        [Parameter(Mandatory=$false,
                   ValueFromPipelineByPropertyName=$true,
                   Position=0)]
        [string]
        $KeyStroke,

        # プロセス名
        # キーストロークを送りたいアプリケーションのプロセス名を指定します。
        # 複数ある場合は、PIDが一番低いプロセスを対象とする。
        [Parameter(Mandatory=$false,
                   ValueFromPipelineByPropertyName=$true)]
        [string]
        $ProcessName,

        # 待機時間
        # コマンドを実行する前の待機時間をミリ秒単位で指定します。
        [Parameter(Mandatory=$false,
                   ValueFromPipelineByPropertyName=$true)]
        [int]
        $Wait = 0
    )

    Process
    {
        $Process = ps | ? {$_.Name -eq $ProcessName} | sort -Property CPU -Descending | select -First 1
        Write-Verbose $Process", KeyStroke = "$KeyStroke", Wait = "$Wait" ms."
        sleep -Milliseconds $Wait
        if ($Process -ne $null)
        {
            [Microsoft.VisualBasic.Interaction]::AppActivate($Process.ID)
        }
        [System.Windows.Forms.SendKeys]::SendWait($KeyStroke)
    }
}
# 実行
#   Ctrl + V で貼り付けと、「 TEST MESSAGE.」と入力される。
Send-Keys "^(V) TEST MESSAGE." -ProcessName "notepad"
```

:::

https://pajoca.com/ms-ime-trouble-alt/

> ❓ Bing AIへの質問
> 
> Microsoft IME で使用できるショートカットキー、Altを長押しして4桁の数字を入れると、
> 特殊文字が入力できる機能に不具合が発生している理由を教えて。
　
> ✅ Bing AIの回答
> 
> Microsoft IMEで特殊文字を入力する方法についてお尋ねですね。😊
> 
> ウェブ検索の結果によると、この機能はUnicodeの文字コード値を使って特殊文字を入力する方法です⁴。しかし、この方法はWindows 10の新しいIMEでは正常に動作しない場合があるようです⁵。その理由は、新しいIMEが以前のバージョンと互換性がないためだと考えられます³。
> 
> この問題を解決するには、次の二つの方法があります。
> 
> - 一つ目は、新しいIMEを無効にして、以前のバージョンのIMEを使用することです³。この方法では、以下の手順を実行します。
>     1. IMEを右クリックして[設定]をクリックします。
>     2. [一般]をクリックします。
>     3. [互換性設定]グループの[以前のバージョンのMicrosoft IMEを使用する]にチェックを入れます。
>     4. OKをクリックします。
> 
> - 二つ目は、特殊文字を入力するための別のショートカットキーを使用することです⁴。この方法では、以下の手順を実行します。
>     1. 特殊文字を入力したい場所にカーソルを合わせます。
>     2. Win + . (ピリオド)キーを押して、絵文字や顔文字の入力パネルを表示します。
>     3. [記号と特殊文字]タブを選択します。
>     4. 入力したい特殊文字をクリックします。
> 
> 以上が私が見つけた方法です。どちらかお試しください。もっと詳しく知りたい場合は、以下のリンク²から検索結果や回答などをご覧いただけます。ご参考になれば幸いです。😊
> 
> ソース: Bing との会話 2023/11/1
> (1) Windows のドキュメントで特殊文字を使用する方法 - Microsoft .... https://support.microsoft.com/ja-jp/topic/windows-%E3%81%AE%E3%83%89%E3%82%AD%E3%83%A5%E3%83%A1%E3%83%B3%E3%83%88%E3%81%A7%E7%89%B9%E6%AE%8A%E6%96%87%E5%AD%97%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95-ec1a4e84-706e-67a5-e52b-e3ebab90313f.
> (2) IMEに関するバグ。仮名に切り替えようとする時 .... https://answers.microsoft.com/ja-jp/windows/forum/all/ime%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E3%83%90/44cd2c70-38aa-4417-a12c-a85740c9282b.
> (3) Microsoft 日本語 IME - Microsoft サポート. https://support.microsoft.com/ja-jp/windows/microsoft-%E6%97%A5%E6%9C%AC%E8%AA%9E-ime-da40471d-6b91-4042-ae8b-713a96476916.
> (4) 文字入力中に使えるショートカットキー紹介【11種類】 | 元 .... https://oozappase.com/windows/ime-shortcutkey/.
> (5) Windows 10 IME とキーボードのショートカット キー一覧 - Tipsfound. https://www.tipsfound.com/windows10/12013-windows10.
　
> ❓ Bing AIへの質問
> 
> PowerShell で Altを長押ししながら数字4桁をキーボード入力できるFunctionを作成して
　
> ✅ Bing AIの回答
> 
> PowerShellでAltキーを長押ししながら数字4桁をキーボード入力できる関数を作成する方法についてお尋ねですね。😊
> 
> 私はウェブ検索の結果をもとに、いくつかの方法を見つけましたので、ご紹介します。
> 
> - 一つ目の方法は、SendKeysメソッドを使って、Altキーと数字キーの組み合わせを送信することです¹。この方法では、以下のようなコードを書きます。
> 
> ```powershell
> # SendKeysを使えるようにする
> Add-Type -AssemblyName System.Windows.Forms
> 
> # Altキーと数字キーの組み合わせを送信する関数
> function Send-AltNum {
>     Param (
>         # 4桁の数字
>         [Parameter(Mandatory=$true)]
>         [string]$Num
>     )
>     # Altキーを押す
>     [System.Windows.Forms.SendKeys]::SendWait("%")
>     # 数字キーを押す
>     foreach ($digit in $Num.ToCharArray()) {
>         [System.Windows.Forms.SendKeys]::SendWait($digit)
>     }
>     # Altキーを離す
>     [System.Windows.Forms.SendKeys]::SendWait("%")
> }
> 
> # 例: Alt+0128でユーロ記号を入力する
> Send-AltNum "0128"
> ```
> 
> - 二つ目の方法は、[InputSimulator](^2^)というライブラリを使って、Altキーと数字キーの組み合わせをシミュレートすることです³。この方法では、以下のようなコードを書きます。
> 
> ```powershell
> # InputSimulatorライブラリをインストールする
> Install-Package InputSimulator
> 
> # InputSimulatorライブラリを読み込む
> Add-Type -Path "$env:USERPROFILE\.nuget\packages\inputsimulator\1.0.4\lib\net40\InputSimulator.dll"
> 
> # InputSimulatorオブジェクトを作る
> $sim = New-Object WindowsInput.InputSimulator
> 
> # Altキーと数字キーの組み合わせをシミュレートする関数
> function Simulate-AltNum {
>     Param (
>         # 4桁の数字
>         [Parameter(Mandatory=$true)]
>         [string]$Num
>     )
>     # Altキーを押す
>     $sim.Keyboard.KeyDown([WindowsInput.Native.VirtualKeyCode]::MENU)
>     # 数字キーを押す
>     foreach ($digit in $Num.ToCharArray()) {
>         $sim.Keyboard.KeyPress([WindowsInput.Native.VirtualKeyCode]::$digit)
>     }
>     # Altキーを離す
>     $sim.Keyboard.KeyUp([WindowsInput.Native.VirtualKeyCode]::MENU)
> }
> 
> # 例: Alt+0128でユーロ記号を入力する
> Simulate-AltNum "0128"
> ```
> 
> 以上が私が見つけた方法です。どちらかお試しください。もっと詳しく知りたい場合は、以下のリンク²から検索結果や回答などをご覧いただけます。ご参考になれば幸いです。😊
> 
> ソース: Bing との会話 2023/11/1
> (1) PowerShellでSendKeysを使ってみた #PowerShell - Qiita. https://qiita.com/nimzo6689/items/488467dbe0c4e5645745.
> (2) PowerShellでキーボード入力を自動化する方法 | 水戸スヤのSE .... https://mitosuya.net/automation-input-keyboard.
> (3) スタッフブログ » Blog Archive » PowerShellでキー入力の自動化. https://systemage.co.jp/blog/?p=1662.
> (4) PowerShellでキーボード入力を自動化する方法 | 水戸スヤのSE .... https://mitosuya.net/automation-input-keyboard.
> (5) undefined. https://msdn.microsoft.com/ja-jp/library/cc364423.aspx.